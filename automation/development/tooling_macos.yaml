apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: dev_tools_automation_macos
  path: automation/development/tooling_macos
  description: Development tools automation for macOS (uses Homebrew)

executor:
  profile: local
  version: noetl-runtime/1
workload:
  action: help  # setup, validate-install, validate-devtools, validate-docker, install-base, install-devtools, install-jq, install-yq, install-kind, install-pyenv, install-uv, install-tfenv, install-psql, ensure-path, fix-docker-perms

workflow:
  - step: start
    desc: Entry point for macOS dev tools automation
    tool:
      kind: shell
      cmds:
        - echo "macOS Dev Tools Automation - Action '{{ workload.action }}'"
    next:
      - when: "{{ workload.action }} == setup"
        then:
          - step: setup_tools
        args: {}
      - when: "{{ workload.action }} == validate-install"
        then:
          - step: validate_install
        args: {}
      - when: "{{ workload.action }} == validate-devtools"
        then:
          - step: validate_devtools
        args: {}
      - when: "{{ workload.action }} == validate-docker"
        then:
          - step: validate_docker
        args: {}
      - when: "{{ workload.action }} == install-base"
        then:
          - step: install_base
        args: {}
      - when: "{{ workload.action }} == install-devtools"
        then:
          - step: install_devtools
        args: {}
      - when: "{{ workload.action }} == install-jq"
        then:
          - step: install_jq
        args: {}
      - when: "{{ workload.action }} == install-yq"
        then:
          - step: install_yq
        args: {}
      - when: "{{ workload.action }} == install-kind"
        then:
          - step: install_kind
        args: {}
      - when: "{{ workload.action }} == install-pyenv"
        then:
          - step: install_pyenv
        args: {}
      - when: "{{ workload.action }} == install-uv"
        then:
          - step: install_uv
        args: {}
      - when: "{{ workload.action }} == install-tfenv"
        then:
          - step: install_tfenv
        args: {}
      - when: "{{ workload.action }} == install-psql"
        then:
          - step: install_psql
        args: {}
      - when: "{{ workload.action }} == ensure-path"
        then:
          - step: ensure_path
        args: {}
      - when: "{{ workload.action }} == install-homebrew"
        then:
          - step: install_homebrew
        args: {}
      - when: "{{ workload.action }} == help"
        then:
          - step: show_help
        args: {}
      - step: show_help

  - step: setup_tools
    desc: Validate required tooling on macOS hosts
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Setting up and validating dev tools on macOS..."
          bash -ceu '
          fail=0
          check() {
            if command -v "$1" >/dev/null 2>&1; then
              echo "[OK] $1: $($1 --version 2>/dev/null | head -n1 || echo installed)"
            else
              echo "[MISSING] $1 not found in PATH"; fail=1
            fi
          }
          echo "Validating required tools..."

          # Check Homebrew first
          if ! command -v brew >/dev/null 2>&1; then
            echo "[MISSING] Homebrew not found"
            echo "       -> Install with: /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
            fail=1
          else
            echo "[OK] brew: $(brew --version | head -n1)"
          fi

          check git
          check curl
          if ! command -v jq >/dev/null 2>&1; then
            echo "[MISSING] jq not found in PATH"
            echo "       -> Install with: brew install jq"
            fail=1
          else
            echo "[OK] jq: $(jq --version 2>/dev/null | head -n1 || echo installed)"
          fi
          check python3
          if ! command -v cargo >/dev/null 2>&1; then
            echo "[MISSING] cargo (Rust toolchain) not found in PATH"
            echo "       -> Install with: curl --proto '\''=https'\'' --tlsv1.2 -sSf https://sh.rustup.rs | sh"
            fail=1
          else
            echo "[OK] cargo: $(cargo --version 2>/dev/null | head -n1 || echo installed)"
          fi
          if command -v docker >/dev/null 2>&1; then
            echo "[OK] docker available"; if ! docker info >/dev/null 2>&1; then
              echo "[WARN] docker present but daemon not reachable"
              echo "       -> Ensure Docker Desktop is running"
            fi
          else
            echo "[MISSING] docker not found in PATH"
            echo "       -> Install Docker Desktop from https://www.docker.com/products/docker-desktop/"
            fail=1
          fi
          if command -v task >/dev/null 2>&1; then echo "[OK] task available"; else echo "[INFO] task not installed (install with: brew install go-task)"; fi
          if command -v noetl >/dev/null 2>&1; then
            echo "[OK] noetl CLI: $(noetl --version 2>/dev/null | head -n1 || echo present)"
          else
            echo "[INFO] noetl CLI not installed - install with: pip install noetl[cli]"
          fi
          exit $fail
          '
          echo "Building noetlctl locally..."
          cargo build --release --manifest-path crates/noetlctl/Cargo.toml
    next:
      - step: end

  - step: validate_install
    desc: Validate required tools are installed
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Validating required tools installation on macOS..."
          bash -ceu '
          fail=0
          check() {
            if command -v "$1" >/dev/null 2>&1; then
              echo "[OK] $1: $($1 --version 2>/dev/null | head -n1 || echo installed)"
            else
              echo "[MISSING] $1 not found in PATH"; fail=1
            fi
          }
          echo "Validating required tools..."

          # Check Homebrew
          if ! command -v brew >/dev/null 2>&1; then
            echo "[MISSING] Homebrew not found"
            fail=1
          else
            echo "[OK] brew: $(brew --version | head -n1)"
          fi

          check git
          check curl
          if ! command -v jq >/dev/null 2>&1; then
            echo "[MISSING] jq not found in PATH"
            fail=1
          else
            echo "[OK] jq: $(jq --version 2>/dev/null | head -n1 || echo installed)"
          fi
          check python3
          if ! command -v cargo >/dev/null 2>&1; then
            echo "[MISSING] cargo (Rust toolchain) not found in PATH"
            fail=1
          else
            echo "[OK] cargo: $(cargo --version 2>/dev/null | head -n1 || echo installed)"
          fi
          if command -v docker >/dev/null 2>&1; then
            echo "[OK] docker available"; if ! docker info >/dev/null 2>&1; then
              echo "[WARN] docker present but daemon not reachable"
              echo "       -> Ensure Docker Desktop is running"
            fi
          else
            echo "[MISSING] docker not found in PATH"
            fail=1
          fi
          if command -v task >/dev/null 2>&1; then echo "[OK] task available"; else echo "[INFO] task not installed"; fi
          if command -v noetl >/dev/null 2>&1; then
            echo "[OK] noetl CLI: $(noetl --version 2>/dev/null | head -n1 || echo present)"
          else
            echo "[INFO] noetl CLI not installed - install with: pip install noetl[cli]"
          fi
          exit $fail
          '
    next:
      - step: end

  - step: validate_devtools
    desc: Validate optional dev tools available
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Validating optional dev tools on macOS..."
          bash -ceu '
          tools=(kind yq pyenv uv tfenv terraform kubectl)
          for t in "${tools[@]}"; do
            if command -v "$t" >/dev/null 2>&1; then
              case "$t" in
                kind) echo "[OK] kind: $(kind --version || true)";;
                yq) echo "[OK] yq: $(yq --version || true)";;
                pyenv) echo "[OK] pyenv: $(pyenv --version || true)";;
                uv) echo "[OK] uv: $(uv --version || true)";;
                tfenv) echo "[OK] tfenv: $(tfenv --version || true)";;
                terraform) echo "[OK] terraform: $(terraform version | head -n1 || true)";;
                kubectl) echo "[OK] kubectl: $(kubectl version --client --short 2>/dev/null || kubectl version --client 2>/dev/null | head -n1 || true)";;
              esac
            else
              echo "[MISSING] $t not found in PATH"
            fi
          done
          '
    next:
      - step: end

  - step: validate_docker
    desc: Validate Docker Desktop on macOS
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Validating Docker Desktop on macOS..."
          if ! command -v docker >/dev/null 2>&1; then
            echo "[ERROR] Docker not found. Install Docker Desktop from https://www.docker.com/products/docker-desktop/"
            exit 1
          fi
          docker info
          docker run --rm hello-world
    next:
      - step: end

  - step: install_homebrew
    desc: Install Homebrew package manager
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Installing Homebrew..."
          bash -ceu '
          if command -v brew >/dev/null 2>&1; then
            echo "[SKIP] Homebrew already installed: $(brew --version | head -n1)"
            exit 0
          fi
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

          # Add brew to PATH for Apple Silicon Macs
          if [ -f /opt/homebrew/bin/brew ]; then
            echo "[INFO] Adding Homebrew to PATH for Apple Silicon..."
            echo "eval \"\$(/opt/homebrew/bin/brew shellenv)\"" >> ~/.zprofile
            eval "$(/opt/homebrew/bin/brew shellenv)"
          fi

          brew --version
          '
    next:
      - step: end

  - step: install_base
    desc: Install basic CLI tools via Homebrew
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Installing basic CLI tools via Homebrew..."
          echo "  - git, curl, jq, make"
          echo "  - python3"
          bash -ceu '
          if ! command -v brew >/dev/null 2>&1; then
            echo "[ERROR] Homebrew not found. Install it first with: noetl run automation/development/tooling_macos.yaml --set action=install-homebrew"
            exit 1
          fi

          # Update Homebrew
          brew update

          # Install base tools
          brew install git curl jq make coreutils

          # Install Python if not present
          if ! command -v python3 >/dev/null 2>&1; then
            brew install python@3.11
          fi

          echo "[OK] Base tools installed."
          '
    next:
      - step: end

  - step: install_devtools
    desc: Install yq, kind, pyenv, uv, tfenv, kubectl (aggregate)
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Installing dev tools via Homebrew (yq, kind, pyenv, uv, tfenv, kubectl)..."

          bash -ceu '
          if ! command -v brew >/dev/null 2>&1; then
            echo "[ERROR] Homebrew not found. Install it first."
            exit 1
          fi

          # Install yq
          if command -v yq >/dev/null 2>&1; then
            echo "[SKIP] yq already installed: $(yq --version || true)"
          else
            brew install yq
            echo "[OK] yq: $(yq --version || true)"
          fi

          # Install kind
          if command -v kind >/dev/null 2>&1; then
            echo "[SKIP] kind already installed: $(kind --version || true)"
          else
            brew install kind
            echo "[OK] kind: $(kind --version || true)"
          fi

          # Install kubectl
          if command -v kubectl >/dev/null 2>&1; then
            echo "[SKIP] kubectl already installed"
          else
            brew install kubectl
            echo "[OK] kubectl installed"
          fi

          # Install pyenv
          if command -v pyenv >/dev/null 2>&1; then
            echo "[SKIP] pyenv already installed: $(pyenv --version || true)"
          else
            brew install pyenv pyenv-virtualenv

            # Configure shell
            SHELL_RC="$HOME/.zshrc"
            if [ ! -f "$SHELL_RC" ]; then
              SHELL_RC="$HOME/.bash_profile"
            fi

            if ! grep -q "pyenv setup (added by NoETL tooling)" "$SHELL_RC" 2>/dev/null; then
              printf "\n# pyenv setup (added by NoETL tooling)\n" >> "$SHELL_RC"
              printf "export PYENV_ROOT=\"\$HOME/.pyenv\"\n" >> "$SHELL_RC"
              printf "[[ -d \$PYENV_ROOT/bin ]] && export PATH=\"\$PYENV_ROOT/bin:\$PATH\"\n" >> "$SHELL_RC"
              printf "eval \"\$(pyenv init -)\"\n" >> "$SHELL_RC"
              printf "eval \"\$(pyenv virtualenv-init -)\"\n" >> "$SHELL_RC"
            fi
            echo "[OK] pyenv: $(pyenv --version || true)"
          fi

          # Install uv
          if command -v uv >/dev/null 2>&1; then
            echo "[SKIP] uv already installed: $(uv --version || true)"
          else
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo "[OK] uv installed"
          fi

          # Install tfenv
          if command -v tfenv >/dev/null 2>&1; then
            echo "[SKIP] tfenv already installed: $(tfenv --version || true)"
          else
            brew install tfenv
            echo "[OK] tfenv: $(tfenv --version || true)"
            tfenv install latest
            tfenv use latest
          fi

          # Install jq
          if command -v jq >/dev/null 2>&1; then
            echo "[SKIP] jq already installed: $(jq --version || true)"
          else
            brew install jq
            echo "[OK] jq: $(jq --version || true)"
          fi

          # Install psql
          if command -v psql >/dev/null 2>&1; then
            echo "[SKIP] psql already installed: $(psql --version || true)"
          else
            brew install libpq
            brew link --force libpq
            echo "[OK] psql: $(psql --version || true)"
          fi

          # Install go-task
          if command -v task >/dev/null 2>&1; then
            echo "[SKIP] task already installed: $(task --version || true)"
          else
            brew install go-task
            echo "[OK] task: $(task --version || true)"
          fi
          '
    next:
      - step: end

  - step: install_jq
    desc: Install jq via Homebrew
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Installing jq..."
          bash -ceu '
          if command -v jq >/dev/null 2>&1; then
            echo "[SKIP] jq already installed: $(jq --version || true)"
            exit 0
          fi
          brew install jq
          jq --version
          '
    next:
      - step: end

  - step: install_yq
    desc: Install yq via Homebrew
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Installing yq..."
          bash -ceu '
          if command -v yq >/dev/null 2>&1; then
            echo "[SKIP] yq already installed: $(yq --version || true)"
            exit 0
          fi
          brew install yq
          yq --version
          '
    next:
      - step: end

  - step: install_kind
    desc: Install kind (Kubernetes in Docker) via Homebrew
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Installing kind..."
          bash -ceu '
          if command -v kind >/dev/null 2>&1; then
            echo "[SKIP] kind already installed: $(kind --version || true)"
            exit 0
          fi
          brew install kind
          kind --version
          '
    next:
      - step: end

  - step: install_pyenv
    desc: Install pyenv via Homebrew
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Installing pyenv..."
          bash -ceu '
          if command -v pyenv >/dev/null 2>&1; then
            echo "[SKIP] pyenv already installed: $(pyenv --version || true)"
            exit 0
          fi

          brew install pyenv pyenv-virtualenv

          # Configure shell (prefer zsh on macOS)
          SHELL_RC="$HOME/.zshrc"
          if [ ! -f "$SHELL_RC" ]; then
            SHELL_RC="$HOME/.bash_profile"
          fi

          if ! grep -q "pyenv setup (added by NoETL tooling)" "$SHELL_RC" 2>/dev/null; then
            printf "\n# pyenv setup (added by NoETL tooling)\n" >> "$SHELL_RC"
            printf "export PYENV_ROOT=\"\$HOME/.pyenv\"\n" >> "$SHELL_RC"
            printf "[[ -d \$PYENV_ROOT/bin ]] && export PATH=\"\$PYENV_ROOT/bin:\$PATH\"\n" >> "$SHELL_RC"
            printf "eval \"\$(pyenv init -)\"\n" >> "$SHELL_RC"
            printf "eval \"\$(pyenv virtualenv-init -)\"\n" >> "$SHELL_RC"
          fi

          pyenv --version || true
          echo "[INFO] Restart your shell or run: source $SHELL_RC"
          '
    next:
      - step: end

  - step: install_uv
    desc: Install uv (fast Python package manager)
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Installing uv..."
          bash -ceu '
          if command -v uv >/dev/null 2>&1; then
            echo "[SKIP] uv already installed: $(uv --version || true)"
            exit 0
          fi
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "[INFO] If uv is not in PATH, restart your shell or source the profile suggested by the installer."
          uv --version || true
          '
    next:
      - step: end

  - step: install_tfenv
    desc: Install tfenv and latest Terraform via Homebrew
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Installing tfenv and Terraform..."
          bash -ceu '
          if command -v tfenv >/dev/null 2>&1; then
            echo "[SKIP] tfenv already installed: $(tfenv --version || true)"
          else
            brew install tfenv
          fi

          if command -v tfenv >/dev/null 2>&1; then
            echo "[OK] tfenv: $(tfenv --version || true)"
            tfenv install latest
            tfenv use latest
            terraform version
          else
            echo "[ERROR] tfenv not on PATH yet; restart your shell" >&2
          fi
          '
    next:
      - step: end

  - step: install_psql
    desc: Install PostgreSQL client tools (psql) via Homebrew
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Installing PostgreSQL client tools..."
          bash -ceu '
          if command -v psql >/dev/null 2>&1; then
            echo "[SKIP] psql already installed: $(psql --version || true)"
            exit 0
          fi
          brew install libpq
          brew link --force libpq
          if command -v psql >/dev/null 2>&1; then
            echo "[OK] psql: $(psql --version || true)"
          else
            echo "[INFO] psql installed but not in PATH. Add to PATH:"
            echo "  export PATH=\"/opt/homebrew/opt/libpq/bin:\$PATH\""
          fi
          '
    next:
      - step: end

  - step: ensure_path
    desc: Ensure common tool paths are added to shell
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Ensuring common tool paths in shell config..."
          bash -ceu '
          # Determine shell config file
          SHELL_RC="$HOME/.zshrc"
          if [ ! -f "$SHELL_RC" ]; then
            SHELL_RC="$HOME/.bash_profile"
          fi

          ensure_line() { grep -qxF "$1" "$SHELL_RC" 2>/dev/null || echo "$1" >> "$SHELL_RC"; }

          # Common paths for macOS
          ensure_line "export PATH=\"\$HOME/.local/bin:\$PATH\""
          ensure_line "export PATH=\"/usr/local/bin:\$PATH\""

          # Homebrew paths (Apple Silicon)
          if [ -d /opt/homebrew ]; then
            ensure_line "eval \"\$(/opt/homebrew/bin/brew shellenv)\""
          fi

          # libpq path for psql
          if [ -d /opt/homebrew/opt/libpq/bin ]; then
            ensure_line "export PATH=\"/opt/homebrew/opt/libpq/bin:\$PATH\""
          fi

          export PATH="$HOME/.local/bin:/usr/local/bin:$PATH"
          echo "[OK] Ensured PATH contains common directories"
          echo "Current PATH: $PATH"
          echo "[INFO] If this is your first time adding these, restart your shell or: source $SHELL_RC"
          '
    next:
      - step: end

  - step: show_help
    desc: Display available actions
    tool:
      kind: shell
      cmds:
        - |
          echo "=================================================="
          echo " macOS Dev Tools Automation"
          echo "=================================================="
          echo ""
          echo "Usage:"
          echo "  noetl run automation/development/tooling_macos.yaml --set action=<action>"
          echo ""
          echo "Setup & Validation:"
          echo "  setup               - Validate required tooling on macOS"
          echo "  validate-install    - Validate required tools are installed"
          echo "  validate-devtools   - Validate optional dev tools available"
          echo "  validate-docker     - Validate Docker Desktop"
          echo ""
          echo "Installation (Base):"
          echo "  install-homebrew    - Install Homebrew package manager"
          echo "  install-base        - Install basic CLI tools (git, curl, jq, make)"
          echo "  install-devtools    - Install all dev tools (yq, kind, pyenv, uv, tfenv, kubectl)"
          echo ""
          echo "Installation (Individual):"
          echo "  install-jq          - Install jq via Homebrew"
          echo "  install-yq          - Install yq via Homebrew"
          echo "  install-kind        - Install kind (Kubernetes in Docker)"
          echo "  install-pyenv       - Install pyenv via Homebrew"
          echo "  install-uv          - Install uv (fast Python package manager)"
          echo "  install-tfenv       - Install tfenv and latest Terraform"
          echo "  install-psql        - Install PostgreSQL client tools"
          echo ""
          echo "Configuration:"
          echo "  ensure-path         - Ensure tool paths in shell config"
          echo ""
          echo "Examples:"
          echo "  # Setup and validate all tools"
          echo "  noetl run automation/development/tooling_macos.yaml --set action=setup"
          echo ""
          echo "  # Install Homebrew first (if not installed)"
          echo "  noetl run automation/development/tooling_macos.yaml --set action=install-homebrew"
          echo ""
          echo "  # Install base tools"
          echo "  noetl run automation/development/tooling_macos.yaml --set action=install-base"
          echo ""
          echo "  # Install all dev tools"
          echo "  noetl run automation/development/tooling_macos.yaml --set action=install-devtools"
          echo ""
          echo "  # Validate installation"
          echo "  noetl run automation/development/tooling_macos.yaml --set action=validate-install"
          echo ""
    next:
      - step: end

  - step: end
    desc: End workflow

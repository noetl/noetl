apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: pagination_server_automation
  path: automation/test/pagination-server

executor:
  profile: local
  version: noetl-runtime/1
workload:
  action: help  # build, deploy, full, status, logs, test, undeploy

workflow:
  - step: start
    desc: Entry point for pagination server automation
    tool:
      kind: shell
      cmds:
        - echo "Pagination Server Automation - Action '{{ workload.action }}'"
    next:
      - step: build_image
        when: "{{ workload.action == 'build' }}"
      - step: load_image
        when: "{{ workload.action == 'load' }}"
      - step: deploy_server
        when: "{{ workload.action == 'deploy' }}"
      - step: build_image
        when: "{{ workload.action == 'full' }}"
      - step: check_status
        when: "{{ workload.action == 'status' }}"
      - step: show_logs
        when: "{{ workload.action == 'logs' }}"
      - step: test_endpoints
        when: "{{ workload.action == 'test' }}"
      - step: undeploy_server
        when: "{{ workload.action == 'undeploy' }}"
      - step: show_help

  # Direct step aliases for positional argument support
  - step: status
    desc: Alias for check_status
    tool:
      kind: noop
    next:
      - step: check_status

  - step: build
    desc: Alias for build_image
    tool:
      kind: noop
    next:
      - step: build_image

  - step: load
    desc: Alias for load_image
    tool:
      kind: noop
    next:
      - step: load_image

  - step: deploy
    desc: Alias for deploy_server
    tool:
      kind: noop
    next:
      - step: deploy_server

  - step: full
    desc: Full deployment workflow
    tool:
      kind: noop
    next:
      - step: build_image

  - step: logs
    desc: Alias for show_logs
    tool:
      kind: noop
    next:
      - step: show_logs

  - step: test
    desc: Alias for test_endpoints
    tool:
      kind: noop
    next:
      - step: test_endpoints

  - step: undeploy
    desc: Alias for undeploy_server
    tool:
      kind: noop
    next:
      - step: undeploy_server

  - step: build_image
    desc: Build pagination test server Docker image
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Building pagination test server image..."
          IMAGE_TAG=$(date +%Y-%m-%d-%H-%M)
          docker build -t local/test-server:$IMAGE_TAG -f docker/test-server/Dockerfile .
          docker tag local/test-server:$IMAGE_TAG local/test-server:latest
          echo "Built test-server:$IMAGE_TAG"
    next:
      - step: load_image
        when: "{{ workload.action == 'full' }}"
      - step: end

  - step: load_image
    desc: Load pagination server image into kind cluster
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Loading pagination server image to kind cluster..."
          kind load docker-image local/test-server:latest --name noetl
    next:
      - step: deploy_server
        when: "{{ workload.action == 'full' }}"
      - step: end

  - step: deploy_server
    desc: Deploy pagination test server to Kubernetes
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Deploying pagination test server..."
          kubectl apply -f ci/manifests/test-server/namespace.yaml
          sleep 2
          kubectl apply -f ci/manifests/test-server/deployment.yaml
          echo "Waiting for pagination test server to be ready..."
          kubectl wait --for=condition=ready pod -l app=paginated-api -n test-server --timeout=60s || true
          kubectl get pods -n test-server
    next:
      - step: check_status
        when: "{{ workload.action == 'full' }}"
      - step: end

  - step: check_status
    desc: Check pagination server deployment status
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Checking pagination server status..."
          echo "=== Pagination Test Server Pods ==="
          kubectl get pods -n test-server
          echo ""
          echo "=== Pagination Test Server Services ==="
          kubectl get svc -n test-server
          echo ""
          echo "=== Pagination Test Server Endpoints ==="
          echo "ClusterIP: http://paginated-api.test-server.svc.cluster.local:5555"
          echo "NodePort: http://localhost:30555"
    next:
      - step: end

  - step: show_logs
    desc: Show pagination server logs
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Pagination server logs:"
          kubectl logs -n test-server -l app=paginated-api --tail=100
    next:
      - step: end

  - step: test_endpoints
    desc: Test pagination server API endpoints
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Testing pagination server endpoints..."
          kubectl run -n test-server curl-test --image=curlimages/curl:latest --rm -i --restart=Never -- sh -c '
          echo "=== Health Check ==="
          curl -s http://paginated-api:5555/health
          echo ""
          echo ""
          echo "=== Page 1 of assessments ==="
          curl -s http://paginated-api:5555/api/v1/assessments?page=1 | head -20
          echo ""
          echo "=== Users with offset ==="
          curl -s http://paginated-api:5555/api/v1/users?offset=0&limit=5
          echo ""
          '
    next:
      - step: end

  - step: undeploy_server
    desc: Remove pagination server from Kubernetes
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Removing pagination test server..."
          kubectl delete -f ci/manifests/test-server/deployment.yaml --ignore-not-found=true
          kubectl delete namespace test-server --ignore-not-found=true
    next:
      - step: end

  - step: show_help
    desc: Display available actions
    tool:
      kind: shell
      cmds:
        - |
          echo "====================================="
          echo " Pagination Server Automation"
          echo "====================================="
          echo ""
          echo "Usage:"
          echo "  noetl run automation/test/pagination-server.yaml --set action=<action>"
          echo ""
          echo "Available actions:"
          echo "  build     - Build pagination test server Docker image"
          echo "  load      - Load image into kind cluster"
          echo "  deploy    - Deploy to Kubernetes"
          echo "  full      - Build, load, and deploy (complete workflow)"
          echo "  status    - Check deployment status"
          echo "  logs      - Show server logs"
          echo "  test      - Test API endpoints"
          echo "  undeploy  - Remove from Kubernetes"
          echo ""
          echo "Examples:"
          echo "  noetl run automation/test/pagination-server.yaml --set action=full"
          echo "  noetl run automation/test/pagination-server.yaml --set action=status"
          echo "  noetl run automation/test/pagination-server.yaml --set action=test"
          echo ""
    next:
      - step: end

  - step: end
    desc: End workflow
    tool:
      kind: noop

apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: bootstrap_environment
  path: automation/setup/bootstrap
  description: Complete K8s environment setup with prerequisite validation
workload:
  registry: "local"
  image_name: "noetl"
workflow:
  - step: start
    desc: Begin bootstrap process
    tool:
      kind: shell
      cmds:
        - echo "Starting NoETL environment bootstrap..."
    next:
      - step: validate_prerequisites
  
  - step: validate_prerequisites
    desc: Validate required tools are installed
    tool:
      kind: shell
      cmds:
        - |
          echo "Validating prerequisites..."
          echo ""
          
          MISSING=""
          
          # Check noetl binary (required)
          if ! command -v noetl &> /dev/null; then
            echo "FAIL noetl binary not found"
            MISSING="$MISSING noetl"
          else
            echo "OK noetl binary: $(which noetl)"
          fi
          
          # Check Docker (required)
          if ! command -v docker &> /dev/null; then
            echo "FAIL docker not found"
            MISSING="$MISSING docker"
          else
            echo "OK docker: $(docker --version)"
          fi
          
          # Check kind (required)
          if ! command -v kind &> /dev/null; then
            echo "FAIL kind not found"
            MISSING="$MISSING kind"
          else
            echo "OK kind: $(kind version)"
          fi
          
          # Check kubectl (required)
          if ! command -v kubectl &> /dev/null; then
            echo "FAIL kubectl not found"
            MISSING="$MISSING kubectl"
          else
            echo "OK kubectl: $(kubectl version --client --short 2>/dev/null || echo 'installed')"
          fi
          
          # Check task (required)
          if ! command -v task &> /dev/null; then
            echo "FAIL task not found"
            MISSING="$MISSING task"
          else
            echo "OK task: $(task --version)"
          fi
          
          # Check Python (optional but recommended)
          if ! command -v python3 &> /dev/null; then
            echo "WARN python3 not found (optional)"
          else
            echo "OK python3: $(python3 --version)"
          fi
          
          # Check uv (optional for fast Python package management)
          if ! command -v uv &> /dev/null; then
            echo "WARN uv not found (optional, provides faster Python package management)"
          else
            echo "OK uv: $(uv --version)"
          fi
          
          echo ""
          if [ -n "$MISSING" ]; then
            echo "FAIL Missing required tools:$MISSING"
            echo ""
            echo "Install missing tools:"
            echo "  macOS: brew install docker kind kubectl go-task"
            echo "  Linux: See https://noetl.dev/docs/installation"
            exit 1
          else
            echo "OK All required prerequisites installed"
          fi
    next:
      - step: check_docker_running
  
  - step: check_docker_running
    desc: Verify Docker daemon is running
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Checking Docker daemon..."
          if ! docker info &> /dev/null; then
            echo "FAIL Docker daemon is not running"
            echo "   Start Docker Desktop or run: sudo systemctl start docker"
            exit 1
          else
            echo "OK Docker daemon is running"
          fi
    next:
      - step: check_existing_cluster
  
  - step: check_existing_cluster
    desc: Check if kind cluster already exists
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Checking for existing kind cluster..."
          if kind get clusters 2>/dev/null | grep -q "^noetl$"; then
            echo "OK Kind cluster 'noetl' already exists"
            echo "   To rebuild: noetl run automation/main.yaml --payload '{\"target\":\"destroy\"}'"
          else
            echo "INFO No existing cluster found, will create new one"
          fi
    next:
      - step: build_rust_cli
  
  - step: build_rust_cli
    desc: Build Rust CLI binary
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Building Rust CLI..."
          task noetlctl:local:build
    next:
      - step: build_docker_images
  
  - step: build_docker_images
    desc: Build NoETL Docker images
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Building Docker images..."
          # Generate timestamp tag like task does
          IMAGE_TAG=$(date +%Y-%m-%d-%H-%M)
          echo "$IMAGE_TAG" > .noetl_last_build_tag.txt
          echo "Building with tag: $IMAGE_TAG"
          docker build -t {{ workload.registry }}/{{ workload.image_name }}:$IMAGE_TAG -f docker/noetl/dev/Dockerfile .
    next:
      - step: create_kind_cluster
  
  - step: create_kind_cluster
    desc: Create kind cluster if it doesn't exist
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Setting up Kubernetes cluster..."
          if kind get clusters 2>/dev/null | grep -q "^noetl$"; then
            echo "OK Cluster already exists, skipping creation"
          else
            echo "Creating kind cluster..."
            task kind:local:cluster-create
          fi
    next:
      - step: load_image_to_kind
  
  - step: load_image_to_kind
    desc: Load NoETL Docker image into kind cluster
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Loading NoETL image into kind cluster..."
          # Read the tag from the file created during build
          if [ ! -f .noetl_last_build_tag.txt ]; then
            echo "ERROR: .noetl_last_build_tag.txt not found. Build must have failed."
            exit 1
          fi
          IMAGE_TAG=$(cat .noetl_last_build_tag.txt)
          IMAGE="{{ workload.registry }}/{{ workload.image_name }}:$IMAGE_TAG"
          echo "Loading image: $IMAGE"
          kind load docker-image "$IMAGE" --name noetl
    next:
      - step: deploy_postgres
  
  - step: deploy_postgres
    desc: Deploy PostgreSQL to cluster
    tool:
      kind: playbook
      path: ../infrastructure/postgres.yaml
      args:
        action: deploy
    next:
      - step: deploy_noetl
  
  - step: deploy_noetl
    desc: Deploy NoETL server and workers
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Deploying NoETL..."
          # Create namespace first
          kubectl apply -f ci/manifests/noetl/namespace/
          
          # Read the tag from the file created during build
          if [ ! -f .noetl_last_build_tag.txt ]; then
            echo "ERROR: .noetl_last_build_tag.txt not found. Build must have failed."
            exit 1
          fi
          IMAGE_TAG=$(cat .noetl_last_build_tag.txt)
          IMAGE="{{ workload.registry }}/{{ workload.image_name }}:$IMAGE_TAG"
          echo "Using image: $IMAGE"
          
          # Apply manifests with image substitution
          for manifest in ci/manifests/noetl/*.yaml; do
            if [ -f "$manifest" ]; then
              sed "s|{{ workload.registry }}/{{ workload.image_name }}:latest|$IMAGE|g" "$manifest" | kubectl apply -f -
            fi
          done
    next:
      - step: deploy_observability
  
  - step: deploy_observability
    desc: Deploy observability stack (ClickHouse, Qdrant, NATS)
    tool:
      kind: playbook
      path: ../infrastructure/observability.yaml
      args:
        action: activate-all
    next:
      - step: wait_for_services
  
  - step: wait_for_services
    desc: Wait for services to be ready
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Waiting for services to be ready..."
          sleep 15
          
          echo "Waiting for PostgreSQL..."
          kubectl wait --for=condition=ready pod -l app=postgres -n postgres --timeout=60s || true
          
          echo "Waiting for NoETL server..."
          kubectl wait --for=condition=ready pod -l app=noetl-server -n noetl --timeout=60s || true
          
          echo "Waiting for NATS (mandatory)..."
          kubectl wait --for=condition=ready pod -l app=nats -n nats --timeout=120s || echo "ERROR: NATS failed to start - NoETL requires NATS"
          
          echo "Waiting for Qdrant..."
          kubectl wait --for=condition=ready pod -l app=qdrant -n qdrant --timeout=60s || true
          
          echo "Waiting for ClickHouse (optional)..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=chi-clickhouse-clickhouse -n clickhouse --timeout=120s || echo "Warning: ClickHouse not ready"
    next:
      - step: test_cluster_health
  
  - step: test_cluster_health
    desc: Verify cluster health and connectivity
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Testing cluster health..."
          task test:k8s:cluster-health || echo "Warning: Some health checks failed"
    next:
      - step: summary
  
  - step: summary
    desc: Show bootstrap summary
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "=========================================="
          echo "Bootstrap Complete!"
          echo "=========================================="
          echo ""
          echo "Environment Status:"
          echo "  Kind cluster: noetl"
          echo "  PostgreSQL: deployed"
          echo "  NoETL server: deployed"
          echo "  NoETL workers: deployed"
          echo "  Observability: deployed (ClickHouse, Qdrant, NATS)"
          echo ""
          echo "Endpoints:"
          echo "  NoETL API: http://localhost:8082"
          echo "  PostgreSQL: localhost:54321"
          echo "  ClickHouse HTTP: http://localhost:30123"
          echo "  Qdrant: http://localhost:30633"
          echo ""
          echo "Next Steps:"
          echo "  1. Register credentials:"
          echo "     noetl register credential --directory tests/fixtures/credentials"
          echo ""
          echo "  2. Register playbooks:"
          echo "     noetl register playbook --directory tests/fixtures/playbooks"
          echo ""
          echo "  3. Test execution:"
          echo "     noetl execute catalog/test/hello_world"
          echo ""
          echo "  4. Check status:"
          echo "     kubectl get pods -n noetl"
          echo ""
          echo "To destroy:"
          echo "  noetl run automation/main.yaml destroy"
          echo ""
    next:
      - step: end
  
  - step: end
    desc: End bootstrap workflow

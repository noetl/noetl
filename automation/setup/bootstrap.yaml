apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: bootstrap_environment
  path: automation/setup/bootstrap
  description: Complete K8s environment setup with prerequisite validation
executor:
  profile: local
  version: noetl-runtime/1
workload:
  registry: "local"
  image_name: "noetl"
  build_rust_cli: false
  deploy_gateway: true
  kind_config: "ci/kind/config.yaml"
workflow:
  - step: start
    desc: Begin bootstrap process
    tool:
      kind: shell
      cmds:
        - echo "Starting NoETL environment bootstrap..."
    next:
      - step: validate_prerequisites
  
  - step: validate_prerequisites
    desc: Validate required tools are installed
    tool:
      kind: shell
      cmds:
        - |
          echo "Validating prerequisites..."
          echo ""
          
          MISSING=""
          
          # Check noetl binary (required)
          if ! command -v noetl &> /dev/null; then
            echo "FAIL noetl binary not found"
            MISSING="$MISSING noetl"
          else
            echo "OK noetl binary: $(which noetl)"
          fi
          
          # Check Docker (required)
          if ! command -v docker &> /dev/null; then
            echo "FAIL docker not found"
            MISSING="$MISSING docker"
          else
            echo "OK docker: $(docker --version)"
          fi
          
          # Check kind (required)
          if ! command -v kind &> /dev/null; then
            echo "FAIL kind not found"
            MISSING="$MISSING kind"
          else
            echo "OK kind: $(kind version)"
          fi
          
          # Check kubectl (required)
          if ! command -v kubectl &> /dev/null; then
            echo "FAIL kubectl not found"
            MISSING="$MISSING kubectl"
          else
            echo "OK kubectl: $(kubectl version --client --short 2>/dev/null || echo 'installed')"
          fi
          
          # Check task (required)
          if ! command -v task &> /dev/null; then
            echo "FAIL task not found"
            MISSING="$MISSING task"
          else
            echo "OK task: $(task --version)"
          fi
          
          # Check Python (optional but recommended)
          if ! command -v python3 &> /dev/null; then
            echo "WARN python3 not found (optional)"
          else
            echo "OK python3: $(python3 --version)"
          fi
          
          # Check uv (optional for fast Python package management)
          if ! command -v uv &> /dev/null; then
            echo "WARN uv not found (optional, provides faster Python package management)"
          else
            echo "OK uv: $(uv --version)"
          fi
          
          echo ""
          if [ -n "$MISSING" ]; then
            echo "FAIL Missing required tools:$MISSING"
            echo ""
            echo "Install missing tools using NoETL tooling playbooks:"
            echo ""
            echo "  # Auto-detect OS and install all dev tools:"
            echo "  noetl run automation/development/setup_tooling.yaml --set action=install-devtools"
            echo ""
            echo "  # Or use platform-specific playbooks:"
            echo "  # macOS:"
            echo "  noetl run automation/development/tooling_macos.yaml --set action=install-devtools"
            echo ""
            echo "  # Linux/WSL2:"
            echo "  noetl run automation/development/tooling_linux.yaml --set action=install-devtools"
            echo ""
            echo "  # Manual installation:"
            echo "  macOS: brew install docker kind kubectl go-task"
            echo "  Linux: See https://noetl.dev/docs/installation"
            exit 1
          else
            echo "OK All required prerequisites installed"
          fi
    next:
      - step: check_docker_running
  
  - step: check_docker_running
    desc: Verify Docker daemon is running
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Checking Docker daemon..."
          if ! docker info &> /dev/null; then
            echo "FAIL Docker daemon is not running"
            echo "   Start Docker Desktop or run: sudo systemctl start docker"
            exit 1
          else
            echo "OK Docker daemon is running"
          fi
    next:
      - step: check_existing_cluster
  
  - step: check_existing_cluster
    desc: Check if kind cluster already exists
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Checking for existing kind cluster..."
          if kind get clusters 2>/dev/null | grep -q "^noetl$"; then
            echo "OK Kind cluster 'noetl' already exists"
            echo "   To rebuild: noetl run automation/destroy.yaml"
            echo "   # or: noetl run automation/main.yaml --set target=destroy"
          else
            echo "INFO No existing cluster found, will create new one"
          fi
    next:
      - step: maybe_build_rust_cli

  - step: maybe_build_rust_cli
    desc: Build Rust CLI if binary not found or force flag set
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Checking for Rust CLI binary..."
          FORCE_BUILD="{{ workload.build_rust_cli }}"

          # Note: This checks for existing binary to skip long compilation times.
          # Version mismatch is possible if source changed but binary wasn't rebuilt.
          # For guaranteed consistency, use: --set build_rust_cli=true

          if [ "$FORCE_BUILD" = "true" ]; then
            echo "INFO Force build requested via build_rust_cli=true"
            echo "Building Rust CLI (this may take a while)..."
            cargo build --release --manifest-path crates/noetlctl/Cargo.toml
            if [ -f "target/release/noetl" ]; then
              echo "OK noetl CLI built successfully"
              ls -la target/release/noetl
            else
              echo "ERROR noetl CLI build failed"
              exit 1
            fi
          elif [ -f "target/release/noetl" ]; then
            echo "OK noetl binary found at target/release/noetl"
            echo "   To force rebuild: noetl run boot --set build_rust_cli=true"
            ls -la target/release/noetl
          else
            echo "INFO noetl binary not found at target/release/noetl"
            echo "Building Rust CLI (this may take a while)..."
            cargo build --release --manifest-path crates/noetlctl/Cargo.toml
            if [ -f "target/release/noetl" ]; then
              echo "OK noetl CLI built successfully"
              ls -la target/release/noetl
            else
              echo "ERROR noetl CLI build failed"
              exit 1
            fi
          fi
    next:
      - step: build_docker_images
  
  - step: build_docker_images
    desc: Build NoETL Docker images
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Building Docker images..."
          # Generate timestamp tag like task does
          IMAGE_TAG=$(date +%Y-%m-%d-%H-%M)
          echo "$IMAGE_TAG" > .noetl_last_build_tag.txt
          echo "Building with tag: $IMAGE_TAG"
          docker buildx build --load --platform linux/amd64 -t {{ workload.registry }}/{{ workload.image_name }}:$IMAGE_TAG -f docker/noetl/dev/Dockerfile .
    next:
      - step: check_port_conflicts

  - step: check_port_conflicts
    desc: Check for kind port conflicts
    tool:
      kind: shell
      cmds:
        - |
          if [ ! -f "{{ workload.kind_config }}" ]; then
            echo "ERROR: kind config not found: {{ workload.kind_config }}"
            exit 1
          fi
          PORTS=$(grep -E "hostPort:" "{{ workload.kind_config }}" | awk '{print $2}' | tr -d '"')
          IN_USE=""
          for port in $PORTS; do
            if lsof -nP -iTCP:"$port" -sTCP:LISTEN >/dev/null 2>&1; then
              IN_USE="$IN_USE $port"
            fi
          done
          if [ -n "$IN_USE" ]; then
            echo "ERROR: The following host ports are already in use:$IN_USE"
            echo "Stop the processes using those ports or re-run with a reduced mapping set:"
            echo "  --set kind_config=ci/kind/config-minimal.yaml"
            exit 1
          fi
    next:
      - step: create_kind_cluster
  
  - step: create_kind_cluster
    desc: Create kind cluster if it doesn't exist
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Setting up Kubernetes cluster..."
          if kind get clusters 2>/dev/null | grep -q "^noetl$"; then
            echo "OK Cluster already exists, skipping creation"
          else
            echo "Creating kind cluster..."
            kind create cluster --config={{ workload.kind_config }}
          fi
    next:
      - step: load_image_to_kind
  
  - step: load_image_to_kind
    desc: Load NoETL Docker image into kind cluster
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Loading NoETL image into kind cluster..."
          # Read the tag from the file created during build
          if [ ! -f .noetl_last_build_tag.txt ]; then
            echo "ERROR: .noetl_last_build_tag.txt not found. Build must have failed."
            exit 1
          fi
          IMAGE_TAG=$(cat .noetl_last_build_tag.txt)
          IMAGE="{{ workload.registry }}/{{ workload.image_name }}:$IMAGE_TAG"
          echo "Loading image: $IMAGE"
          kind load docker-image "$IMAGE" --name noetl
    next:
      - step: deploy_postgres
  
  - step: deploy_postgres
    desc: Deploy PostgreSQL to cluster
    tool:
      kind: playbook
      path: ../infrastructure/postgres.yaml
      args:
        action: deploy
    next:
      - step: deploy_nats
  
  - step: deploy_nats
    desc: Deploy NATS JetStream (required dependency)
    tool:
      kind: playbook
      path: ../infrastructure/nats.yaml
      args:
        action: deploy
    next:
      - step: deploy_qdrant
  
  - step: deploy_qdrant
    desc: Deploy Qdrant vector database
    tool:
      kind: playbook
      path: ../infrastructure/qdrant.yaml
      args:
        action: deploy
    next:
      - step: deploy_clickhouse
  
  - step: deploy_clickhouse
    desc: Deploy ClickHouse observability stack
    tool:
      kind: playbook
      path: ../infrastructure/clickhouse.yaml
      args:
        action: deploy
    next:
      - step: deploy_monitoring
  
  - step: deploy_monitoring
    desc: Deploy monitoring stack (VictoriaMetrics, Grafana)
    tool:
      kind: playbook
      path: ../infrastructure/monitoring.yaml
      args:
        action: deploy
    next:
      - step: wait_for_dependencies
  
  - step: wait_for_dependencies
    desc: Wait for dependencies to be ready before deploying NoETL
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Waiting for dependencies to be ready..."
          sleep 10
          
          echo "Waiting for PostgreSQL..."
          kubectl wait --for=condition=ready pod -l app=postgres -n postgres --timeout=90s
          
          echo "Waiting for NATS (mandatory)..."
          kubectl wait --for=condition=ready pod -l app=nats -n nats --timeout=120s || echo "ERROR: NATS failed to start - NoETL requires NATS"
          
          echo "Waiting for Qdrant..."
          kubectl wait --for=condition=ready pod -l app=qdrant -n qdrant --timeout=90s || true
          
          echo "âœ“ Dependencies ready. Proceeding with NoETL deployment..."
    next:
      - step: deploy_test_server
  
  - step: deploy_test_server
    desc: Deploy pagination test server for integration tests
    tool:
      kind: playbook
      path: ../test/pagination-server.yaml
      args:
        action: full
    next:
      - step: maybe_deploy_gateway

  - step: maybe_deploy_gateway
    desc: Deploy Gateway only when requested
    tool:
      kind: shell
      cmds:
        - |
          echo "Deploy Gateway flag: {{ workload.deploy_gateway }}"
    case:
      - when: "{{ workload.deploy_gateway }} == true"
        then:
          - step: deploy_gateway
      - when: "true"
        then:
          - step: deploy_noetl
  
  - step: deploy_gateway
    desc: Deploy NoETL Gateway API
    tool:
      kind: playbook
      path: ../infrastructure/gateway.yaml
      args:
        action: deploy
    next:
      - step: deploy_noetl
  
  - step: deploy_noetl
    desc: Deploy NoETL server and workers
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Deploying NoETL..."
          # Create namespace first
          kubectl apply -f ci/manifests/noetl/namespace/
          
          # Read the tag from the file created during build
          if [ ! -f .noetl_last_build_tag.txt ]; then
            echo "ERROR: .noetl_last_build_tag.txt not found. Build must have failed."
            exit 1
          fi
          IMAGE_TAG=$(cat .noetl_last_build_tag.txt)
          IMAGE="{{ workload.registry }}/{{ workload.image_name }}:$IMAGE_TAG"
          echo "Using image: $IMAGE"
          
          # Apply manifests with image substitution
          for manifest in ci/manifests/noetl/*.yaml; do
            if [ -f "$manifest" ]; then
              sed "s|image_name:image_tag|$IMAGE|g" "$manifest" | kubectl apply -f -
            fi
          done
    next:
      - step: wait_for_services
  
  - step: wait_for_services
    desc: Wait for NoETL and optional services
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Waiting for NoETL services to be ready..."
          sleep 10
          
          echo "Waiting for NoETL server..."
          kubectl wait --for=condition=ready pod -l app=noetl-server -n noetl --timeout=90s || echo "Warning: NoETL server not ready"
          
          echo "Waiting for NoETL workers..."
          kubectl wait --for=condition=ready pod -l app=noetl-worker -n noetl --timeout=90s || echo "Warning: NoETL workers not ready"
          
          echo "Waiting for ClickHouse (optional)..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=chi-clickhouse-clickhouse -n clickhouse --timeout=120s || echo "Warning: ClickHouse not ready"
          
          echo "Waiting for VictoriaMetrics operator..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=victoria-metrics-operator -n vmoperator --timeout=60s || true
          
          echo "Waiting for VictoriaMetrics cluster..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=vmsingle -n vmstack --timeout=90s || echo "Warning: VictoriaMetrics not ready"
    next:
      - step: test_cluster_health
  
  - step: test_cluster_health
    desc: Verify cluster health and connectivity
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Testing cluster health..."
          kubectl config use-context kind-noetl
          echo "=== Checking NoETL server health ==="
          curl -f http://localhost:8082/api/health || echo "NoETL server not ready"
          echo "\n=== Checking PostgreSQL connection ==="
          kubectl exec deployment/postgres -n postgres -- pg_isready -h localhost -p 5432 -U demo
          echo "\n=== Checking services ==="
          kubectl get svc -A | grep -E "noetl|postgres"
    next:
      - step: summary
  
  - step: summary
    desc: Show bootstrap summary
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "=========================================="
          echo "Bootstrap Complete!"
          echo "=========================================="
          echo ""
          echo "Environment Status:"
          echo "  Kind cluster: noetl"
          echo "  PostgreSQL: deployed"
          echo "  NoETL server: deployed"
          echo "  NoETL workers: deployed"
          echo "  Gateway: deployed (Rust API)"
          echo "  Observability: deployed (ClickHouse, Qdrant, NATS)"
          echo "  Monitoring: deployed (VictoriaMetrics, Grafana)"
          echo "  Test Server: deployed (Pagination API)"
          echo ""
          echo "Endpoints:"
          echo "  NoETL API: http://localhost:8082"
          echo "  Gateway API: http://localhost:8080"
          echo "  PostgreSQL: localhost:54321"
          echo "  Grafana: http://localhost:3000"
          echo "  VictoriaLogs: http://localhost:9428"
          echo "  ClickHouse HTTP: http://localhost:30123"
          echo "  ClickHouse Native: localhost:30900"
          echo "  Qdrant HTTP: http://localhost:30633"
          echo "  Qdrant gRPC: localhost:30634"
          echo "  NATS Client: localhost:30422"
          echo "  NATS Monitoring: http://localhost:30822"
          echo "  Test Server: http://localhost:30555"
          echo ""
          echo "Next Steps:"
          echo "  1. Register credentials:"
          echo "     noetl register credential --directory tests/fixtures/credentials"
          echo ""
          echo "  2. Register playbooks:"
          echo "     noetl register playbook --directory tests/fixtures/playbooks"
          echo ""
          echo "  3. Test execution:"
          echo "     noetl execute catalog/test/hello_world"
          echo ""
          echo "  4. Check status:"
          echo "     kubectl get pods -n noetl"
          echo ""
          echo "To destroy:"
          echo "  noetl run automation/main.yaml destroy"
          echo ""
    next:
      - step: end
  
  - step: end
    desc: End bootstrap workflow

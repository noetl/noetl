apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: gateway_automation
  path: automation/infrastructure/gateway

executor:
  profile: local
  version: noetl-runtime/1
workload:
  action: help  # build-image, load-image, deploy, deploy-all, remove, redeploy, restart, status, logs, test

workflow:
  - step: start
    desc: Entry point for Gateway automation
    tool:
      kind: shell
      cmds:
        - echo "Gateway Automation - Action '{{ workload.action }}'"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: build_image
          when: "{{ workload.action == 'build-image' }}"
        - step: load_image
          when: "{{ workload.action == 'load-image' }}"
        - step: deploy_gateway
          when: "{{ workload.action == 'deploy' }}"
        - step: deploy_all
          when: "{{ workload.action == 'deploy-all' }}"
        - step: remove_gateway
          when: "{{ workload.action == 'remove' }}"
        - step: redeploy_gateway
          when: "{{ workload.action == 'redeploy' }}"
        - step: restart_gateway
          when: "{{ workload.action == 'restart' }}"
        - step: check_status
          when: "{{ workload.action == 'status' }}"
        - step: view_logs
          when: "{{ workload.action == 'logs' }}"
        - step: test_gateway
          when: "{{ workload.action == 'test' }}"
        - step: show_help
          when: "{{ workload.action == 'help' }}"
        - step: show_help

  - step: build_image
    desc: Build Gateway Docker image and load into kind
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Building Gateway Docker image..."
          docker buildx build --load --platform linux/amd64 -t noetl-gateway:latest -f crates/gateway/Dockerfile crates/gateway
          echo "Loading Gateway image into kind cluster..."
          kind load docker-image noetl-gateway:latest --name noetl
          echo "Gateway image built and loaded into kind cluster"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: load_image
    desc: Load Gateway image into kind cluster
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Loading Gateway image into kind cluster..."
          if docker image inspect noetl-gateway:latest >/dev/null 2>&1; then
            kind load docker-image noetl-gateway:latest --name noetl
            echo "Gateway image loaded successfully"
          else
            echo "ERROR: noetl-gateway:latest image not found in Docker"
            echo "Build the image first with: noetl run automation/infrastructure/gateway.yaml --set action=build-image"
            exit 1
          fi
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: deploy_gateway
    desc: Deploy Gateway API to Kubernetes
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Deploying Gateway API to Kubernetes..."
          kubectl apply -f ci/manifests/gateway/namespace.yaml
          kubectl apply -f ci/manifests/gateway/deployment.yaml
          kubectl apply -f ci/manifests/gateway/service.yaml
          echo "Gateway API deployed at http://localhost:8090"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: deploy_all
    desc: Build and deploy Gateway API and UI to Kubernetes
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Building and deploying Gateway API and UI..."
          docker buildx build --load --platform linux/amd64 -t noetl-gateway:latest -f crates/gateway/Dockerfile crates/gateway
          kind load docker-image noetl-gateway:latest --name noetl
          kubectl apply -f ci/manifests/gateway/namespace.yaml
          kubectl apply -f ci/manifests/gateway/deployment.yaml
          kubectl apply -f ci/manifests/gateway/service.yaml
          echo "Gateway API deployed at http://localhost:8090"
          kubectl apply -f ci/manifests/gateway/configmap-ui.yaml
          kubectl apply -f ci/manifests/gateway/configmap-ui-files.yaml
          kubectl apply -f ci/manifests/gateway/deployment-ui.yaml
          kubectl apply -f ci/manifests/gateway/service-ui.yaml
          echo "Gateway UI deployed at http://localhost:8080"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: remove_gateway
    desc: Remove Gateway from Kubernetes
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Removing Gateway from Kubernetes..."
          kubectl delete namespace gateway --ignore-not-found=true
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: redeploy_gateway
    desc: Rebuild and redeploy Gateway
    tool:
      kind: shell
      cmds:
        - echo ""
        - echo "Rebuilding Gateway image..."
        - docker buildx build --progress=plain --load --platform linux/amd64 -t noetl-gateway:latest -f crates/gateway/Dockerfile crates/gateway
        - echo "Loading into kind cluster..."
        - kind load docker-image noetl-gateway:latest --name noetl
        - echo "Restarting deployment..."
        - kubectl rollout restart deployment/gateway -n gateway
        - kubectl rollout status deployment/gateway -n gateway --timeout=60s
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: restart_gateway
    desc: Restart Gateway pods
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Restarting Gateway pods..."
          kubectl rollout restart deployment/gateway -n gateway
          kubectl rollout restart deployment/gateway-ui -n gateway
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: check_status
    desc: Check Gateway deployment status
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Gateway Deployment Status:"
          echo "=========================="
          kubectl get all -n gateway
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: view_logs
    desc: Show Gateway logs
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Gateway Logs:"
          echo "============="
          kubectl logs -n gateway -l app=gateway --tail=100 -f
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: test_gateway
    desc: Test Gateway endpoints
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "Testing Gateway endpoints..."
          curl -s http://localhost:8090/graphql | head -20 || echo "Gateway not responding"
          curl -s http://localhost:8080/health || echo "Gateway UI not responding"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: show_help
    desc: Display available actions
    tool:
      kind: shell
      cmds:
        - |
          echo "=================================================="
          echo " Gateway API Automation"
          echo "=================================================="
          echo ""
          echo "Usage:"
          echo "  noetl run automation/infrastructure/gateway.yaml --set action=<action>"
          echo ""
          echo "Build & Deployment:"
          echo "  build-image - Build Gateway Docker image and load into kind"
          echo "  build-image - Build Gateway Docker image and load into kind"
          echo "  load-image  - Load existing Gateway image into kind cluster"
          echo "  deploy      - Deploy Gateway API to Kubernetes"
          echo "  deploy-all  - Build and deploy Gateway API and UI"
          echo "  remove      - Remove Gateway from Kubernetes"
          echo "  redeploy    - Rebuild and redeploy Gateway"
          echo ""
          echo "Operations:"
          echo "  restart     - Restart Gateway pods"
          echo "  status      - Check deployment status"
          echo "  logs        - Show Gateway logs"
          echo "  test        - Test Gateway endpoints"
          echo ""
          echo "Examples:"
          echo "  # Build and deploy everything"
          echo "  noetl run automation/infrastructure/gateway.yaml --set action=deploy-all"
          echo ""
          echo "  # Check status"
          echo "  noetl run automation/infrastructure/gateway.yaml --set action=status"
          echo ""
          echo "  # Rebuild and redeploy"
          echo "  noetl run automation/infrastructure/gateway.yaml --set action=redeploy"
          echo ""
          echo "  # View logs"
          echo "  noetl run automation/infrastructure/gateway.yaml --set action=logs"
          echo ""
          echo "  # Test endpoints"
          echo "  noetl run automation/infrastructure/gateway.yaml --set action=test"
          echo ""
          echo "Gateway Location: crates/gateway"
          echo ""
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: End workflow
    tool:
      kind: noop

apiVersion: noetl.io/v1
kind: Playbook

metadata:
  name: postgres_save_simple2
  path: examples/test/postgres_save_simple2

workload:
  message: "Hello Save"

workflow:
  - step: start
    desc: "Start Postgres Save Demo"
    next:
      - step: create_table

  - step: create_table
    desc: "Ensure target table exists"
    type: postgres
    auth:
      pg:
        type: postgres
        key: pg_local
    command: |
      CREATE TABLE IF NOT EXISTS public.postgres_save_demo (
        id TEXT PRIMARY KEY,
        message TEXT,
        created_at TIMESTAMPTZ DEFAULT now()
      );
    next:
      - step: save_row

  - step: save_row
    desc: "Save one row via save(plugin=postgres)"
    type: save
    storage: postgres
    auth:
      pg:
        type: postgres
        key: pg_local
    table: public.postgres_save_demo
    mode: upsert
    key: id
    data:
      id: "{{ execution_id }}"
      message: "{{ workload.message }}"
    next:
      - step: end

  - step: end
    desc: "Finalize"
    result:
      status: "ok"
      saved: "{{ save_row.result.saved }}"
      table: "{{ save_row.result.table }}"
      message: "{{ workload.message }}"

apiVersion: noetl.io/v1
kind: Playbook

metadata:
  name: postgres_save_simple
  path: examples/test/postgres_save_simple

workload:
  pg_host: "{{ env.POSTGRES_HOST | default('localhost') }}"
  pg_port: "{{ env.POSTGRES_PORT | default('5432') }}"
  pg_user: "{{ env.POSTGRES_USER | default('demo') }}"
  pg_password: "{{ env.POSTGRES_PASSWORD | default('demo') }}"
  pg_db: "{{ env.POSTGRES_DB | default('demo_noetl') }}"
  message: "Hello Save"

workflow:
  - step: start
    desc: "Start Postgres Save Demo"
    next:
      - step: create_table

  - name: get_data
    type: postgres
    auth:
      pg:
        type: postgres
        key: pg_local
    command: |
      CREATE TABLE IF NOT EXISTS public.postgres_save_demo (
        id TEXT PRIMARY KEY,
        message TEXT,
        created_at TIMESTAMPTZ DEFAULT now()
      );
    next:
      - step: save_row

  - step: save_row
    desc: "Save one row via save(plugin=postgres)"
    type: save
    save:
      storage:
        kind: postgres
        auth:
          pg:
            type: postgres
            key: pg_local
      table: public.postgres_save_demo
      mode: upsert
      key: id
      data:
        id: "{{ execution_id }}"
        message: "{{ workload.message }}"
    next:
      - step: end

  - step: end
    desc: "Finalize"
    result:
      status: "ok"
      saved: "{{ save_row.saved }}"
      table: "{{ save_row.table }}"
      message: "{{ workload.message }}"

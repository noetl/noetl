{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://noetl.io/schemas/playbook.v2.schema.json",
    "title": "NoETL Playbook (Widget-based v2)",
    "type": "object",
    "required": [
        "apiVersion",
        "kind",
        "name",
        "path",
        "workflow"
    ],
    "properties": {
        "apiVersion": {
            "const": "noetl.io/v1"
        },
        "kind": {
            "const": "Playbook"
        },
        "name": {
            "type": "string"
        },
        "path": {
            "type": "string"
        },
        "environment": {
            "type": "object",
            "additionalProperties": true
        },
        "context": {
            "type": "object",
            "additionalProperties": true
        },
        "workbook": {
            "type": "array",
            "items": {
                "$ref": "#/$defs/task"
            }
        },
        "workflow": {
            "type": "array",
            "items": {
                "$ref": "#/$defs/step"
            },
            "minItems": 1
        }
    },
    "$defs": {
        "identifier": {
            "type": "string",
            "pattern": "^[A-Za-z_][A-Za-z0-9_-]*$"
        },
        "nextRef": {
            "oneOf": [
                {
                    "type": "string"
                },
                {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "minItems": 1
                }
            ]
        },
        "step": {
            "type": "object",
            "required": [
                "step",
                "type"
            ],
            "properties": {
                "step": {
                    "$ref": "#/$defs/identifier"
                },
                "type": {
                    "type": "string",
                    "enum": [
                        "start",
                        "end",
                        "workbook",
                        "python",
                        "http",
                        "duckdb",
                        "postgres",
                        "secrets",
                        "playbooks",
                        "loop"
                    ]
                },
                "desc": {
                    "type": "string"
                },
                "next": {
                    "$ref": "#/$defs/nextRef"
                },
                "with": {
                    "type": "object",
                    "additionalProperties": true
                },
                "as": {
                    "$ref": "#/$defs/identifier"
                },
                "task": {
                    "type": "string"
                },
                "code": {
                    "type": "string"
                },
                "method": {
                    "type": "string",
                    "enum": [
                        "GET",
                        "POST",
                        "PUT",
                        "DELETE",
                        "PATCH"
                    ]
                },
                "endpoint": {
                    "type": "string"
                },
                "headers": {
                    "type": "object",
                    "additionalProperties": true
                },
                "params": {
                    "type": "object",
                    "additionalProperties": true
                },
                "body": {},
                "timeout": {
                    "type": "number"
                },
                "verify": {
                    "type": "boolean"
                },
                "script": {
                    "type": "string"
                },
                "files": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "sql": {
                    "type": "string"
                },
                "connection": {
                    "type": "string"
                },
                "db_host": {
                    "type": "string"
                },
                "db_port": {
                    "type": "integer"
                },
                "db_user": {
                    "type": "string"
                },
                "db_password": {
                    "type": "string"
                },
                "db_name": {
                    "type": "string"
                },
                "db_schema": {
                    "type": "string"
                },
                "provider": {
                    "type": "string",
                    "enum": [
                        "gcp",
                        "aws",
                        "azure",
                        "vault",
                        "env"
                    ]
                },
                "name": {
                    "type": "string"
                },
                "project": {
                    "type": "string"
                },
                "version": {
                    "oneOf": [
                        {
                            "type": "string"
                        },
                        {
                            "type": "number"
                        }
                    ]
                },
                "catalog_path": {
                    "type": "string"
                },
                "parallel": {
                    "type": "boolean"
                },
                "mode": {
                    "type": "string",
                    "enum": [
                        "workbook",
                        "playbooks"
                    ]
                },
                "in": {
                    "oneOf": [
                        {
                            "type": "array"
                        },
                        {
                            "type": "string"
                        }
                    ]
                },
                "iterator": {
                    "$ref": "#/$defs/identifier"
                }
            },
            "allOf": [
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "start"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "next"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "end"
                            }
                        }
                    },
                    "then": {
                        "not": {
                            "required": [
                                "next"
                            ]
                        }
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "workbook"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "task"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "python"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "code"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "http"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "method",
                            "endpoint"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "duckdb"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "script"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "postgres"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "sql"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "secrets"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "provider",
                            "name"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "playbooks"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "catalog_path"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "loop"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "mode",
                            "in",
                            "iterator"
                        ],
                        "allOf": [
                            {
                                "if": {
                                    "properties": {
                                        "mode": {
                                            "const": "workbook"
                                        }
                                    }
                                },
                                "then": {
                                    "required": [
                                        "task"
                                    ]
                                }
                            },
                            {
                                "if": {
                                    "properties": {
                                        "mode": {
                                            "const": "playbooks"
                                        }
                                    }
                                },
                                "then": {
                                    "required": [
                                        "catalog_path"
                                    ]
                                }
                            }
                        ]
                    }
                }
            ],
            "additionalProperties": false
        },
        "task": {
            "type": "object",
            "required": [
                "task",
                "type"
            ],
            "properties": {
                "task": {
                    "$ref": "#/$defs/identifier"
                },
                "type": {
                    "type": "string",
                    "enum": [
                        "python",
                        "http",
                        "runner",
                        "duckdb",
                        "postgres",
                        "secrets"
                    ]
                },
                "desc": {
                    "type": "string"
                },
                "code": {
                    "type": "string"
                },
                "method": {
                    "type": "string",
                    "enum": [
                        "GET",
                        "POST",
                        "PUT",
                        "DELETE",
                        "PATCH"
                    ]
                },
                "endpoint": {
                    "type": "string"
                },
                "params": {
                    "type": "object",
                    "additionalProperties": true
                },
                "headers": {
                    "type": "object",
                    "additionalProperties": true
                },
                "body": {},
                "timeout": {
                    "type": "number"
                },
                "verify": {
                    "type": "boolean"
                },
                "script": {
                    "type": "string"
                },
                "files": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "sql": {
                    "type": "string"
                },
                "connection": {
                    "type": "string"
                },
                "db_host": {
                    "type": "string"
                },
                "db_port": {
                    "type": "integer"
                },
                "db_user": {
                    "type": "string"
                },
                "db_password": {
                    "type": "string"
                },
                "db_name": {
                    "type": "string"
                },
                "db_schema": {
                    "type": "string"
                },
                "provider": {
                    "type": "string",
                    "enum": [
                        "gcp",
                        "aws",
                        "azure",
                        "vault",
                        "env"
                    ]
                },
                "name": {
                    "type": "string"
                },
                "project": {
                    "type": "string"
                },
                "version": {
                    "oneOf": [
                        {
                            "type": "string"
                        },
                        {
                            "type": "number"
                        }
                    ]
                }
            },
            "additionalProperties": true
        }
    }
}
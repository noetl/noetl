# ClickStack Observability Schema
# Schema for NoETL observability data in ClickHouse
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: clickhouse-observability-schema
  namespace: clickhouse
data:
  init.sql: |
    -- ============================================================================
    -- NoETL Observability Schema for ClickHouse
    -- ClickStack observability tables for logs, metrics, and traces
    -- https://clickhouse.com/use-cases/observability
    -- ============================================================================
    
    -- Create observability database
    CREATE DATABASE IF NOT EXISTS observability;
    
    -- ============================================================================
    -- LOGS TABLE (OpenTelemetry format)
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS observability.logs
    (
        Timestamp DateTime64(9) CODEC(Delta, ZSTD(1)),
        TimestampNanos UInt32 CODEC(ZSTD(1)),
        TraceId String CODEC(ZSTD(1)),
        SpanId String CODEC(ZSTD(1)),
        TraceFlags UInt32 CODEC(ZSTD(1)),
        SeverityText LowCardinality(String) CODEC(ZSTD(1)),
        SeverityNumber UInt8 CODEC(ZSTD(1)),
        ServiceName LowCardinality(String) CODEC(ZSTD(1)),
        Body String CODEC(ZSTD(1)),
        ResourceAttributes Map(LowCardinality(String), String) CODEC(ZSTD(1)),
        LogAttributes Map(LowCardinality(String), String) CODEC(ZSTD(1)),
        INDEX idx_trace_id TraceId TYPE bloom_filter(0.001) GRANULARITY 1,
        INDEX idx_severity SeverityText TYPE set(25) GRANULARITY 4,
        INDEX idx_service ServiceName TYPE set(100) GRANULARITY 4
    )
    ENGINE = MergeTree
    PARTITION BY toDate(Timestamp)
    ORDER BY (ServiceName, SeverityText, toUnixTimestamp(Timestamp), TraceId)
    TTL toDateTime(Timestamp) + INTERVAL 30 DAY
    SETTINGS index_granularity = 8192, ttl_only_drop_parts = 1;
    
    -- ============================================================================
    -- METRICS TABLE (OpenTelemetry format)
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS observability.metrics
    (
        Timestamp DateTime64(9) CODEC(Delta, ZSTD(1)),
        TimestampNanos UInt32 CODEC(ZSTD(1)),
        MetricName LowCardinality(String) CODEC(ZSTD(1)),
        MetricType Enum8('Gauge' = 1, 'Sum' = 2, 'Histogram' = 3, 'Summary' = 4) CODEC(ZSTD(1)),
        ServiceName LowCardinality(String) CODEC(ZSTD(1)),
        Value Float64 CODEC(ZSTD(1)),
        Attributes Map(LowCardinality(String), String) CODEC(ZSTD(1)),
        ResourceAttributes Map(LowCardinality(String), String) CODEC(ZSTD(1)),
        INDEX idx_metric_name MetricName TYPE set(1000) GRANULARITY 4,
        INDEX idx_service ServiceName TYPE set(100) GRANULARITY 4
    )
    ENGINE = MergeTree
    PARTITION BY toDate(Timestamp)
    ORDER BY (ServiceName, MetricName, toUnixTimestamp(Timestamp))
    TTL toDateTime(Timestamp) + INTERVAL 90 DAY
    SETTINGS index_granularity = 8192, ttl_only_drop_parts = 1;
    
    -- ============================================================================
    -- TRACES TABLE (OpenTelemetry format)
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS observability.traces
    (
        Timestamp DateTime64(9) CODEC(Delta, ZSTD(1)),
        TimestampNanos UInt32 CODEC(ZSTD(1)),
        TraceId String CODEC(ZSTD(1)),
        SpanId String CODEC(ZSTD(1)),
        ParentSpanId String CODEC(ZSTD(1)),
        TraceState String CODEC(ZSTD(1)),
        SpanName LowCardinality(String) CODEC(ZSTD(1)),
        SpanKind Enum8('UNSPECIFIED' = 0, 'INTERNAL' = 1, 'SERVER' = 2, 'CLIENT' = 3, 'PRODUCER' = 4, 'CONSUMER' = 5) CODEC(ZSTD(1)),
        ServiceName LowCardinality(String) CODEC(ZSTD(1)),
        Duration UInt64 CODEC(ZSTD(1)),
        StatusCode Enum8('UNSET' = 0, 'OK' = 1, 'ERROR' = 2) CODEC(ZSTD(1)),
        StatusMessage String CODEC(ZSTD(1)),
        SpanAttributes Map(LowCardinality(String), String) CODEC(ZSTD(1)),
        ResourceAttributes Map(LowCardinality(String), String) CODEC(ZSTD(1)),
        Events Nested(
            Timestamp DateTime64(9),
            Name LowCardinality(String),
            Attributes Map(LowCardinality(String), String)
        ) CODEC(ZSTD(1)),
        Links Nested(
            TraceId String,
            SpanId String,
            TraceState String,
            Attributes Map(LowCardinality(String), String)
        ) CODEC(ZSTD(1)),
        INDEX idx_trace_id TraceId TYPE bloom_filter(0.001) GRANULARITY 1,
        INDEX idx_span_name SpanName TYPE set(1000) GRANULARITY 4,
        INDEX idx_service ServiceName TYPE set(100) GRANULARITY 4,
        INDEX idx_duration Duration TYPE minmax GRANULARITY 1
    )
    ENGINE = MergeTree
    PARTITION BY toDate(Timestamp)
    ORDER BY (ServiceName, SpanName, toUnixTimestamp(Timestamp), TraceId)
    TTL toDateTime(Timestamp) + INTERVAL 30 DAY
    SETTINGS index_granularity = 8192, ttl_only_drop_parts = 1;
    
    -- ============================================================================
    -- NOETL EVENTS TABLE (NoETL-specific events)
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS observability.noetl_events
    (
        Timestamp DateTime64(9) CODEC(Delta, ZSTD(1)),
        EventId String CODEC(ZSTD(1)),
        ExecutionId String CODEC(ZSTD(1)),
        EventType LowCardinality(String) CODEC(ZSTD(1)),
        Status LowCardinality(String) CODEC(ZSTD(1)),
        StepName LowCardinality(String) CODEC(ZSTD(1)),
        NodeName LowCardinality(String) CODEC(ZSTD(1)),
        PlaybookPath String CODEC(ZSTD(1)),
        Duration UInt64 CODEC(ZSTD(1)),
        ErrorMessage String CODEC(ZSTD(1)),
        Metadata Map(LowCardinality(String), String) CODEC(ZSTD(1)),
        INDEX idx_event_id EventId TYPE bloom_filter(0.001) GRANULARITY 1,
        INDEX idx_execution_id ExecutionId TYPE bloom_filter(0.001) GRANULARITY 1,
        INDEX idx_event_type EventType TYPE set(50) GRANULARITY 4,
        INDEX idx_status Status TYPE set(10) GRANULARITY 4
    )
    ENGINE = MergeTree
    PARTITION BY toDate(Timestamp)
    ORDER BY (EventType, Status, toUnixTimestamp(Timestamp), ExecutionId)
    TTL toDateTime(Timestamp) + INTERVAL 90 DAY
    SETTINGS index_granularity = 8192, ttl_only_drop_parts = 1;
    
    -- ============================================================================
    -- MATERIALIZED VIEWS FOR ANALYTICS
    -- ============================================================================
    
    -- Error rate by service
    CREATE MATERIALIZED VIEW IF NOT EXISTS observability.error_rate_by_service
    ENGINE = SummingMergeTree()
    PARTITION BY toDate(Timestamp)
    ORDER BY (ServiceName, toStartOfHour(Timestamp))
    POPULATE
    AS SELECT
        toStartOfHour(Timestamp) AS Timestamp,
        ServiceName,
        countIf(SeverityNumber >= 17) AS ErrorCount,
        count() AS TotalCount
    FROM observability.logs
    GROUP BY Timestamp, ServiceName;
    
    -- Average duration by span
    CREATE MATERIALIZED VIEW IF NOT EXISTS observability.avg_duration_by_span
    ENGINE = AggregatingMergeTree()
    PARTITION BY toDate(Timestamp)
    ORDER BY (ServiceName, SpanName, toStartOfMinute(Timestamp))
    POPULATE
    AS SELECT
        toStartOfMinute(Timestamp) AS Timestamp,
        ServiceName,
        SpanName,
        avgState(Duration) AS AvgDuration,
        maxState(Duration) AS MaxDuration,
        minState(Duration) AS MinDuration
    FROM observability.traces
    GROUP BY Timestamp, ServiceName, SpanName;
    
    -- NoETL execution statistics
    CREATE MATERIALIZED VIEW IF NOT EXISTS observability.noetl_execution_stats
    ENGINE = SummingMergeTree()
    PARTITION BY toDate(Timestamp)
    ORDER BY (EventType, Status, toStartOfHour(Timestamp))
    POPULATE
    AS SELECT
        toStartOfHour(Timestamp) AS Timestamp,
        EventType,
        Status,
        count() AS EventCount,
        avg(Duration) AS AvgDuration,
        max(Duration) AS MaxDuration
    FROM observability.noetl_events
    GROUP BY Timestamp, EventType, Status;
    
    -- Grant permissions
    GRANT ALL ON observability.* TO default;
    GRANT ALL ON observability.* TO admin;

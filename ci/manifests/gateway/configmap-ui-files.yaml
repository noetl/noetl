apiVersion: v1
data:
  README.md: "# Gateway UI Test Fixtures\n\nStatic UI files for testing the NoETL
    Gateway authentication and GraphQL integration.\n\n## Files\n\n- `index.html`
    - Main application page (flight search demo)\n- `login.html` - Authentication
    login page\n- `app.js` - Main application logic with GraphQL integration\n- `auth.js`
    - Authentication utilities (session management, token validation)\n- `styles.css`
    - Shared styles for UI\n\n## Features\n\n- \U0001F510 Auth0 authentication integration\n-
    \U0001F3A8 Beautiful gradient design (purple/blue theme)\n- \U0001F4AC Real-time
    chat interface with typing indicators\n- ✈️ Flight search with Amadeus AI API\n-
    \U0001F4F1 Fully responsive (mobile and desktop)\n- \U0001F3AD Smooth animations
    and transitions\n- ⚡ GraphQL integration with error handling\n- \U0001F512 Session-based
    access control\n\n## How It Works\n\nThese are **pure static files** (HTML/JS/CSS)
    that connect to the Gateway API via JavaScript fetch calls.\n\nThe JavaScript
    files make HTTP requests to:\n- `http://localhost:8090/api/auth/*` - Authentication
    endpoints\n- `http://localhost:8090/graphql` - GraphQL endpoint\n\n**You can serve
    these files any way you want:**\n\n### Local Development Options\n\n**Option 1:
    Python (Quick & Easy)**\n```bash\ncd tests/fixtures/gateway_ui\npython3 -m http.server
    8080\n```\n\n**Option 2: Node.js**\n```bash\nnpx http-server -p 8080 --cors\n```\n\nThe
    UI connects to the Gateway API. Update these URLs if needed:\n\n**For local development
    with different ports:**\n\nIn `auth.js`:\n```javascript\n// Change this if gateway
    is on different port/host\nconst API_BASE = 'http://localhost:8090'; // Gateway
    API URL\n```\n\nIn `app.js`:\n```javascript\n// Uses authenticatedGraphQL from
    auth.js which calls ${API_BASE}/graphql\n```\n\n**For production:**\n```javascript\nconst
    API_BASE = 'https://api.yourdomain.com'; // Your production gateway\n```\n\nThe
    HTML/JS files are **completely separate** from the gateway - they're just a frontend
    that makes API calls.n tests/fixtures/gateway_ui/login.html\n# or double-click
    login.html in Finder\n```\n⚠️ Note: Opening as `file://` may cause CORS issues.
    Use HTTP server for full functionality.\n\n### Production Deployment\n\nIn production,
    serve these files with:\n- **Nginx** - Standard web server\n- **Apache** - Traditional
    web server  \n- **CDN** - CloudFront, Cloudflare, Fastly\n- **Object Storage**
    - S3 + CloudFront, GCS, Azure Blob\n- **Vercel/Netlify** - Serverless static hosting\n\nThen
    update `env.js` to point to your gateway URL.\n\n## Configuration\n\nThe Gateway
    UI uses `env.js` for environment-specific configuration. It automatically detects
    your environment:\n\n| Environment | Gateway URL | Detection |\n|-------------|-------------|-----------|\n|
    **local** | `http://localhost:8080` | Default for localhost |\n| **kind** | `http://localhost:30080`
    | Port >= 30000 (NodePort) |\n| **gke** | `https://gateway.mestumre.dev` | mestumre.dev
    or noetl.io hostname |\n\n### Manual Override\n\nOverride the environment via
    URL parameter:\n```\nhttp://localhost:8090/login.html?env=kind\nhttp://localhost:8090/login.html?env=gke\nhttp://localhost:8090/login.html?env=local\n```\n\n###
    Custom Configuration\n\nEdit `env.js` to add custom environments or change defaults:\n```javascript\nconst
    configs = {\n  local: {\n    name: 'Local Development',\n    gatewayUrl: 'http://localhost:8080',
    \ // Change port here\n  },\n  kind: {\n    name: 'Kind Kubernetes Cluster',\n
    \   gatewayUrl: 'http://localhost:30080', // Kind NodePort\n  },\n  gke: {\n    name:
    'GKE Production',\n    gatewayUrl: 'https://gateway.mestumre.dev',  // Or your
    domain\n  }\n};\n```\n\n## Gateway Integration\n\nThe UI communicates with these
    Gateway endpoints:\n\n- `POST /api/auth/login` - Auth0 login\n- `POST /api/auth/validate`
    - Session validation\n- `POST /api/auth/check-access` - Permission checking\n-
    `POST /graphql` - Protected GraphQL endpoint (requires authentication)\n\n###
    Session Caching with NATS K/V\n\nThe Gateway uses NATS K/V as a fast session cache
    to avoid calling NoETL playbooks for every request:\n\n```\n┌─────────┐     ┌─────────┐
    \    ┌──────────────┐     ┌──────────┐\n│   UI    │────▶│ Gateway │────▶│ NATS
    K/V     │     │ NoETL    │\n└─────────┘     └────┬────┘     │ (sessions)   │     │
    Server   │\n                     │          └──────────────┘     └──────────┘\n
    \                    │                 │                   │\n                     │
    \ 1. Check cache │                   │\n                     │◀────────────────│
    \                  │\n                     │                                     │\n
    \                    │  2. Cache miss? Call playbook       │\n                     │─────────────────────────────────────▶\n```\n\n**Flow:**\n1.
    **Login:** Gateway calls `auth0_login` playbook → creates session in Postgres
    + NATS K/V cache\n2. **Subsequent requests:** Gateway checks NATS K/V directly
    (sub-millisecond)\n3. **Cache miss:** Gateway calls `auth0_validate_session` →
    refreshes NATS K/V cache\n\nThis provides fast session lookups while keeping Postgres
    as the source of truth.\n\n## Testing Flow\n\n### Local Development\n1. **Start
    Gateway**: `cd crates/gateway && cargo run --release`\n2. **Start UI server**:
    `cd tests/fixtures/gateway_ui && python3 -m http.server 8090`\n3. **Open browser**:
    `http://localhost:8090/login.html`\n4. **Login**: Use Auth0 token or test session
    token\n\n### Kind Kubernetes Cluster\n1. **Deploy to Kind**: See documentation/docs/development/kind_kubernetes.md\n2.
    **Start UI server**: `cd tests/fixtures/gateway_ui && python3 -m http.server 8090`\n3.
    **Open browser**: `http://localhost:8090/login.html?env=kind`\n4. **Gateway endpoint**:
    `http://localhost:30080` (via NodePort)\n\n### GKE Production\n1. **Deploy to
    GKE**: See documentation for GKE deployment\n2. **Open browser**: `https://your-domain.com/login.html`\n3.
    **Gateway endpoint**: Auto-detected from hostname\n\n## Creating Test Session\n\n```sql\n--
    Connect to PostgreSQL\npsql -h localhost -p 54321 -U demo -d demo_noetl\n\n--
    Create test user and session\nINSERT INTO auth.users (auth0_id, email, display_name,
    is_active)\nVALUES ('auth0|test123', 'test@example.com', 'Test User', true)\nRETURNING
    user_id;\n\n-- Grant admin role (use user_id from above)\nINSERT INTO auth.user_roles
    (user_id, role_id)\nSELECT 1, role_id FROM auth.roles WHERE role_name = 'admin';\n\n--
    Create test session (expires in 8 hours)\nINSERT INTO auth.sessions (user_id,
    session_token, expires_at)\nVALUES (1, 'test-session-token-12345', NOW() + INTERVAL
    '8 hours')\nRETURNING session_token;\n```\n\nUse the returned `session_token`
    for direct login testing.\n\n## GraphQL Integration\n\nThe interface uses this
    mutation:\n\n```graphql\nmutation ExecuteAmadeus($name: String!, $vars: JSON)
    {\n  executePlaybook(name: $name, variables: $vars) {\n    id\n    name\n    status\n
    \   textOutput\n  }\n}\n```\n\nWith variables:\n```json\n{\n  \"name\": \"api_integration/amadeus_ai_api\",\n
    \ \"vars\": {\n    \"query\": \"User's flight search query\"\n  }\n}\n```\n\n##
    Usage\n\n### Option 1: Serve with your Rust application\n\nAdd to your `main.rs`:\n\n```rust\nuse
    axum::{\n    Router,\n    routing::get_service,\n};\nuse tower_http::services::ServeDir;\n\nlet
    app = Router::new()\n    .nest_service(\"/\", ServeDir::new(\"static\"));\n```\n\n###
    Option 2: Simple HTTP server\n\n```bash\n# Using Python\ncd static\npython3 -m
    http.server 8000\n\n# Or using Node.js\nnpx http-server static -p 8000\n```\n\nThen
    open: http://localhost:8000\n\n## Customization\n\n### Colors\n\nEdit CSS variables
    in `styles.css`:\n\n```css\n:root {\n    --primary-color: #667eea;\n    --secondary-color:
    #764ba2;\n    /* ... more colors */\n}\n```\n\n### Suggestions\n\nEdit suggestion
    chips in `index.html`:\n\n```html\n<button class=\"suggestion-chip\" onclick=\"sendSuggestion('Your
    custom query')\">\n    Your button text\n</button>\n```\n\n### GraphQL Endpoint\n\nThe
    default endpoint is `/graphql`. Update in `app.js` if different:\n\n```javascript\nconst
    GRAPHQL_ENDPOINT = 'http://your-server:port/graphql';\n```\n\n## Browser Support\n\n-
    Chrome/Edge (latest)\n- Firefox (latest)\n- Safari (latest)\n- Mobile browsers
    (iOS Safari, Chrome Mobile)\n\n## Features Breakdown\n\n### User Interface\n-
    Gradient header with avatar icon\n- Chat bubbles with timestamps\n- Typing indicator
    animation\n- Error messages with icons\n- Execution status badges\n\n### Functionality\n-
    Send text queries\n- Quick suggestion buttons\n- Real-time GraphQL queries\n-
    Response formatting (markdown-like)\n- Auto-scroll to latest message\n- Input
    validation\n- Loading states\n\n## Example Queries\n\nTry these in the chat:\n-
    \"I want a one-way flight from SFO to JFK on March 15, 2026 for 1 adult\"\n- \"Show
    me flights from LAX to Miami next week for 2 passengers\"\n- \"I need a round
    trip from New York to London in April\"\n- \"Find flights from Chicago to Paris
    on June 10th\"\n\n## Troubleshooting\n\n### CORS Issues\nIf you get CORS errors,
    ensure your server allows requests from the origin serving the HTML:\n\n```rust\n//
    Add CORS middleware in your Rust application\nuse tower_http::cors::CorsLayer;\n\nlet
    app = Router::new()\n    .layer(CorsLayer::permissive());\n```\n\n### GraphQL
    Errors\nCheck browser console for detailed error messages. The chat will display
    user-friendly error messages.\n\n### Styling Issues\nClear browser cache if styles
    don't update after changes.\n"
  app.js: |
    // Configuration
    const PLAYBOOK_NAME = 'api_integration/amadeus_ai_api';

    // DOM Elements
    const chatContainer = document.getElementById('chatContainer');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');

    // State
    let isProcessing = false;
    let sseReady = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      chatForm.addEventListener('submit', handleSubmit);
      chatInput.addEventListener('input', handleInputChange);

      // Listen for SSE connection
      window.addEventListener('sse-connected', (event) => {
        console.log('[app.js] SSE connected with clientId:', event.detail.clientId.substring(0, 8) + '...');
        sseReady = true;
        updateConnectionStatus(true);
      });

      // Listen for playbook progress updates
      window.addEventListener('playbook-progress', (event) => {
        const { message, step, progress } = event.detail;
        console.log('[app.js] Progress:', message || step, progress);
        // Could update typing indicator with progress message
      });
    });

    // Update connection status indicator (optional UI enhancement)
    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('connectionStatus');
      if (statusEl) {
        statusEl.className = connected ? 'status-connected' : 'status-disconnected';
        statusEl.title = connected ? 'Real-time updates enabled' : 'Connecting...';
      }
    }

    // Handle form submission
    async function handleSubmit(e) {
      e.preventDefault();

      const query = chatInput.value.trim();
      if (!query || isProcessing) return;

      // Check SSE connection
      if (!isSSEConnected()) {
        addErrorMessage('Real-time connection not established. Please wait or refresh the page.');
        return;
      }

      // Check playbook access before execution
      const hasAccess = await checkPlaybookAccess(PLAYBOOK_NAME, 'execute');
      if (!hasAccess) {
        addErrorMessage('You do not have permission to execute this playbook. Please contact your administrator.');
        return;
      }

      // Clear input
      chatInput.value = '';

      // Hide welcome message if it exists
      const welcomeMessage = chatContainer.querySelector('.welcome-message');
      if (welcomeMessage) {
        welcomeMessage.remove();
      }

      // Add user message
      addMessage(query, 'user');

      // Show typing indicator
      const typingIndicator = addTypingIndicator();

      // Disable input
      setProcessing(true);

      try {
        // Execute playbook with async callback via SSE
        const result = await executePlaybookAsync(PLAYBOOK_NAME, { query: query });

        // Remove typing indicator
        typingIndicator.remove();

        // Add assistant response
        if (result.textOutput) {
          addMessage(result.textOutput, 'assistant', result);
        } else {
          addMessage('I received your request but got no response. Please try again.', 'assistant', result);
        }
      } catch (error) {
        console.error('Error executing playbook:', error);
        typingIndicator.remove();

        if (error.message === 'Session expired' || error.message === 'Not authenticated') {
          addErrorMessage('Your session has expired. Redirecting to login...');
          setTimeout(() => {
            redirectToLogin();
          }, 2000);
        } else if (error.message.includes('timed out')) {
          addErrorMessage('The request took too long. Please try again.');
        } else {
          addErrorMessage(error.message || 'Failed to process your request. Please try again.');
        }
      } finally {
        setProcessing(false);
      }
    }

    // Legacy executePlaybook function (kept for fallback if SSE not available)
    async function executePlaybookFallback(query) {
      const mutation = `
            mutation ExecuteAmadeus($name: String!, $vars: JSON) {
                executePlaybook(name: $name, variables: $vars) {
                    id
                    name
                    status
                    textOutput
                }
            }
        `;

      const variables = {
        name: PLAYBOOK_NAME,
        vars: {
          query: query
        }
      };

      // Use authenticated GraphQL function from auth.js
      const data = await authenticatedGraphQL(mutation, variables);
      return data.executePlaybook;
    }

    // Add message to chat
    function addMessage(text, role, executionData = null) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';

      const textDiv = document.createElement('div');
      textDiv.className = 'message-text';

      // Format the text (convert markdown-like syntax to HTML)
      textDiv.innerHTML = formatMessage(text);

      contentDiv.appendChild(textDiv);

      // Add timestamp
      const timeDiv = document.createElement('div');
      timeDiv.className = 'message-time';
      timeDiv.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      contentDiv.appendChild(timeDiv);

      // Add execution info for assistant messages
      if (role === 'assistant' && executionData) {
        const infoDiv = document.createElement('div');
        infoDiv.className = 'execution-info';

        const statusBadge = document.createElement('span');
        statusBadge.className = `status-badge ${executionData.status.toLowerCase()}`;
        statusBadge.textContent = executionData.status;

        infoDiv.innerHTML = `Execution ID: ${executionData.id}`;
        infoDiv.appendChild(statusBadge);
        contentDiv.appendChild(infoDiv);
      }

      messageDiv.appendChild(contentDiv);
      chatContainer.appendChild(messageDiv);

      // Scroll to bottom
      scrollToBottom();
    }

    // Format message text (simple markdown-like formatting)
    function formatMessage(text) {
      if (!text) return '';

      // Escape HTML
      text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

      // Convert markdown headers
      text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
      text = text.replace(/^## (.*$)/gim, '<h3>$1</h3>');

      // Convert bold
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

      // Convert line breaks
      text = text.replace(/\n\n/g, '</p><p>');
      text = text.replace(/\n/g, '<br>');

      // Wrap in paragraph if not already wrapped
      if (!text.startsWith('<h3>') && !text.startsWith('<p>')) {
        text = '<p>' + text + '</p>';
      }

      return text;
    }

    // Add typing indicator
    function addTypingIndicator() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant typing';

      const indicatorDiv = document.createElement('div');
      indicatorDiv.className = 'typing-indicator';

      for (let i = 0; i < 3; i++) {
        const dot = document.createElement('div');
        dot.className = 'typing-dot';
        indicatorDiv.appendChild(dot);
      }

      messageDiv.appendChild(indicatorDiv);
      chatContainer.appendChild(messageDiv);

      scrollToBottom();

      return messageDiv;
    }

    // Add error message
    function addErrorMessage(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.innerHTML = `
            <span class="error-icon">⚠️</span>
            <span>${message}</span>
        `;
      chatContainer.appendChild(errorDiv);
      scrollToBottom();
    }

    // Handle input change
    function handleInputChange() {
      const hasValue = chatInput.value.trim().length > 0;
      sendButton.disabled = !hasValue || isProcessing;
    }

    // Set processing state
    function setProcessing(processing) {
      isProcessing = processing;
      chatInput.disabled = processing;
      sendButton.disabled = processing;

      if (processing) {
        chatInput.placeholder = 'Processing...';
      } else {
        chatInput.placeholder = "Ask about flights, e.g., 'I want to fly from SFO to JFK tomorrow'";
        chatInput.focus();
      }
    }

    // Scroll to bottom of chat
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Send suggestion
    function sendSuggestion(text) {
      chatInput.value = text;
      handleInputChange();
      chatForm.dispatchEvent(new Event('submit'));
    }

    // Make sendSuggestion available globally for onclick handlers
    window.sendSuggestion = sendSuggestion;
  auth.js: |
    // Authentication utilities for Gateway UI
    //
    // NOTE: This file requires env.js to be loaded first.
    // The gateway URL is configured via window.ENV.gatewayUrl

    // Get API base from environment configuration (set by env.js)
    function getApiBase() {
      if (window.ENV && window.ENV.gatewayUrl) {
        return window.ENV.gatewayUrl;
      }
      // Fallback for direct usage without env.js
      console.warn('[auth.js] ENV not loaded, using fallback localhost:8080');
      return 'http://localhost:8080';
    }

    // Lazy-initialized API URLs (allows env.js to load first)
    let _apiBase = null;
    let _authValidateUrl = null;
    let _authCheckAccessUrl = null;

    // SSE connection state
    let _eventSource = null;
    let _clientId = null;
    let _sseConnected = false;
    let _pendingCallbacks = new Map(); // requestId -> { resolve, reject, typingIndicator }
    let _reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;
    const RECONNECT_DELAY_MS = 2000;

    function getAuthValidateUrl() {
      if (!_authValidateUrl) {
        _apiBase = getApiBase();
        _authValidateUrl = `${_apiBase}/api/auth/validate`;
      }
      return _authValidateUrl;
    }

    function getAuthCheckAccessUrl() {
      if (!_authCheckAccessUrl) {
        _apiBase = getApiBase();
        _authCheckAccessUrl = `${_apiBase}/api/auth/check-access`;
      }
      return _authCheckAccessUrl;
    }

    // Check authentication on page load
    // Skip auto-check on login page to prevent redirect loops
    window.addEventListener('DOMContentLoaded', async () => {
      const isLoginPage = window.location.pathname.endsWith('login.html') ||
                          window.location.pathname === '/login.html';
      if (!isLoginPage) {
        await checkAuth();
      }
    });

    /**
     * Check if user is authenticated, redirect to login if not
     * Uses "soft" validation for local testing - if token and user_info exist in localStorage,
     * we trust them for UI display. Real authorization happens at API level.
     */
    async function checkAuth() {
      const token = getSessionToken();
      const userInfo = getUserInfo();

      if (!token) {
        redirectToLogin();
        return false;
      }

      // If we have cached user info, use it for UI display
      // This enables testing while backend validation playbook is being fixed
      if (userInfo) {
        console.log('Using cached user info for UI (soft auth mode)');
        displayUserInfo();

        // Connect SSE for real-time callbacks
        connectSSE();

        // Try to validate in background, but don't block UI
        validateSession(token).then(valid => {
          if (valid) {
            console.log('Backend session validation succeeded');
          } else {
            console.warn('Backend session validation failed - UI using cached data');
            // Don't redirect - let API calls handle 401 errors
          }
        }).catch(err => {
          console.warn('Backend session validation error:', err);
        });

        return true;
      }

      // No cached user info - must validate with backend
      const valid = await validateSession(token);

      if (!valid) {
        clearAuth();
        redirectToLogin();
        return false;
      }

      // Display user info
      displayUserInfo();

      // Connect SSE for real-time callbacks
      connectSSE();

      return true;
    }

    /**
     * Get session token from localStorage
     */
    function getSessionToken() {
      return localStorage.getItem('session_token');
    }

    /**
     * Get user info from localStorage
     */
    function getUserInfo() {
      const userStr = localStorage.getItem('user_info');
      if (!userStr) return null;

      try {
        return JSON.parse(userStr);
      } catch (e) {
        console.error('Failed to parse user info:', e);
        return null;
      }
    }

    /**
     * Validate session token with backend
     */
    async function validateSession(token) {
      try {
        const response = await fetch(getAuthValidateUrl(), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_token: token,
          }),
        });

        if (!response.ok) {
          console.error('Session validation failed:', response.status);
          return false;
        }

        const data = await response.json();

        if (data.valid && data.user) {
          // Update user info if returned
          localStorage.setItem('user_info', JSON.stringify(data.user));
          return true;
        }

        return false;
      } catch (error) {
        console.error('Session validation error:', error);
        return false;
      }
    }

    /**
     * Check if user has access to execute a playbook
     */
    async function checkPlaybookAccess(playbookPath, permissionType = 'execute') {
      const token = getSessionToken();

      if (!token) {
        return false;
      }

      try {
        const response = await fetch(getAuthCheckAccessUrl(), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_token: token,
            playbook_path: playbookPath,
            permission_type: permissionType,
          }),
        });

        if (!response.ok) {
          console.error('Access check failed:', response.status);
          return false;
        }

        const data = await response.json();
        return data.allowed || false;
      } catch (error) {
        console.error('Access check error:', error);
        return false;
      }
    }

    /**
     * Display user information in header
     */
    function displayUserInfo() {
      const user = getUserInfo();
      if (!user) return;

      const userDisplay = document.getElementById('userDisplay');
      if (userDisplay) {
        userDisplay.textContent = user.display_name || user.email;
      }

      // Setup logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
      }
    }

    /**
     * Logout user
     */
    function logout() {
      disconnectSSE();
      clearAuth();
      redirectToLogin();
    }

    /**
     * Clear authentication data
     */
    function clearAuth() {
      localStorage.removeItem('session_token');
      localStorage.removeItem('user_info');
    }

    /**
     * Redirect to login page
     */
    function redirectToLogin() {
      window.location.href = '/login.html';
    }

    /**
     * Make authenticated GraphQL request
     */
    async function authenticatedGraphQL(query, variables) {
      const token = getSessionToken();

      if (!token) {
        throw new Error('Not authenticated');
      }

      const response = await fetch(`${getApiBase()}/graphql`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify({
          query,
          variables,
        }),
      });

      if (response.status === 401) {
        // Session expired, redirect to login
        clearAuth();
        redirectToLogin();
        throw new Error('Session expired');
      }

      if (!response.ok) {
        throw new Error(`GraphQL request failed: ${response.status}`);
      }

      const data = await response.json();

      if (data.errors) {
        throw new Error(data.errors[0].message || 'GraphQL error');
      }

      return data.data;
    }

    // ============================================================================
    // SSE CONNECTION MANAGEMENT
    // ============================================================================

    /**
     * Connect to SSE endpoint for real-time playbook results
     */
    function connectSSE() {
      const token = getSessionToken();
      if (!token) {
        console.warn('[SSE] No session token, skipping SSE connection');
        return;
      }

      // Close existing connection if any
      if (_eventSource) {
        _eventSource.close();
        _eventSource = null;
      }

      const sseUrl = `${getApiBase()}/events?session_token=${encodeURIComponent(token)}${_clientId ? `&client_id=${encodeURIComponent(_clientId)}` : ''}`;
      console.log('[SSE] Connecting to:', sseUrl.replace(/session_token=[^&]+/, 'session_token=***'));

      _eventSource = new EventSource(sseUrl);

      _eventSource.onopen = () => {
        console.log('[SSE] Connection opened');
        _reconnectAttempts = 0;
      };

      // Handle initialization message (JSON-RPC response)
      _eventSource.addEventListener('message', (event) => {
        try {
          const msg = JSON.parse(event.data);
          if (msg.result && msg.result.clientId) {
            _clientId = msg.result.clientId;
            _sseConnected = true;
            console.log('[SSE] Initialized with clientId:', _clientId.substring(0, 8) + '...');

            // Handle any pending requests from reconnection
            if (msg.result.pendingRequests && msg.result.pendingRequests.length > 0) {
              console.log('[SSE] Found pending requests:', msg.result.pendingRequests.length);
            }

            // Dispatch custom event for UI
            window.dispatchEvent(new CustomEvent('sse-connected', { detail: { clientId: _clientId } }));
          }
        } catch (e) {
          console.warn('[SSE] Failed to parse message:', e);
        }
      });

      // Handle playbook result notifications
      _eventSource.addEventListener('playbook/result', (event) => {
        try {
          const msg = JSON.parse(event.data);
          const params = msg.params || {};
          const requestId = params.requestId;

          console.log('[SSE] Playbook result:', requestId?.substring(0, 8) + '...', params.status);

          // Find pending callback
          const pending = _pendingCallbacks.get(requestId);
          if (pending) {
            _pendingCallbacks.delete(requestId);

            if (params.status === 'FAILED' || params.error) {
              const errorMsg = params.error?.message || 'Playbook execution failed';
              pending.reject(new Error(errorMsg));
            } else {
              pending.resolve({
                id: params.executionId,
                executionId: params.executionId,
                requestId: requestId,
                status: params.status,
                // Support both camelCase (from playbooks) and snake_case (legacy)
                textOutput: params.data?.textOutput || params.data?.text_output || params.data?.result || JSON.stringify(params.data),
                data: params.data
              });
            }
          } else {
            console.warn('[SSE] No pending callback for requestId:', requestId?.substring(0, 8) + '...');
            // Dispatch event for any listeners
            window.dispatchEvent(new CustomEvent('playbook-result', { detail: params }));
          }
        } catch (e) {
          console.error('[SSE] Failed to handle playbook result:', e);
        }
      });

      // Handle progress notifications
      _eventSource.addEventListener('playbook/progress', (event) => {
        try {
          const msg = JSON.parse(event.data);
          const params = msg.params || {};
          console.log('[SSE] Progress:', params.requestId?.substring(0, 8) + '...', params.message || params.step);

          // Dispatch event for UI
          window.dispatchEvent(new CustomEvent('playbook-progress', { detail: params }));
        } catch (e) {
          console.warn('[SSE] Failed to handle progress:', e);
        }
      });

      // Handle ping/heartbeat
      _eventSource.addEventListener('ping', () => {
        // Heartbeat received, connection is alive
      });

      // Handle errors
      _eventSource.addEventListener('error', (event) => {
        try {
          const msg = JSON.parse(event.data);
          console.error('[SSE] Error event:', msg);

          if (msg.error?.code === -32001) { // Unauthorized
            clearAuth();
            redirectToLogin();
          }
        } catch (e) {
          // Not a JSON error, likely connection error
          console.error('[SSE] Connection error');
        }
      });

      _eventSource.onerror = (error) => {
        console.error('[SSE] EventSource error:', error);
        _sseConnected = false;

        // Attempt reconnection
        if (_reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
          _reconnectAttempts++;
          console.log(`[SSE] Reconnecting in ${RECONNECT_DELAY_MS}ms (attempt ${_reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`);
          setTimeout(() => connectSSE(), RECONNECT_DELAY_MS);
        } else {
          console.error('[SSE] Max reconnection attempts reached');
          // Reject all pending callbacks
          for (const [requestId, pending] of _pendingCallbacks) {
            pending.reject(new Error('SSE connection lost'));
          }
          _pendingCallbacks.clear();
        }
      };
    }

    /**
     * Disconnect SSE
     */
    function disconnectSSE() {
      if (_eventSource) {
        _eventSource.close();
        _eventSource = null;
      }
      _sseConnected = false;
      _clientId = null;
    }

    /**
     * Get current client ID for SSE
     */
    function getClientId() {
      return _clientId;
    }

    /**
     * Check if SSE is connected
     */
    function isSSEConnected() {
      return _sseConnected && _eventSource && _eventSource.readyState === EventSource.OPEN;
    }

    /**
     * Register a pending callback for a playbook execution
     */
    function registerPendingCallback(requestId, resolve, reject, timeout = 120000) {
      const timeoutId = setTimeout(() => {
        const pending = _pendingCallbacks.get(requestId);
        if (pending) {
          _pendingCallbacks.delete(requestId);
          pending.reject(new Error('Playbook execution timed out'));
        }
      }, timeout);

      _pendingCallbacks.set(requestId, {
        resolve: (result) => {
          clearTimeout(timeoutId);
          resolve(result);
        },
        reject: (error) => {
          clearTimeout(timeoutId);
          reject(error);
        }
      });
    }

    /**
     * Execute playbook with async callback via SSE
     */
    async function executePlaybookAsync(playbookName, variables = {}) {
      if (!isSSEConnected()) {
        throw new Error('SSE not connected. Please wait for connection or refresh the page.');
      }

      const mutation = `
        mutation ExecutePlaybook($name: String!, $vars: JSON, $clientId: String) {
          executePlaybook(name: $name, variables: $vars, clientId: $clientId) {
            id
            executionId
            requestId
            name
            status
          }
        }
      `;

      const gqlVariables = {
        name: playbookName,
        vars: variables,
        clientId: _clientId
      };

      // Execute the mutation
      const data = await authenticatedGraphQL(mutation, gqlVariables);
      const result = data.executePlaybook;

      if (!result.requestId) {
        // No async callback, return immediately (shouldn't happen with clientId)
        console.warn('[SSE] No requestId returned, falling back to sync result');
        return result;
      }

      // Wait for callback via SSE
      return new Promise((resolve, reject) => {
        registerPendingCallback(result.requestId, resolve, reject);
        console.log('[SSE] Waiting for callback:', result.requestId.substring(0, 8) + '...');
      });
    }
  config.js: |
    // Auth0 Configuration
    // Update this file to change Auth0 settings
    const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const auth0Config = {
      domain: 'mestumre-development.us.auth0.com',
      clientId: 'Jqop7YoaiZalLHdBRo5ScNQ1RJhbhbDN',
      // Redirect back to login.html
      // Port mapping (from ci/kind/config.yaml):
      //   - 8080: UI server (Python HTTP server for development)
      //   - 8090: Gateway API (Kind hostPort -> containerPort 30090)
      // NOTE: Auth0 callback URLs must be configured to allow this port
      redirectUri: isLocalDev ? 'http://localhost:8080/login.html' : window.location.origin + '/login.html'
    };
  dashboard.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>NoETL Gateway - Dashboard</title>
      <script src="/env.js"></script>
      <script src="/config.js"></script>
      <script src="/auth.js"></script>
      <style>
        :root {
          --primary: #667eea;
          --primary-dark: #5a67d8;
          --secondary: #764ba2;
          --success: #48bb78;
          --warning: #ed8936;
          --danger: #e53e3e;
          --info: #38b2ac;
          --dark: #1a202c;
          --gray-100: #f7fafc;
          --gray-200: #edf2f7;
          --gray-300: #e2e8f0;
          --gray-400: #cbd5e0;
          --gray-500: #a0aec0;
          --gray-600: #718096;
          --gray-700: #4a5568;
          --gray-800: #2d3748;
          --sidebar-width: 260px;
          --header-height: 64px;
        }

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
          background: var(--gray-100);
          color: var(--gray-800);
          min-height: 100vh;
        }

        /* Layout */
        .app-layout {
          display: flex;
          min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
          width: var(--sidebar-width);
          background: var(--dark);
          color: white;
          position: fixed;
          top: 0;
          left: 0;
          height: 100vh;
          display: flex;
          flex-direction: column;
          z-index: 100;
          transition: transform 0.3s ease;
        }

        .sidebar-header {
          padding: 1.5rem;
          display: flex;
          align-items: center;
          gap: 1rem;
          border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-logo {
          width: 40px;
          height: 40px;
          background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
          border-radius: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .sidebar-logo svg {
          width: 24px;
          height: 24px;
          stroke: white;
        }

        .sidebar-title {
          font-size: 1.25rem;
          font-weight: 700;
        }

        .sidebar-nav {
          flex: 1;
          padding: 1rem 0;
          overflow-y: auto;
        }

        .nav-section {
          padding: 0.5rem 1rem;
          font-size: 0.7rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.1em;
          color: var(--gray-500);
          margin-top: 1rem;
        }

        .nav-item {
          display: flex;
          align-items: center;
          gap: 0.75rem;
          padding: 0.75rem 1.5rem;
          color: var(--gray-400);
          text-decoration: none;
          cursor: pointer;
          transition: all 0.2s;
          border-left: 3px solid transparent;
        }

        .nav-item:hover {
          background: rgba(255,255,255,0.05);
          color: white;
        }

        .nav-item.active {
          background: rgba(102, 126, 234, 0.15);
          color: var(--primary);
          border-left-color: var(--primary);
        }

        .nav-item svg {
          width: 20px;
          height: 20px;
        }

        .nav-item .badge {
          margin-left: auto;
          background: var(--primary);
          color: white;
          font-size: 0.7rem;
          padding: 0.2rem 0.5rem;
          border-radius: 10px;
          font-weight: 600;
        }

        .sidebar-footer {
          padding: 1rem 1.5rem;
          border-top: 1px solid rgba(255,255,255,0.1);
        }

        .user-profile {
          display: flex;
          align-items: center;
          gap: 0.75rem;
        }

        .user-avatar {
          width: 36px;
          height: 36px;
          background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 600;
          font-size: 0.9rem;
        }

        .user-info {
          flex: 1;
          min-width: 0;
        }

        .user-name {
          font-size: 0.9rem;
          font-weight: 600;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .user-email {
          font-size: 0.75rem;
          color: var(--gray-500);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .btn-logout {
          background: none;
          border: none;
          color: var(--gray-500);
          cursor: pointer;
          padding: 0.5rem;
          border-radius: 6px;
          transition: all 0.2s;
        }

        .btn-logout:hover {
          background: rgba(229, 62, 62, 0.2);
          color: var(--danger);
        }

        /* Main Content */
        .main-content {
          flex: 1;
          margin-left: var(--sidebar-width);
          min-height: 100vh;
        }

        .header {
          background: white;
          height: var(--header-height);
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 0 2rem;
          border-bottom: 1px solid var(--gray-200);
          position: sticky;
          top: 0;
          z-index: 50;
        }

        .header-title {
          font-size: 1.5rem;
          font-weight: 600;
          color: var(--dark);
        }

        .header-actions {
          display: flex;
          align-items: center;
          gap: 1rem;
        }

        .page-content {
          padding: 2rem;
        }

        /* Stats Grid */
        .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
          gap: 1.5rem;
          margin-bottom: 2rem;
        }

        .stat-card {
          background: white;
          border-radius: 12px;
          padding: 1.5rem;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          display: flex;
          align-items: flex-start;
          gap: 1rem;
          transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-icon {
          width: 48px;
          height: 48px;
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1.5rem;
        }

        .stat-icon.playbooks { background: rgba(102, 126, 234, 0.1); }
        .stat-icon.executions { background: rgba(72, 187, 120, 0.1); }
        .stat-icon.running { background: rgba(237, 137, 54, 0.1); }
        .stat-icon.success { background: rgba(56, 178, 172, 0.1); }

        .stat-content {
          flex: 1;
        }

        .stat-label {
          font-size: 0.875rem;
          color: var(--gray-600);
          margin-bottom: 0.25rem;
        }

        .stat-value {
          font-size: 2rem;
          font-weight: 700;
          color: var(--dark);
          line-height: 1;
        }

        .stat-change {
          font-size: 0.75rem;
          margin-top: 0.5rem;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        /* Section */
        .section {
          background: white;
          border-radius: 12px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          margin-bottom: 2rem;
        }

        .section-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 1.25rem 1.5rem;
          border-bottom: 1px solid var(--gray-200);
        }

        .section-title {
          font-size: 1.125rem;
          font-weight: 600;
          color: var(--dark);
        }

        .section-actions {
          display: flex;
          gap: 0.75rem;
        }

        .section-body {
          padding: 1.5rem;
        }

        /* Buttons */
        .btn {
          display: inline-flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.625rem 1.25rem;
          border-radius: 8px;
          font-size: 0.875rem;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s;
          border: none;
          text-decoration: none;
        }

        .btn-primary {
          background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
          color: white;
        }

        .btn-primary:hover:not(:disabled) {
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
          background: var(--gray-200);
          color: var(--gray-700);
        }

        .btn-secondary:hover {
          background: var(--gray-300);
        }

        .btn-ghost {
          background: transparent;
          color: var(--gray-600);
        }

        .btn-ghost:hover {
          background: var(--gray-100);
          color: var(--gray-800);
        }

        .btn-success {
          background: var(--success);
          color: white;
        }

        .btn-danger {
          background: var(--danger);
          color: white;
        }

        .btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        .btn-sm {
          padding: 0.375rem 0.75rem;
          font-size: 0.8125rem;
        }

        .btn-icon {
          padding: 0.5rem;
        }

        /* Table */
        .data-table {
          width: 100%;
          border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
          padding: 0.875rem 1rem;
          text-align: left;
          border-bottom: 1px solid var(--gray-200);
        }

        .data-table th {
          font-size: 0.75rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.05em;
          color: var(--gray-600);
          background: var(--gray-50);
        }

        .data-table tbody tr {
          transition: background 0.2s;
        }

        .data-table tbody tr:hover {
          background: var(--gray-50);
        }

        .data-table tbody tr:last-child td {
          border-bottom: none;
        }

        /* Status Badge */
        .status-badge {
          display: inline-flex;
          align-items: center;
          gap: 0.375rem;
          padding: 0.25rem 0.75rem;
          border-radius: 9999px;
          font-size: 0.75rem;
          font-weight: 600;
        }

        .status-badge::before {
          content: '';
          width: 6px;
          height: 6px;
          border-radius: 50%;
        }

        .status-completed, .status-success { background: rgba(72, 187, 120, 0.15); color: #22543d; }
        .status-completed::before, .status-success::before { background: var(--success); }

        .status-running, .status-active { background: rgba(56, 178, 172, 0.15); color: #234e52; }
        .status-running::before, .status-active::before { background: var(--info); animation: pulse 1.5s infinite; }

        .status-failed, .status-error { background: rgba(229, 62, 62, 0.15); color: #742a2a; }
        .status-failed::before, .status-error::before { background: var(--danger); }

        .status-pending, .status-queued { background: rgba(237, 137, 54, 0.15); color: #744210; }
        .status-pending::before, .status-queued::before { background: var(--warning); }

        .status-cancelled, .status-inactive { background: rgba(160, 174, 192, 0.15); color: #4a5568; }
        .status-cancelled::before, .status-inactive::before { background: var(--gray-500); }

        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }

        /* Search & Filter */
        .search-bar {
          display: flex;
          align-items: center;
          gap: 1rem;
          margin-bottom: 1.5rem;
        }

        .search-input-wrapper {
          flex: 1;
          position: relative;
        }

        .search-input-wrapper svg {
          position: absolute;
          left: 1rem;
          top: 50%;
          transform: translateY(-50%);
          width: 20px;
          height: 20px;
          color: var(--gray-400);
        }

        .search-input {
          width: 100%;
          padding: 0.75rem 1rem 0.75rem 2.75rem;
          border: 2px solid var(--gray-200);
          border-radius: 10px;
          font-size: 0.9375rem;
          transition: all 0.2s;
          outline: none;
        }

        .search-input:focus {
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-select {
          padding: 0.75rem 1rem;
          border: 2px solid var(--gray-200);
          border-radius: 10px;
          font-size: 0.9375rem;
          outline: none;
          background: white;
          cursor: pointer;
          min-width: 150px;
        }

        .filter-select:focus {
          border-color: var(--primary);
        }

        /* Cards Grid */
        .cards-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
          gap: 1.25rem;
        }

        .playbook-card {
          background: white;
          border: 2px solid var(--gray-200);
          border-radius: 12px;
          padding: 1.25rem;
          transition: all 0.2s;
          cursor: pointer;
        }

        .playbook-card:hover {
          border-color: var(--primary);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .playbook-card-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 0.75rem;
        }

        .playbook-card-title {
          font-size: 1rem;
          font-weight: 600;
          color: var(--dark);
          margin-bottom: 0.25rem;
        }

        .playbook-card-path {
          font-size: 0.8125rem;
          color: var(--gray-500);
          font-family: monospace;
        }

        .playbook-card-description {
          font-size: 0.875rem;
          color: var(--gray-600);
          margin-bottom: 1rem;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
        }

        .playbook-card-footer {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding-top: 0.75rem;
          border-top: 1px solid var(--gray-200);
        }

        .playbook-card-meta {
          font-size: 0.75rem;
          color: var(--gray-500);
        }

        /* Modal */
        .modal-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(4px);
          z-index: 1000;
          justify-content: center;
          align-items: center;
          padding: 2rem;
        }

        .modal-overlay.active {
          display: flex;
        }

        .modal {
          background: white;
          border-radius: 16px;
          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
          width: 100%;
          max-width: 800px;
          max-height: calc(100vh - 4rem);
          display: flex;
          flex-direction: column;
          animation: modalEnter 0.2s ease-out;
        }

        @keyframes modalEnter {
          from {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
          }
          to {
            opacity: 1;
            transform: scale(1) translateY(0);
          }
        }

        .modal-large {
          max-width: 1000px;
        }

        .modal-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 1.5rem;
          border-bottom: 1px solid var(--gray-200);
        }

        .modal-title {
          font-size: 1.25rem;
          font-weight: 600;
          color: var(--dark);
        }

        .modal-close {
          background: none;
          border: none;
          width: 36px;
          height: 36px;
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          color: var(--gray-500);
          transition: all 0.2s;
        }

        .modal-close:hover {
          background: var(--gray-100);
          color: var(--gray-700);
        }

        .modal-body {
          flex: 1;
          padding: 1.5rem;
          overflow-y: auto;
        }

        .modal-footer {
          display: flex;
          justify-content: flex-end;
          gap: 0.75rem;
          padding: 1.25rem 1.5rem;
          border-top: 1px solid var(--gray-200);
          background: var(--gray-50);
          border-radius: 0 0 16px 16px;
        }

        /* Form */
        .form-group {
          margin-bottom: 1.5rem;
        }

        .form-label {
          display: block;
          font-size: 0.875rem;
          font-weight: 600;
          color: var(--gray-700);
          margin-bottom: 0.5rem;
        }

        .form-input,
        .form-textarea,
        .form-select {
          width: 100%;
          padding: 0.75rem 1rem;
          border: 2px solid var(--gray-200);
          border-radius: 8px;
          font-size: 0.9375rem;
          transition: all 0.2s;
          outline: none;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
          min-height: 150px;
          font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
          font-size: 0.875rem;
          resize: vertical;
        }

        .form-help {
          font-size: 0.8125rem;
          color: var(--gray-500);
          margin-top: 0.5rem;
        }

        /* Code Block */
        .code-block {
          background: var(--dark);
          color: #e2e8f0;
          padding: 1rem;
          border-radius: 8px;
          font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
          font-size: 0.8125rem;
          overflow-x: auto;
          max-height: 400px;
          overflow-y: auto;
        }

        /* Empty State */
        .empty-state {
          text-align: center;
          padding: 3rem 2rem;
          color: var(--gray-500);
        }

        .empty-state-icon {
          font-size: 3rem;
          margin-bottom: 1rem;
          opacity: 0.5;
        }

        .empty-state-title {
          font-size: 1.125rem;
          font-weight: 600;
          color: var(--gray-700);
          margin-bottom: 0.5rem;
        }

        .empty-state-description {
          font-size: 0.9375rem;
          max-width: 400px;
          margin: 0 auto;
        }

        /* Loading */
        .loading-spinner {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid var(--gray-200);
          border-top-color: var(--primary);
          border-radius: 50%;
          animation: spin 0.8s linear infinite;
        }

        .loading-spinner.lg {
          width: 40px;
          height: 40px;
          border-width: 4px;
        }

        @keyframes spin {
          to { transform: rotate(360deg); }
        }

        .loading-overlay {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 3rem;
          color: var(--gray-600);
          gap: 1rem;
        }

        /* Tabs */
        .tabs {
          display: flex;
          border-bottom: 2px solid var(--gray-200);
          margin-bottom: 1.5rem;
        }

        .tab {
          padding: 0.75rem 1.25rem;
          background: none;
          border: none;
          font-size: 0.9375rem;
          font-weight: 500;
          color: var(--gray-500);
          cursor: pointer;
          border-bottom: 2px solid transparent;
          margin-bottom: -2px;
          transition: all 0.2s;
        }

        .tab:hover {
          color: var(--primary);
        }

        .tab.active {
          color: var(--primary);
          border-bottom-color: var(--primary);
        }

        /* Execution Details */
        .execution-info-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1.5rem;
          margin-bottom: 1.5rem;
        }

        .info-item {
          padding: 1rem;
          background: var(--gray-50);
          border-radius: 8px;
        }

        .info-label {
          font-size: 0.75rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.05em;
          color: var(--gray-500);
          margin-bottom: 0.25rem;
        }

        .info-value {
          font-size: 1rem;
          color: var(--dark);
          font-weight: 500;
        }

        /* Events Timeline */
        .events-timeline {
          position: relative;
          padding-left: 1.5rem;
        }

        .events-timeline::before {
          content: '';
          position: absolute;
          left: 0.5rem;
          top: 0;
          bottom: 0;
          width: 2px;
          background: var(--gray-200);
        }

        .event-item {
          position: relative;
          padding: 1rem 0 1rem 1.5rem;
          border-bottom: 1px solid var(--gray-100);
        }

        .event-item:last-child {
          border-bottom: none;
        }

        .event-item::before {
          content: '';
          position: absolute;
          left: -1.25rem;
          top: 1.25rem;
          width: 10px;
          height: 10px;
          border-radius: 50%;
          background: white;
          border: 2px solid var(--gray-400);
        }

        .event-item.success::before { border-color: var(--success); }
        .event-item.running::before { border-color: var(--info); }
        .event-item.failed::before { border-color: var(--danger); }

        .event-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 0.5rem;
        }

        .event-name {
          font-weight: 600;
          color: var(--dark);
        }

        .event-time {
          font-size: 0.8125rem;
          color: var(--gray-500);
        }

        .event-details {
          font-size: 0.875rem;
          color: var(--gray-600);
        }

        /* Responsive */
        @media (max-width: 1024px) {
          .sidebar {
            transform: translateX(-100%);
          }

          .sidebar.open {
            transform: translateX(0);
          }

          .main-content {
            margin-left: 0;
          }

          .header {
            padding-left: 1rem;
          }

          .menu-toggle {
            display: flex;
          }
        }

        /* Utility */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .truncate {
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        .mono { font-family: 'Monaco', 'Menlo', 'Consolas', monospace; }

        /* Toast Notifications */
        .toast-container {
          position: fixed;
          bottom: 2rem;
          right: 2rem;
          z-index: 2000;
          display: flex;
          flex-direction: column;
          gap: 0.75rem;
        }

        .toast {
          background: white;
          border-radius: 10px;
          padding: 1rem 1.5rem;
          box-shadow: 0 10px 40px rgba(0,0,0,0.2);
          display: flex;
          align-items: center;
          gap: 0.75rem;
          animation: toastEnter 0.3s ease-out;
          min-width: 300px;
        }

        @keyframes toastEnter {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.info { border-left: 4px solid var(--info); }

        .toast-icon {
          font-size: 1.25rem;
        }

        .toast-content {
          flex: 1;
        }

        .toast-title {
          font-weight: 600;
          color: var(--dark);
          margin-bottom: 0.125rem;
        }

        .toast-message {
          font-size: 0.875rem;
          color: var(--gray-600);
        }
      </style>
    </head>
    <body>
      <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
          <div class="sidebar-header">
            <div class="sidebar-logo">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
              </svg>
            </div>
            <span class="sidebar-title">NoETL</span>
          </div>

          <nav class="sidebar-nav">
            <div class="nav-section">Main</div>
            <a class="nav-item active" onclick="showPage('dashboard')" data-page="dashboard">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
              Dashboard
            </a>

            <div class="nav-section">Workflows</div>
            <a class="nav-item" onclick="showPage('playbooks')" data-page="playbooks">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              Playbooks
              <span class="badge" id="playbookBadge">0</span>
            </a>
            <a class="nav-item" onclick="showPage('executions')" data-page="executions">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
              Executions
              <span class="badge" id="executionBadge">0</span>
            </a>

            <div class="nav-section">Management</div>
            <a class="nav-item" onclick="showPage('credentials')" data-page="credentials">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              Credentials
            </a>
            <a class="nav-item" onclick="showPage('settings')" data-page="settings">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
              Settings
            </a>
          </nav>

          <div class="sidebar-footer">
            <div class="user-profile">
              <div class="user-avatar" id="userAvatar">U</div>
              <div class="user-info">
                <div class="user-name" id="userName">User</div>
                <div class="user-email" id="userEmail">user@example.com</div>
              </div>
              <button class="btn-logout" onclick="logout()" title="Logout">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                  <polyline points="16 17 21 12 16 7"></polyline>
                  <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
              </button>
            </div>
          </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
          <!-- Dashboard Page -->
          <div id="page-dashboard" class="page">
            <header class="header">
              <h1 class="header-title">Dashboard</h1>
              <div class="header-actions">
                <button class="btn btn-primary" onclick="openExecuteModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                  </svg>
                  Execute Playbook
                </button>
              </div>
            </header>

            <div class="page-content">
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-icon playbooks">&#128203;</div>
                  <div class="stat-content">
                    <div class="stat-label">Total Playbooks</div>
                    <div class="stat-value" id="statPlaybooks">-</div>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon executions">&#128640;</div>
                  <div class="stat-content">
                    <div class="stat-label">Total Executions</div>
                    <div class="stat-value" id="statExecutions">-</div>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon running">&#9654;</div>
                  <div class="stat-content">
                    <div class="stat-label">Active Executions</div>
                    <div class="stat-value" id="statActive">-</div>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon success">&#10003;</div>
                  <div class="stat-content">
                    <div class="stat-label">Success Rate</div>
                    <div class="stat-value" id="statSuccessRate">-</div>
                  </div>
                </div>
              </div>

              <div class="section">
                <div class="section-header">
                  <h2 class="section-title">Recent Executions</h2>
                  <div class="section-actions">
                    <button class="btn btn-ghost btn-sm" onclick="loadRecentExecutions()">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                      </svg>
                      Refresh
                    </button>
                  </div>
                </div>
                <div class="section-body" id="recentExecutionsContainer">
                  <div class="loading-overlay">
                    <div class="loading-spinner lg"></div>
                    <span>Loading recent executions...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Playbooks Page -->
          <div id="page-playbooks" class="page hidden">
            <header class="header">
              <h1 class="header-title">Playbooks</h1>
              <div class="header-actions">
                <button class="btn btn-secondary" onclick="loadPlaybooks()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                  </svg>
                  Refresh
                </button>
                <button class="btn btn-primary" onclick="openCreatePlaybookModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  New Playbook
                </button>
              </div>
            </header>

            <div class="page-content">
              <div class="search-bar">
                <div class="search-input-wrapper">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                  </svg>
                  <input type="text" class="search-input" placeholder="Search playbooks..." id="playbookSearch" oninput="filterPlaybooks()">
                </div>
                <select class="filter-select" id="playbookStatusFilter" onchange="filterPlaybooks()">
                  <option value="">All Status</option>
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>

              <div id="playbooksContainer">
                <div class="loading-overlay">
                  <div class="loading-spinner lg"></div>
                  <span>Loading playbooks...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Executions Page -->
          <div id="page-executions" class="page hidden">
            <header class="header">
              <h1 class="header-title">Executions</h1>
              <div class="header-actions">
                <button class="btn btn-secondary" onclick="loadExecutions()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                  </svg>
                  Refresh
                </button>
              </div>
            </header>

            <div class="page-content">
              <div class="search-bar">
                <div class="search-input-wrapper">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                  </svg>
                  <input type="text" class="search-input" placeholder="Search executions..." id="executionSearch" oninput="filterExecutions()">
                </div>
                <select class="filter-select" id="executionStatusFilter" onchange="filterExecutions()">
                  <option value="">All Status</option>
                  <option value="running">Running</option>
                  <option value="completed">Completed</option>
                  <option value="failed">Failed</option>
                  <option value="pending">Pending</option>
                </select>
              </div>

              <div class="section">
                <div class="section-body" style="padding: 0; overflow-x: auto;">
                  <table class="data-table" id="executionsTable">
                    <thead>
                      <tr>
                        <th>Execution ID</th>
                        <th>Playbook</th>
                        <th>Status</th>
                        <th>Started</th>
                        <th>Duration</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="executionsTableBody">
                      <tr>
                        <td colspan="6" class="text-center" style="padding: 3rem;">
                          <div class="loading-spinner lg"></div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Credentials Page -->
          <div id="page-credentials" class="page hidden">
            <header class="header">
              <h1 class="header-title">Credentials</h1>
              <div class="header-actions">
                <button class="btn btn-secondary" onclick="loadCredentials()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                  </svg>
                  Refresh
                </button>
                <button class="btn btn-primary" onclick="openCreateCredentialModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  New Credential
                </button>
              </div>
            </header>

            <div class="page-content">
              <div class="section">
                <div class="section-body" style="padding: 0; overflow-x: auto;">
                  <table class="data-table" id="credentialsTable">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Created</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="credentialsTableBody">
                      <tr>
                        <td colspan="5" class="text-center" style="padding: 3rem;">
                          <div class="loading-spinner lg"></div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Settings Page -->
          <div id="page-settings" class="page hidden">
            <header class="header">
              <h1 class="header-title">Settings</h1>
            </header>

            <div class="page-content">
              <div class="section">
                <div class="section-header">
                  <h2 class="section-title">Gateway Configuration</h2>
                </div>
                <div class="section-body">
                  <div class="form-group">
                    <label class="form-label">Gateway URL</label>
                    <input type="text" class="form-input" id="settingsGatewayUrl" readonly>
                    <p class="form-help">The gateway API endpoint used for all requests.</p>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Session Token</label>
                    <input type="text" class="form-input mono" id="settingsSessionToken" readonly>
                    <p class="form-help">Your current authentication token.</p>
                  </div>
                </div>
              </div>

              <div class="section">
                <div class="section-header">
                  <h2 class="section-title">User Information</h2>
                </div>
                <div class="section-body">
                  <pre class="code-block" id="settingsUserInfo">{}</pre>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- Execute Playbook Modal -->
      <div id="executeModal" class="modal-overlay" onclick="closeModalOnOverlay(event, 'executeModal')">
        <div class="modal">
          <div class="modal-header">
            <h2 class="modal-title">Execute Playbook</h2>
            <button class="modal-close" onclick="closeModal('executeModal')">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <!-- Mode 1: Select playbook from dropdown (when opened from header button) -->
            <div id="executePlaybookSelectGroup" class="form-group">
              <label class="form-label">Select Playbook</label>
              <select class="form-select" id="executePlaybookSelect" onchange="onExecutePlaybookChange()">
                <option value="">-- Select a playbook --</option>
              </select>
            </div>
            <!-- Mode 2: Playbook already selected, show path and version selector -->
            <div id="executePlaybookFixedGroup" class="form-group hidden">
              <label class="form-label">Playbook</label>
              <input type="text" class="form-input mono" id="executePlaybookPath" readonly style="background: var(--gray-100);">
            </div>
            <div id="executeVersionGroup" class="form-group hidden">
              <label class="form-label">Version</label>
              <select class="form-select" id="executeVersionSelect" onchange="onExecuteVersionChange()">
              </select>
            </div>
            <div id="executePlaybookDetails" class="hidden">
              <div class="form-group">
                <label class="form-label">Description</label>
                <p id="executePlaybookDescription" style="color: var(--gray-600);">-</p>
              </div>
              <div class="form-group">
                <label class="form-label">Variables (JSON)</label>
                <textarea class="form-textarea" id="executeVariables" placeholder='{"key": "value"}'>{}</textarea>
                <p class="form-help">Enter execution variables as a JSON object.</p>
              </div>
            </div>
            <div id="executeResult" class="hidden"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('executeModal')">Cancel</button>
            <button class="btn btn-primary" id="executeBtn" disabled onclick="executePlaybook()">
              <span id="executeBtnText">Execute</span>
              <span id="executeBtnSpinner" class="loading-spinner hidden"></span>
            </button>
          </div>
        </div>
      </div>

      <!-- Playbook Detail Modal -->
      <div id="playbookDetailModal" class="modal-overlay" onclick="closeModalOnOverlay(event, 'playbookDetailModal')">
        <div class="modal modal-large">
          <div class="modal-header">
            <h2 class="modal-title" id="playbookDetailTitle">Playbook Details</h2>
            <button class="modal-close" onclick="closeModal('playbookDetailModal')">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body" id="playbookDetailBody">
            <div class="loading-overlay">
              <div class="loading-spinner lg"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('playbookDetailModal')">Close</button>
            <button class="btn btn-primary" onclick="executeFromDetail()">Execute</button>
          </div>
        </div>
      </div>

      <!-- Execution Detail Modal -->
      <div id="executionDetailModal" class="modal-overlay" onclick="closeModalOnOverlay(event, 'executionDetailModal')">
        <div class="modal modal-large">
          <div class="modal-header">
            <h2 class="modal-title">Execution Details</h2>
            <button class="modal-close" onclick="closeModal('executionDetailModal')">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body" id="executionDetailBody">
            <div class="loading-overlay">
              <div class="loading-spinner lg"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('executionDetailModal')">Close</button>
            <button class="btn btn-danger hidden" id="cancelExecutionBtn" onclick="cancelExecution()">Cancel Execution</button>
          </div>
        </div>
      </div>

      <!-- Create Playbook Modal -->
      <div id="createPlaybookModal" class="modal-overlay" onclick="closeModalOnOverlay(event, 'createPlaybookModal')">
        <div class="modal modal-large">
          <div class="modal-header">
            <h2 class="modal-title">Create New Playbook</h2>
            <button class="modal-close" onclick="closeModal('createPlaybookModal')">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">Playbook YAML</label>
              <textarea class="form-textarea" id="newPlaybookContent" style="min-height: 400px;" placeholder="# Paste your playbook YAML here
    name: my_playbook
    description: My awesome playbook
    workflow:
      - name: step1
        action: log
        config:
          message: Hello World"></textarea>
              <p class="form-help">Enter the playbook definition in YAML format.</p>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createPlaybookModal')">Cancel</button>
            <button class="btn btn-primary" onclick="createPlaybook()">
              <span id="createPlaybookBtnText">Create Playbook</span>
              <span id="createPlaybookBtnSpinner" class="loading-spinner hidden"></span>
            </button>
          </div>
        </div>
      </div>

      <!-- Create Credential Modal -->
      <div id="createCredentialModal" class="modal-overlay" onclick="closeModalOnOverlay(event, 'createCredentialModal')">
        <div class="modal">
          <div class="modal-header">
            <h2 class="modal-title">Create New Credential</h2>
            <button class="modal-close" onclick="closeModal('createCredentialModal')">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">Name</label>
              <input type="text" class="form-input" id="newCredentialName" placeholder="my-api-key">
            </div>
            <div class="form-group">
              <label class="form-label">Type</label>
              <select class="form-select" id="newCredentialType">
                <option value="api_key">API Key</option>
                <option value="oauth2">OAuth2</option>
                <option value="basic">Basic Auth</option>
                <option value="ssh">SSH Key</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Description</label>
              <input type="text" class="form-input" id="newCredentialDescription" placeholder="Description of this credential">
            </div>
            <div class="form-group">
              <label class="form-label">Credential Data (JSON)</label>
              <textarea class="form-textarea" id="newCredentialData" placeholder='{"key": "value"}'>{}</textarea>
              <p class="form-help">Enter credential data as a JSON object. This data will be encrypted.</p>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createCredentialModal')">Cancel</button>
            <button class="btn btn-primary" onclick="createCredential()">Create Credential</button>
          </div>
        </div>
      </div>

      <!-- Toast Container -->
      <div class="toast-container" id="toastContainer"></div>

      <script>
        // Configuration - use DASHBOARD_API to avoid conflict with auth.js API_BASE
        // Uses window.ENV from env.js for environment-specific configuration
        const DASHBOARD_API = (window.ENV && window.ENV.gatewayUrl) || window.GATEWAY_CONFIG?.gatewayUrl || 'http://localhost:8080';
        const PROXY_BASE = `${DASHBOARD_API}/noetl`;

        // State
        let currentPage = 'dashboard';
        let playbooks = [];
        let executions = [];
        let credentials = [];
        let currentPlaybook = null;
        let currentExecution = null;

        // Initialize
        async function init() {
          const token = localStorage.getItem('session_token');
          const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');

          if (!token) {
            window.location.href = '/login.html';
            return;
          }

          // Set user info
          const name = userInfo.display_name || userInfo.email || 'User';
          document.getElementById('userName').textContent = name;
          document.getElementById('userEmail').textContent = userInfo.email || '';
          document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();

          // Load initial data
          await Promise.all([
            loadDashboardStats(),
            loadPlaybooks(),
            loadRecentExecutions()
          ]);
        }

        // API Helper
        async function apiRequest(method, endpoint, body = null) {
          const token = localStorage.getItem('session_token');
          if (!token) {
            throw new Error('Not authenticated');
          }

          const options = {
            method,
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          };

          if (body) {
            options.body = JSON.stringify(body);
          }

          const response = await fetch(`${PROXY_BASE}${endpoint}`, options);

          if (response.status === 401) {
            localStorage.removeItem('session_token');
            localStorage.removeItem('user_info');
            window.location.href = '/login.html';
            throw new Error('Session expired');
          }

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || `Request failed: ${response.status}`);
          }

          const text = await response.text();
          if (!text) return null;
          try {
            return JSON.parse(text);
          } catch {
            return text;
          }
        }

        // Page Navigation
        function showPage(page) {
          currentPage = page;

          // Hide all pages
          document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));

          // Show selected page
          document.getElementById(`page-${page}`).classList.remove('hidden');

          // Update nav
          document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.page === page);
          });

          // Load page data
          switch (page) {
            case 'dashboard':
              loadDashboardStats();
              loadRecentExecutions();
              break;
            case 'playbooks':
              loadPlaybooks();
              break;
            case 'executions':
              loadExecutions();
              break;
            case 'credentials':
              loadCredentials();
              break;
            case 'settings':
              loadSettings();
              break;
          }
        }

        // Dashboard
        async function loadDashboardStats() {
          try {
            const stats = await apiRequest('GET', '/dashboard/stats');
            document.getElementById('statPlaybooks').textContent = stats.total_playbooks || 0;
            document.getElementById('statExecutions').textContent = stats.total_executions || 0;
            document.getElementById('statActive').textContent = stats.active_executions || 0;
            document.getElementById('statSuccessRate').textContent = stats.success_rate ? `${stats.success_rate}%` : '-';

            document.getElementById('playbookBadge').textContent = stats.total_playbooks || 0;
            document.getElementById('executionBadge').textContent = stats.total_executions || 0;
          } catch (error) {
            console.error('Failed to load dashboard stats:', error);
          }
        }

        async function loadRecentExecutions() {
          const container = document.getElementById('recentExecutionsContainer');

          try {
            const data = await apiRequest('GET', '/executions?limit=10');
            executions = Array.isArray(data) ? data : (data.executions || []);

            if (executions.length === 0) {
              container.innerHTML = `
                <div class="empty-state">
                  <div class="empty-state-icon">&#128640;</div>
                  <div class="empty-state-title">No executions yet</div>
                  <div class="empty-state-description">Execute a playbook to see it here.</div>
                </div>
              `;
              return;
            }

            container.innerHTML = `
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Playbook</th>
                    <th>Status</th>
                    <th>Started</th>
                    <th>Duration</th>
                  </tr>
                </thead>
                <tbody>
                  ${executions.slice(0, 5).map(exec => `
                    <tr onclick="viewExecution('${exec.execution_id}')" style="cursor: pointer;">
                      <td class="truncate" style="max-width: 250px;">${escapeHtml(exec.path || exec.playbook_name || '-')}</td>
                      <td><span class="status-badge status-${(exec.status || 'pending').toLowerCase()}">${exec.status || 'Unknown'}</span></td>
                      <td>${exec.started_at ? formatDate(exec.started_at) : '-'}</td>
                      <td>${formatDuration(exec.duration)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          } catch (error) {
            console.error('Failed to load recent executions:', error);
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">&#9888;</div>
                <div class="empty-state-title">Failed to load executions</div>
                <div class="empty-state-description">${escapeHtml(error.message)}</div>
              </div>
            `;
          }
        }

        // Playbooks
        async function loadPlaybooks() {
          const container = document.getElementById('playbooksContainer');

          try {
            const data = await apiRequest('POST', '/catalog/list', { resource_type: 'Playbook' });
            playbooks = data.entries || [];

            // Show unique playbooks count (not total versions)
            const uniqueCount = getUniquePlaybooksByPath(playbooks).length;
            document.getElementById('playbookBadge').textContent = uniqueCount;

            if (playbooks.length === 0) {
              container.innerHTML = `
                <div class="empty-state">
                  <div class="empty-state-icon">&#128203;</div>
                  <div class="empty-state-title">No playbooks found</div>
                  <div class="empty-state-description">Create your first playbook to get started.</div>
                  <button class="btn btn-primary" style="margin-top: 1rem;" onclick="openCreatePlaybookModal()">Create Playbook</button>
                </div>
              `;
              return;
            }

            renderPlaybooks();
          } catch (error) {
            console.error('Failed to load playbooks:', error);
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">&#9888;</div>
                <div class="empty-state-title">Failed to load playbooks</div>
                <div class="empty-state-description">${escapeHtml(error.message)}</div>
              </div>
            `;
          }
        }

        // Get unique playbooks by path, keeping only the latest version
        function getUniquePlaybooksByPath(playbookList) {
          const byPath = {};
          playbookList.forEach(pb => {
            const path = pb.path;
            if (!byPath[path]) {
              byPath[path] = pb;
            } else {
              // Compare versions - keep the higher one
              const currentVersion = parseInt(byPath[path].version) || 0;
              const newVersion = parseInt(pb.version) || 0;
              if (newVersion > currentVersion) {
                byPath[path] = pb;
              }
            }
          });
          return Object.values(byPath);
        }

        // Get all versions of a playbook by path
        function getPlaybookVersions(path) {
          return playbooks
            .filter(pb => pb.path === path)
            .sort((a, b) => (parseInt(b.version) || 0) - (parseInt(a.version) || 0));
        }

        function renderPlaybooks() {
          const container = document.getElementById('playbooksContainer');
          const search = document.getElementById('playbookSearch').value.toLowerCase();
          const status = document.getElementById('playbookStatusFilter').value;

          // First filter, then deduplicate
          const filtered = playbooks.filter(pb => {
            const matchesSearch = !search ||
              (pb.path || '').toLowerCase().includes(search) ||
              (pb.description || '').toLowerCase().includes(search);
            const matchesStatus = !status || (pb.status || 'active').toLowerCase() === status;
            return matchesSearch && matchesStatus;
          });

          // Get unique playbooks (latest version only)
          const uniquePlaybooks = getUniquePlaybooksByPath(filtered);

          if (uniquePlaybooks.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">&#128269;</div>
                <div class="empty-state-title">No matching playbooks</div>
                <div class="empty-state-description">Try adjusting your search or filter.</div>
              </div>
            `;
            return;
          }

          container.innerHTML = `
            <div class="cards-grid">
              ${uniquePlaybooks.map(pb => {
                const versions = getPlaybookVersions(pb.path);
                const versionCount = versions.length;
                return `
                <div class="playbook-card" onclick="viewPlaybook('${escapeHtml(pb.path)}')">
                  <div class="playbook-card-header">
                    <div>
                      <div class="playbook-card-title">${escapeHtml(pb.path?.split('/').pop() || pb.path)}</div>
                      <div class="playbook-card-path">${escapeHtml(pb.path)}</div>
                    </div>
                    <span class="status-badge status-${(pb.status || 'active').toLowerCase()}">${pb.status || 'Active'}</span>
                  </div>
                  <div class="playbook-card-description">${escapeHtml(pb.description || 'No description')}</div>
                  <div class="playbook-card-footer">
                    <span class="playbook-card-meta">v${escapeHtml(pb.version || 'latest')}${versionCount > 1 ? ` (${versionCount} versions)` : ''}</span>
                    <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); executePlaybookDirect('${escapeHtml(pb.path)}')">Execute</button>
                  </div>
                </div>
              `;}).join('')}
            </div>
          `;
        }

        function filterPlaybooks() {
          renderPlaybooks();
        }

        async function viewPlaybook(path) {
          openModal('playbookDetailModal');
          document.getElementById('playbookDetailTitle').textContent = path;
          document.getElementById('playbookDetailBody').innerHTML = `
            <div class="loading-overlay">
              <div class="loading-spinner lg"></div>
            </div>
          `;

          try {
            const data = await apiRequest('POST', '/catalog/resource', { path, version: 'latest' });
            currentPlaybook = data;

            document.getElementById('playbookDetailBody').innerHTML = `
              <div class="execution-info-grid">
                <div class="info-item">
                  <div class="info-label">Path</div>
                  <div class="info-value mono">${escapeHtml(data.path)}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Version</div>
                  <div class="info-value">${escapeHtml(data.version || 'latest')}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Status</div>
                  <div class="info-value"><span class="status-badge status-${(data.status || 'active').toLowerCase()}">${data.status || 'Active'}</span></div>
                </div>
                <div class="info-item">
                  <div class="info-label">Catalog ID</div>
                  <div class="info-value">${data.catalog_id || '-'}</div>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Description</label>
                <p style="color: var(--gray-600);">${escapeHtml(data.description || 'No description')}</p>
              </div>

              <div class="form-group">
                <label class="form-label">Content</label>
                <pre class="code-block">${escapeHtml(data.content || JSON.stringify(data.payload, null, 2) || 'No content')}</pre>
              </div>
            `;
          } catch (error) {
            document.getElementById('playbookDetailBody').innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">&#9888;</div>
                <div class="empty-state-title">Failed to load playbook</div>
                <div class="empty-state-description">${escapeHtml(error.message)}</div>
              </div>
            `;
          }
        }

        function executeFromDetail() {
          if (!currentPlaybook) return;
          closeModal('playbookDetailModal');
          executePlaybookDirect(currentPlaybook.path);
        }

        // Executions
        async function loadExecutions() {
          const tbody = document.getElementById('executionsTableBody');

          try {
            const data = await apiRequest('GET', '/executions');
            executions = Array.isArray(data) ? data : (data.executions || []);

            document.getElementById('executionBadge').textContent = executions.length;

            if (executions.length === 0) {
              tbody.innerHTML = `
                <tr>
                  <td colspan="6">
                    <div class="empty-state">
                      <div class="empty-state-icon">&#128640;</div>
                      <div class="empty-state-title">No executions yet</div>
                    </div>
                  </td>
                </tr>
              `;
              return;
            }

            renderExecutions();
          } catch (error) {
            console.error('Failed to load executions:', error);
            tbody.innerHTML = `
              <tr>
                <td colspan="6">
                  <div class="empty-state">
                    <div class="empty-state-icon">&#9888;</div>
                    <div class="empty-state-title">Failed to load executions</div>
                    <div class="empty-state-description">${escapeHtml(error.message)}</div>
                  </div>
                </td>
              </tr>
            `;
          }
        }

        function renderExecutions() {
          const tbody = document.getElementById('executionsTableBody');
          const search = document.getElementById('executionSearch').value.toLowerCase();
          const status = document.getElementById('executionStatusFilter').value;

          const filtered = executions.filter(exec => {
            const matchesSearch = !search ||
              (exec.execution_id || '').toString().includes(search) ||
              (exec.path || exec.playbook_name || '').toLowerCase().includes(search);
            const matchesStatus = !status || (exec.status || '').toLowerCase() === status;
            return matchesSearch && matchesStatus;
          });

          if (filtered.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="6">
                  <div class="empty-state">
                    <div class="empty-state-icon">&#128269;</div>
                    <div class="empty-state-title">No matching executions</div>
                  </div>
                </td>
              </tr>
            `;
            return;
          }

          tbody.innerHTML = filtered.map(exec => `
            <tr>
              <td><code>${exec.execution_id}</code></td>
              <td class="truncate" style="max-width: 200px;">${escapeHtml(exec.path || exec.playbook_name || '-')}</td>
              <td><span class="status-badge status-${(exec.status || 'pending').toLowerCase()}">${exec.status || 'Unknown'}</span></td>
              <td>${exec.started_at ? formatDate(exec.started_at) : '-'}</td>
              <td>${formatDuration(exec.duration)}</td>
              <td>
                <button class="btn btn-sm btn-ghost" onclick="viewExecution('${exec.execution_id}')">View</button>
              </td>
            </tr>
          `).join('');
        }

        function filterExecutions() {
          renderExecutions();
        }

        async function viewExecution(executionId) {
          openModal('executionDetailModal');
          currentExecution = { execution_id: executionId };
          document.getElementById('cancelExecutionBtn').classList.add('hidden');
          document.getElementById('executionDetailBody').innerHTML = `
            <div class="loading-overlay">
              <div class="loading-spinner lg"></div>
            </div>
          `;

          try {
            const data = await apiRequest('GET', `/executions/${executionId}`);
            currentExecution = data;

            const isRunning = ['running', 'pending', 'queued'].includes((data.status || '').toLowerCase());
            if (isRunning) {
              document.getElementById('cancelExecutionBtn').classList.remove('hidden');
            }

            const events = data.events || [];

            document.getElementById('executionDetailBody').innerHTML = `
              <div class="execution-info-grid">
                <div class="info-item">
                  <div class="info-label">Execution ID</div>
                  <div class="info-value mono">${data.execution_id}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Playbook</div>
                  <div class="info-value">${escapeHtml(data.path || data.playbook_name || '-')}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Catalog ID</div>
                  <div class="info-value mono">${data.catalog_id || '-'}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Version</div>
                  <div class="info-value">${data.version || '-'}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Status</div>
                  <div class="info-value"><span class="status-badge status-${(data.status || 'pending').toLowerCase()}">${data.status || 'Unknown'}</span></div>
                </div>
                <div class="info-item">
                  <div class="info-label">Duration</div>
                  <div class="info-value">${formatDuration(data.duration)}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Started</div>
                  <div class="info-value">${data.started_at ? formatDate(data.started_at) : '-'}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Completed</div>
                  <div class="info-value">${data.completed_at ? formatDate(data.completed_at) : '-'}</div>
                </div>
              </div>

              ${data.error ? `
                <div style="background: rgba(229, 62, 62, 0.1); border: 1px solid var(--danger); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                  <strong style="color: var(--danger);">Error:</strong>
                  <p style="color: var(--gray-700); margin-top: 0.5rem;">${escapeHtml(data.error)}</p>
                </div>
              ` : ''}

              ${data.result ? `
                <div class="form-group">
                  <label class="form-label">Result</label>
                  <pre class="code-block">${JSON.stringify(data.result, null, 2)}</pre>
                </div>
              ` : ''}

              <div class="form-group">
                <label class="form-label">Events (${events.length})</label>
                ${events.length > 0 ? `
                  <div class="events-timeline">
                    ${events.map(event => `
                      <div class="event-item ${(event.status || '').toLowerCase()}">
                        <div class="event-header">
                          <span class="event-name">${escapeHtml(event.node_name || event.event_type || 'Event')}</span>
                          <span class="event-time">${event.timestamp ? formatDate(event.timestamp) : ''}</span>
                        </div>
                        <div class="event-details">
                          <span class="status-badge status-${(event.status || 'pending').toLowerCase()}">${event.status || 'Unknown'}</span>
                          ${event.duration ? ` - ${formatDuration(event.duration)}` : ''}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                ` : '<p style="color: var(--gray-500);">No events recorded.</p>'}
              </div>
            `;
          } catch (error) {
            document.getElementById('executionDetailBody').innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">&#9888;</div>
                <div class="empty-state-title">Failed to load execution</div>
                <div class="empty-state-description">${escapeHtml(error.message)}</div>
              </div>
            `;
          }
        }

        async function cancelExecution() {
          if (!currentExecution) return;

          if (!confirm('Are you sure you want to cancel this execution?')) return;

          try {
            await apiRequest('POST', `/executions/${currentExecution.execution_id}/cancel`, {
              reason: 'Cancelled by user',
              cascade: true
            });
            showToast('success', 'Execution Cancelled', 'The execution has been cancelled.');
            closeModal('executionDetailModal');
            loadExecutions();
            loadRecentExecutions();
          } catch (error) {
            showToast('error', 'Failed to Cancel', error.message);
          }
        }

        // Credentials
        async function loadCredentials() {
          const tbody = document.getElementById('credentialsTableBody');

          try {
            const data = await apiRequest('GET', '/credentials');
            credentials = data.items || [];

            if (credentials.length === 0) {
              tbody.innerHTML = `
                <tr>
                  <td colspan="5">
                    <div class="empty-state">
                      <div class="empty-state-icon">&#128274;</div>
                      <div class="empty-state-title">No credentials found</div>
                      <div class="empty-state-description">Create your first credential to get started.</div>
                    </div>
                  </td>
                </tr>
              `;
              return;
            }

            tbody.innerHTML = credentials.map(cred => `
              <tr>
                <td><strong>${escapeHtml(cred.name)}</strong></td>
                <td><span class="status-badge">${escapeHtml(cred.credential_type || 'custom')}</span></td>
                <td class="truncate" style="max-width: 300px;">${escapeHtml(cred.description || '-')}</td>
                <td>${cred.created_at ? formatDate(cred.created_at) : '-'}</td>
                <td>
                  <button class="btn btn-sm btn-ghost" onclick="deleteCredential('${escapeHtml(cred.id || cred.name)}')">Delete</button>
                </td>
              </tr>
            `).join('');
          } catch (error) {
            console.error('Failed to load credentials:', error);
            tbody.innerHTML = `
              <tr>
                <td colspan="5">
                  <div class="empty-state">
                    <div class="empty-state-icon">&#9888;</div>
                    <div class="empty-state-title">Failed to load credentials</div>
                    <div class="empty-state-description">${escapeHtml(error.message)}</div>
                  </div>
                </td>
              </tr>
            `;
          }
        }

        async function createCredential() {
          const name = document.getElementById('newCredentialName').value.trim();
          const type = document.getElementById('newCredentialType').value;
          const description = document.getElementById('newCredentialDescription').value.trim();
          const dataText = document.getElementById('newCredentialData').value;

          if (!name) {
            showToast('error', 'Validation Error', 'Please enter a credential name.');
            return;
          }

          let data;
          try {
            data = JSON.parse(dataText);
          } catch {
            showToast('error', 'Validation Error', 'Invalid JSON in credential data.');
            return;
          }

          try {
            await apiRequest('POST', '/credentials', {
              name,
              credential_type: type,
              description,
              data
            });
            showToast('success', 'Credential Created', `Credential "${name}" has been created.`);
            closeModal('createCredentialModal');
            loadCredentials();
          } catch (error) {
            showToast('error', 'Failed to Create', error.message);
          }
        }

        async function deleteCredential(identifier) {
          if (!confirm(`Are you sure you want to delete credential "${identifier}"?`)) return;

          try {
            await apiRequest('DELETE', `/credentials/${identifier}`);
            showToast('success', 'Credential Deleted', `Credential "${identifier}" has been deleted.`);
            loadCredentials();
          } catch (error) {
            showToast('error', 'Failed to Delete', error.message);
          }
        }

        // Settings
        function loadSettings() {
          const token = localStorage.getItem('session_token');
          const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');

          document.getElementById('settingsGatewayUrl').value = DASHBOARD_API;
          document.getElementById('settingsSessionToken').value = token || '';
          document.getElementById('settingsUserInfo').textContent = JSON.stringify(userInfo, null, 2);
        }

        // Execute Modal - state
        let executeMode = 'select'; // 'select' (from header) or 'direct' (from card)
        let executeSelectedPath = null;

        // Open execute modal from header button (select playbook from dropdown)
        async function openExecuteModal() {
          executeMode = 'select';
          executeSelectedPath = null;

          openModal('executeModal');
          document.getElementById('executeResult').classList.add('hidden');
          document.getElementById('executePlaybookDetails').classList.add('hidden');
          document.getElementById('executeVariables').value = '{}';
          document.getElementById('executeBtn').disabled = true;

          // Show playbook dropdown, hide fixed path and version
          document.getElementById('executePlaybookSelectGroup').classList.remove('hidden');
          document.getElementById('executePlaybookFixedGroup').classList.add('hidden');
          document.getElementById('executeVersionGroup').classList.add('hidden');

          const select = document.getElementById('executePlaybookSelect');
          select.innerHTML = '<option value="">-- Select a playbook --</option>';

          if (playbooks.length === 0) {
            await loadPlaybooks();
          }

          // Show only unique playbooks (latest version)
          const uniquePlaybooks = getUniquePlaybooksByPath(playbooks);
          uniquePlaybooks.forEach(pb => {
            const option = document.createElement('option');
            option.value = pb.path;
            option.textContent = pb.path;
            option.dataset.path = pb.path;
            option.dataset.catalogId = pb.catalog_id;
            option.dataset.description = pb.description || '';
            select.appendChild(option);
          });
        }

        // Called when playbook is selected from dropdown (header button mode)
        function onExecutePlaybookChange() {
          const select = document.getElementById('executePlaybookSelect');
          const option = select.options[select.selectedIndex];

          if (!select.value) {
            document.getElementById('executePlaybookDetails').classList.add('hidden');
            document.getElementById('executeVersionGroup').classList.add('hidden');
            document.getElementById('executeBtn').disabled = true;
            return;
          }

          const path = option.dataset.path;
          executeSelectedPath = path;

          // Populate version dropdown
          populateVersionDropdown(path);
          document.getElementById('executeVersionGroup').classList.remove('hidden');

          document.getElementById('executePlaybookDescription').textContent = option.dataset.description || 'No description';
          document.getElementById('executePlaybookDetails').classList.remove('hidden');
          document.getElementById('executeBtn').disabled = false;
        }

        // Populate version dropdown for a given playbook path
        function populateVersionDropdown(path) {
          const versions = getPlaybookVersions(path);
          const versionSelect = document.getElementById('executeVersionSelect');
          versionSelect.innerHTML = '';

          versions.forEach((pb, idx) => {
            const option = document.createElement('option');
            option.value = pb.catalog_id;
            option.textContent = `v${pb.version || 'latest'}${idx === 0 ? ' (latest)' : ''}`;
            option.dataset.path = pb.path;
            option.dataset.catalogId = pb.catalog_id;
            option.dataset.description = pb.description || '';
            option.dataset.version = pb.version || 'latest';
            versionSelect.appendChild(option);
          });
        }

        // Called when version is changed
        function onExecuteVersionChange() {
          const versionSelect = document.getElementById('executeVersionSelect');
          const option = versionSelect.options[versionSelect.selectedIndex];
          if (option && option.dataset.description) {
            document.getElementById('executePlaybookDescription').textContent = option.dataset.description || 'No description';
          }
        }

        async function executePlaybook() {
          let path;
          let version;
          let catalogId;
          const variablesText = document.getElementById('executeVariables').value;

          // Get path based on mode
          if (executeMode === 'select') {
            const select = document.getElementById('executePlaybookSelect');
            const option = select.options[select.selectedIndex];
            path = option.dataset.path;
          } else {
            path = executeSelectedPath;
          }

          // Get selected version and catalog_id from version dropdown
          const versionSelect = document.getElementById('executeVersionSelect');
          const versionOption = versionSelect.options[versionSelect.selectedIndex];
          if (versionOption) {
            version = versionOption.dataset.version;
            catalogId = versionOption.dataset.catalogId;
          }

          if (!path && !catalogId) {
            showToast('error', 'Validation Error', 'No playbook selected.');
            return;
          }

          let payload;
          try {
            payload = JSON.parse(variablesText);
          } catch {
            showToast('error', 'Validation Error', 'Invalid JSON in variables.');
            return;
          }

          document.getElementById('executeBtn').disabled = true;
          document.getElementById('executeBtnText').classList.add('hidden');
          document.getElementById('executeBtnSpinner').classList.remove('hidden');

          // Debug: log what we're sending
          console.log('Executing playbook:', { path, version, catalogId });

          try {
            // Build request with path + version (preferred since backend now supports it)
            // Note: catalog_id has JS precision issues with large numbers, so we use path + version
            const requestBody = {
              path: path,
              args: payload
            };

            // Add version to run specific version (not "latest")
            if (version && version !== 'latest') {
              requestBody.version = String(version);
            }

            console.log('Request body:', JSON.stringify(requestBody));
            const result = await apiRequest('POST', '/run/playbook', requestBody);

            document.getElementById('executeResult').innerHTML = `
              <div style="background: rgba(72, 187, 120, 0.1); border: 1px solid var(--success); border-radius: 8px; padding: 1rem;">
                <strong style="color: var(--success);">Execution Started</strong>
                <p style="margin-top: 0.5rem;">Execution ID: <code>${result.execution_id}</code></p>
                <button class="btn btn-sm btn-primary" style="margin-top: 0.5rem;" onclick="closeModal('executeModal'); viewExecution('${result.execution_id}')">View Details</button>
              </div>
            `;
            document.getElementById('executeResult').classList.remove('hidden');

            loadDashboardStats();
            loadRecentExecutions();
            loadExecutions();

          } catch (error) {
            document.getElementById('executeResult').innerHTML = `
              <div style="background: rgba(229, 62, 62, 0.1); border: 1px solid var(--danger); border-radius: 8px; padding: 1rem;">
                <strong style="color: var(--danger);">Execution Failed</strong>
                <p style="margin-top: 0.5rem;">${escapeHtml(error.message)}</p>
              </div>
            `;
            document.getElementById('executeResult').classList.remove('hidden');
          }

          document.getElementById('executeBtn').disabled = false;
          document.getElementById('executeBtnText').classList.remove('hidden');
          document.getElementById('executeBtnSpinner').classList.add('hidden');
        }

        // Open execute modal for a specific playbook (from card button)
        async function executePlaybookDirect(path) {
          executeMode = 'direct';
          executeSelectedPath = path;

          openModal('executeModal');
          document.getElementById('executeResult').classList.add('hidden');
          document.getElementById('executeVariables').value = '{}';

          // Hide playbook dropdown, show fixed path and version selector
          document.getElementById('executePlaybookSelectGroup').classList.add('hidden');
          document.getElementById('executePlaybookFixedGroup').classList.remove('hidden');
          document.getElementById('executeVersionGroup').classList.remove('hidden');
          document.getElementById('executePlaybookDetails').classList.remove('hidden');

          // Set playbook path
          document.getElementById('executePlaybookPath').value = path;

          if (playbooks.length === 0) {
            await loadPlaybooks();
          }

          // Populate version dropdown
          populateVersionDropdown(path);

          // Set description from latest version
          const versions = getPlaybookVersions(path);
          if (versions.length > 0) {
            document.getElementById('executePlaybookDescription').textContent = versions[0].description || 'No description';
          }

          document.getElementById('executeBtn').disabled = false;
        }

        // Create Playbook
        function openCreatePlaybookModal() {
          document.getElementById('newPlaybookContent').value = '';
          openModal('createPlaybookModal');
        }

        async function createPlaybook() {
          const content = document.getElementById('newPlaybookContent').value.trim();

          if (!content) {
            showToast('error', 'Validation Error', 'Please enter playbook content.');
            return;
          }

          document.getElementById('createPlaybookBtnText').classList.add('hidden');
          document.getElementById('createPlaybookBtnSpinner').classList.remove('hidden');

          try {
            const result = await apiRequest('POST', '/catalog/register', {
              content,
              resource_type: 'Playbook'
            });

            showToast('success', 'Playbook Created', `Playbook "${result.path || 'new'}" has been created.`);
            closeModal('createPlaybookModal');
            loadPlaybooks();
            loadDashboardStats();

          } catch (error) {
            showToast('error', 'Failed to Create', error.message);
          }

          document.getElementById('createPlaybookBtnText').classList.remove('hidden');
          document.getElementById('createPlaybookBtnSpinner').classList.add('hidden');
        }

        function openCreateCredentialModal() {
          document.getElementById('newCredentialName').value = '';
          document.getElementById('newCredentialType').value = 'api_key';
          document.getElementById('newCredentialDescription').value = '';
          document.getElementById('newCredentialData').value = '{}';
          openModal('createCredentialModal');
        }

        // Modal helpers
        function openModal(modalId) {
          document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
          document.getElementById(modalId).classList.remove('active');
        }

        function closeModalOnOverlay(event, modalId) {
          if (event.target.classList.contains('modal-overlay')) {
            closeModal(modalId);
          }
        }

        // Toast notifications
        function showToast(type, title, message) {
          const container = document.getElementById('toastContainer');
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;

          const icons = {
            success: '&#10003;',
            error: '&#10007;',
            info: 'i'
          };

          toast.innerHTML = `
            <span class="toast-icon">${icons[type] || icons.info}</span>
            <div class="toast-content">
              <div class="toast-title">${escapeHtml(title)}</div>
              <div class="toast-message">${escapeHtml(message)}</div>
            </div>
          `;

          container.appendChild(toast);

          setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100px)';
            setTimeout(() => toast.remove(), 300);
          }, 5000);
        }

        // Utility functions
        function escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        function formatDate(dateStr) {
          if (!dateStr) return '-';
          const date = new Date(dateStr);
          return date.toLocaleString();
        }

        function formatDuration(seconds) {
          if (!seconds && seconds !== 0) return '-';
          if (seconds < 1) return `${Math.round(seconds * 1000)}ms`;
          if (seconds < 60) return `${seconds.toFixed(1)}s`;
          const minutes = Math.floor(seconds / 60);
          const secs = Math.round(seconds % 60);
          return `${minutes}m ${secs}s`;
        }

        function logout() {
          if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('session_token');
            localStorage.removeItem('user_info');
            window.location.href = '/login.html';
          }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
      </script>
    </body>
    </html>
  env.js: |
    // Environment Configuration for Gateway UI
    //
    // This file provides environment-specific configuration.
    // Modify this file to point to different gateway endpoints.
    //
    // Environments:
    //   - local:  Direct localhost (cargo run)
    //   - kind:   Kind Kubernetes cluster with NodePort
    //   - gke:    Google Kubernetes Engine (production)

    (function() {
      // Environment detection based on hostname
      const hostname = window.location.hostname;
      const port = window.location.port;

      // Determine environment
      // Default to 'kind' for localhost since that's the typical dev setup
      // (UI on 8080, gateway on 8090 via Kind port mapping)
      let detectedEnv = 'kind';

      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        // Port 8080 = UI server, gateway is on 8090 -> use 'kind'
        // Port 8090 = gateway directly (rare, testing only) -> use 'local'
        // Port 30000+ = inside cluster -> use 'kind'
        if (port === '8090') {
          detectedEnv = 'local';
        } else {
          detectedEnv = 'kind';
        }
      } else if (hostname.includes('mestumre.dev') || hostname.includes('noetl.io')) {
        detectedEnv = 'gke';
      }

      // Allow manual override via URL parameter: ?env=kind
      const urlParams = new URLSearchParams(window.location.search);
      const envOverride = urlParams.get('env');
      if (envOverride && ['local', 'kind', 'gke'].includes(envOverride)) {
        detectedEnv = envOverride;
      }

      // Environment-specific configurations
      // Port mappings from ci/kind/config.yaml:
      //   - Gateway API: containerPort 30090 -> hostPort 8090
      //   - Gateway UI: containerPort 30080 -> hostPort 8080
      const configs = {
        local: {
          name: 'Local Development',
          gatewayUrl: 'http://localhost:8080',
          description: 'Direct connection to locally running gateway (cargo run)'
        },
        kind: {
          name: 'Kind Kubernetes Cluster',
          gatewayUrl: 'http://localhost:8090',
          description: 'Connection via Kind port mapping (hostPort 8090 -> containerPort 30090)'
        },
        gke: {
          name: 'GKE Production',
          gatewayUrl: 'https://gateway.mestumre.dev',
          description: 'Production Google Kubernetes Engine deployment'
        }
      };

      // Export configuration globally
      const config = configs[detectedEnv];

      window.ENV = {
        current: detectedEnv,
        name: config.name,
        gatewayUrl: config.gatewayUrl,
        description: config.description,

        // Helper to get full API URL
        apiUrl: function(path) {
          return this.gatewayUrl + (path.startsWith('/') ? path : '/' + path);
        },

        // Log current environment
        log: function() {
          console.log(`[ENV] ${this.name} (${this.current})`);
          console.log(`[ENV] Gateway: ${this.gatewayUrl}`);
        }
      };

      // Auto-log on load
      window.ENV.log();
    })();
  index.html: |-
    <!DOCTYPE html>
    <html lang="en">

    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Cybx AI Flight Assistant</title>
      <link rel="stylesheet" href="/styles.css">
    </head>

    <body>
      <div class="container">
        <div class="chat-header">
          <div class="header-content">
            <div class="avatar">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path
                  d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                </path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
              </svg>
            </div>
            <div class="header-info">
              <h1>Cybx AI</h1>
              <p>Your intelligent flight search assistant</p>
            </div>
            <div class="user-menu">
              <span id="connectionStatus" class="status-indicator status-disconnected" title="Connecting..."></span>
              <span id="userDisplay" class="user-name"></span>
              <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>
          </div>
        </div>

        <div class="chat-container" id="chatContainer">
          <div class="welcome-message">
            <div class="welcome-icon">✈️</div>
            <h2>Welcome to Cybx AI</h2>
            <p>I can help you find flights. Try asking something like:</p>
            <div class="suggestions">
              <button class="suggestion-chip"
                onclick="sendSuggestion('I want a one-way flight from SFO to JFK on March 15, 2026 for 1 adult')">
                Find flights from SFO to JFK
              </button>
              <button class="suggestion-chip"
                onclick="sendSuggestion('Show me flights from LAX to Miami next week for 2 passengers')">
                LAX to Miami for 2 people
              </button>
              <button class="suggestion-chip"
                onclick="sendSuggestion('I need a round trip from New York to London in April')">
                Round trip NY to London
              </button>
            </div>
          </div>
        </div>

        <div class="chat-input-container">
          <form id="chatForm" class="chat-form">
            <input type="text" id="chatInput" class="chat-input"
              placeholder="Ask about flights, e.g., 'I want to fly from SFO to JFK tomorrow'" autocomplete="off" />
            <button type="submit" class="send-button" id="sendButton">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </form>
        </div>
      </div>

      <script src="/env.js"></script>
      <script src="/auth.js"></script>
      <script src="/app.js"></script>
    </body>

    </html>
  login.html: "<!DOCTYPE html>\n<html lang=\"en\">\n\n<head>\n  <meta charset=\"UTF-8\">\n
    \ <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n
    \ <title>Login - Cybx AI Gateway</title>\n  <script src=\"/env.js\"></script>\n
    \ <script src=\"/config.js\"></script>\n  <link rel=\"stylesheet\" href=\"/styles.css\">\n
    \ <style>\n    body {\n      display: flex;\n      align-items: center;\n      justify-content:
    center;\n      min-height: 100vh;\n      background: linear-gradient(135deg, #667eea
    0%, #764ba2 100%);\n      margin: 0;\n      font-family: -apple-system, BlinkMacSystemFont,
    'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;\n    }\n\n    .login-container
    {\n      background: white;\n      border-radius: 16px;\n      box-shadow: 0 20px
    60px rgba(0, 0, 0, 0.3);\n      padding: 3rem;\n      width: 100%;\n      max-width:
    420px;\n      animation: slideUp 0.4s ease-out;\n    }\n\n    @keyframes slideUp
    {\n      from {\n        opacity: 0;\n        transform: translateY(30px);\n      }\n\n
    \     to {\n        opacity: 1;\n        transform: translateY(0);\n      }\n
    \   }\n\n    .login-header {\n      text-align: center;\n      margin-bottom:
    2rem;\n    }\n\n    .login-header h1 {\n      font-size: 1.75rem;\n      font-weight:
    700;\n      color: #1a202c;\n      margin: 0 0 0.5rem 0;\n    }\n\n    .login-header
    p {\n      font-size: 0.95rem;\n      color: #718096;\n      margin: 0;\n    }\n\n
    \   .logo {\n      width: 64px;\n      height: 64px;\n      margin: 0 auto 1rem;\n
    \     background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      border-radius:
    16px;\n      display: flex;\n      align-items: center;\n      justify-content:
    center;\n    }\n\n    .logo svg {\n      width: 36px;\n      height: 36px;\n      stroke:
    white;\n    }\n\n    .form-group {\n      margin-bottom: 1.5rem;\n    }\n\n    .form-group
    label {\n      display: block;\n      font-size: 0.9rem;\n      font-weight: 600;\n
    \     color: #2d3748;\n      margin-bottom: 0.5rem;\n    }\n\n    .form-group
    input {\n      width: 100%;\n      padding: 0.875rem 1rem;\n      font-size: 1rem;\n
    \     border: 2px solid #e2e8f0;\n      border-radius: 8px;\n      box-sizing:
    border-box;\n      transition: all 0.2s;\n      outline: none;\n    }\n\n    .form-group
    input:focus {\n      border-color: #667eea;\n      box-shadow: 0 0 0 3px rgba(102,
    126, 234, 0.1);\n    }\n\n    .form-group input::placeholder {\n      color: #a0aec0;\n
    \   }\n\n    .btn-login {\n      width: 100%;\n      padding: 1rem;\n      font-size:
    1rem;\n      font-weight: 600;\n      color: white;\n      background: linear-gradient(135deg,
    #667eea 0%, #764ba2 100%);\n      border: none;\n      border-radius: 8px;\n      cursor:
    pointer;\n      transition: all 0.2s;\n      outline: none;\n    }\n\n    .btn-login:hover:not(:disabled)
    {\n      transform: translateY(-2px);\n      box-shadow: 0 8px 20px rgba(102,
    126, 234, 0.4);\n    }\n\n    .btn-login:disabled {\n      opacity: 0.6;\n      cursor:
    not-allowed;\n    }\n\n    .auth0-section {\n      margin: 2rem 0;\n      padding:
    1.5rem;\n      background: #f7fafc;\n      border-radius: 8px;\n      border:
    2px dashed #cbd5e0;\n    }\n\n    .auth0-section h3 {\n      font-size: 0.9rem;\n
    \     font-weight: 600;\n      color: #2d3748;\n      margin: 0 0 1rem 0;\n      text-align:
    center;\n    }\n\n    .divider {\n      display: flex;\n      align-items: center;\n
    \     margin: 1.5rem 0;\n      color: #a0aec0;\n      font-size: 0.85rem;\n    }\n\n
    \   .divider::before,\n    .divider::after {\n      content: '';\n      flex:
    1;\n      height: 1px;\n      background: #e2e8f0;\n    }\n\n    .divider span
    {\n      padding: 0 1rem;\n    }\n\n    .alert {\n      padding: 1rem;\n      border-radius:
    8px;\n      margin-bottom: 1.5rem;\n      font-size: 0.9rem;\n      display: none;\n
    \   }\n\n    .alert.error {\n      background: #fed7d7;\n      color: #c53030;\n
    \     border: 1px solid #fc8181;\n    }\n\n    .alert.success {\n      background:
    #c6f6d5;\n      color: #2f855a;\n      border: 1px solid #9ae6b4;\n    }\n\n    .alert.show
    {\n      display: block;\n      animation: slideDown 0.3s ease-out;\n    }\n\n
    \   @keyframes slideDown {\n      from {\n        opacity: 0;\n        transform:
    translateY(-10px);\n      }\n\n      to {\n        opacity: 1;\n        transform:
    translateY(0);\n      }\n    }\n\n    .spinner {\n      display: inline-block;\n
    \     width: 16px;\n      height: 16px;\n      border: 2px solid rgba(255, 255,
    255, 0.3);\n      border-radius: 50%;\n      border-top-color: white;\n      animation:
    spin 0.8s linear infinite;\n      margin-right: 0.5rem;\n    }\n\n    @keyframes
    spin {\n      to {\n        transform: rotate(360deg);\n      }\n    }\n\n    .footer-links
    {\n      text-align: center;\n      margin-top: 1.5rem;\n      font-size: 0.85rem;\n
    \     color: #718096;\n    }\n\n    .footer-links a {\n      color: #667eea;\n
    \     text-decoration: none;\n    }\n\n    .footer-links a:hover {\n      text-decoration:
    underline;\n    }\n  </style>\n</head>\n\n<body>\n  <div class=\"login-container\">\n
    \   <div class=\"login-header\">\n      <div class=\"logo\">\n        <svg xmlns=\"http://www.w3.org/2000/svg\"
    viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"\n
    \         stroke-linecap=\"round\" stroke-linejoin=\"round\">\n          <path\n
    \           d=\"M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3
    8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z\">\n          </path>\n
    \         <polyline points=\"3.27 6.96 12 12.01 20.73 6.96\"></polyline>\n          <line
    x1=\"12\" y1=\"22.08\" x2=\"12\" y2=\"12\"></line>\n        </svg>\n      </div>\n
    \     <h1>Welcome to Cybx AI Gateway</h1>\n      <p>Sign in to access the platform</p>\n
    \   </div>\n\n    <div id=\"alert\" class=\"alert\"></div>\n\n    <!-- Auth0 Login
    Section -->\n    <div class=\"auth0-section\">\n      <h3>\U0001F510 Auth0 Login
    (Production)</h3>\n      <p style=\"font-size: 0.9rem; color: #718096; margin-bottom:
    1rem;\">\n        Click below to sign in via Auth0 Universal Login\n      </p>\n
    \     <button type=\"button\" class=\"btn-login\" id=\"auth0LoginBtn\" onclick=\"loginWithAuth0()\">\n
    \       Sign In with Auth0\n      </button>\n    </div>\n\n    <div class=\"divider\">\n
    \     <span>OR</span>\n    </div>\n\n    <!-- Direct Login Section (for testing)
    -->\n    <form id=\"directLoginForm\">\n      <div class=\"form-group\">\n        <label
    for=\"sessionToken\">Session Token (Testing)</label>\n        <input type=\"text\"
    id=\"sessionToken\" placeholder=\"Direct session token for testing\">\n      </div>\n
    \     <button type=\"submit\" class=\"btn-login\" id=\"directSubmitBtn\">\n        Sign
    In with Token\n      </button>\n    </form>\n\n    <div class=\"footer-links\">\n
    \     Need help? <a href=\"mailto:support@cybx.ai\">Contact Support</a>\n    </div>\n
    \ </div>\n\n  <script>\n    // Gateway API - configured via env.js\n    // Uses
    window.ENV.gatewayUrl set by environment detection\n    function getGatewayApi()
    {\n      if (window.ENV && window.ENV.gatewayUrl) {\n        return window.ENV.gatewayUrl;\n
    \     }\n      console.warn('[login.js] ENV not loaded, using fallback localhost:8080');\n
    \     return 'http://localhost:8080';\n    }\n\n    // Lazy-initialized URLs\n
    \   let _gatewayApi = null;\n    function getAuthLoginUrl() {\n      if (!_gatewayApi)
    _gatewayApi = getGatewayApi();\n      return `${_gatewayApi}/api/auth/login`;\n
    \   }\n    function getAuthValidateUrl() {\n      if (!_gatewayApi) _gatewayApi
    = getGatewayApi();\n      return `${_gatewayApi}/api/auth/validate`;\n    }\n\n
    \   // Auth0 Universal Login redirect\n    function loginWithAuth0() {\n      const
    auth0Domain = auth0Config.domain;\n      const clientId = auth0Config.clientId;\n
    \     const redirectUri = auth0Config.redirectUri;\n      \n      // Build Auth0
    authorization URL - request id_token for userinfo access\n      const authUrl
    = `https://${auth0Domain}/authorize?` +\n        `response_type=id_token token&`
    +\n        `client_id=${clientId}&` +\n        `redirect_uri=${encodeURIComponent(redirectUri)}&`
    +\n        `scope=openid profile email&` +\n        `nonce=${Math.random().toString(36).substring(7)}`;\n
    \     \n      // Redirect to Auth0 login page\n      window.location.href = authUrl;\n
    \   }\n\n    // Handle Auth0 callback (token in URL hash)\n    window.addEventListener('DOMContentLoaded',
    async () => {\n      // Check if we have a token from Auth0 redirect\n      const
    hash = window.location.hash;\n      if (hash && (hash.includes('access_token=')
    || hash.includes('id_token='))) {\n        const params = new URLSearchParams(hash.substring(1));\n
    \       const accessToken = params.get('access_token');\n        const idToken
    = params.get('id_token');\n\n        if (accessToken && idToken) {\n          showAlert('Processing
    Auth0 login...', 'info');\n\n          try {\n            // Call Gateway's auth
    login endpoint with the Auth0 tokens\n            const response = await fetch(getAuthLoginUrl(),
    {\n              method: 'POST',\n              headers: {'Content-Type': 'application/json'},\n
    \             body: JSON.stringify({\n                auth0_token: idToken,\n
    \               auth0_domain: auth0Config.domain\n              })\n            });\n\n
    \           if (response.ok) {\n              const data = await response.json();\n\n
    \             if (data.session_token) {\n                // Store session token
    and user info\n                localStorage.setItem('session_token', data.session_token);\n
    \               if (data.user) {\n                  localStorage.setItem('user_info',
    JSON.stringify(data.user));\n                }\n\n                showAlert('Login
    successful! Redirecting...', 'success');\n\n                // Clean URL hash
    and redirect\n                window.location.hash = '';\n                setTimeout(()
    => {\n                  window.location.href = '/dashboard.html';\n                },
    1000);\n              } else {\n                throw new Error('No session token
    in response');\n              }\n            } else {\n              const errorData
    = await response.json().catch(() => ({}));\n              throw new Error(errorData.error
    || `Login failed: ${response.status}`);\n            }\n          } catch (error)
    {\n            console.error('Auth0 callback error:', error);\n            showAlert('Auth0
    login failed: ' + error.message, 'error');\n            // Clean URL hash\n            window.location.hash
    = '';\n          }\n          return;\n        }\n      }\n\n      // Check if
    already logged in with session token\n      // Use \"soft\" auth - if token AND
    user_info exist, redirect without backend validation\n      // This enables testing
    while backend validation playbook is being fixed\n      const token = localStorage.getItem('session_token');\n
    \     const userInfo = localStorage.getItem('user_info');\n      if (token &&
    userInfo) {\n        window.location.href = '/dashboard.html';\n        return;\n
    \     } else if (token && !userInfo) {\n        // Token exists but no user_info
    - try to validate\n        const valid = await validateSession(token);\n        if
    (valid) {\n          window.location.href = '/dashboard.html';\n        } else
    {\n          // Token is invalid, clear it\n          localStorage.removeItem('session_token');\n
    \       }\n        return;\n      }\n    });\n\n    // Direct token login form
    handler\n    document.getElementById('directLoginForm').addEventListener('submit',
    async (e) => {\n      e.preventDefault();\n\n      const sessionToken = document.getElementById('sessionToken').value.trim();\n\n
    \     if (!sessionToken) {\n        showAlert('Please enter a session token',
    'error');\n        return;\n      }\n\n      const submitBtn = document.getElementById('directSubmitBtn');\n
    \     submitBtn.disabled = true;\n      submitBtn.innerHTML = '<span class=\"spinner\"></span>
    Validating...';\n\n      try {\n        const valid = await validateSession(sessionToken);\n\n
    \       if (valid) {\n          // Session is valid, store and redirect\n          localStorage.setItem('session_token',
    sessionToken);\n          showAlert('Session validated successfully!', 'success');\n\n
    \         setTimeout(() => {\n            window.location.href = '/dashboard.html';\n
    \         }, 1000);\n        } else {\n          throw new Error('Invalid or expired
    session token');\n        }\n      } catch (error) {\n        console.error('Direct
    login error:', error);\n        showAlert(error.message || 'Token validation failed',
    'error');\n        submitBtn.disabled = false;\n        submitBtn.innerHTML =
    'Sign In with Token';\n      }\n    });\n\n    // Validate session helper - calls
    Gateway API\n    async function validateSession(token) {\n      try {\n        const
    response = await fetch(getAuthValidateUrl(), {\n          method: 'POST',\n          headers:
    {\n            'Content-Type': 'application/json',\n          },\n          body:
    JSON.stringify({\n            session_token: token\n          }),\n        });\n\n
    \       if (!response.ok) {\n          console.error('Session validation failed:',
    response.status);\n          return false;\n        }\n\n        const data =
    await response.json();\n\n        if (data.valid && data.user) {\n          localStorage.setItem('user_info',
    JSON.stringify(data.user));\n          return true;\n        }\n\n        return
    false;\n      } catch (error) {\n        console.error('Session validation error:',
    error);\n        return false;\n      }\n    }\n\n    // Show alert helper\n    function
    showAlert(message, type) {\n      const alert = document.getElementById('alert');\n
    \     alert.textContent = message;\n      alert.className = `alert ${type} show`;\n\n
    \     setTimeout(() => {\n        alert.classList.remove('show');\n      }, 5000);\n
    \   }\n  </script>\n</body>\n\n</html>\n"
  styles.css: |-
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #667eea;
      --primary-dark: #5568d3;
      --secondary-color: #764ba2;
      --success-color: #48bb78;
      --error-color: #f56565;
      --text-primary: #2d3748;
      --text-secondary: #718096;
      --bg-light: #f7fafc;
      --bg-white: #ffffff;
      --border-color: #e2e8f0;
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 900px;
      height: 90vh;
      max-height: 800px;
      background: var(--bg-white);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */
    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      box-shadow: var(--shadow-md);
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 16px;
      justify-content: space-between;
    }

    .avatar {
      width: 56px;
      height: 56px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    .avatar svg {
      width: 32px;
      height: 32px;
    }

    .header-info h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .header-info p {
      font-size: 14px;
      opacity: 0.9;
    }

    /* User menu */
    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-left: auto;
    }

    .user-name {
      font-size: 14px;
      font-weight: 500;
      opacity: 0.95;
    }

    .logout-btn {
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      color: white;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }

    /* Connection Status Indicator */
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      transition: background-color 0.3s ease;
    }

    .status-connected {
      background: #48bb78;
      box-shadow: 0 0 8px rgba(72, 187, 120, 0.6);
    }

    .status-disconnected {
      background: #f6ad55;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    /* Chat Container */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      background: var(--bg-light);
    }

    .chat-container::-webkit-scrollbar {
      width: 8px;
    }

    .chat-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-container::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* Welcome Message */
    .welcome-message {
      text-align: center;
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    .welcome-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .welcome-message h2 {
      font-size: 28px;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .welcome-message p {
      color: var(--text-secondary);
      margin-bottom: 24px;
      font-size: 16px;
    }

    .suggestions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 24px;
    }

    .suggestion-chip {
      background: var(--bg-white);
      border: 2px solid var(--border-color);
      color: var(--text-primary);
      padding: 14px 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }

    .suggestion-chip:hover {
      border-color: var(--primary-color);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    /* Messages */
    .message {
      display: flex;
      margin-bottom: 20px;
      animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      justify-content: flex-end;
    }

    .message-content {
      max-width: 70%;
      padding: 16px 20px;
      border-radius: 16px;
      position: relative;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
      background: var(--bg-white);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-bottom-left-radius: 4px;
      box-shadow: var(--shadow-sm);
    }

    .message-text {
      line-height: 1.6;
      word-wrap: break-word;
    }

    .message-text p {
      margin-bottom: 12px;
    }

    .message-text p:last-child {
      margin-bottom: 0;
    }

    .message-text h3 {
      margin-top: 16px;
      margin-bottom: 8px;
      font-size: 18px;
    }

    .message-text ul {
      margin-left: 20px;
      margin-bottom: 12px;
    }

    .message-text li {
      margin-bottom: 6px;
    }

    .message-text strong {
      font-weight: 600;
    }

    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 6px;
    }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px 20px;
      background: var(--bg-white);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      max-width: 70px;
      box-shadow: var(--shadow-sm);
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: typingAnimation 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typingAnimation {

      0%,
      60%,
      100% {
        transform: translateY(0);
        opacity: 0.7;
      }

      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    /* Error Message */
    .error-message {
      background: #fff5f5;
      border: 1px solid #feb2b2;
      color: var(--error-color);
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .error-icon {
      font-size: 20px;
    }

    /* Input Container */
    .chat-input-container {
      padding: 20px 24px;
      background: var(--bg-white);
      border-top: 1px solid var(--border-color);
    }

    .chat-form {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .chat-input {
      flex: 1;
      padding: 14px 20px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 15px;
      color: var(--text-primary);
      transition: all 0.3s ease;
      outline: none;
    }

    .chat-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .chat-input::placeholder {
      color: var(--text-secondary);
    }

    .send-button {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    .send-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .send-button:active {
      transform: translateY(0);
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .send-button svg {
      width: 20px;
      height: 20px;
    }

    /* Execution Info */
    .execution-info {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .message.assistant .execution-info {
      border-top: 1px solid var(--border-color);
    }

    /* Status Badge */
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 8px;
    }

    .status-badge.success {
      background: rgba(72, 187, 120, 0.2);
      color: var(--success-color);
    }

    .status-badge.running {
      background: rgba(102, 126, 234, 0.2);
      color: var(--primary-color);
    }

    .status-badge.error {
      background: rgba(245, 101, 101, 0.2);
      color: var(--error-color);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 0;
      }

      .container {
        height: 100vh;
        max-height: none;
        border-radius: 0;
      }

      .chat-header {
        padding: 20px;
      }

      .header-info h1 {
        font-size: 20px;
      }

      .message-content {
        max-width: 85%;
      }

      .welcome-message h2 {
        font-size: 24px;
      }

      .suggestions {
        gap: 10px;
      }

      .suggestion-chip {
        padding: 12px 16px;
        font-size: 13px;
      }
    }
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: gateway-ui-files
  namespace: gateway

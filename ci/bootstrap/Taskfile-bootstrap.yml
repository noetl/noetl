version: '3.45'

# This is a template Taskfile for projects using NoETL as a submodule.
# Copy this file to your project root as Taskfile.yml

# Import all NoETL tasks with 'noetl:' prefix
includes:
  noetl:
    taskfile: ./.noetl/taskfile.yml
    dir: ./.noetl
  
  # You can also import specific NoETL taskfiles directly
  # noetl-kind:
  #   taskfile: ./.noetl/ci/taskfile/kind.yml
  #   dir: ./.noetl
  #   flatten: true

env:
  # Project-specific environment variables
  PROJECT_NAME: "my-project"
  NOETL_HOST: "localhost"
  NOETL_PORT: "8083"

tasks:
  default:
    silent: true
    cmds:
      - task --list

  # === Bootstrap and Setup ===
  
  bootstrap:
    desc: Complete environment setup (tools + venv + cluster)
    cmds:
      - ./noetl/ci/bootstrap/bootstrap.sh

  bootstrap:verify:
    desc: Verify all required tools are installed
    cmds:
      - |
        echo "=== Verifying Tools ==="
        check_tool() {
          if command -v "$1" >/dev/null 2>&1; then
            echo "✓ $1: $(command -v $1)"
          else
            echo "✗ $1: NOT FOUND"
            return 1
          fi
        }
        
        check_tool docker
        check_tool kubectl
        check_tool helm
        check_tool kind
        check_tool jq
        check_tool yq
        check_tool task
        check_tool psql
        check_tool python3
        
        echo ""
        echo "=== Verifying Python Environment ==="
        if [[ -d .venv ]]; then
          echo "✓ .venv directory exists"
          if command -v noetl >/dev/null 2>&1; then
            echo "✓ noetl CLI installed"
            noetl --version 2>&1 || echo "  (CLI available)"
          else
            echo "✗ noetl CLI not found - install with: pip install noetl[cli]"
          fi
        else
          echo "✗ .venv directory not found"
          echo "  Run: task bootstrap:venv"
        fi
        
        echo ""
        echo "=== Verifying Observability Services ==="
        if kubectl get namespace clickhouse >/dev/null 2>&1; then
          echo "✓ ClickHouse namespace exists"
        else
          echo "✗ ClickHouse not deployed"
        fi
        if kubectl get namespace qdrant >/dev/null 2>&1; then
          echo "✓ Qdrant namespace exists"
        else
          echo "✗ Qdrant not deployed"
        fi
        if kubectl get namespace nats >/dev/null 2>&1; then
          echo "✓ NATS namespace exists"
        else
          echo "✗ NATS not deployed"
        fi
        echo "  Run: task observability:activate-all"

  bootstrap:venv:
    desc: Create Python venv with project + noetl dependencies
    cmds:
      - |
        if [[ -d .venv ]]; then
          echo ".venv already exists"
          exit 0
        fi
        
        echo "Creating Python virtual environment..."
        python3 -m venv .venv
        source .venv/bin/activate
        
        echo "Upgrading pip..."
        pip install --upgrade pip
        
        echo "Installing uv for faster package resolution..."
        pip install uv
        
        echo "Installing NoETL..."
        uv pip install -e ./noetl
        
        if [[ -f pyproject.toml ]]; then
          echo "Installing project dependencies..."
          uv pip install -e .
        fi
        
        echo ""
        echo "✓ Virtual environment created"
        echo "  Activate: source .venv/bin/activate"

  # === Development Workflow ===
  
  dev:setup:
    desc: Complete development environment setup
    aliases: [setup]
    cmds:
      - task: bootstrap:verify
      - task: noetl:dev:k8s:bootstrap
  
  dev:start:
    desc: Start NoETL infrastructure
    aliases: [start]
    cmds:
      - task: noetl:kind:local:cluster-create
      - task: noetl:postgres:k8s:deploy
      - task: noetl:observability:activate-all
      - task: noetl:monitoring:k8s:deploy
      - task: noetl:noetl:k8s:deploy
      - echo ""
      - echo "NoETL started!"
      - echo "  UI: http://localhost:8083"
      - echo "  Grafana: kubectl port-forward -n vmstack svc/vmstack-grafana 3000:80"
      - echo "  ClickHouse HTTP: localhost:30123 (NodePort)"
      - echo "  ClickHouse Native: localhost:30900 (NodePort)"
      - echo "  Qdrant HTTP: localhost:30633 (NodePort)"
      - echo "  Qdrant gRPC: localhost:30634 (NodePort)"
      - echo "  NATS Client: localhost:30422 (NodePort)"
      - echo "  NATS Monitoring: localhost:30822 (NodePort)"
  
  dev:stop:
    desc: Stop NoETL infrastructure
    aliases: [stop]
    cmds:
      - task: noetl:kind:local:cluster-delete
  
  dev:restart:
    desc: Restart NoETL infrastructure
    aliases: [restart]
    cmds:
      - task: dev:stop
      - task: dev:start
  
  dev:status:
    desc: Show status of NoETL infrastructure
    aliases: [status]
    cmds:
      - echo "=== Kind Clusters ==="
      - kind get clusters || echo "No clusters found"
      - echo ""
      - echo "=== Kubernetes Pods ==="
      - kubectl get pods --all-namespaces || echo "Cluster not accessible"
      - echo ""
      - echo "=== NoETL Services ==="
      - kubectl get svc -n noetl || echo "NoETL namespace not found"

  # === Credential Management ===
  
  credentials:register:
    desc: Register all credentials from credentials/ directory
    aliases: [creds]
    cmds:
      - |
        if [[ ! -d credentials ]]; then
          echo "No credentials/ directory found"
          echo "Create one and add your credential JSON files"
          exit 0
        fi
        
        for cred in credentials/*.json; do
          [[ -f "$cred" ]] || continue
          [[ "$cred" == *".example.json" ]] && continue
          [[ "$cred" == *".template.json" ]] && continue
          
          echo "Registering $cred..."
          noetl register "$cred" \
            --host $NOETL_HOST \
            --port $NOETL_PORT
        done
        
        echo ""
        echo "✓ Credentials registered"

  # === Playbook Management ===
  
  playbooks:register:
    desc: Register all playbooks from playbooks/ directory
    aliases: [reg]
    cmds:
      - |
        if [[ ! -d playbooks ]]; then
          echo "No playbooks/ directory found"
          echo "Create one and add your playbook YAML files"
          exit 0
        fi
        
        for playbook in playbooks/*.yaml playbooks/*.yml; do
          [[ -f "$playbook" ]] || continue
          
          echo "Registering $playbook..."
          noetl register "$playbook" \
            --host $NOETL_HOST \
            --port $NOETL_PORT
        done
        
        echo ""
        echo "✓ Playbooks registered"

  playbooks:list:
    desc: List all registered playbooks
    aliases: [list]
    cmds:
      - |
        noetl list playbooks \
          --host $NOETL_HOST \
          --port $NOETL_PORT

  playbooks:execute:
    desc: "Execute a playbook (usage: task playbooks:execute -- <playbook_name>)"
    aliases: [exec]
    cmds:
      - |
        if [[ -z "{{.CLI_ARGS}}" ]]; then
          echo "Usage: task playbooks:execute -- <playbook_name>"
          exit 1
        fi
        
        noetl execute playbook "{{.CLI_ARGS}}" \
          --host $NOETL_HOST \
          --port $NOETL_PORT

  # === Kubernetes Helpers ===
  
  k8s:logs:noetl:
    desc: Show NoETL server logs
    aliases: [logs]
    cmds:
      - kubectl logs -n noetl -l app=noetl-server --tail=100 -f

  k8s:logs:worker:
    desc: Show NoETL worker logs
    cmds:
      - kubectl logs -n noetl -l app=noetl-worker --tail=100 -f

  k8s:logs:postgres:
    desc: Show PostgreSQL logs
    cmds:
      - kubectl logs -n postgres -l app=postgres --tail=100 -f

  k8s:port-forward:ui:
    desc: Port-forward NoETL UI (http://localhost:8083)
    cmds:
      - kubectl port-forward -n noetl svc/noetl-server 8083:8083

  k8s:port-forward:postgres:
    desc: Port-forward PostgreSQL (localhost:5432)
    cmds:
      - kubectl port-forward -n postgres svc/postgres 5432:5432

  k8s:port-forward:grafana:
    desc: Port-forward Grafana (http://localhost:3000)
    cmds:
      - kubectl port-forward -n vmstack svc/vmstack-grafana 3000:80

  k8s:shell:postgres:
    desc: Open psql shell to NoETL database
    cmds:
      - |
        echo "Connecting to PostgreSQL..."
        echo "Password: noetl"
        kubectl exec -it -n postgres deployment/postgres -- psql -U noetl -d noetl

  # === Testing ===
  
  test:
    desc: Run project tests
    cmds:
      - |
        if [[ -f pytest.ini ]] || [[ -d tests ]]; then
          source .venv/bin/activate
          pytest tests/ -v
        else
          echo "No tests found (pytest.ini or tests/ directory)"
        fi

  test:integration:
    desc: Run integration tests with NoETL
    cmds:
      - task: credentials:register
      - task: playbooks:register
      - |
        # Add your integration test commands here
        echo "Running integration tests..."
        # pytest tests/integration/ -v

  # === Cleanup ===
  
  clean:cache:
    desc: Clear NoETL local cache
    cmds:
      - task: noetl:cache:local:clear-all

  clean:venv:
    desc: Remove Python virtual environment
    cmds:
      - rm -rf .venv
      - echo "✓ .venv removed"

  clean:cluster:
    desc: Delete Kind cluster
    cmds:
      - task: noetl:kind:local:cluster-delete

  clean:all:
    desc: Clean everything (venv + cache + cluster)
    cmds:
      - task: clean:cluster
      - task: clean:cache
      - task: clean:venv
      - echo ""
      - echo "✓ All cleaned"
      - echo "  Run 'task bootstrap' to start fresh"

  # === Documentation ===
  
  docs:
    desc: Show quick reference
    cmds:
      - |
        cat << 'EOF'
        === Quick Reference ===
        
        Setup:
          task bootstrap              # Complete setup
          task bootstrap:verify       # Verify tools
          task dev:setup             # Setup infrastructure
        
        Development:
          task dev:start             # Start NoETL
          task dev:stop              # Stop NoETL
          task dev:status            # Show status
        
        Credentials & Playbooks:
          task credentials:register  # Register credentials
          task playbooks:register    # Register playbooks
          task playbooks:list        # List playbooks
          task playbooks:execute -- <name>  # Execute playbook
        
        Logs & Debugging:
          task k8s:logs:noetl       # NoETL server logs
          task k8s:logs:worker      # Worker logs
          task k8s:logs:postgres    # Postgres logs
        
        Access Services:
          NoETL UI:  http://localhost:8083
          Grafana:   task k8s:port-forward:grafana
          Postgres:  task k8s:port-forward:postgres
        
        Cleanup:
          task clean:all            # Clean everything
        
        Documentation:
          ./noetl/ci/bootstrap/README.md
          https://noetl.io
        EOF

# === Project-Specific Tasks (Examples) ===

  # Add your custom tasks below

  # Example: Custom deployment
  # deploy:custom-service:
  #   desc: Deploy custom service to cluster
  #   cmds:
  #     - kubectl apply -f k8s/custom-service.yaml

  # Example: Custom data pipeline
  # pipeline:run:etl:
  #   desc: Run ETL pipeline
  #   cmds:
  #     - .venv/bin/python scripts/etl_pipeline.py

  # Example: Database migration
  # db:migrate:
  #   desc: Run database migrations
  #   cmds:
  #     - .venv/bin/alembic upgrade head

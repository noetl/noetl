version: '3.45'

tasks:
  dev:tools:setup:
    desc: Validate required tooling on WSL2 hosts
    cmds:
      - task: dev:tools:validate-install

  dev:tools:validate-install:
    desc: Validate required tools are installed and accessible in WSL2
    silent: true
    cmds:
      - |
        bash -ceu '
        fail=0
        check() {
          if command -v "$1" >/dev/null 2>&1; then
            echo "[OK] $1: $($1 --version 2>/dev/null | head -n1 || echo installed)"
          else
            echo "[MISSING] $1 not found in PATH"; fail=1
          fi
        }
        echo "Validating required tools..."
        check git
        check curl
        if ! command -v jq >/dev/null 2>&1; then
          echo "[MISSING] jq not found in PATH"
          echo "       -> Install with: task dev:tools:install-jq"
          fail=1
        else
          echo "[OK] jq: $(jq --version 2>/dev/null | head -n1 || echo installed)"
        fi
        check python3
        if command -v docker >/dev/null 2>&1; then
          echo "[OK] docker available"; if ! docker info >/dev/null 2>&1; then
            echo "[WARN] docker present but daemon not reachable"
            echo "       -> Ensure Docker Desktop is running and WSL integration is enabled"
            echo "       -> You may need to add your user to the docker group: task tools:fix-docker-perms"
          fi
        else
          echo "[MISSING] docker not found in PATH"
          fail=1
        fi
        if command -v task >/dev/null 2>&1; then echo "[OK] task available"; else echo "[INFO] task not installed (you are likely running this via task already)"; fi
        exit $fail
        '

  dev:tools:validate-docker:
    desc: Validate Docker Desktop integration from WSL2 (may pull hello-world image)
    cmds:
      - docker info
      - docker run --rm hello-world

  dev:tools:install-base:
    desc: Install basic CLI tools (git, curl, jq, make, ca-certificates, lsof, python3, pip, venv)
    cmds:
      - |
        bash -ceu '
        sudo apt-get update
        sudo apt-get install -y \
          git make curl jq ca-certificates lsof \
          build-essential unzip \
          python3 python3-venv python3-pip
        echo "[OK] Base tools installed. If versions are not updated in current shell, open a new terminal."
        '

  dev:tools:ensure-path:
    desc: Ensure common tool paths are added to ~/.bashrc and current shell (WSL/Ubuntu)
    silent: true
    cmds:
      - |
        bash -ceu '
        BASHRC="$HOME/.bashrc"
        ensure_line() { grep -qxF "$1" "$BASHRC" || echo "$1" >> "$BASHRC"; }
        ensure_line "export PATH=\"$HOME/.local/bin:\$PATH\""
        ensure_line "export PATH=\"/usr/local/bin:\$PATH\""
        export PATH="$HOME/.local/bin:/usr/local/bin:$PATH"
        echo "[OK] Ensured PATH contains: $HOME/.local/bin and /usr/local/bin"
        echo "Current PATH: $PATH"
        echo "[INFO] If this is your first time adding these, open a new shell or: source ~/.bashrc"
        '

  dev:tools:fix-docker-perms:
    desc: Add current user to docker group (WSL/Linux) and print next steps
    silent: true
    cmds:
      - |
        bash -ceu '
        sudo groupadd -f docker
        if id -nG "$USER" | grep -qw docker; then
          echo "[SKIP] $USER already in docker group"
        else
          sudo usermod -aG docker "$USER"
          echo "[OK] Added $USER to docker group"
        fi
        echo
        echo "Next steps:"
        echo "  1) Close and reopen your WSL terminal (or run: newgrp docker)"
        echo "  2) Ensure Docker Desktop is running and WSL integration is enabled"
  echo "  3) Re-run: task dev:tools:validate-docker"
        '

  dev:tools:validate-devtools:
    desc: Validate optional dev tools available (kind, yq, pyenv, uv, tfenv)
    silent: true
    cmds:
      - |
        bash -ceu '
        tools=(kind yq pyenv uv tfenv terraform)
        for t in "${tools[@]}"; do
          if command -v "$t" >/dev/null 2>&1; then
            case "$t" in
              kind) echo "[OK] kind: $(kind --version || true)";;
              yq) echo "[OK] yq: $(yq --version || true)";;
              pyenv) echo "[OK] pyenv: $(pyenv --version || true)";;
              uv) echo "[OK] uv: $(uv --version || true)";;
              tfenv) echo "[OK] tfenv: $(tfenv --version || true)";;
              terraform) echo "[OK] terraform: $(terraform version | head -n1 || true)";;
            esac
          else
            echo "[MISSING] $t not found in PATH"
          fi
        done
        '

  dev:tools:install-yq:
    desc: Install yq via PPA (Ubuntu/WSL)
    cmds:
      - |
        bash -ceu '
        if command -v yq >/dev/null 2>&1; then
          echo "[SKIP] yq already installed: $(yq --version || true)"
          exit 0
        fi
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository -y ppa:rmescandon/yq
        sudo apt-get update
        sudo apt-get install -y yq
        yq --version
        '

  dev:tools:install-kind:
    desc: Install kind (Kubernetes in Docker)
    cmds:
      - |
        bash -ceu '
        if command -v kind >/dev/null 2>&1; then
          echo "[SKIP] kind already installed: $(kind --version || true)"
          exit 0
        fi
        KIND_VER="${KIND_VER:-v0.23.0}"
        curl -fsSL -o ./kind "https://kind.sigs.k8s.io/dl/${KIND_VER}/kind-linux-amd64"
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind
        kind --version
        '

  dev:tools:install-pyenv:
    desc: Install pyenv and initialize bash shell configuration
    cmds:
      - |
        bash -ceu '
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev zlib1g-dev \
          libbz2-dev libreadline-dev libsqlite3-dev curl git \
          libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev \
          libffi-dev liblzma-dev
        if [ ! -d "$HOME/.pyenv" ]; then
          curl https://pyenv.run | bash
        else
          echo "[SKIP] pyenv directory already exists at ~/.pyenv"
        fi
        BASHRC="$HOME/.bashrc"
        if ! grep -q "pyenv setup (added by Taskfile tools:install-pyenv)" "$BASHRC"; then
          printf "\n# pyenv setup (added by Taskfile tools:install-pyenv)\n" >> "$BASHRC"
          printf "export PYENV_ROOT=\"$HOME/.pyenv\"\n" >> "$BASHRC"
          printf "command -v pyenv >/dev/null || export PATH=\"$PYENV_ROOT/bin:\$PATH\"\n" >> "$BASHRC"
          printf "eval \"$(pyenv init -)\"\n" >> "$BASHRC"
        fi
        export PYENV_ROOT="$HOME/.pyenv"
        export PATH="$PYENV_ROOT/bin:$PATH"
        command -v pyenv >/dev/null 2>&1 || eval "$(pyenv init -)" >/dev/null 2>&1 || true
        pyenv --version || true
        '

  dev:tools:install-uv:
    desc: Install uv (fast Python package manager)
    cmds:
      - |
        bash -ceu '
        if command -v uv >/dev/null 2>&1; then
          echo "[SKIP] uv already installed: $(uv --version || true)"
          exit 0
        fi
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "[INFO] If uv is not in PATH, restart your shell or source the profile suggested by the installer."
        uv --version || true
        '

  dev:tools:install-tfenv:
    desc: Install tfenv and latest Terraform
    cmds:
      - |
        bash -ceu '
        if [ ! -d "$HOME/.tfenv" ]; then
          git clone https://github.com/tfutils/tfenv.git "$HOME/.tfenv"
        else
          echo "[SKIP] ~/.tfenv already exists"
        fi
        BASHRC="$HOME/.bashrc"
        if ! grep -q "tfenv (added by Taskfile tools:install-tfenv)" "$BASHRC"; then
          printf "\n# tfenv (added by Taskfile tools:install-tfenv)\n" >> "$BASHRC"
          printf "export PATH=\"$HOME/.tfenv/bin:\$PATH\"\n" >> "$BASHRC"
        fi
        export PATH="$HOME/.tfenv/bin:$PATH"
        if command -v tfenv >/dev/null 2>&1; then
          echo "[OK] tfenv: $(tfenv --version || true)"
          tfenv install latest
          tfenv use latest
          terraform version
        else
          echo "[ERROR] tfenv not on PATH yet; open a new shell or source ~/.bashrc then rerun: task tools:install-tfenv" >&2
        fi
        '

  dev:tools:install-jq:
    desc: Install jq via apt (Ubuntu/WSL)
    cmds:
      - |
        bash -ceu '
        if command -v jq >/dev/null 2>&1; then
          echo "[SKIP] jq already installed: $(jq --version || true)"
          exit 0
        fi
        sudo apt-get update
        sudo apt-get install -y jq
        jq --version
        '

  dev:tools:install-psql:
    desc: Install PostgreSQL client tools (psql) without server
    cmds:
      - |
        bash -ceu '
        if command -v psql >/dev/null 2>&1; then
          echo "[SKIP] psql already installed: $(psql --version || true)"
          exit 0
        fi
        sudo apt-get update
        sudo apt-get install -y postgresql-client
        if command -v psql >/dev/null 2>&1; then
          echo "[OK] psql: $(psql --version || true)"
        else
          echo "[ERROR] psql not found in PATH after installation. You may need to restart your shell." >&2
          exit 1
        fi
        '

  dev:tools:install-devtools:
    desc: Install yq, kind, pyenv, uv, tfenv (aggregate)
    cmds:
      - task: dev:tools:install-yq
      - task: dev:tools:install-kind
      - task: dev:tools:install-pyenv
      - task: dev:tools:install-uv
      - task: dev:tools:install-tfenv
      - task: dev:tools:install-jq
      - task: dev:tools:install-psql

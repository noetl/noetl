version: '3.45'

tasks:
  docker:local:noetl-image-build:
    desc: Build noetl container with docker
    aliases: [dbn, docker-build-noetl]
    vars:
      CACHE: '{{ if (eq .CLI_ARGS "cache")}}{{ else }}--no-cache{{ end }}'
      REGISTRY: '{{.REGISTRY | default "local"}}'
      IMAGE_NAME: '{{.IMAGE_NAME | default "noetl"}}'
      IMAGE_TAG:
        sh: date +%Y-%m-%d-%H-%M
    env:
      DOCKER_BUILDKIT: "0"
    cmds:
      - echo "{{.IMAGE_TAG}}" > .noetl_last_build_tag.txt
      - docker build {{.CACHE}} -t {{.REGISTRY}}/{{.IMAGE_NAME}}:{{.IMAGE_TAG}} -f docker/noetl/dev/Dockerfile .

  docker:local:images-clear:
    desc: Clear all docker images
    aliases: [cdi, clear-docker-images]
    vars:
      REGISTRY: '{{.REGISTRY | default "local"}}'
      IMAGE_NAME: '{{.IMAGE_NAME | default "noetl"}}'
    cmds:
      - docker images "{{.REGISTRY}}/{{.IMAGE_NAME}}" --format "{{`{{.ID}}`}}" | xargs -r docker rmi -f

  docker:local:cleanup-all:
    desc: Clean all docker resources (builders, images, volumes)
    aliases: [dca, docker-cleanup-all]
    cmds:
      - docker builder prune --all --force
      - docker image prune --all --force
      - docker volume prune --force

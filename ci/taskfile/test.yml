version: '3.45'

# NoETL Test Task Automation
# ===========================
# Key workflows:
# - setup-test-environment: Register all credentials and test playbooks (one-time setup)
# - register-all-test-playbooks: Register all test playbooks from fixtures directory  
# - test-create-tables: Create database tables required for save storage tests
# - test-*-full: Complete test workflows including setup, table creation, and execution
# - test-save-storage-all: Run complete save storage test suite with optimized setup
env:
  NOETL_HOST: localhost
  NOETL_PORT: 8082

tasks:
  # === Test Tasks ===
  test:k8s:cluster-health:
    desc: Check cluster health and endpoints
    aliases: [tch, test-cluster-health]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Checking NoETL server health ==="
      - curl -f http://localhost:8082/api/health || echo "NoETL server not ready"
      - echo "\n=== Checking PostgreSQL connection ==="
      - kubectl exec deployment/postgres -n postgres -- pg_isready -h localhost -p 5432 -U demo
      - echo "\n=== Checking services ==="
      - kubectl get svc -A | grep -E "noetl|postgres"

  test:local:create-tables:
    desc: Create database tables for save storage tests
    aliases: [tctl, test-create-tables-local]
    cmds:
      - |
        set -e
        echo "=== Creating database tables for save storage tests (local) ==="
        
        # Check if local server is running
        if ! curl -s -m 2 -f "http://localhost:8083/health" >/dev/null 2>&1; then
          echo "ERROR: NoETL server is not running on port 8083"
          echo "Please start the server first with: task noetl:local-server-debug"
          exit 1
        fi
        
        if [ -x ".venv/bin/noetl" ]; then
          cli=".venv/bin/noetl"
        else
          cli="noetl"
        fi
        
        echo "Executing create_tables playbook with local postgres credentials..."
        $cli execute playbook "tests/fixtures/playbooks/save_storage_test/create_tables" \
          --host localhost --port 8083 \
          --payload '{"pg_auth": "pg_local"}' --merge --json
        echo "✓ Database tables created successfully"

  playbook:local:execute:
    desc: Execute a test playbook with local postgres credentials
    aliases: [tel, test-execute-local]
    vars:
      PLAYBOOK: "{{ or .PLAYBOOK \"\" }}"
      HOST: "{{ or .HOST \"localhost\" }}"
      PORT: "{{ or .PORT \"8083\" }}"
    cmds:
      - |
        set -e
        playbook="{{.PLAYBOOK}}"
        host="{{.HOST}}"
        port="{{.PORT}}"
        
        if [ -z "$playbook" ]; then
          echo "ERROR: PLAYBOOK parameter is required"
          echo "Usage: task playbook:local:execute PLAYBOOK=tests/fixtures/playbooks/save_storage_test/save_simple_test [HOST=localhost] [PORT=8083]"
          exit 1
        fi
        
        # Check if server is running
        echo "Checking if NoETL server is running on $host:$port..."
        if ! curl -s -m 2 -f "http://$host:$port/health" >/dev/null 2>&1; then
          echo "ERROR: NoETL server is not running on $host:$port"
          echo "Please start the server first"
          exit 1
        fi
        
        if [ -x ".venv/bin/noetl" ]; then
          cli=".venv/bin/noetl"
        else
          cli="noetl"
        fi
        
        echo "Executing playbook: $playbook on $host:$port (with local postgres credentials)"
        $cli execute playbook "$playbook" \
          --host "$host" --port "$port" \
          --payload '{"pg_auth": "pg_local"}' --merge --json


  test:k8s:register-credentials:
    desc: Register test credentials
    aliases: [rtc, register-test-credentials]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Registering pg_k8s credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/pg_k8s.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/pg_k8s.json
        fi
      - echo "\n=== Registering gcs_hmac_local credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/gcs_hmac_local.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/gcs_hmac_local.json
        fi
      - echo "\n=== Registering pg_local credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/pg_local.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/pg_local.json
        fi
      - echo "\n=== Registering noetl_ducklake_catalog credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/noetl_ducklake_catalog.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/noetl_ducklake_catalog.json
        fi
      - echo "\n=== Registering sf_test credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/sf_test.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/sf_test.json
        fi
      - echo "\n=== Registering google_oauth credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/google_oauth.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/google_oauth.json
        fi
      - echo "\n=== Registering gcs_service_account credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/gcs_service_account_noetl.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/gcs_service_account_noetl.json
        fi
      - echo "\n=== Test credentials registered successfully ==="

  test:k8s:register-playbooks:
    desc: Register all test playbooks
    aliases: [rtp, register-test-playbooks]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Registering all test playbooks ==="
      - ./tests/fixtures/register_test_playbooks.sh {{ .NOETL_HOST }} {{ .NOETL_PORT }}
      - echo "=== All test playbooks registered successfully ==="

  test:local:register-credentials:
    desc: Register test credentials to local server
    aliases: [rtc-local, register-test-credentials-local]
    cmds:
      - echo "=== Registering pg_k8s credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/pg_k8s.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/pg_k8s.json
        fi
      - echo "\n=== Registering gcs_hmac_local credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/gcs_hmac_local.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/gcs_hmac_local.json
        fi
      - echo "\n=== Registering noetl_ducklake_catalog credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/noetl_ducklake_catalog.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/noetl_ducklake_catalog.json
        fi
      - echo "\n=== Registering pg_local credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/pg_local.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/pg_local.json
        fi
      - echo "\n=== Registering sf_test credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/sf_test.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/sf_test.json
        fi
      - echo "\n=== Registering google_oauth credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/google_oauth.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/google_oauth.json
        fi
      - echo "\n=== Registering gcs_service_account credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/gcs_service_account_noetl.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8083/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/gcs_service_account_noetl.json
        fi
      - echo "\n=== Test credentials registered successfully ==="

  test:local:register-playbooks:
    desc: Register all test playbooks to local server
    aliases: [rtp-local, register-test-playbooks-local]
    cmds:
      - echo "=== Registering all test playbooks ==="
      - ./tests/fixtures/register_test_playbooks.sh localhost 8083
      - echo "=== All test playbooks registered successfully ==="

  test:k8s:setup-environment:
  # before run we need go to https://console.cloud.google.com/security/secret-manager/secret/gcs_hmac_local/versions?project=noetl-demo-19700101
  # copy and paste to tests/fixtures/credentials/gcs_hmac_local.json the values for key_id and secret
    desc: Complete test environment setup
    aliases: [ste, setup-test-environment]
    cmds:
      - echo "=== Setting up complete test environment ==="
      - task: test:k8s:register-credentials
      - sleep 2
      - task: test:k8s:register-playbooks
      - echo "=== Test environment setup completed ==="




  # === Save Storage Test Tasks ===
  test:k8s:create-tables:
    desc: Create database tables for save storage tests
    aliases: [tct]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Creating database tables for save storage tests ==="
      - bin/noetl --host {{.NOETL_HOST}} --port {{.NOETL_PORT}} execute playbook "tests/fixtures/playbooks/save_storage_test/create_tables" --json
      - sleep 10
      - echo "=== Database tables created successfully ==="




  test:k8s:validate-save-storage:
    desc: Validate save storage test environment
    aliases: [vsst]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Running Save Storage Test Validation ==="
      - tests/fixtures/playbooks/save_storage_test/validate_tests.sh validate
      - echo "=== Save Storage Test Validation Completed ==="

  # === Container Test Tasks ===
  
  test:container:build-image:
    desc: Build container test image and load into Kind
    aliases: [tcbi, test-container-build]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Building container test image ==="
      - docker build -t noetl/postgres-container-test:latest tests/fixtures/playbooks/container_postgres_init/
      - echo "=== Loading image into Kind cluster ==="
      - kind load docker-image noetl/postgres-container-test:latest --name noetl
      - echo "=== Verifying image in cluster ==="
      - docker exec noetl-control-plane crictl images | grep postgres-container-test || echo "WARNING - Image not found in cluster"
      - echo "=== Container image built and loaded successfully ==="

  test:container:register:
    desc: Register container_postgres_init playbook
    aliases: [tcr, test-container-register]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Registering container_postgres_init playbook ==="
      - bin/noetl --host {{.NOETL_HOST}} --port {{.NOETL_PORT}} register playbook --file tests/fixtures/playbooks/container_postgres_init/container_postgres_init.yaml
      - echo "=== Playbook registered successfully ==="

  test:container:execute:
    desc: Execute container_postgres_init playbook
    aliases: [tce, test-container-execute]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Executing container_postgres_init playbook ==="
      - bin/noetl --host {{.NOETL_HOST}} --port {{.NOETL_PORT}} execute playbook tests/fixtures/playbooks/container_postgres_init --json
      - echo "=== Playbook execution completed ==="

  test:container:verify:
    desc: Verify container test results in PostgreSQL
    aliases: [tcv, test-container-verify]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Verifying container test results ==="
      - echo "\n--- Checking if schema exists (will wait up to 60s) ---"
      - |
        for i in {1..12}; do
          if kubectl exec -n postgres deployment/postgres -- psql -U demo -d demo_noetl -c "\dn container_test" 2>/dev/null | grep -q container_test; then
            echo "✓ Schema container_test exists"
            break
          fi
          echo "Waiting for schema creation... ($i/12)"
          sleep 5
        done
      - echo "\n--- Execution Log ---"
      - kubectl exec -n postgres deployment/postgres -- psql -U demo -d demo_noetl -c "SELECT * FROM container_test.execution_log ORDER BY executed_at;"
      - echo "\n--- Table Summary ---"
      - kubectl exec -n postgres deployment/postgres -- psql -U demo -d demo_noetl -c "SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size FROM pg_tables WHERE schemaname = 'container_test' ORDER BY tablename;"
      - echo "\n--- Data Counts ---"
      - kubectl exec -n postgres deployment/postgres -- psql -U demo -d demo_noetl -c "SELECT 'customers' AS table_name, COUNT(*) AS count FROM container_test.customers UNION ALL SELECT 'products', COUNT(*) FROM container_test.products UNION ALL SELECT 'orders', COUNT(*) FROM container_test.orders UNION ALL SELECT 'order_items', COUNT(*) FROM container_test.order_items ORDER BY table_name;"
      - echo "=== Verification completed ==="

  test:container:status:
    desc: Check status of container jobs and pods
    aliases: [tcs, test-container-status]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Container Jobs Status ==="
      - kubectl get jobs -n noetl -l noetl.io/component=container
      - echo "\n=== Container Pods Status ==="
      - kubectl get pods -n noetl -l noetl.io/component=container
      - echo "\n=== Recent Job Logs (if available) ==="
      - |
        POD=$(kubectl get pods -n noetl -l noetl.io/component=container --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1:].metadata.name}' 2>/dev/null)
        if [ -n "$POD" ]; then
          echo "Latest pod: $POD"
          kubectl logs -n noetl "$POD" --tail=50 || echo "No logs available"
        else
          echo "No container pods found"
        fi

  test:container:debug:
    desc: Debug container test execution issues
    aliases: [tcd, test-container-debug]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== NoETL Worker Status ==="
      - kubectl get pods -n noetl -l app=noetl-worker
      - echo "\n=== NoETL Worker Logs (last 30 lines) ==="
      - kubectl logs -n noetl deployment/noetl-worker --tail=30
      - echo "\n=== NoETL Server Status ==="
      - kubectl get pods -n noetl -l app=noetl-server
      - echo "\n=== PostgreSQL Status ==="
      - kubectl get pods -n postgres
      - echo "\n=== DNS Test from Worker ==="
      - |
        WORKER_POD=$(kubectl get pods -n noetl -l app=noetl-worker -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$WORKER_POD" ]; then
          echo "Testing DNS resolution from worker pod: $WORKER_POD"
          kubectl exec -n noetl "$WORKER_POD" -- nslookup postgres.postgres.svc.cluster.local || echo "DNS resolution failed"
        fi
      - echo "\n=== Container Jobs and ConfigMaps ==="
      - kubectl get jobs,configmaps -n noetl -l noetl.io/component=container

  test:container:cleanup:
    desc: Clean up container test schema
    aliases: [tcc, test-container-cleanup]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Cleaning up container test schema ==="
      - kubectl exec -n postgres deployment/postgres -- psql -U demo -d demo_noetl -c "DROP SCHEMA IF EXISTS container_test CASCADE;"
      - echo "=== Schema cleaned up successfully ==="

  test:container:full:
    desc: Full container test workflow (build, register, execute, verify)
    aliases: [tcf, test-container-full]
    cmds:
      - task: kubectl:local:context-set-kind
      - task: test:container:build-image
      - sleep 2
      - task: test:container:register
      - sleep 2
      - task: test:container:execute
      - echo "=== Waiting for container jobs to complete (30s) ==="
      - sleep 30
      - task: test:container:verify
      - echo "=== Full container test workflow completed successfully ==="

  # === Retry Test Tasks ===

  test:local:retry-all:
    desc: Run all retry tests
    aliases: [tra, test-retry-all]
    cmds:
      - task: noetl:local:reset
      - echo "\n=== Running HTTP status code retry test ==="
      - task: playbook:local:execute:retry-http-status
      - echo "\n=== Running HTTP stop condition retry test ==="
      - task: playbook:local:execute-retry-http-stop
      - echo "\n=== Running Python exception retry test ==="
      - task: playbook:local:execute-retry-python-exception
      - echo "\n=== Running DuckDB retry test ==="
      - task: playbook:local:execute-retry-duckdb
      - echo "\n=== Running simple config retry test ==="
      - task: playbook:local:execute-retry-simple-config
      - echo "\n=== All retry tests completed ==="

  # === Regression Testing (NoETL Native) ===
  test:regression:setup:
    desc: Setup test schema for regression testing
    aliases: [trs, test-regression-setup]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Creating test schema for regression testing ==="
      - |
        if [ -x ".venv/bin/noetl" ]; then
          cli=".venv/bin/noetl"
        else
          cli="noetl"
        fi
        
        # Register schema creation playbook (using file path)
        $cli register tests/fixtures/playbooks/regression_test/create_test_schema.yaml \
          --host localhost --port 8082
        
        # Execute schema creation (using catalog path)
        $cli execute playbook tests/fixtures/playbooks/regression_test/create_test_schema \
          --host localhost --port 8082 \
          --payload '{"pg_auth": "pg_k8s"}' --merge --json

  test:regression:run:
    desc: Run complete NoETL-native regression test suite
    aliases: [trr, test-regression-run]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Running NoETL-native regression test suite ==="
      - |
        if [ -x ".venv/bin/noetl" ]; then
          cli=".venv/bin/noetl"
        else
          cli="noetl"
        fi
        
        # Register master test playbook (using file path)
        echo "Registering master regression test playbook..."
        $cli register tests/fixtures/playbooks/regression_test/master_regression_test.yaml \
          --host localhost --port 8082
        
        # Execute master test playbook (using catalog path)
        echo "Executing master regression test..."
        $cli execute playbook tests/fixtures/playbooks/regression_test/master_regression_test \
          --host localhost --port 8082 \
          --payload '{"pg_auth": "pg_k8s"}' --merge --json

  test:regression:full:
    desc: Setup and run complete regression test suite
    aliases: [trf, test-regression-full]
    cmds:
      - task: test:k8s:register-playbooks
      - task: test:regression:setup
      - task: test:regression:run

  test:regression:results:
    desc: View latest regression test results
    aliases: [trv, test-regression-view]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Latest Regression Test Results ==="
      - |
        curl -sS -X POST "http://localhost:8082/api/postgres/execute" \
          -H 'Content-Type: application/json' \
          -d '{
            "schema": "noetl_test",
            "query": "SELECT test_run_id, test_timestamp, total_tests, passed_tests, failed_tests, success_rate FROM noetl_test.regression_summary ORDER BY test_timestamp DESC LIMIT 5"
          }' | jq -C '.'
      - echo "\n=== Failed Tests (Latest Run) ==="
      - |
        curl -sS -X POST "http://localhost:8082/api/postgres/execute" \
          -H 'Content-Type: application/json' \
          -d '{
            "schema": "noetl_test",
            "query": "SELECT r.playbook_name, r.category, r.status, r.validation_errors FROM noetl_test.regression_results r WHERE r.test_run_id = (SELECT test_run_id FROM noetl_test.regression_summary ORDER BY test_timestamp DESC LIMIT 1) AND r.test_passed = false"
          }' | jq -C '.'

  # === Regression Testing (Pytest) ===
  test:playbooks:regression:
    desc: Run pytest-based playbook regression test suite
    aliases: [tpr, test-regression-pytest]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Running pytest playbook regression tests ==="
      - pytest tests/test_playbook_regression.py -v --tb=short

  test:playbooks:regression-category:
    desc: Run regression tests for specific category
    aliases: [tprc, test-regression-category]
    vars:
      CATEGORY: "{{ or .CATEGORY \"\" }}"
    cmds:
      - task: kubectl:local:context-set-kind
      - |
        category="{{.CATEGORY}}"
        if [ -z "$category" ]; then
          echo "ERROR: CATEGORY parameter is required"
          echo "Usage: task test:playbooks:regression-category CATEGORY=basic"
          echo "Available categories: basic, data_transfer, control_flow, storage, api_integration, advanced"
          exit 1
        fi
        echo "=== Running regression tests for category: $category ==="
        pytest tests/test_playbook_regression.py -v --tb=short --category="$category"

  test:playbooks:regression-single:
    desc: Run regression test for a single playbook
    aliases: [tprs, test-regression-single]
    vars:
      PLAYBOOK: "{{ or .PLAYBOOK \"\" }}"
    cmds:
      - task: kubectl:local:context-set-kind
      - |
        playbook="{{.PLAYBOOK}}"
        if [ -z "$playbook" ]; then
          echo "ERROR: PLAYBOOK parameter is required"
          echo "Usage: task test:playbooks:regression-single PLAYBOOK=hello_world"
          exit 1
        fi
        echo "=== Running regression test for playbook: $playbook ==="
        pytest tests/test_playbook_regression.py -v --tb=short -k "$playbook"

  test:playbooks:update-expected:
    desc: Update expected results for all playbooks (creates baseline)
    aliases: [tpue, test-update-expected]
    cmds:
      - task: kubectl:local:context-set-kind
      - echo "=== Updating expected results (creating baseline) ==="
      - echo "⚠ This will overwrite all expected result files"
      - pytest tests/test_playbook_regression.py -v --tb=short --update-expected

  test:playbooks:update-expected-single:
    desc: Update expected results for a single playbook
    aliases: [tpues, test-update-expected-single]
    vars:
      PLAYBOOK: "{{ or .PLAYBOOK \"\" }}"
    cmds:
      - task: kubectl:local:context-set-kind
      - |
        playbook="{{.PLAYBOOK}}"
        if [ -z "$playbook" ]; then
          echo "ERROR: PLAYBOOK parameter is required"
          echo "Usage: task test:playbooks:update-expected-single PLAYBOOK=hello_world"
          exit 1
        fi
        echo "=== Updating expected results for playbook: $playbook ==="
        pytest tests/test_playbook_regression.py -v --tb=short -k "$playbook" --update-expected

  test:playbooks:list:
    desc: List all configured playbooks in test suite
    aliases: [tpl, test-list-playbooks]
    cmds:
      - |
        echo "=== Configured Playbooks for Regression Testing ==="
        echo ""
        python3 -c "
        import yaml
        from pathlib import Path
        
        config_file = Path('tests/fixtures/playbook_test_config.yaml')
        with open(config_file) as f:
            config = yaml.safe_load(f)
        
        playbooks = config.get('playbooks', [])
        
        # Group by category
        by_category = {}
        for p in playbooks:
            cat = p.get('category', 'uncategorized')
            if cat not in by_category:
                by_category[cat] = []
            by_category[cat].append(p)
        
        # Print by category
        for category in sorted(by_category.keys()):
            print(f'\n{category.upper()}:')
            for p in by_category[category]:
                name = p.get('name')
                enabled = '✓' if p.get('enabled', True) else '✗'
                creds = ', '.join(p.get('requires_credentials', []))
                creds_str = f' (creds: {creds})' if creds else ''
                print(f'  {enabled} {name}{creds_str}')
        
        total = len(playbooks)
        enabled_count = len([p for p in playbooks if p.get('enabled', True)])
        print(f'\nTotal: {total} playbooks ({enabled_count} enabled)')
        "

version: '3.45'

# NATS JetStream tasks

tasks:
  deploy:
    desc: Deploy NATS JetStream
    cmds:
      - helm repo add nats https://nats-io.github.io/k8s/helm/charts/
      - helm repo update
      - helm upgrade --install nats nats/nats --values=ci/manifests/nats/values.yaml --namespace=nats --create-namespace --wait --wait-for-jobs 
      - echo "✓ NATS deployed"
      - task: status

  undeploy:
    desc: Remove NATS JetStream
    cmds:
      - helm uninstall nats --namespace=nats --wait
      - echo "✓ NATS removed"

  restart:
    desc: Restart NATS
    cmds:
      - kubectl rollout restart statefulset/nats -n nats
      - kubectl rollout status statefulset/nats -n nats --timeout=120s
      - echo "✓ NATS restarted"

  status:
    desc: Show NATS status
    cmds:
      - echo "=== NATS Namespace ==="
      - kubectl get namespace nats 2>/dev/null || echo "Namespace not found"
      - echo ""
      - echo "=== NATS Pods ==="
      - kubectl get pods -n nats 2>/dev/null || echo "No pods"
      - echo ""
      - echo "=== NATS Services ==="
      - kubectl get svc -n nats 2>/dev/null || echo "No services"
      - echo ""
      - echo "=== NATS PVCs ==="
      - kubectl get pvc -n nats 2>/dev/null || echo "No PVCs"

  logs:
    desc: Show NATS logs
    cmds:
      - kubectl logs -n nats statefulset/nats --tail=100 -f

  # connect:
  #   desc: Connect to NATS CLI
  #   cmds:
  #     - |
  #       POD=$(kubectl get pods -n nats -l app=nats -o jsonpath='{.items[0].metadata.name}')
  #       if [ -n "$POD" ]; then
  #         echo "Connecting to NATS..."
  #         kubectl exec -it -n nats $POD -- nats-server --version
  #       else
  #         echo "NATS pod not found"
  #         exit 1
  #       fi

  # health:
  #   desc: Check NATS health
  #   cmds:
  #     - |
  #       POD=$(kubectl get pods -n nats -l app=nats -o jsonpath='{.items[0].metadata.name}')
  #       if [ -n "$POD" ]; then
  #         kubectl exec -n nats $POD -- wget -qO- http://localhost:8222/healthz
  #       fi

  port-forward:
    desc: Forward NATS ports
    cmds:
      - echo "Forwarding NATS ports..."
      - echo "Client - localhost:4222"
      - echo "Monitoring - localhost:8222"
      - echo "Press Ctrl+C to stop"
      - |
        kubectl port-forward -n nats svc/nats 4222:4222 &
        kubectl port-forward -n nats svc/nats-headless 8222:8222 &
        wait

  streams:
    desc: List JetStream streams
    cmds:
      - |
        POD=$(kubectl get pods -n nats -l app.kubernetes.io/component=nats-box -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          kubectl exec -n nats $POD -- sh -c "nats server ls --sort=name --context=sys && nats stream ls"
        fi

  # monitoring:
  #   desc: Show NATS monitoring dashboard
  #   cmds:
  #     - |
  #       POD=$(kubectl get pods -n nats -l app=nats -o jsonpath='{.items[0].metadata.name}')
  #       if [ -n "$POD" ]; then
  #         kubectl exec -n nats $POD -- wget -qO- http://localhost:8222/varz
  #       fi

  # test:
  #   desc: Test NATS connection and JetStream
  #   cmds:
  #     - echo "=== Testing NATS Connection ==="
  #     - task: health
  #     - echo ""
  #     - echo "=== JetStream Info ==="
  #     - task: streams
  #     - echo ""
  #     - echo "✓ NATS tests completed"

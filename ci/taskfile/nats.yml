version: '3.45'

# NATS JetStream tasks

tasks:
  deploy:
    desc: Deploy NATS JetStream
    cmds:
      - kubectl apply -f ci/manifests/nats/namespace.yaml
      - kubectl apply -f ci/manifests/nats/nats.yaml
      - echo "✓ NATS deployed"
      - echo "Waiting for NATS to be ready..."
      - kubectl wait --for=condition=ready --timeout=120s pod -l app=nats -n nats || true
      - task: status

  undeploy:
    desc: Remove NATS JetStream
    cmds:
      - kubectl delete -f ci/manifests/nats/nats.yaml --ignore-not-found=true
      - kubectl delete -f ci/manifests/nats/namespace.yaml --ignore-not-found=true
      - echo "✓ NATS removed"

  restart:
    desc: Restart NATS
    cmds:
      - kubectl rollout restart statefulset/nats -n nats
      - kubectl rollout status statefulset/nats -n nats --timeout=120s
      - echo "✓ NATS restarted"

  status:
    desc: Show NATS status
    cmds:
      - echo "=== NATS Namespace ==="
      - kubectl get namespace nats 2>/dev/null || echo "Namespace not found"
      - echo ""
      - echo "=== NATS Pods ==="
      - kubectl get pods -n nats 2>/dev/null || echo "No pods"
      - echo ""
      - echo "=== NATS Services ==="
      - kubectl get svc -n nats 2>/dev/null || echo "No services"
      - echo ""
      - echo "=== NATS PVCs ==="
      - kubectl get pvc -n nats 2>/dev/null || echo "No PVCs"

  logs:
    desc: Show NATS logs
    cmds:
      - kubectl logs -n nats statefulset/nats --tail=100 -f

  connect:
    desc: Connect to NATS CLI
    cmds:
      - |
        POD=$(kubectl get pods -n nats -l app=nats -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          echo "Connecting to NATS..."
          kubectl exec -it -n nats $POD -- nats-server --version
        else
          echo "NATS pod not found"
          exit 1
        fi

  health:
    desc: Check NATS health
    cmds:
      - |
        POD=$(kubectl get pods -n nats -l app=nats -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          kubectl exec -n nats $POD -- wget -qO- http://localhost:8222/healthz
        fi

  port-forward:
    desc: Forward NATS ports
    cmds:
      - echo "Forwarding NATS ports..."
      - echo "Client - localhost:4222"
      - echo "Monitoring - localhost:8222"
      - echo "Press Ctrl+C to stop"
      - kubectl port-forward -n nats svc/nats 4222:4222 8222:8222

  streams:
    desc: List JetStream streams
    cmds:
      - |
        POD=$(kubectl get pods -n nats -l app=nats -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          kubectl exec -n nats $POD -- wget -qO- http://localhost:8222/jsz
        fi

  monitoring:
    desc: Show NATS monitoring dashboard
    cmds:
      - |
        POD=$(kubectl get pods -n nats -l app=nats -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          kubectl exec -n nats $POD -- wget -qO- http://localhost:8222/varz
        fi

  test:
    desc: Test NATS connection and JetStream
    cmds:
      - echo "=== Testing NATS Connection ==="
      - task: health
      - echo ""
      - echo "=== JetStream Info ==="
      - task: streams
      - echo ""
      - echo "✓ NATS tests completed"

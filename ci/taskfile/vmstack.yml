version: '3.45'

env:
  REGISTRY: "local"
  IMAGE_NAME: "noetl"

tasks:
  monitoring:k8s:add-metrics-server-helm-repo:
    desc: Add Metircs Server helm repository
    cmds:
      - helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
      - helm repo update

  monitoring:k8s:deploy-metrics-server:
    desc: Deploy Metrics Server
    aliases: [dm]
    cmds:
      - task: kubectl:local:context-set-kind
      - |
        helm upgrade --install metrics-server metrics-server/metrics-server \
          --values ci/vmstack/mericsserver-values.yaml --version 3.13.0 \
          --namespace metrics-server --create-namespace \
          --wait --wait-for-jobs

  monitoring:k8s:remove-metrics-server:
    desc: Remove Metrics Server
    aliases: [rm]
    cmds:
      - task: kubectl:local:context-set-kind
      - helm uninstall metrics-server -n metrics-server

  monitoring:k8s:add-victoriametrics-helm-repo:
    desc: Add VictoriaMetrics helm repository
    cmds:
      - helm repo add vm https://victoriametrics.github.io/helm-charts/
      - helm repo update

  monitoring:k8s:deploy-vmstack-operator:
    desc: Deploy VictoriaMetrics operator
    aliases: [do]
    cmds:
      - task: kubectl:local:context-set-kind
      - |
        helm upgrade --install vmoperator vm/victoria-metrics-operator \
          --values ci/vmstack/vmoperator-values.yaml --version 0.54.0 \
          --namespace vmoperator --create-namespace \
          --wait --wait-for-jobs

  monitoring:k8s:remove-vmstack-operator:
    desc: Remove VictoriaMetrics operator
    aliases: [ro]
    cmds:
      - task: kubectl:local:context-set-kind
      - helm uninstall vmoperator -n vmoperator

  monitoring:k8s:deploy-vmstack:
    desc:  Deploy VictoriaMetrics stack
    aliases: [ds]
    cmds:
      - task: kubectl:local:context-set-kind
      - |
        helm upgrade --install vmstack vm/victoria-metrics-k8s-stack \
          --values ci/vmstack/vmstack-values.yaml --version 0.60.1 \
          --namespace vmstack --create-namespace \
          --wait --wait-for-jobs

  monitoring:k8s:remove-vmstack:
    desc:  Remove VictoriaMetrics stack
    aliases: [rs]
    cmds:
      - task: kubectl:local:context-set-kind
      - helm uninstall vmstack -n vmstack

  monitoring:k8s:deploy-vmlogs:
    desc: Deploy VictoriaLogs
    aliases: [dl]
    cmds:
      - task: kubectl:local:context-set-kind
      - |
        helm upgrade --install vmlogs vm/victoria-logs-single \
          --values ci/vmstack/vmlogs-values.yaml --version 0.11.11 \
          --namespace vmlogs --create-namespace \
          --wait --wait-for-jobs

  monitoring:k8s:remove-vmlogs:
    desc:  Remove VictoriaLogs
    aliases: [rl]
    cmds:
      - task: kubectl:local:context-set-kind
      - helm uninstall vmlogs -n vmlogs

  monitoring:k8s:add-vector-helm-repo:
    desc: Add Vector helm repository
    cmds:
      - helm repo add vector https://helm.vector.dev
      - helm repo update

  monitoring:k8s:deploy-vector:
    desc: Deploy Victor
    aliases: [dv]
    cmds:
      - task: kubectl:local:context-set-kind
      - |
        helm upgrade --install vector vector/vector \
          --values ci/vmstack/vector-values.yaml --version 0.46.0 \
          --namespace vector --create-namespace \
          --wait --wait-for-jobs

  monitoring:k8s:remove-vector:
    desc:  Remove Vector
    aliases: [rv]
    cmds:
      - task: kubectl:local:context-set-kind
      - helm uninstall vector -n vector

  monitoring:k8s:deploy-exporter:
    desc: Deploy postgres-exporter and vmscrape
    aliases: [de]
    cmds:
      - task: kubectl:local:context-set-kind
      - kubectl apply -f ci/manifests/postgres-exporter/namespace/namespace.yaml
      - sleep 2
      - kubectl apply -f ci/manifests/postgres-exporter

  monitoring:k8s:remove-exporter:
    desc: Remove postgres-exporter and vmscrape
    aliases: [re]
    cmds:
      - task: kubectl:local:context-set-kind
      - kubectl delete -f ci/manifests/postgres-exporter/

  monitoring:k8s:deploy-noetl-scrape:
    desc: Deploy VMServiceScrape for noetl
    aliases: [dns]
    cmds:
      - task: kubectl:local:context-set-kind
      - kubectl apply -f ci/manifests/noetl-scrape/namespace/namespace.yaml
      - sleep 2
      - kubectl apply -f ci/manifests/noetl-scrape/

  monitoring:k8s:remove-noetl-scrape:
    desc: Remove VMServiceScrape for noetl
    aliases: [rns]
    cmds:
      - task: kubectl:local:context-set-kind
      - kubectl delete -f ci/manifests/noetl-scrape/

  monitoring:k8s:deploy-dashboards:
    desc: Deploy noetl and postgres Grafana dashboards
    aliases: [dd]
    cmds:
      - task: kubectl:local:context-set-kind
      - kubectl apply -f ci/manifests/grafana-dashboards

  monitoring:k8s:remove-dashboards:
    desc: Remove noetl and postgres Grafana dashboards
    aliases: [rd]
    cmds:
      - task: kubectl:local:context-set-kind
      - kubectl delete -f ci/manifests/grafana-dashboards

# === Combined Tasks ===
  monitoring:k8s:deploy:
    desc: Deploy Metrics Server, Victoria Metrics operator and stack
    aliases: [dmon]
    cmds:
      - task: monitoring:k8s:add-metrics-server-helm-repo
      - task: monitoring:k8s:add-victoriametrics-helm-repo
      - task: monitoring:k8s:add-vector-helm-repo
      - task: monitoring:k8s:deploy-metrics-server
      - task: monitoring:k8s:deploy-vmstack-operator
      - task: monitoring:k8s:deploy-vmstack
      - task: monitoring:k8s:deploy-vmlogs
      - task: monitoring:k8s:deploy-vector
      - task: monitoring:k8s:deploy-exporter
      - task: monitoring:k8s:deploy-noetl-scrape
      - task: monitoring:k8s:deploy-dashboards

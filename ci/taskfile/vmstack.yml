version: '3.45'

env:
  REGISTRY: "local"
  IMAGE_NAME: "noetl"

tasks:
  add-metrics-server-helm-repo:
    desc: Add Metircs Server helm repository
    cmds:
      - helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
      - helm repo update

  deploy-metrics-server:
    desc: Deploy Metrics Server
    aliases: [dm]
    cmds:
      - kubectl config use-context kind-noetl 
      - |
        helm upgrade --install metrics-server metrics-server/metrics-server \
          --values ci/vmstack/mericsserver-values.yaml --version 3.13.0 \
          --namespace metrics-server --create-namespace \
          --wait --wait-for-jobs

  remove-metrics-server:
    desc: Remove Metrics Server
    aliases: [rm]
    cmds:
      - kubectl config use-context kind-noetl 
      - helm uninstall metrics-server -n metrics-server

  add-victoriametrics-helm-repo:
    desc: Add VictoriaMetrics helm repository
    cmds:
      - helm repo add vm https://victoriametrics.github.io/helm-charts/
      - helm repo update

  deploy-vmstack-operator:
    desc: Deploy VictoriaMetrics operator
    aliases: [do]
    cmds:
      - kubectl config use-context kind-noetl 
      - |
        helm upgrade --install vmoperator vm/victoria-metrics-operator \
          --values ci/vmstack/vmoperator-values.yaml --version 0.54.0 \
          --namespace vmoperator --create-namespace \
          --wait --wait-for-jobs

  remove-vmstack-operator:
    desc: Remove VictoriaMetrics operator
    aliases: [ro]
    cmds:
      - kubectl config use-context kind-noetl 
      - helm uninstall vmoperator -n vmoperator

  deploy-vmstack:
    desc:  Deploy VictoriaMetrics stack
    aliases: [ds]
    cmds:
      - kubectl config use-context kind-noetl
      - |
        helm upgrade --install vmstack vm/victoria-metrics-k8s-stack \
          --values ci/vmstack/vmstack-values.yaml --version 0.60.1 \
          --namespace vmstack --create-namespace \
          --wait --wait-for-jobs

  remove-vmstack:
    desc:  Remove VictoriaMetrics stack
    aliases: [rs]
    cmds:
      - kubectl config use-context kind-noetl
      - helm uninstall vmstack -n vmstack

  deploy-vmlogs:
    desc: Deploy VictoriaLogs
    aliases: [dl]
    cmds:
      - kubectl config use-context kind-noetl 
      - |
        helm upgrade --install vmlogs vm/victoria-logs-single \
          --values ci/vmstack/vmlogs-values.yaml --version 0.11.11 \
          --namespace vmlogs --create-namespace \
          --wait --wait-for-jobs

  remove-vmlogs:
    desc:  Remove VictoriaLogs
    aliases: [rl]
    cmds:
      - kubectl config use-context kind-noetl
      - helm uninstall vmlogs -n vmlogs

  add-vector-helm-repo:
    desc: Add Vector helm repository
    cmds:
      - helm repo add vector https://helm.vector.dev
      - helm repo update

  deploy-vector:
    desc: Deploy Victor
    aliases: [dv]
    cmds:
      - kubectl config use-context kind-noetl 
      - |
        helm upgrade --install vector vector/vector \
          --values ci/vmstack/vector-values.yaml --version 0.46.0 \
          --namespace vector --create-namespace \
          --wait --wait-for-jobs

  remove--vector:
    desc:  Remove Vector
    aliases: [rv]
    cmds:
      - kubectl config use-context kind-noetl
      - helm uninstall vector -n vector

  deploy-exporter:
    desc: Deploy postgres-exporter and vmscrape
    aliases: [de]
    cmds:
      - kubectl config use-context kind-noetl
      - kubectl apply -f ci/manifests/postgres-exporter/namespace/namespace.yaml
      - sleep 2
      - kubectl apply -f ci/manifests/postgres-exporter

  remove-exporter:
    desc: Remove postgres-exporter and vmscrape
    aliases: [re]
    cmds:
      - kubectl config use-context kind-noetl
      - kubectl delete -f ci/manifests/postgres-exporter/

  deploy-noetl-scrape:
    desc: Deploy VMServiceScrape for noetl
    aliases: [dns]
    cmds:
      - kubectl config use-context kind-noetl
      - kubectl apply -f ci/manifests/noetl-scrape/namespace/namespace.yaml
      - sleep 2
      - kubectl apply -f ci/manifests/noetl-scrape/

  remove-noetl-scrape:
    desc: Remove VMServiceScrape for noetl
    aliases: [rns]
    cmds:
      - kubectl config use-context kind-noetl
      - kubectl delete -f ci/manifests/noetl-scrape/

  deploy-dashboards:
    desc: Deploy noetl and postgres Grafana dashboards
    aliases: [dd]
    cmds:
      - kubectl config use-context kind-noetl
      - kubectl apply -f ci/manifests/grafana-dashboards

  remove-dashboards:
    desc: Remove noetl and postgres Grafana dashboards
    aliases: [rd]
    cmds:
      - kubectl config use-context kind-noetl
      - kubectl delete -f ci/manifests/grafana-dashboards

# === Combined Tasks ===
  deploy-monitoring:
    desc: Deploy Metrics Server, Victoria Metrics operator and stack
    aliases: [dmon]
    cmds:
      - task: add-metrics-server-helm-repo
      - task: add-victoriametrics-helm-repo
      - task: add-vector-helm-repo
      - task: deploy-metrics-server
      - task: deploy-vmstack-operator
      - task: deploy-vmstack
      - task: deploy-vmlogs
      - task: deploy-vector
      - task: deploy-exporter
      - task: deploy-noetl-scrape
      - task: deploy-dashboards

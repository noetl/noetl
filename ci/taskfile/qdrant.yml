version: '3.45'

# Qdrant Vector Database tasks

tasks:
  deploy:
    desc: Deploy Qdrant vector database
    cmds:
      - kubectl apply -f ci/manifests/qdrant/namespace.yaml
      - kubectl apply -f ci/manifests/qdrant/qdrant.yaml
      - echo "✓ Qdrant deployed"
      - echo "Waiting for Qdrant to be ready..."
      - kubectl wait --for=condition=ready --timeout=120s pod -l app=qdrant -n qdrant || true
      - task: status

  undeploy:
    desc: Remove Qdrant vector database
    cmds:
      - kubectl delete -f ci/manifests/qdrant/qdrant.yaml --ignore-not-found=true
      - kubectl delete -f ci/manifests/qdrant/namespace.yaml --ignore-not-found=true
      - echo "✓ Qdrant removed"

  restart:
    desc: Restart Qdrant
    cmds:
      - kubectl rollout restart statefulset/qdrant -n qdrant
      - kubectl rollout status statefulset/qdrant -n qdrant --timeout=120s
      - echo "✓ Qdrant restarted"

  status:
    desc: Show Qdrant status
    cmds:
      - echo "=== Qdrant Namespace ==="
      - kubectl get namespace qdrant 2>/dev/null || echo "Namespace not found"
      - echo ""
      - echo "=== Qdrant Pods ==="
      - kubectl get pods -n qdrant 2>/dev/null || echo "No pods"
      - echo ""
      - echo "=== Qdrant Services ==="
      - kubectl get svc -n qdrant 2>/dev/null || echo "No services"
      - echo ""
      - echo "=== Qdrant PVCs ==="
      - kubectl get pvc -n qdrant 2>/dev/null || echo "No PVCs"

  logs:
    desc: Show Qdrant logs
    cmds:
      - kubectl logs -n qdrant statefulset/qdrant --tail=100 -f

  connect:
    desc: Connect to Qdrant REST API
    cmds:
      - |
        POD=$(kubectl get pods -n qdrant -l app=qdrant -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          echo "Testing Qdrant connection..."
          kubectl exec -n qdrant $POD -- wget -qO- http://localhost:6333
        else
          echo "Qdrant pod not found"
          exit 1
        fi

  health:
    desc: Check Qdrant health
    cmds:
      - |
        POD=$(kubectl get pods -n qdrant -l app=qdrant -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          kubectl exec -n qdrant $POD -- wget -qO- http://localhost:6333/healthz
        fi

  port-forward:
    desc: Forward Qdrant ports
    cmds:
      - echo "Forwarding Qdrant ports..."
      - echo "HTTP - localhost:6333"
      - echo "gRPC - localhost:6334"
      - echo "Press Ctrl+C to stop"
      - kubectl port-forward -n qdrant svc/qdrant 6333:6333 6334:6334

  collections:
    desc: List Qdrant collections
    cmds:
      - |
        POD=$(kubectl get pods -n qdrant -l app=qdrant -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          kubectl exec -n qdrant $POD -- wget -qO- http://localhost:6333/collections
        fi

  test:
    desc: Test Qdrant with sample collection
    cmds:
      - echo "=== Testing Qdrant Connection ==="
      - task: health
      - echo ""
      - echo "=== Listing Collections ==="
      - task: collections
      - echo ""
      - echo "✓ Qdrant tests completed"

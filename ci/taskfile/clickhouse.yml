version: '3.45'

# ClickHouse tasks for NoETL observability stack

tasks:
  deploy:
    desc: Deploy complete ClickHouse observability stack
    cmds:
      - task: deploy-namespace
      - task: deploy-crds
      - task: deploy-operator
      - task: deploy-cluster
      - task: deploy-schema
      - task: deploy-mcp-server
      - echo "✓ ClickHouse observability stack deployed"
      - task: status

  deploy-namespace:
    desc: Create ClickHouse namespace
    cmds:
      - kubectl apply -f ci/manifests/clickhouse/namespace.yaml
      - echo "✓ ClickHouse namespace created"

  deploy-crds:
    desc: Deploy ClickHouse CRDs
    cmds:
      - kubectl apply -f ci/manifests/clickhouse/crds.yaml
      - echo "✓ ClickHouse CRDs deployed"
      - sleep 2

  deploy-operator:
    desc: Deploy ClickHouse operator
    cmds:
      - kubectl apply -f ci/manifests/clickhouse/operator.yaml
      - echo "✓ ClickHouse operator deployed"
      - echo "Waiting for operator to be ready..."
      - kubectl wait --for=condition=available --timeout=120s deployment/clickhouse-operator -n clickhouse || true
      - sleep 5

  deploy-cluster:
    desc: Deploy ClickHouse cluster
    cmds:
      - kubectl apply -f ci/manifests/clickhouse/clickhouse-cluster.yaml
      - echo "✓ ClickHouse cluster deployed"
      - echo "Waiting for ClickHouse to be ready (this may take 2-3 minutes)..."
      - |
        for i in {1..60}; do
          if kubectl get pods -n clickhouse -l clickhouse.altinity.com/chi=noetl-clickhouse 2>/dev/null | grep -q "Running"; then
            echo "✓ ClickHouse pod is running"
            break
          fi
          echo "Waiting for ClickHouse pod... ($i/60)"
          sleep 5
        done
      - sleep 10

  deploy-schema:
    desc: Deploy observability schema to ClickHouse
    cmds:
      - kubectl apply -f ci/manifests/clickhouse/observability-schema.yaml
      - echo "✓ Observability schema ConfigMap created"
      - echo "Schema will be initialized on first connection"

  deploy-mcp-server:
    desc: Deploy ClickHouse MCP server
    cmds:
      - kubectl apply -f ci/manifests/clickhouse/mcp-server.yaml
      - echo "✓ ClickHouse MCP server deployed"
      - kubectl wait --for=condition=available --timeout=60s deployment/clickhouse-mcp-server -n clickhouse || true

  undeploy:
    desc: Remove ClickHouse observability stack
    cmds:
      - kubectl delete -f ci/manifests/clickhouse/mcp-server.yaml --ignore-not-found=true
      - kubectl delete -f ci/manifests/clickhouse/clickhouse-cluster.yaml --ignore-not-found=true
      - kubectl delete -f ci/manifests/clickhouse/observability-schema.yaml --ignore-not-found=true
      - kubectl delete -f ci/manifests/clickhouse/operator.yaml --ignore-not-found=true
      - kubectl delete -f ci/manifests/clickhouse/crds.yaml --ignore-not-found=true
      - kubectl delete -f ci/manifests/clickhouse/namespace.yaml --ignore-not-found=true
      - echo "✓ ClickHouse stack removed"

  restart:
    desc: Restart ClickHouse cluster
    cmds:
      - kubectl rollout restart statefulset -n clickhouse -l clickhouse.altinity.com/chi=noetl-clickhouse
      - kubectl rollout status statefulset -n clickhouse -l clickhouse.altinity.com/chi=noetl-clickhouse --timeout=120s
      - echo "✓ ClickHouse cluster restarted"

  restart-operator:
    desc: Restart ClickHouse operator
    cmds:
      - kubectl rollout restart deployment/clickhouse-operator -n clickhouse
      - kubectl rollout status deployment/clickhouse-operator -n clickhouse --timeout=60s
      - echo "✓ ClickHouse operator restarted"

  restart-mcp:
    desc: Restart ClickHouse MCP server
    cmds:
      - kubectl rollout restart deployment/clickhouse-mcp-server -n clickhouse
      - kubectl rollout status deployment/clickhouse-mcp-server -n clickhouse --timeout=60s
      - echo "✓ ClickHouse MCP server restarted"

  status:
    desc: Show ClickHouse stack status
    cmds:
      - echo "=== ClickHouse Namespace ==="
      - kubectl get namespace clickhouse 2>/dev/null || echo "Namespace not found"
      - echo ""
      - echo "=== ClickHouse Operator ==="
      - kubectl get deployment clickhouse-operator -n clickhouse 2>/dev/null || echo "Operator not deployed"
      - echo ""
      - echo "=== ClickHouse Cluster ==="
      - kubectl get chi -n clickhouse 2>/dev/null || echo "No ClickHouseInstallation resources"
      - kubectl get statefulset -n clickhouse 2>/dev/null || echo "No StatefulSets"
      - kubectl get pods -n clickhouse 2>/dev/null || echo "No pods"
      - echo ""
      - echo "=== ClickHouse Services ==="
      - kubectl get svc -n clickhouse 2>/dev/null || echo "No services"
      - echo ""
      - echo "=== MCP Server ==="
      - kubectl get deployment clickhouse-mcp-server -n clickhouse 2>/dev/null || echo "MCP server not deployed"

  logs:
    desc: Show ClickHouse server logs
    cmds:
      - |
        POD=$(kubectl get pods -n clickhouse -l clickhouse.altinity.com/chi=noetl-clickhouse -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          kubectl logs -n clickhouse $POD --tail=100 -f
        else
          echo "ClickHouse pod not found"
        fi

  logs-operator:
    desc: Show ClickHouse operator logs
    cmds:
      - kubectl logs -n clickhouse deployment/clickhouse-operator --tail=100 -f

  logs-mcp:
    desc: Show ClickHouse MCP server logs
    cmds:
      - kubectl logs -n clickhouse deployment/clickhouse-mcp-server --tail=100 -f

  connect:
    desc: Connect to ClickHouse CLI
    cmds:
      - |
        POD=$(kubectl get pods -n clickhouse -l clickhouse.altinity.com/chi=noetl-clickhouse -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          echo "Connecting to ClickHouse..."
          kubectl exec -it -n clickhouse $POD -- clickhouse-client
        else
          echo "ClickHouse pod not found"
          exit 1
        fi

  query:
    desc: Execute ClickHouse query
    cmds:
      - |
        POD=$(kubectl get pods -n clickhouse -l clickhouse.altinity.com/chi=noetl-clickhouse -o jsonpath='{.items[0].metadata.name}')
        QUERY="{{.CLI_ARGS}}"
        if [ -n "$POD" ] && [ -n "$QUERY" ]; then
          kubectl exec -n clickhouse $POD -- clickhouse-client --query="$QUERY"
        else
          echo "Usage: task clickhouse:query -- \"SELECT 1\""
          exit 1
        fi

  test:
    desc: Test ClickHouse connection and schema
    cmds:
      - echo "=== Testing ClickHouse Connection ==="
      - |
        POD=$(kubectl get pods -n clickhouse -l clickhouse.altinity.com/chi=noetl-clickhouse -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          kubectl exec -n clickhouse $POD -- clickhouse-client --query="SELECT version()"
        fi
      - echo ""
      - echo "=== Testing Observability Database ==="
      - |
        POD=$(kubectl get pods -n clickhouse -l clickhouse.altinity.com/chi=noetl-clickhouse -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          kubectl exec -n clickhouse $POD -- clickhouse-client --query="SHOW DATABASES"
        fi
      - echo ""
      - echo "=== Testing Observability Tables ==="
      - |
        POD=$(kubectl get pods -n clickhouse -l clickhouse.altinity.com/chi=noetl-clickhouse -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          kubectl exec -n clickhouse $POD -- clickhouse-client --query="SHOW TABLES FROM observability" || echo "Schema not initialized yet"
        fi
      - echo ""
      - echo "✓ ClickHouse tests completed"

  port-forward:
    desc: Forward ClickHouse ports
    cmds:
      - echo "Forwarding ClickHouse ports..."
      - echo "HTTP - localhost:8123"
      - echo "Native - localhost:9000"
      - echo "Press Ctrl+C to stop"
      - kubectl port-forward -n clickhouse svc/clickhouse 8123:8123 9000:9000

  port-forward-mcp:
    desc: Forward ClickHouse MCP server port
    cmds:
      - echo "Forwarding ClickHouse MCP server port..."
      - echo "MCP - localhost:8124"
      - echo "Press Ctrl+C to stop"
      - kubectl port-forward -n clickhouse svc/clickhouse-mcp 8124:8124
      - kubectl port-forward -n clickhouse svc/clickhouse-mcp 8124:8124

  health:
    desc: Check ClickHouse cluster health
    cmds:
      - echo "=== ClickHouse Cluster Health ==="
      - |
        POD=$(kubectl get pods -n clickhouse -l clickhouse.altinity.com/chi=noetl-clickhouse -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          kubectl exec -n clickhouse $POD -- clickhouse-client --query="SELECT hostName(), version(), uptime() FORMAT Vertical"
        fi

  clean-data:
    desc: Drop all observability data
    cmds:
      - echo "⚠ This will delete all observability data!"
      - echo "Press Ctrl+C to cancel, or wait 5 seconds..."
      - sleep 5
      - |
        POD=$(kubectl get pods -n clickhouse -l clickhouse.altinity.com/chi=noetl-clickhouse -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          kubectl exec -n clickhouse $POD -- clickhouse-client --query="TRUNCATE TABLE IF EXISTS observability.logs"
          kubectl exec -n clickhouse $POD -- clickhouse-client --query="TRUNCATE TABLE IF EXISTS observability.metrics"
          kubectl exec -n clickhouse $POD -- clickhouse-client --query="TRUNCATE TABLE IF EXISTS observability.traces"
          kubectl exec -n clickhouse $POD -- clickhouse-client --query="TRUNCATE TABLE IF EXISTS observability.noetl_events"
          echo "✓ All observability data deleted"
        fi

  optimize:
    desc: Optimize ClickHouse tables
    cmds:
      - echo "Optimizing observability tables..."
      - |
        POD=$(kubectl get pods -n clickhouse -l clickhouse.altinity.com/chi=noetl-clickhouse -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD" ]; then
          kubectl exec -n clickhouse $POD -- clickhouse-client --query="OPTIMIZE TABLE observability.logs FINAL" || true
          kubectl exec -n clickhouse $POD -- clickhouse-client --query="OPTIMIZE TABLE observability.metrics FINAL" || true
          kubectl exec -n clickhouse $POD -- clickhouse-client --query="OPTIMIZE TABLE observability.traces FINAL" || true
          kubectl exec -n clickhouse $POD -- clickhouse-client --query="OPTIMIZE TABLE observability.noetl_events FINAL" || true
          echo "✓ Tables optimized"
        fi

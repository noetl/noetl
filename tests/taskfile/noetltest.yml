version: '3.45'

# NoETL Test Task Automation
# ===========================
# Key workflows:
# - setup-test-environment: Register all credentials and test playbooks (one-time setup)
# - register-all-test-playbooks: Register all test playbooks from fixtures directory  
# - test-create-tables: Create database tables required for save storage tests
# - test-*-full: Complete test workflows including setup, table creation, and execution
# - test-save-storage-all: Run complete save storage test suite with optimized setup

tasks:
  # === Test Tasks ===
  test-register-control-flow-workbook:
    desc: Register control flow workbook playbook to cluster
    aliases: [trcfw]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 30082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl register tests/fixtures/playbooks/control_flow_workbook/control_flow_workbook.yaml --host {{ .NOETL_HOST }} --port {{ .NOETL_PORT }}

  test-execute-control-flow-workbook:
    desc: Execute control flow workbook test on cluster
    aliases: [tecfw]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 30082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl execute playbook "tests/fixtures/playbooks/control_flow_workbook" --host {{ .NOETL_HOST }} --port {{ .NOETL_PORT }} --json

  test-control-flow-workbook-full:
    desc: Full test - setup environment and execute control flow workbook on cluster
    aliases: [tcfwf]
    cmds:
      - task: setup-test-environment
      - sleep 2
      - task: test-execute-control-flow-workbook

  test-cluster-health:
    desc: Check cluster health and endpoints
    aliases: [tch]
    cmds:
      - kubectl config use-context kind-noetl
      - echo "=== Checking NoETL server health ==="
      - curl -f http://localhost:8082/api/health || echo "NoETL server not ready"
      - echo "\n=== Checking PostgreSQL connection ==="
      - kubectl exec deployment/postgres -n postgres -- pg_isready -h localhost -p 5432 -U demo
      - echo "\n=== Checking services ==="
      - kubectl get svc -A | grep -E "noetl|postgres"

  register-test-credentials:
    desc: Register test credentials (pg_k8s and gcs_hmac_local) to cluster
    aliases: [rtc]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - echo "=== Registering pg_k8s credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/pg_k8s.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/pg_k8s.json
        fi
      - echo "\n=== Registering gcs_hmac_local credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/gcs_hmac_local.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/gcs_hmac_local.json
        fi
      - echo "\n=== Registering pg_local credential ==="
      - |
        if command -v jq >/dev/null 2>&1; then
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/pg_local.json | jq -C .
        else
          curl -sS -X POST "http://localhost:8082/api/credentials" \
            -H 'Content-Type: application/json' \
            --data-binary @tests/fixtures/credentials/pg_local.json
        fi
      - echo "\n=== Test credentials registered successfully ==="

  register-all-test-playbooks:
    desc: Register all test playbooks from fixtures directory to cluster
    aliases: [ratp]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - echo "=== Registering all test playbooks ==="
      - ./register_test_playbooks.sh {{ .NOETL_HOST }} {{ .NOETL_PORT }}
      - echo "=== All test playbooks registered successfully ==="

  setup-test-environment:
    desc: Complete test environment setup - register credentials and all playbooks
    aliases: [ste]
    cmds:
      - echo "=== Setting up complete test environment ==="
      - task: register-test-credentials
      - sleep 2
      - task: register-all-test-playbooks
      - echo "=== Test environment setup completed ==="

  test-register-http-duckdb-postgres:
    desc: Register HTTP DuckDB Postgres playbook to cluster
    aliases: [trhdp]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl register tests/fixtures/playbooks/http_duckdb_postgres/http_duckdb_postgres.yaml --host localhost --port 8082

  test-execute-http-duckdb-postgres:
    desc: Execute HTTP DuckDB Postgres test on cluster
    aliases: [tehdp]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl execute playbook "tests/fixtures/playbooks/http_duckdb_postgres" --host localhost --port 8082 --json

  test-http-duckdb-postgres-full:
    desc: Full test - setup environment and execute HTTP DuckDB Postgres test
    aliases: [thdpf]
    cmds:
      - task: setup-test-environment
      - sleep 2
      - task: test-execute-http-duckdb-postgres

  test-register-playbook-composition:
    desc: Register playbook composition test to cluster
    aliases: [trpc]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl register tests/fixtures/playbooks/playbook_composition/playbook_composition.yaml --host localhost --port 8082

  test-execute-playbook-composition:
    desc: Execute playbook composition test on cluster
    aliases: [tepc]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl execute playbook "tests/fixtures/playbooks/playbook_composition/playbook_composition" --host localhost --port 8082 --json

  test-playbook-composition-full:
    desc: Full test - register credentials, register playbook, and execute playbook composition test
    aliases: [tpcf]
    cmds:
      - task: register-test-credentials
      - sleep 2
      - task: test-register-playbook-composition
      - sleep 2
      - task: test-execute-playbook-composition

  test-register-hello-world:
    desc: Register hello world playbook to cluster
    aliases: [trhw]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl register tests/fixtures/playbooks/hello_world/hello_world.yaml --host {{ .NOETL_HOST }} --port {{ .NOETL_PORT }}

  test-execute-hello-world:
    desc: Execute hello world test on cluster
    aliases: [tehw]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl execute playbook "tests/fixtures/playbooks/hello_world" --host {{ .NOETL_HOST }} --port {{ .NOETL_PORT }} --json

  test-hello-world-full:
    desc: Full test - register and execute hello world test
    aliases: [thwf]
    cmds:
      - task: test-register-hello-world
      - sleep 2
      - task: test-execute-hello-world

  # === Save Storage Test Tasks ===
  test-create-tables:
    desc: Create required database tables for save storage tests
    aliases: [tct]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - echo "=== Creating database tables for save storage tests ==="
      - .venv/bin/noetl execute playbook "tests/fixtures/playbooks/save_storage_test/create_tables" --host {{ .NOETL_HOST }} --port {{ .NOETL_PORT }} --json
      - sleep 10
      - echo "=== Database tables created successfully ==="

  test-register-save-simple:
    desc: Register save storage simple test playbook to cluster
    aliases: [trsss]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl register tests/fixtures/playbooks/save_storage_test/save_simple_test.yaml --host {{ .NOETL_HOST }} --port {{ .NOETL_PORT }}

  test-execute-save-simple:
    desc: Execute save storage simple test on cluster
    aliases: [tesss]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl execute playbook "tests/fixtures/playbooks/save_storage_test/save_simple_test" --host {{ .NOETL_HOST }} --port {{ .NOETL_PORT }} --json

  test-save-simple-full:
    desc: Full test - setup environment, create tables, and execute save storage simple test
    aliases: [tsssf]
    cmds:
      - task: setup-test-environment
      - sleep 2
      - task: test-create-tables
      - sleep 5
      - task: test-execute-save-simple

  # === Save Storage Delegation Test ===
  test-register-save-delegation:
    desc: Register save storage delegation test playbook to cluster
    aliases: [trsdt]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl register tests/fixtures/playbooks/save_storage_test/save_delegation_test.yaml --host {{ .NOETL_HOST }} --port {{ .NOETL_PORT }}

  test-execute-save-delegation:
    desc: Execute save storage delegation test on cluster
    aliases: [tesdt]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl execute playbook "tests/fixtures/playbooks/save_storage_test/save_delegation_test" --host {{ .NOETL_HOST }} --port {{ .NOETL_PORT }} --json

  test-save-delegation-full:
    desc: Full test - setup environment, create tables, and execute save storage delegation test
    aliases: [tsdtf]
    cmds:
      - task: setup-test-environment
      - sleep 2
      - task: test-create-tables
      - sleep 5
      - task: test-execute-save-delegation
      - sleep 2
      - task: test-execute-save-simple

  test-register-save-comprehensive:
    desc: Register save storage comprehensive test playbook to cluster
    aliases: [trsct]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl register tests/fixtures/playbooks/save_storage_test/save_all_storage_types.yaml --host {{ .NOETL_HOST }} --port {{ .NOETL_PORT }}

  test-execute-save-comprehensive:
    desc: Execute save storage comprehensive test on cluster
    aliases: [tesct]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl execute playbook "tests/fixtures/playbooks/save_storage_test/save_all_storage_types" --host {{ .NOETL_HOST }} --port {{ .NOETL_PORT }} --json

  test-save-comprehensive-full:
    desc: Full test - setup environment, create tables, and execute save storage comprehensive test
    aliases: [tsctf]
    cmds:
      - task: setup-test-environment
      - sleep 2
      - task: test-create-tables
      - sleep 5
      - task: test-execute-save-comprehensive

  test-register-save-edge-cases:
    desc: Register save storage edge cases test playbook to cluster
    aliases: [trsec]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl register tests/fixtures/playbooks/save_storage_test/save_edge_cases.yaml --host {{ .NOETL_HOST }} --port {{ .NOETL_PORT }}

  test-execute-save-edge-cases:
    desc: Execute save storage edge cases test on cluster
    aliases: [tesec]
    env:
      NOETL_HOST: localhost
      NOETL_PORT: 8082
    cmds:
      - kubectl config use-context kind-noetl
      - .venv/bin/noetl execute playbook "tests/fixtures/playbooks/save_storage_test/save_edge_cases" --host {{ .NOETL_HOST }} --port {{ .NOETL_PORT }} --json

  test-save-edge-cases-full:
    desc: Full test - setup environment, create tables, and execute save storage edge cases test
    aliases: [tsecf]
    cmds:
      - task: setup-test-environment
      - sleep 2
      - task: test-create-tables
      - sleep 5
      - task: test-execute-save-edge-cases

  test-save-storage-all:
    desc: Run all save storage tests (simple, comprehensive, edge cases)
    aliases: [tssall]
    cmds:
      - echo "=== Running Save Storage Test Suite ==="
      - task: setup-test-environment
      - sleep 2
      - task: test-create-tables
      - sleep 5
      - echo "=== Running save storage simple test ==="
      - task: test-execute-save-simple
      - sleep 5
      - echo "=== Running save storage comprehensive test ==="
      - task: test-execute-save-comprehensive
      - sleep 5
      - echo "=== Running save storage edge cases test ==="
      - task: test-execute-save-edge-cases
      - echo "=== Save Storage Test Suite Completed ==="

  validate-save-storage-tests:
    desc: Validate save storage test environment and run validation script
    aliases: [vsst]
    cmds:
      - kubectl config use-context kind-noetl
      - echo "=== Running Save Storage Test Validation ==="
      - tests/fixtures/playbooks/save_storage_test/validate_tests.sh validate
      - echo "=== Save Storage Test Validation Completed ==="

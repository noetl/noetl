apiVersion: noetl.io/v1
kind: Playbook

metadata:
  name: google_secret_manager_oauth
  path: tests/fixtures/playbooks/oauth/google_secret_manager

workload:
  google_auth: google_oauth
  project_id: noetl-demo-19700101  # Your GCP project from gcloud config
  secret_name: gcs_hmac_local
  version: latest
  message: Test Google Secret Manager access using OAuth tokens

workflow:
  - step: start
    desc: Start Google Secret Manager OAuth test
    next:
      - step: get_oauth_token

  - step: get_oauth_token
    desc: Generate OAuth token for Secret Manager API
    tool: python
    code: |
      def main(google_auth, project_id):
          """
          Generate OAuth token using the token() function.
          This will use the Google service account credentials to generate
          an ID token with the correct audience for Secret Manager API.
          """
          # The token() function is registered in the Jinja2 environment
          # It will be resolved when the template is rendered
          return {
              'status': 'success',
              'message': 'Token will be generated via Jinja2 template in next step',
              'project_id': project_id
          }
    args:
      google_auth: "{{ workload.google_auth }}"
      project_id: "{{ workload.project_id }}"
    next:
      - step: call_secret_manager_api

  - step: call_secret_manager_api
    desc: Call Google Secret Manager API with OAuth token
    tool: http
    method: GET
    url: "https://secretmanager.googleapis.com/v1/projects/{{ workload.project_id }}/secrets/{{ workload.secret_name }}/versions/{{ workload.version }}:access"
    headers:
      Authorization: "Bearer {{ token(workload.google_auth) }}"
      Content-Type: application/json
    next:
      - step: parse_secret_response

  - step: parse_secret_response
    desc: Parse and validate Secret Manager response
    tool: python
    code: |
      import base64
      import json
      
      def main(api_response):
          """Parse the Secret Manager API response."""
          if not isinstance(api_response, dict):
              return {'status': 'error', 'message': 'Invalid API response format'}
          
          data = api_response.get('data', {})
          status_code = api_response.get('status_code', 0)
          
          if status_code != 200:
              return {
                  'status': 'error',
                  'status_code': status_code,
                  'message': f"API call failed with status {status_code}",
                  'response': data
              }
          
          # Extract secret payload
          payload = data.get('payload', {})
          secret_data_b64 = payload.get('data', '')
          
          if not secret_data_b64:
              return {
                  'status': 'error',
                  'message': 'No secret data found in response'
              }
          
          # Decode base64 secret
          try:
              secret_value = base64.b64decode(secret_data_b64).decode('utf-8')
              return {
                  'status': 'success',
                  'secret_value': secret_value,
                  'secret_length': len(secret_value),
                  'message': 'Secret retrieved successfully'
              }
          except Exception as e:
              return {
                  'status': 'error',
                  'message': f'Failed to decode secret: {str(e)}'
              }
    args:
      api_response: "{{ call_secret_manager_api }}"
    next:
      - step: verify_token_auth

  - step: verify_token_auth
    desc: Verify token-based authentication worked
    tool: python
    code: |
      def main(parse_result):
          """Verify the entire OAuth flow worked."""
          if not isinstance(parse_result, dict):
              return {'status': 'error', 'message': 'Invalid parse result'}
          
          if parse_result.get('status') == 'success':
              return {
                  'status': 'success',
                  'message': 'OAuth token authentication successful!',
                  'secret_retrieved': True,
                  'secret_length': parse_result.get('secret_length', 0),
                  'validation': 'Token was generated, API call succeeded, secret decoded'
              }
          else:
              return {
                  'status': 'error',
                  'message': 'OAuth authentication failed',
                  'error_detail': parse_result.get('message', 'Unknown error')
              }
    args:
      parse_result: "{{ parse_secret_response }}"
    next:
      - step: end

  - step: end
    desc: OAuth test completed

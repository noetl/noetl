apiVersion: noetl.io/v2
kind: Playbook

metadata:
  name: google_secret_manager_oauth
  path: tests/fixtures/playbooks/oauth/google_secret_manager

workload:
  google_auth: google_oauth
  project_id: noetl-demo-19700101  # Your GCP project from gcloud config
  secret_name: gcs_hmac_local
  version: latest
  message: Test Google Secret Manager access using OAuth tokens

workflow:
  - step: start
    desc: Start Google Secret Manager OAuth test
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "initialized", "message": "Starting Secret Manager OAuth test"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: get_oauth_token

  - step: get_oauth_token
    desc: Generate OAuth token for Secret Manager API
    tool:
      kind: python
      args:
        google_auth: "{{ google_auth }}"
        project_id: "{{ project_id }}"
      code: |
        """
        Generate OAuth token using the token() function.
        This will use the Google service account credentials to generate
        an ID token with the correct audience for Secret Manager API.
        """
        # The token() function is registered in the Jinja2 environment
        # It will be resolved when the template is rendered
        result = {
            'status': 'success',
            'message': 'Token will be generated via Jinja2 template in next step',
            'project_id': project_id
        }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: call_secret_manager_api

  - step: call_secret_manager_api
    desc: Call Google Secret Manager API with OAuth token
    tool:
      kind: http
      method: GET
      url: "https://secretmanager.googleapis.com/v1/projects/{{ project_id }}/secrets/{{ secret_name }}/versions/{{ version }}:access"
      headers:
        Authorization: "Bearer {{ token(google_auth) }}"
        Content-Type: application/json
    next:
      spec:
        mode: exclusive
      arcs:
        - step: parse_secret_response

  - step: parse_secret_response
    desc: Parse and validate Secret Manager response
    tool:
      kind: python
      libs:
        base64: base64
      args:
        api_response: "{{ call_secret_manager_api }}"
      code: |
        """Parse the Secret Manager API response."""

        if not isinstance(api_response, dict):
            result = {'status': 'error', 'message': 'Invalid API response format'}
        else:
            data = api_response.get('data', {})
            status_code = api_response.get('status_code', 0)

            if status_code != 200:
                result = {
                    'status': 'error',
                    'status_code': status_code,
                    'message': f"API call failed with status {status_code}",
                    'response': data
                }
            else:
                # Extract secret payload
                payload = data.get('payload', {})
                secret_data_b64 = payload.get('data', '')

                if not secret_data_b64:
                    result = {
                        'status': 'error',
                        'message': 'No secret data found in response'
                    }
                else:
                    # Decode base64 secret
                    try:
                        secret_value = base64.b64decode(secret_data_b64).decode('utf-8')
                        result = {
                            'status': 'success',
                            'secret_value': secret_value,
                            'secret_length': len(secret_value),
                            'message': 'Secret retrieved successfully'
                        }
                    except Exception as e:
                        result = {
                            'status': 'error',
                            'message': f'Failed to decode secret: {str(e)}'
                        }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: verify_token_auth

  - step: verify_token_auth
    desc: Verify token-based authentication worked
    tool:
      kind: python
      args:
        parse_result: "{{ parse_secret_response }}"
      code: |
        """Verify the entire OAuth flow worked."""
        if not isinstance(parse_result, dict):
            result = {'status': 'error', 'message': 'Invalid parse result'}
        elif parse_result.get('status') == 'success':
            result = {
                'status': 'success',
                'message': 'OAuth token authentication successful!',
                'secret_retrieved': True,
                'secret_length': parse_result.get('secret_length', 0),
                'validation': 'Token was generated, API call succeeded, secret decoded'
            }
        else:
            result = {
                'status': 'error',
                'message': 'OAuth authentication failed',
                'error_detail': parse_result.get('message', 'Unknown error')
            }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: OAuth test completed
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "completed"}

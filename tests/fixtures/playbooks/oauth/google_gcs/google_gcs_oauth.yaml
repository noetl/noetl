apiVersion: noetl.io/v10
kind: Playbook

metadata:
  name: google_gcs_oauth
  path: tests/fixtures/playbooks/oauth/google_gcs

keychain:
  - name: google_oauth           # Resolved credential name used by token()
    type: google_oauth
    ref: google_oauth            # Credential key stored in DB

workload:
  google_auth: google_oauth
  project_id: noetl-demo-19700101  # Your GCP project from gcloud config
  bucket_name: noetl-demo-19700101  # Use project bucket (commonly exists)
  object_path: fixture/test_oauth.json
  message: Test Google Cloud Storage access using OAuth tokens

workflow:
  - step: start
    desc: Start GCS OAuth test
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "initialized", "message": "Starting GCS OAuth test"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: list_buckets

  - step: list_buckets
    desc: List GCS buckets to verify authentication
    tool:
      kind: http
      method: GET
      url: "https://storage.googleapis.com/storage/v1/b?project={{ project_id }}"
      headers:
        Authorization: "Bearer {{ token(google_auth) }}"
        Content-Type: application/json
    next:
      spec:
        mode: exclusive
      arcs:
        - step: parse_bucket_list

  - step: parse_bucket_list
    desc: Parse bucket list response
    tool:
      kind: python
      args:
        api_response: "{{ list_buckets }}"
      code: |
        """Parse GCS bucket list response."""
        if not isinstance(api_response, dict):
            result = {'status': 'error', 'message': 'Invalid response format'}
        else:
            data = api_response.get('data', {})
            status_code = api_response.get('status_code', 0)

            if status_code != 200:
                result = {
                    'status': 'error',
                    'status_code': status_code,
                    'message': f'API call failed with status {status_code}',
                    'error': data.get('error', {})
                }
            else:
                buckets = data.get('items', [])
                bucket_names = [b.get('name') for b in buckets if b.get('name')]

                result = {
                    'status': 'success',
                    'bucket_count': len(bucket_names),
                    'buckets': bucket_names[:5],  # First 5 buckets
                    'message': f'Found {len(bucket_names)} buckets'
                }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: verify_oauth

  - step: verify_oauth
    desc: Final OAuth verification
    tool:
      kind: python
      args:
        bucket_result: "{{ parse_bucket_list }}"
      code: |
        """Verify OAuth flow completed successfully."""

        # Check bucket listing worked
        bucket_ok = bucket_result.get('status') == 'success'

        if bucket_ok:
            result = {
                'status': 'success',
                'message': 'GCS OAuth authentication fully verified!',
                'bucket_listing': 'SUCCESS',
                'buckets_found': bucket_result.get('bucket_count', 0),
                'validation': 'Token generated, GCS API calls succeeded'
            }
        else:
            result = {
                'status': 'error',
                'message': 'OAuth verification failed',
                'bucket_status': bucket_result.get('status')
            }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: GCS OAuth test completed
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "completed"}

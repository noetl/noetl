apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: test_output_select
  path: tests/output_select_test
  description: 'Test playbook for output_select pattern with large results.


    This demonstrates:

    1. Large result externalization to NATS storage

    2. output_select extraction of small fields

    3. Lazy loading via artifact.get

    4. Template access to extracted fields

    '
workload:
  item_count: 1000
  item_size: 200
workflow:
- step: start
  tool:
  - name: generate_data
    kind: python
    args:
      count: '{{ item_count }}'
      size: '{{ item_size }}'
    code: "# Generate large result that exceeds inline threshold (64KB)\nitems = [\n\
      \    {\"id\": i, \"name\": f\"item_{i}\", \"data\": \"x\" * size, \"status\"\
      : \"active\"}\n    for i in range(count)\n]\nresult = {\n    \"status\": \"\
      success\",\n    \"count\": len(items),\n    \"total_size\": sum(len(item[\"\
      data\"]) for item in items),\n    \"items\": items\n}\n"
  result:
    store:
      kind: auto
    output_select:
    - status
    - count
    - total_size
  next:
    spec:
      mode: exclusive
    arcs:
    - step: verify_extracted_fields
- step: verify_extracted_fields
  tool:
  - name: verify
    kind: python
    args:
      status: '{{ start.status }}'
      count: '{{ start.count }}'
      total_size: '{{ start.total_size }}'
      has_ref: '{{ start._ref is defined }}'
    code: "result = {\n    \"verified\": True,\n    \"status_received\": status,\n\
      \    \"count_received\": count,\n    \"total_size_received\": total_size,\n\
      \    \"was_externalized\": has_ref,\n    \"message\": f\"Verified {count} items\
      \ with total size {total_size}\"\n}\n"
  next:
    spec:
      mode: exclusive
    arcs:
    - step: lazy_load_full_data
- step: lazy_load_full_data
  tool:
  - name: load_artifact
    kind: artifact
    action: get
    args:
      result_ref: '{{ start._ref }}'
  next:
    spec:
      mode: exclusive
    arcs:
    - step: process_full_data
- step: process_full_data
  tool:
  - name: process
    kind: python
    args:
      data: '{{ lazy_load_full_data.data }}'
    code: "if isinstance(data, dict) and \"items\" in data:\n    items = data[\"items\"\
      ]\n    active_count = sum(1 for item in items if item.get(\"status\") == \"\
      active\")\n    result = {\n        \"status\": \"success\",\n        \"total_items\"\
      : len(items),\n        \"active_items\": active_count,\n        \"first_item_id\"\
      : items[0][\"id\"] if items else None\n    }\nelse:\n    result = {\"status\"\
      : \"error\", \"message\": \"Data not in expected format\"}\n"
  next:
    spec:
      mode: exclusive
    arcs:
    - step: summary
- step: summary
  tool:
  - name: summarize
    kind: python
    args:
      extraction_verified: '{{ verify_extracted_fields.verified }}'
      was_externalized: '{{ verify_extracted_fields.was_externalized }}'
      full_data_processed: '{{ process_full_data.total_items }}'
    code: "result = {\n    \"test_result\": \"PASSED\" if extraction_verified and\
      \ was_externalized else \"FAILED\",\n    \"output_select_worked\": extraction_verified,\n\
      \    \"result_was_externalized\": was_externalized,\n    \"full_data_items_processed\"\
      : full_data_processed,\n    \"message\": \"output_select pattern verified successfully\"\
      \ if extraction_verified else \"Test failed\"\n}\n"

apiVersion: noetl.io/v2
kind: Playbook

metadata:
  name: google_id_token_comparison_test
  path: tests/fixtures/playbooks/keychain/google_id_token_comparison
  description: Test both service_account_secret and service_account_credential modes
  version: "1.0"

workload:
  pg_auth: pg_k8s
  gcp_auth: google_oauth
  # Secret Manager mode settings
  service_account_secret_path: projects/1014428265962/secrets/pcc-athena-interop-dev-sa/versions/latest
  # Credential table mode settings
  service_account_credential_name: google_pcc_athena_interop_dev
  # Shared settings
  target_service_url: https://pcc-client-proxy-dev-324vm4y6ma-uc.a.run.app
  test_endpoint: /api/public/preview1/orgs/dea15e95-4b45-40bb-a307-7452a51f8be3/assessments
  org_uuid: "dea15e95-4b45-40bb-a307-7452a51f8be3"
  customer_code: "bhs"

keychain:
  # Mode 1: Service account from Secret Manager
  - name: id_token_from_secret_manager
    kind: google_id_token
    scope: global
    auto_renew: true
    auth: "{{ workload.gcp_auth }}"
    service_account_secret: "{{ workload.service_account_secret_path }}"
    target_audience: "{{ workload.target_service_url }}"
  
  # Mode 2: Service account from credential table (simpler!)
  - name: id_token_from_credential
    kind: google_id_token
    scope: global
    auto_renew: true
    service_account_credential: "{{ workload.service_account_credential_name }}"
    target_audience: "{{ workload.target_service_url }}"

workflow:
  - step: start
    desc: Initialize comparison test
    tool:
      kind: postgres
      auth: "{{ workload.pg_auth }}"
      command: |
        CREATE TABLE IF NOT EXISTS google_id_token_comparison_results (
          id SERIAL PRIMARY KEY,
          execution_id VARCHAR(64),
          test_mode VARCHAR(64),
          test_step VARCHAR(64),
          result JSONB,
          created_at TIMESTAMP DEFAULT NOW()
        );
        
        INSERT INTO google_id_token_comparison_results (execution_id, test_mode, test_step, result)
        VALUES (
          '{{ job.uuid }}',
          'initialization',
          'start',
          '{"status": "initialized", "message": "Testing both Secret Manager and Credential table modes"}'::jsonb
        );
    next:
      - step: test_secret_manager_mode

  - step: test_secret_manager_mode
    desc: Test API call using token from Secret Manager
    tool:
      kind: http
      url: "{{ workload.target_service_url }}{{ workload.test_endpoint }}"
      method: GET
      params:
        facId: 12
        startDate: "2024-01-01T00:00:00.000Z"
        endDate: "2024-12-31T23:59:59.999Z"
        patientId: 465984
        pageSize: 1
        page: 1
      headers:
        Authorization: "Bearer {{ keychain.id_token_from_secret_manager.id_token }}"
        x-customer-code: "{{ workload.customer_code }}"
        Accept: "application/json"
    next:
      - step: store_secret_manager_result

  - step: store_secret_manager_result
    desc: Store Secret Manager mode result
    tool:
      kind: postgres
      auth: "{{ workload.pg_auth }}"
      command: |
        INSERT INTO google_id_token_comparison_results (execution_id, test_mode, test_step, result)
        VALUES (
          '{{ job.uuid }}',
          'secret_manager',
          'api_call',
          $${{ {
            "status": "success" if test_secret_manager_mode.status_code == 200 else "error",
            "status_code": test_secret_manager_mode.status_code,
            "has_data": test_secret_manager_mode.data is defined and test_secret_manager_mode.data.data is defined,
            "data_count": test_secret_manager_mode.data.data | length if test_secret_manager_mode.data and test_secret_manager_mode.data.data else 0
          } | tojson }}$$::jsonb
        );
    next:
      - step: test_credential_table_mode

  - step: test_credential_table_mode
    desc: Test API call using token from credential table
    tool:
      kind: http
      url: "{{ workload.target_service_url }}{{ workload.test_endpoint }}"
      method: GET
      params:
        facId: 12
        startDate: "2024-01-01T00:00:00.000Z"
        endDate: "2024-12-31T23:59:59.999Z"
        patientId: 465984
        pageSize: 1
        page: 1
      headers:
        Authorization: "Bearer {{ keychain.id_token_from_credential.id_token }}"
        x-customer-code: "{{ workload.customer_code }}"
        Accept: "application/json"
    next:
      - step: store_credential_table_result

  - step: store_credential_table_result
    desc: Store credential table mode result
    tool:
      kind: postgres
      auth: "{{ workload.pg_auth }}"
      command: |
        INSERT INTO google_id_token_comparison_results (execution_id, test_mode, test_step, result)
        VALUES (
          '{{ job.uuid }}',
          'credential_table',
          'api_call',
          $${{ {
            "status": "success" if test_credential_table_mode.status_code == 200 else "error",
            "status_code": test_credential_table_mode.status_code,
            "has_data": test_credential_table_mode.data is defined and test_credential_table_mode.data.data is defined,
            "data_count": test_credential_table_mode.data.data | length if test_credential_table_mode.data and test_credential_table_mode.data.data else 0
          } | tojson }}$$::jsonb
        );
    next:
      - step: compare_results

  - step: compare_results
    desc: Compare both modes and verify they work identically
    tool:
      kind: python
      args:
        sm_status: "{{ test_secret_manager_mode.status_code }}"
        cred_status: "{{ test_credential_table_mode.status_code }}"
      code: |
        both_successful = (sm_status == 200) and (cred_status == 200)
        
        result = {
            "status": "success" if both_successful else "partial_success",
            "message": "Both modes work identically" if both_successful else "Check individual results",
            "secret_manager_mode": {
                "status_code": sm_status,
                "working": sm_status == 200
            },
            "credential_table_mode": {
                "status_code": cred_status,
                "working": cred_status == 200
            },
            "recommendation": "Use credential_table mode - simpler setup, no Secret Manager needed" if both_successful else "Debug individual modes"
        }
    next:
      - step: store_comparison_result

  - step: store_comparison_result
    desc: Store final comparison result
    tool:
      kind: postgres
      auth: "{{ workload.pg_auth }}"
      command: |
        INSERT INTO google_id_token_comparison_results (execution_id, test_mode, test_step, result)
        VALUES (
          '{{ job.uuid }}',
          'comparison',
          'final_result',
          $${{ compare_results | tojson }}$$::jsonb
        );
    next:
      - step: end

  - step: end
    desc: Complete comparison test
    tool:
      kind: python
      code: |
        print("[END] Google ID token comparison test completed")
        result = {
            "status": "completed",
            "message": "Both modes tested - check database for results"
        }

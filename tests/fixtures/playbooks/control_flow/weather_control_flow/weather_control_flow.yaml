apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: weather_control_flow
  path: control_flow/weather_control_flow
spec:
  jobId: "{{ job.uuid }}"
  state: ready
  cities:
    - name: "New York"
      lat: 40.71
      lon: -74.01
  temperature_threshold: 20
  base_url: "https://api.open-meteo.com/v1"
workflow:
  - step: start
    desc: "Start weather control flow workflow"
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "initialized"}
    case:
      - when: "{{ event.name == 'call.done' and spec.state == 'ready' }}"
        then:
          - next:
              - step: fetch_weather

      - when: "{{ event.name == 'call.done' and spec.state != 'ready' }}"
        then:
          - next:
              - step: end

  - step: fetch_weather
    desc: "Fetch weather data for the city"
    tool:
      kind: python
      auth: {}
      libs:
        httpx: httpx
      args: {}
      code: "threshold = 20\ncity_dict = {\"name\": \"New York\", \"lat\": 40.71, \"lon\": -74.01}\nurl = f\"https://api.open-meteo.com/v1/forecast\"\nparams = {\n    \"latitude\": city_dict[\"lat\"],\n    \"longitude\": city_dict[\"lon\"],\n    \"hourly\": \"temperature_2m\",\n    \"forecast_days\": 1\n}\n\nresponse = httpx.get(url, params=params)\nforecast_data = response.json()\n\n# Extract max temperature from forecast\ntemperatures = forecast_data.get('hourly', {}).get('temperature_2m', [])\nmax_temp = max(temperatures) if temperatures else 15\n\nresult = {\n    'city': city_dict,\n    'max_temp': max_temp,\n    'alert': max_temp > threshold\n}"
    case:
      - when: "{{ event.name == 'call.done' and response is defined and response.max_temp > spec.temperature_threshold }}"
        then:
          - next:
              - step: report_warm
                args:
                  city: "{{ response.city }}"
                  temperature: "{{ response.max_temp }}"

      - when: "{{ event.name == 'call.done' and response is defined and response.max_temp <= spec.temperature_threshold }}"
        then:
          - next:
              - step: report_cold
                args:
                  city: "{{ response.city }}"
                  temperature: "{{ response.max_temp }}"

  - step: report_warm
    desc: "Report warm weather"
    tool:
      kind: python
      auth: {}
      libs: {}
      args:
        city: "{{ city }}"
        temperature: "{{ temperature }}"
      code: "city_name = city[\"name\"] if isinstance(city, dict) else str(city)\nprint(f\"It's warm in {city_name} ({temperature}°C)\")\nresult = {\"status\": \"warm\", \"city\": city_name, \"temperature\": temperature}"
    next:
      - step: end

  - step: report_cold
    desc: "Report cold weather"
    tool:
      kind: python
      auth: {}
      libs: {}
      args:
        city: "{{ city }}"
        temperature: "{{ temperature }}"
      code: "city_name = city[\"name\"] if isinstance(city, dict) else str(city)\nprint(f\"It's cold in {city_name} ({temperature}°C)\")\nresult = {\"status\": \"cold\", \"city\": city_name, \"temperature\": temperature}"
    next:
      - step: end

  - step: end
    desc: "End of weather control flow workflow"
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "complete"}

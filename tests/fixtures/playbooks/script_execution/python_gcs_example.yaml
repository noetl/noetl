apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: python_gcs_script_example
  path: tests/script_execution/python_gcs

workload:
  gcs_script_uri: gs://noetl-demo-19700101/scripts/hello_world.py
  gcp_credential: google_oauth
  greeting_name: GCS-Loaded

workflow:
  - step: start
    desc: Start workflow
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "initialized"}
    next:
      - step: run_python_from_gcs

  - step: run_python_from_gcs
    desc: Execute Python script from Google Cloud Storage using full URI
    tool:
      kind: python
      script:
        uri: "{{ workload.gcs_script_uri }}"
        source:
          type: gcs
          auth: "{{ workload.gcp_credential }}"
      args:
        name: "{{ workload.greeting_name }}"
        count: 2
    next:
      - step: verify_result

  - step: verify_result
    desc: Verify GCS-loaded script executed correctly
    tool:
      kind: python
      auth: {}
      libs: {}
      args:
        result: "{{ run_python_from_gcs }}"
      code: |
        assert result['status'] == 'success', f"Expected success, got {result['status']}"
        assert result['total_greetings'] == 2, f"Expected 2 greetings, got {result['total_greetings']}"
        assert len(result['messages']) == 2, f"Expected 2 messages, got {len(result['messages'])}"

        result = {
            "status": "verified",
            "source_type": "gcs",
            "checks_passed": 3,
            "result": result
        }
    next:
      - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "complete"}

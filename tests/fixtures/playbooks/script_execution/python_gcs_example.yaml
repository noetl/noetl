apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: python_gcs_script_example
  path: tests/script_execution/python_gcs

workload:
  gcs_script_uri: gs://noetl-demo-19700101/scripts/hello_world.py
  gcp_credential: google_oauth
  greeting_name: GCS-Loaded

workflow:
  - step: start
    desc: Start workflow
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "initialized"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: run_python_from_gcs

  - step: run_python_from_gcs
    desc: Execute Python script from Google Cloud Storage using full URI
    tool:
      kind: python
      script:
        uri: "{{ gcs_script_uri }}"
        source:
          type: gcs
          auth: "{{ gcp_credential }}"
      args:
        name: "{{ greeting_name }}"
        count: 2
    next:
      spec:
        mode: exclusive
      arcs:
        - step: verify_result

  - step: verify_result
    desc: Verify GCS-loaded script executed correctly
    tool:
      kind: python
      args:
        result: "{{ run_python_from_gcs }}"
      code: |
        assert result['status'] == 'success', f"Expected success, got {result['status']}"
        assert result['total_greetings'] == 2, f"Expected 2 greetings, got {result['total_greetings']}"
        assert len(result['messages']) == 2, f"Expected 2 messages, got {len(result['messages'])}"

        result = {
            "status": "verified",
            "source_type": "gcs",
            "checks_passed": 3,
            "result": result
        }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "complete"}

apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: python_gcs_script_example
  path: tests/script_execution/python_gcs

workload:
  gcs_script_uri: gs://noetl-demo-19700101/scripts/hello_world.py  # Full GCS URI
  gcp_credential: google_oauth  # Credential registered in NoETL
  greeting_name: GCS-Loaded

workflow:
  - step: start
    desc: Start workflow
    tool:
      kind: python
      code: |
        def main():
            return {"status": "initialized"}
    
    case:
      - when: "{{ event.name == 'step.exit' }}"
        then:
          next:
            - step: run_python_from_gcs

  - step: run_python_from_gcs
    desc: Execute Python script from Google Cloud Storage using full URI
    tool:
      kind: python
      script:
        uri: "{{ workload.gcs_script_uri }}"  # Full gs://bucket/path URI
        source:
          type: gcs
          auth: "{{ workload.gcp_credential }}"
      args:
        name: "{{ workload.greeting_name }}"
        count: 2
    
    case:
      - when: "{{ event.name == 'call.done' and response is defined }}"
        then:
          next:
            - step: verify_result

  - step: verify_result
    desc: Verify GCS-loaded script executed correctly
    tool:
      kind: python
      code: |
        def main(result):
            assert result['status'] == 'success', f"Expected success, got {result['status']}"
            assert result['total_greetings'] == 2, f"Expected 2 greetings, got {result['total_greetings']}"
            assert len(result['messages']) == 2, f"Expected 2 messages, got {len(result['messages'])}"
            
            return {
                "status": "verified",
                "source_type": "gcs",
                "checks_passed": 3,
                "result": result
            }
      args:
        result: "{{ run_python_from_gcs }}"
    
    case:
      - when: "{{ event.name == 'call.done' and response is defined }}"
        then:
          next:
            - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      code: |
        def main():
            return {"status": "complete"}

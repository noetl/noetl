apiVersion: noetl.io/v10
kind: Playbook
metadata:
  name: postgres_file_script_example
  path: tests/script_execution/postgres_file

workload:
  script_path: ./tests/fixtures/playbooks/script_execution/scripts/create_test_table.sql
  pg_auth: pg_local

workflow:
  - step: start
    desc: Start workflow
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "initialized"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: run_postgres_from_file

  - step: run_postgres_from_file
    desc: Execute SQL script from local file
    tool:
      kind: postgres
      auth: "{{ pg_auth }}"
      script:
        uri: "{{ script_path }}"
        source:
          type: file
    next:
      spec:
        mode: exclusive
      arcs:
        - step: verify_records

  - step: verify_records
    desc: Verify table was created and populated
    tool:
      kind: postgres
      auth: "{{ pg_auth }}"
      command: |
        SELECT * FROM public.script_test ORDER BY id;
    next:
      spec:
        mode: exclusive
      arcs:
        - step: cleanup

  - step: cleanup
    desc: Clean up test table
    tool:
      kind: postgres
      auth: "{{ pg_auth }}"
      command: |
        DROP TABLE IF EXISTS public.script_test;
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "complete"}

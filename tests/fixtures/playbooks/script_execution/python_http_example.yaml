apiVersion: noetl.io/v10
kind: Playbook
metadata:
  name: python_http_script_example
  path: tests/script_execution/python_http

workload:
  script_url: https://raw.githubusercontent.com/noetl/noetl/v1.2.0/tests/fixtures/playbooks/script_execution/scripts/hello_world.py
  greeting_name: HTTP-Fetched

workflow:
  - step: start
    desc: Start workflow
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "initialized"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: run_python_from_http

  - step: run_python_from_http
    desc: Fetch and execute Python script from HTTP
    tool:
      kind: python
      script:
        uri: hello_world.py
        source:
          type: http
          endpoint: "{{ script_url }}"
          method: GET
          timeout: 30
      args:
        name: "{{ greeting_name }}"
        count: 2
    next:
      spec:
        mode: exclusive
      arcs:
        - step: verify_result

  - step: verify_result
    desc: Verify HTTP-fetched script executed correctly
    tool:
      kind: python
      args:
        result: "{{ run_python_from_http }}"
      code: |
        assert result['status'] == 'success', f"Expected success, got {result['status']}"
        assert result['script_source'] == 'file', f"Script should identify as file source"
        assert result['total_greetings'] == 2, f"Expected 2 greetings, got {result['total_greetings']}"

        result = {
            "status": "verified",
            "source_type": "http",
            "result": result
        }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "complete"}

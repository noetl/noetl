apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: simple_http_example_v2
  path: examples/simple_http_v2
  labels:
    category: example
    version: v2

workload:
  api_url: "https://httpbin.org"
  endpoints:
    - path: "/get"
      name: "test_get"

workflow:
  - step: start
    desc: "Start workflow"
    tool:
      kind: http
      method: GET
      endpoint: "{{ workload.api_url }}/get"
      params:
        test: "hello"
    case:
      - when: "{{ event.name == 'call.done' and response is defined and response.status_code == 200 }}"
        then:
          - result:
              from: response.data
          - next:
              - step: process
                args:
                  data: "{{ response.data }}"

      - when: "{{ event.name == 'call.error' }}"
        then:
          - retry:
              max_attempts: 3
              backoff_multiplier: 2.0
              initial_delay: 0.5

  - step: process
    desc: "Process HTTP response"
    tool:
      kind: python
      auth: {}
      libs: {}
      args:
        data: "{{ data }}"
      code: |
        print(f"Processing data: {data}")
        result = {"status": "processed", "data": data}
    next:
      - step: end

  - step: end
    desc: "End workflow"
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        print("Workflow complete")
        result = {"status": "done"}

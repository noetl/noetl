apiVersion: noetl.io/v10
kind: Playbook
metadata:
  name: weather_loop_v2
  path: examples/weather_loop_v2
  version: "2.0"
workload:
  cities:
    - name: San Francisco
      lat: 37.7749
      lon: -122.4194
    - name: New York
      lat: 40.7128
      lon: -74.0060
    - name: London
      lat: 51.5074
      lon: -0.1278
  weather_api_url: https://api.open-meteo.com/v1/forecast
  alert_threshold: 30

ctx:
  weather_results: []
  alerts: []

workbook:
  - name: evaluate_weather_directly
    tool:
      kind: python
      spec:
        args:
          city: null
          threshold: null
        code: |
          # Evaluate weather data
          temp = city.get("temperature", 0)
          alert = temp > threshold

          result = {
              "city": city["name"],
              "temperature": temp,
              "alert": alert,
              "message": f"Temperature {temp}C {'exceeds' if alert else 'below'} threshold {threshold}C"
          }

workflow:
  - step: start
    desc: Start weather monitoring workflow
    tool:
      kind: python
      spec:
        code: |
          result = {"status": "initialized", "timestamp": "2025-12-10T00:00:00Z"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: city_loop

  - step: city_loop
    desc: Loop over cities and fetch weather data
    loop:
      spec:
        mode: sequential
      in: "{{ cities }}"
      iterator: city
    tool:
      - fetch_weather:
          kind: http
          spec:
            method: GET
            endpoint: "{{ weather_api_url }}"
            params:
              latitude: "{{ iter.city.lat }}"
              longitude: "{{ iter.city.lon }}"
              current_weather: true
              temperature_unit: celsius
            policy:
              rules:
                - when: "{{ outcome.status == 'error' and outcome.http.status in [500, 502, 503, 504] }}"
                  then:
                    do: retry
                    attempts: 3
                    backoff: exponential
                    delay: 1.0
                - when: "{{ outcome.status == 'error' }}"
                  then:
                    do: fail
                - else:
                    do: continue
                    set_iter:
                      current_temp: "{{ outcome.result.current_weather.temperature }}"
                      city_data:
                        name: "{{ iter.city.name }}"
                        temperature: "{{ outcome.result.current_weather.temperature }}"
                        windspeed: "{{ outcome.result.current_weather.windspeed }}"

      - evaluate_and_route:
          kind: python
          spec:
            args:
              city_data: "{{ iter.city_data }}"
              threshold: "{{ alert_threshold }}"
              weather_results: "{{ ctx.weather_results }}"
              alerts: "{{ ctx.alerts }}"
            code: |
              # Evaluate if alert is needed
              temp = city_data.get("temperature", 0)
              alert_triggered = temp > threshold

              if alert_triggered:
                  alerts.append({
                      "city": city_data["name"],
                      "temperature": temp,
                      "alert": True,
                      "message": f"Temperature {temp}C exceeds threshold {threshold}C"
                  })
              else:
                  weather_results.append({
                      "city": city_data["name"],
                      "temperature": temp,
                      "alert": False,
                      "message": f"Temperature {temp}C below threshold {threshold}C"
                  })

              result = {
                  "alert_triggered": alert_triggered,
                  "city_data": city_data,
                  "weather_results": weather_results,
                  "alerts": alerts
              }
            policy:
              rules:
                - else:
                    do: continue
                    set_ctx:
                      weather_results: "{{ outcome.result.weather_results }}"
                      alerts: "{{ outcome.result.alerts }}"

    next:
      spec:
        mode: exclusive
      arcs:
        - step: generate_summary

  - step: generate_summary
    desc: Generate summary of weather monitoring
    tool:
      - compute_summary:
          kind: python
          spec:
            args:
              weather_results: "{{ ctx.weather_results }}"
              alerts: "{{ ctx.alerts }}"
            code: |
              total_cities = len(weather_results) + len(alerts)
              alert_count = len(alerts)

              summary = {
                  "total_cities_monitored": total_cities,
                  "alerts_triggered": alert_count,
                  "alert_percentage": (alert_count / total_cities * 100) if total_cities > 0 else 0,
                  "weather_data": weather_results,
                  "alerts": alerts
              }

              result = summary
            policy:
              rules:
                - else:
                    do: continue
                    set_ctx:
                      summary: "{{ outcome.result }}"

      - save_summary:
          kind: postgres
          spec:
            auth: pg_local
            command: |
              INSERT INTO weather_monitoring_summary (
                execution_id,
                total_cities,
                alerts_triggered,
                summary_data,
                created_at
              ) VALUES (
                '{{ execution_id }}',
                {{ ctx.summary.total_cities_monitored }},
                {{ ctx.summary.alerts_triggered }},
                $json${{ ctx.summary | tojson }}$json$::jsonb,
                NOW()
              );
            policy:
              rules:
                - when: "{{ outcome.status == 'error' }}"
                  then:
                    do: fail
                - else:
                    do: continue

    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: End of weather monitoring workflow
    tool:
      kind: python
      spec:
        code: |
          result = {"status": "completed", "workflow": "weather_monitoring"}

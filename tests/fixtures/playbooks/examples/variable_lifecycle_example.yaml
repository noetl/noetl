apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: variable_lifecycle_example
  path: examples/variable_lifecycle
  description: "Demonstrates BEFORE and AFTER execution variable patterns"

workload:
  environment: "production"
  api_base_url: "https://api.example.com"
  retry_limit: 3
  user_id: "{{ payload.user_id }}"

workflow:
  - step: start
    desc: "Entry point"
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "initialized"}
    next:
      - step: fetch_user_data

  - step: fetch_user_data
    desc: "Fetch user data using global variables"
    tool:
      kind: http
      method: GET
      endpoint: "{{ workload.api_base_url }}/users/{{ workload.user_id }}"
      headers:
        X-Environment: "{{ workload.environment }}"
    case:
      - when: "{{ event.name == 'call.done' and response is defined }}"
        then:
          - set:
              - name: user_email
                value: "{{ response.data.email }}"
              - name: user_status
                value: "{{ response.data.status }}"
              - name: user_created
                value: "{{ response.data.created_at }}"
          - next:
              - step: calculate_metrics

  - step: calculate_metrics
    desc: "Calculate metrics using args from previous step"
    tool:
      kind: python
      auth: {}
      libs: {}
      args:
        email: "{{ vars.user_email }}"
        status: "{{ vars.user_status }}"
        retry_count: "{{ workload.retry_limit }}"
      code: |
        metrics = {
            "email_domain": email.split('@')[1] if '@' in email else 'unknown',
            "is_active": status == 'active',
            "max_retries": retry_count,
            "score": 100 if status == 'active' else 0
        }
        result = metrics
    case:
      - when: "{{ event.name == 'call.done' and response is defined and response.is_active }}"
        then:
          - set:
              - name: email_domain
                value: "{{ response.email_domain }}"
              - name: user_score
                value: "{{ response.score }}"
          - next:
              - step: active_user_flow
                args:
                  domain: "{{ response.email_domain }}"
                  score: "{{ response.score }}"

      - when: "{{ event.name == 'call.done' and response is defined and not response.is_active }}"
        then:
          - set:
              - name: email_domain
                value: "{{ response.email_domain }}"
              - name: user_score
                value: "{{ response.score }}"
          - next:
              - step: inactive_user_flow

  - step: active_user_flow
    desc: "Process active users with received args"
    tool:
      kind: python
      auth: {}
      libs: {}
      args:
        domain: null
        score: null
        global_env: "{{ workload.environment }}"
      code: |
        result = {
            "message": f"Active user in {global_env}",
            "domain": domain,
            "bonus_score": score + 10
        }
    next:
      - step: store_results

  - step: inactive_user_flow
    desc: "Process inactive users"
    tool:
      kind: python
      auth: {}
      libs: {}
      args:
        email: "{{ vars.user_email }}"
        status: "{{ vars.user_status }}"
      code: |
        result = {
            "message": f"Inactive user: {email}",
            "status": status,
            "action": "send_reactivation_email"
        }
    next:
      - step: store_results

  - step: store_results
    desc: "Store results using direct step access"
    tool:
      kind: python
      auth: {}
      libs: {}
      args:
        user_email: "{{ fetch_user_data.data.email }}"
        user_score: "{{ vars.user_score }}"
        environment: "{{ workload.environment }}"
        active_result: "{{ active_user_flow.message if active_user_flow else 'N/A' }}"
        inactive_result: "{{ inactive_user_flow.message if inactive_user_flow else 'N/A' }}"
      code: |
        result = {
            "stored_at": "2025-12-02T17:30:00Z",
            "email": user_email,
            "score": user_score,
            "environment": environment,
            "flow_result": active_result if active_result != 'N/A' else inactive_result
        }
        print(f"Stored results for {user_email} in {environment}")
    next:
      - step: end

  - step: end
    desc: "Workflow complete"
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "complete"}

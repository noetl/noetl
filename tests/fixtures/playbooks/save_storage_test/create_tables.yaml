apiVersion: noetl.io/v10
kind: Playbook
metadata:
  name: create_test_tables
  path: tests/fixtures/playbooks/save_storage_test/create_tables

workload:
  test_name: create_test_tables
  pg_auth: pg_local

workflow:
  - step: start
    desc: Start table creation
    tool:
      kind: python
      code: |
        result = {"status": "initialized"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: create_all_tables

  - step: create_all_tables
    desc: Create all test tables in single operation
    tool:
      kind: postgres
      auth: "{{ pg_auth }}"
      pool:
        name: test_shared_pool
        timeout: 60
        max_size: 10
        min_size: 2
      command: |
        -- Create flat test table
        CREATE TABLE IF NOT EXISTS simple_test_flat (
          test_id VARCHAR(255) PRIMARY KEY,
          test_name VARCHAR(255),
          test_value INTEGER,
          storage_type VARCHAR(255),
          test_execution VARCHAR(255)
        );

        -- Create nested test table
        CREATE TABLE IF NOT EXISTS simple_test_nested (
          test_id VARCHAR(255) PRIMARY KEY,
          test_name VARCHAR(255),
          test_data JSONB,
          storage_type VARCHAR(255),
          test_execution VARCHAR(255)
        );

        -- Create summary table
        CREATE TABLE IF NOT EXISTS test_summary (
          id SERIAL PRIMARY KEY,
          summary_type VARCHAR(255),
          total_records INTEGER,
          avg_value DECIMAL(10,2),
          test_execution VARCHAR(255),
          created_at TIMESTAMP DEFAULT NOW()
        );
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: Table creation completed
    tool:
      kind: python
      code: |
        result = {"status": "completed"}

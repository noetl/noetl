apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: save_storage_delegation_test
  path: tests/fixtures/playbooks/save_storage_test/save_delegation_test
  description: Simple test demonstrating save storage delegation is working
workload:
  pg_auth: pg_local
  test_message: Hello from save storage delegation test!
workflow:
- step: start
  desc: Setup test tables
  tool:
    kind: python
    code: 'result = {"status": "initialized"}

      '
  next:
    spec:
      mode: exclusive
    arcs:
    - step: create_tables
- step: create_tables
  desc: Create required test tables
  tool:
    kind: playbook
    path: tests/fixtures/playbooks/save_storage_test/create_tables
    args:
      pg_auth: '{{ pg_auth }}'
  next:
    spec:
      mode: exclusive
    arcs:
    - step: truncate_tables
- step: truncate_tables
  desc: Clear test data from previous runs
  tool:
    kind: postgres
    auth: '{{ pg_auth }}'
    command: 'TRUNCATE TABLE simple_test_flat CASCADE;

      '
  next:
    spec:
      mode: exclusive
    arcs:
    - step: event_test
- step: event_test
  desc: Test event storage delegation
  tool:
    kind: python
    code: "# Simple function that doesn't need input_data parameter\nresult = {\n\
      \    \"test\": \"event_storage\",\n    \"message\": \"Event storage delegation\
      \ working\"\n}\n"
  next:
    spec:
      mode: exclusive
    arcs:
    - step: postgres_test
- step: postgres_test
  desc: Test postgres storage delegation
  tool:
  - name: generate_data
    kind: python
    code: "result = {\n    \"test\": \"postgres_storage\",\n    \"message\": \"Postgres\
      \ storage delegation working\",\n    \"value\": 123\n}\n"
  - name: save_postgres
    kind: postgres
    auth: '{{ pg_auth }}'
    command: "INSERT INTO simple_test_flat (test_id, test_name, test_value, storage_type,\
      \ test_execution)\nVALUES (\n  'delegation_test',\n  '{{ generate_data.test\
      \ }}',\n  {{ generate_data.value }},\n  'delegation',\n  '{{ execution_id }}'\n\
      )\nON CONFLICT (test_id) DO UPDATE SET\n  test_name = EXCLUDED.test_name,\n\
      \  test_value = EXCLUDED.test_value,\n  storage_type = EXCLUDED.storage_type,\n\
      \  test_execution = EXCLUDED.test_execution;\n"
  next:
    spec:
      mode: exclusive
    arcs:
    - step: duckdb_test
- step: duckdb_test
  desc: Test duckdb storage delegation
  tool:
  - name: generate_data
    kind: python
    code: "result = {\n    \"test\": \"duckdb_storage\",\n    \"message\": \"DuckDB\
      \ storage delegation working\"\n}\n"
  - name: save_duckdb
    kind: duckdb
    commands: 'CREATE OR REPLACE TABLE test_duckdb AS

      SELECT ''delegation_test'' as test_type, ''duckdb_working'' as status;

      SELECT * FROM test_duckdb;

      '
  next:
    spec:
      mode: exclusive
    arcs:
    - step: http_test
- step: http_test
  desc: Test http storage delegation
  tool:
  - name: generate_data
    kind: python
    code: "result = {\n    \"test\": \"http_storage\",\n    \"message\": \"HTTP storage\
      \ delegation working\"\n}\n"
  - name: send_webhook
    kind: http
    method: POST
    url: https://httpbin.org/post
    headers:
      Content-Type: application/json
    body:
      test: '{{ generate_data.test }}'
      message: '{{ generate_data.message }}'
  next:
    spec:
      mode: exclusive
    arcs:
    - step: end
- step: end
  desc: Complete delegation test
  tool:
    kind: python
    code: 'result = {"status": "complete"}

      '

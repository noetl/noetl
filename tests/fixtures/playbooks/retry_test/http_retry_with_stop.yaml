apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: http_retry_with_stop
  path: tests/retry/http_stop_condition
  description: Test HTTP retry with stop condition when successful

workload:
  test_url: https://httpbin.org/get

workflow:
  - step: start
    desc: Fetch URL and stop retrying when status is 200
    tool:
      kind: http
      method: GET
      url: "{{ workload.test_url }}"
    case:
      - when: "{{ event.name == 'call.error' }}"
        then:
          - retry:
              max_attempts: 3
              initial_delay: 0.5
              backoff_multiplier: 1.5

      - when: "{{ event.name == 'call.done' and response is defined }}"
        then:
          - next:
              - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "complete"}

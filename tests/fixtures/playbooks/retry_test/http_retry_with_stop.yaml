apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: http_retry_with_stop
  path: tests/retry/http_stop_condition
  description: Test HTTP retry with stop condition when successful

workload:
  test_url: https://httpbin.org/get

workflow:
  - step: start
    desc: Fetch URL and stop retrying when status is 200
    tool:
      kind: http
      method: GET
      url: "{{ workload.test_url }}"
      eval:
        - expr: "{{ outcome.http.status in [500, 502, 503] }}"
          do: retry
          attempts: 3
          delay: 0.5
          backoff: exponential
        - expr: "{{ outcome.status == 'error' }}"
          do: fail
        - else:
            do: continue
    next:
      - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "complete"}

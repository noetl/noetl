apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: postgres_retry_connection
  path: tests/retry/postgres_connection
  description: Test Postgres retry on connection or query errors

workload:
  query: SELECT 1 as test_value
  pg_auth: pg_k8s

workflow:
  - step: start
    desc: Execute query with retry on errors
    tool:
      kind: postgres
      auth: "{{ workload.pg_auth }}"
      command: "{{ workload.query }}"
      eval:
        - expr: "{{ outcome.status == 'error' }}"
          do: retry
          attempts: 3
          delay: 1.0
          backoff: exponential
        - else:
            do: continue
    next:
      - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "complete"}

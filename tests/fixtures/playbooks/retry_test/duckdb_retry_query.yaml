apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: duckdb_retry_query
  path: tests/retry/duckdb_query
  description: Test DuckDB retry on query failures

workload:
  test_query: SELECT 42 as answer, 'success' as status
  
workflow:
  - step: start
    tool:
      kind: python
      code: |
        def main():
            return {"status": "initialized"}
    
    case:
      - when: "{{ event.name == 'step.exit' }}"
        then:
          next:
            - step: retry

  - step: retry
    desc: Execute DuckDB query with retry
    tool:
      kind: duckdb
      command: "{{ workload.test_query }}"
    
    case:
      - when: "{{ event.name == 'call.error' and error is defined }}"
        then:
          retry:
            max_attempts: 3
            initial_delay: 0.5
            backoff_multiplier: 1.5
      
      - when: "{{ event.name == 'step.exit' and response is defined }}"
        then:
          next:
            - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      code: |
        def main():
            return {"status": "complete"}

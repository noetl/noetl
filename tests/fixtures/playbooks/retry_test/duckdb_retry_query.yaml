apiVersion: noetl.io/v10
kind: Playbook
metadata:
  name: duckdb_retry_query
  path: tests/retry/duckdb_query
  description: Test DuckDB retry on query failures

workload:
  test_query: SELECT 42 as answer, 'success' as status

workflow:
  - step: start
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "initialized"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: retry

  - step: retry
    desc: Execute DuckDB query with retry
    tool:
      kind: duckdb
      command: "{{ test_query }}"
      spec:
        policy:
          rules:
            - when: "{{ outcome.status == 'error' }}"
              then: { do: retry, attempts: 3, delay: 0.5, backoff: exponential }
            - else:
                then: { do: continue }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "complete"}

apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: http_retry_status_code
  path: tests/retry/http_status_code
  description: Test HTTP retry based on status code condition

workload:
  test_url: https://httpbin.org/get
  
workflow:
  - step: start
    desc: Fetch URL that returns 200 (changed from 503 for testing)
    tool:
      kind: http
      method: GET
      url: "{{ workload.test_url }}"
    
    case:
      - when: "{{ event.name == 'call.error' }}"
        then:
          retry:
            max_attempts: 3
            initial_delay: 0.5
            backoff_multiplier: 2.0
            max_delay: 5.0
      
      - when: "{{ event.name == 'step.exit' and response is defined }}"
        then:
          next:
            - step: end
        
  - step: end
    desc: End workflow
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "complete"}

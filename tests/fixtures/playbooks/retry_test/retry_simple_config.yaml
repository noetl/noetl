apiVersion: noetl.io/v1
kind: Playbook
metadata:
  name: retry_simple_config
  path: tests/retry/simple_config
  description: Test simplified retry configuration options

workload:
  api_url: http://paginated-api.test-server.svc.cluster.local:5555
  fail_on_page: "1"
  
workflow:
  - step: start
    desc: Fetch URL and retry on 5xx status codes
    next:
      - step: boolean_retry
  - step: boolean_retry
    desc: Simple on_error retry with defaults
    tool: http
    method: GET
    url: "{{ workload.api_url }}/api/v1/flaky"
    params:
      page: 1
      fail_on: "{{ workload.fail_on_page }}"
    retry:
      on_error:
        when: "{{ error.status in [500, 502, 503] }}"
        max_attempts: 3
        initial_delay: 0.5
    next:
      - step: integer_retry
        
  - step: integer_retry
    desc: Retry with custom max attempts
    tool: http
    method: GET
    url: "{{ workload.api_url }}/api/v1/flaky"
    params:
      page: 1
      fail_on: "{{ workload.fail_on_page }}"
    retry:
      on_error:
        when: "{{ error.status in [500, 502, 503] }}"
        max_attempts: 5
        initial_delay: 0.5
    next:
      - step: full_config_retry
      
  - step: full_config_retry
    desc: Full configuration retry with backoff
    tool: http
    method: GET
    url: "{{ workload.api_url }}/api/v1/flaky"
    params:
      page: 1
      fail_on: "{{ workload.fail_on_page }}"
    retry:
      on_error:
        when: "{{ error.status in [500, 502, 503] }}"
        max_attempts: 3
        initial_delay: 0.5
        backoff_multiplier: 2.0
        max_delay: 10.0
    next:
      - step: end
        
  - step: end
    desc: End workflow

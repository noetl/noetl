apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: retry_simple_config
  path: tests/retry/simple_config
  description: Test simplified retry configuration using tool.spec.policy.rules

workload:
  api_url: http://paginated-api.test-server.svc.cluster.local:5555
  fail_on_page: "1"

workflow:
  - step: start
    desc: Initialize retry tests
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "initialized"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: boolean_retry

  - step: boolean_retry
    desc: Simple on_error retry with defaults
    tool:
      kind: http
      method: GET
      url: "{{ api_url }}/api/v1/flaky"
      params:
        page: 1
        fail_on: "{{ fail_on_page }}"
      spec:
        policy:
          rules:
            - when: "{{ outcome.http.status in [500, 502, 503] }}"
              then: { do: retry, attempts: 3, delay: 0.5 }
            - when: "{{ outcome.status == 'error' }}"
              then: { do: fail }
            - else:
                then: { do: continue }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: integer_retry

  - step: integer_retry
    desc: Retry with custom max attempts
    tool:
      kind: http
      method: GET
      url: "{{ api_url }}/api/v1/flaky"
      params:
        page: 1
        fail_on: "{{ fail_on_page }}"
      spec:
        policy:
          rules:
            - when: "{{ outcome.http.status in [500, 502, 503] }}"
              then: { do: retry, attempts: 5, delay: 0.5 }
            - when: "{{ outcome.status == 'error' }}"
              then: { do: fail }
            - else:
                then: { do: continue }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: full_config_retry

  - step: full_config_retry
    desc: Full configuration retry with backoff
    tool:
      kind: http
      method: GET
      url: "{{ api_url }}/api/v1/flaky"
      params:
        page: 1
        fail_on: "{{ fail_on_page }}"
      spec:
        policy:
          rules:
            - when: "{{ outcome.http.status in [500, 502, 503] }}"
              then: { do: retry, attempts: 3, backoff: exponential, delay: 0.5 }
            - when: "{{ outcome.status == 'error' }}"
              then: { do: fail }
            - else:
                then: { do: continue }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "complete"}

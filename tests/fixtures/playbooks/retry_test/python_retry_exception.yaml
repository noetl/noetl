apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: python_retry_exception
  path: tests/retry/python_exception
  description: Test Python task retry on exception

workload:
  max_value: 10
  
workflow:
  - step: start
    desc: Run Python code that fails initially then succeeds
    tool:
      kind: python
      code: |
        
        def main():
            import random
            # Simulate random failures for testing retry
            rand_val = random.randint(1, 100)
            
            if rand_val < 70:  # 70% chance of failure
                raise Exception(f"Random failure (value: {rand_val})")
            
            return {
                'success': True,
                'message': f'Success after retry (value: {rand_val})',
                'data': {'value': rand_val}
            }
    
    case:
      - when: "{{ event.name == 'call.error' and error is defined }}"
        then:
          retry:
            max_attempts: 5
            initial_delay: 0.2
            backoff_multiplier: 1.5
            max_delay: 2.0
      
      - when: "{{ event.name == 'step.exit' and response is defined }}"
        then:
          next:
            - step: end
        
  - step: end
    desc: End workflow
    tool:
      kind: python
      code: |
        def main():
            return {"status": "complete"}

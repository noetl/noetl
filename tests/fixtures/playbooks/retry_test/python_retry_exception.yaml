apiVersion: noetl.io/v10
kind: Playbook
metadata:
  name: python_retry_exception
  path: tests/retry/python_exception
  description: Test Python task retry on exception

workload:
  max_value: 10

workflow:
  - step: start
    desc: Run Python code that fails initially then succeeds
    tool:
      kind: python
      libs:
        random: random
      args: {}
      code: |
        # Simulate random failures for testing retry
        rand_val = random.randint(1, 100)

        if rand_val < 70:  # 70% chance of failure
            raise Exception(f"Random failure (value: {rand_val})")

        result = {
            'success': True,
            'message': f'Success after retry (value: {rand_val})',
            'data': {'value': rand_val}
        }
      spec:
        policy:
          rules:
            - when: "{{ outcome.status == 'error' }}"
              then: { do: retry, attempts: 5, delay: 0.2, backoff: exponential }
            - else:
                then: { do: continue }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "complete"}

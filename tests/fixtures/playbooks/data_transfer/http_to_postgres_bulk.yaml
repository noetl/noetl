apiVersion: noetl.io/v1
kind: Playbook
metadata:
  name: http_to_postgres_bulk
  path: examples/data_transfer/http_to_postgres_bulk

workload:
  api_url: "https://jsonplaceholder.typicode.com/posts"
  pg_credential: pg_local

workflow:
  - step: start
    desc: Start workflow
    next:
      - step: create_table

  - step: create_table
    desc: Create table for storing HTTP data
    tool: postgres
    auth: "{{ workload.pg_credential }}"
    command: |
      DROP TABLE IF EXISTS public.http_posts;
      
      CREATE TABLE public.http_posts (
        id SERIAL PRIMARY KEY,
        post_id INTEGER,
        user_id INTEGER,
        title TEXT,
        body TEXT,
        fetched_at TIMESTAMPTZ DEFAULT NOW()
      );
    next:
      - step: fetch_http_data

  - step: fetch_http_data
    desc: Fetch data from HTTP API
    tool: http
    method: GET
    url: "{{ workload.api_url }}"
    next:
      - step: bulk_insert

  - step: bulk_insert
    desc: Bulk insert posts into PostgreSQL
    tool: python
    code: |
      import psycopg2
      import json
      
      def main(input_data):
          # Get posts from HTTP response
          posts = input_data.get('fetch_http_data', {}).get('data', [])
          
          # Get credential
          cred_data = input_data.get('credentials', {}).get('pg_local', {})
          
          # Connect to PostgreSQL
          conn = psycopg2.connect(
              host=cred_data.get('host'),
              port=cred_data.get('port', 5432),
              user=cred_data.get('user'),
              password=cred_data.get('password'),
              database=cred_data.get('database')
          )
          
          cursor = conn.cursor()
          
          # Bulk insert
          inserted = 0
          for post in posts:
              cursor.execute(
                  """
                  INSERT INTO public.http_posts (post_id, user_id, title, body)
                  VALUES (%s, %s, %s, %s)
                  """,
                  (post['id'], post['userId'], post['title'], post['body'])
              )
              inserted += 1
          
          conn.commit()
          cursor.close()
          conn.close()
          
          return {'inserted': inserted, 'total': len(posts)}
    next:
      - step: show_count

  - step: show_count
    desc: Verify record count
    tool: postgres
    auth: "{{ workload.pg_credential }}"
    command: |
      SELECT COUNT(*) as records FROM public.http_posts;
    next:
      - step: end

  - step: end
    desc: End workflow

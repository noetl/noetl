apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: http_to_postgres_transfer
  path: tests/fixtures/playbooks/data_transfer/http_to_postgres_transfer

workload:
  api_url: "https://jsonplaceholder.typicode.com/posts"
  pg_auth: pg_local

workflow:
  - step: start
    desc: Start workflow
    tool:
      kind: python
      code: |
        def main():
            return {"status": "initialized"}
    next:
      - step: create_table

  - step: create_table
    desc: Create table for storing HTTP data
    tool:
      kind: postgres
      auth: "{{ workload.pg_auth }}"
      command: |
        DROP TABLE IF EXISTS public.http_to_postgres_transfer;

        CREATE TABLE public.http_to_postgres_transfer (
          id SERIAL PRIMARY KEY,
          post_id INTEGER,
          user_id INTEGER,
          title TEXT,
          body TEXT,
          fetched_at TIMESTAMPTZ DEFAULT NOW()
        );
    next:
      - step: transfer_http_to_pg

  - step: transfer_http_to_pg
    desc: Fetch HTTP data and insert into PostgreSQL
    tool:
      kind: http
      url: "{{ workload.api_url }}"
      method: GET
    
    case:
      - when: "{{ event.name == 'call.done' and response is defined }}"
        then:
          sink:
            tool: postgres
            auth: "{{ workload.pg_auth }}"
            table: public.http_to_postgres_transfer
            mode: insert
            mapping:
              post_id: id
              user_id: userId
              title: title
              body: body
            data: "{{ response.data }}"
          next:
            - step: show_count

  - step: show_count
    desc: Verify record count
    tool:
      kind: postgres
      auth: "{{ workload.pg_auth }}"
      command: |
        SELECT COUNT(*) as records FROM public.http_to_postgres_transfer;
    next:
      - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      code: |
        def main():
            return {"status": "completed"}

apiVersion: noetl.io/v1
kind: Playbook
metadata:
  name: http_to_postgres_transfer
  path: tests/fixtures/playbooks/data_transfer/http_to_postgres_transfer

workload:
  api_url: "https://jsonplaceholder.typicode.com/posts"
  pg_auth: pg_local

workflow:
  - step: start
    desc: Start workflow
    next:
      - step: create_table

  - step: create_table
    desc: Create table for storing HTTP data
    type: postgres
    auth: "{{ workload.pg_auth }}"
    command: |
      DROP TABLE IF EXISTS public.http_posts;
      
      CREATE TABLE public.http_posts (
        id SERIAL PRIMARY KEY,
        post_id INTEGER,
        user_id INTEGER,
        title TEXT,
        body TEXT,
        fetched_at TIMESTAMPTZ DEFAULT NOW()
      );
    next:
      - step: transfer_http_to_pg

  - step: transfer_http_to_pg
    desc: Transfer HTTP API data to PostgreSQL
    type: transfer
    source:
      type: http
      url: "{{ workload.api_url }}"
      method: GET
    target:
      type: postgres
      auth: "{{ workload.pg_auth }}"
      table: public.http_posts
      mode: insert
      mapping:
        post_id: id
        user_id: userId
        title: title
        body: body
    next:
      - step: show_count

  - step: show_count
    desc: Verify record count
    type: postgres
    auth: "{{ workload.pg_auth }}"
    command: |
      SELECT COUNT(*) as records FROM public.http_posts;
    next:
      - step: end

  - step: end
    desc: End workflow

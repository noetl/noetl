apiVersion: noetl.io/v1
kind: Playbook

metadata:
  name: http_to_postgres_simple
  path: tests/fixtures/playbooks/data_transfer/http_to_postgres_simple

workload:
  pg_auth: pg_local
  message: Simple HTTP to PostgreSQL transfer example
  api_url: https://jsonplaceholder.typicode.com/posts

workflow:
  - step: start
    desc: Start HTTP to PostgreSQL transfer
    next:
      - step: fetch_posts

  - step: fetch_posts
    desc: Fetch posts from JSONPlaceholder API
    type: http
    method: GET
    url: "{{ workload.api_url }}"
    next:
      - step: create_pg_table

  - step: create_pg_table
    desc: Create PostgreSQL table for posts
    type: postgres
    auth: "{{ workload.pg_auth }}"
    command: |
      CREATE TABLE IF NOT EXISTS public.http_posts (
        id INTEGER PRIMARY KEY,
        user_id INTEGER,
        title TEXT,
        body TEXT
      );
      
      TRUNCATE TABLE public.http_posts;
    next:
      - step: transform_and_insert

  - step: transform_and_insert
    desc: Transform and insert posts into PostgreSQL
    type: python
    code: |
      def main(input_data):
          """Transform JSON posts and insert into PostgreSQL."""
          # Get posts directly from input_data
          posts = input_data.get('posts', [])
          
          if not posts:
              return {'status': 'error', 'message': 'No posts found', 'count': 0}
          
          # Prepare SQL statements
          insert_statements = []
          for post in posts:
              if not post or not post.get('id'):
                  continue
              
              title = (post.get('title') or '').replace("'", "''")
              body = (post.get('body') or '').replace("'", "''")
              
              sql = f"INSERT INTO public.http_posts (id, user_id, title, body) VALUES ({post['id']}, {post.get('userId', 0)}, '{title}', '{body}') ON CONFLICT (id) DO NOTHING;"
              insert_statements.append(sql)
          
          return {
              'status': 'success',
              'sql_statements': insert_statements,
              'count': len(insert_statements)
          }
    data:
      posts: "{{ fetch_posts.data }}"
    next:
      - step: execute_inserts

  - step: execute_inserts
    desc: Execute INSERT statements
    type: postgres
    auth: "{{ workload.pg_auth }}"
    command: "{{ transform_and_insert.sql_statements | join('\n') }}"
    next:
      - step: verify_data

  - step: verify_data
    desc: Verify data was inserted
    type: postgres
    auth: "{{ workload.pg_auth }}"
    command: |
      SELECT 
        COUNT(*) as total_posts,
        COUNT(DISTINCT user_id) as unique_users,
        MAX(id) as max_post_id
      FROM public.http_posts;
    next:
      - step: show_sample

  - step: show_sample
    desc: Show sample posts
    type: postgres
    auth: "{{ workload.pg_auth }}"
    command: |
      SELECT id, user_id, title, LEFT(body, 50) || '...' as body_preview
      FROM public.http_posts
      ORDER BY id
      LIMIT 5;
    next:
      - step: end

  - step: end
    desc: End HTTP to PostgreSQL transfer

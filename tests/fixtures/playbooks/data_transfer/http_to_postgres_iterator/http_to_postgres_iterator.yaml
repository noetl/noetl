apiVersion: noetl.io/v10
kind: Playbook
metadata:
  name: http_to_postgres_iterator
  path: examples/data_transfer/http_to_postgres_iterator

workload:
  api_url: "https://jsonplaceholder.typicode.com/posts"
  pg_auth: pg_local

workflow:
  - step: start
    desc: Start workflow
    tool:
      kind: python
      code: |
        result = {"status": "initialized"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: create_table

  - step: create_table
    desc: Create table for storing HTTP data
    tool:
      kind: postgres
      auth: "{{ pg_auth }}"
      command: |
        DROP TABLE IF EXISTS public.http_to_postgres_iterator;

        CREATE TABLE public.http_to_postgres_iterator (
          id SERIAL PRIMARY KEY,
          post_id INTEGER,
          user_id INTEGER,
          title TEXT,
          body TEXT,
          fetched_at TIMESTAMPTZ DEFAULT NOW()
        );
    next:
      spec:
        mode: exclusive
      arcs:
        - step: fetch_http_data

  - step: fetch_http_data
    desc: Fetch data from HTTP API
    tool:
      kind: http
      method: GET
      url: "{{ api_url }}"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: insert_posts

  - step: insert_posts
    desc: Insert posts into PostgreSQL
    loop:
      in: "{{ fetch_http_data.data }}"
      iterator: item
      spec:
        mode: parallel
    tool:
      kind: postgres
      auth: "{{ pg_auth }}"
      command: |
        INSERT INTO public.http_to_postgres_iterator (post_id, user_id, title, body)
        VALUES (
          {{ item.id }},
          {{ item.userId }},
          $${{ item.title }}$$,
          $${{ item.body }}$$
        );
    next:
      spec:
        mode: exclusive
      arcs:
        - step: show_count

  - step: show_count
    desc: Verify record count
    tool:
      kind: postgres
      auth: "{{ pg_auth }}"
      command: |
        SELECT COUNT(*) as records FROM public.http_to_postgres_iterator;
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      code: |
        result = {"status": "completed"}

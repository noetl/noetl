apiVersion: noetl.io/v1
kind: Playbook

metadata:
  name: iterator_save_test
  path: tests/iterator_save_test

workload:
  pg_auth: pg_local
  items:
    - name: "item1"
      value: 100
    - name: "item2"
      value: 200
    - name: "item3"
      value: 300

workflow:
  - step: start
    desc: Start test
    next:
      - step: create_table
  
  - step: create_table
    desc: Create test table
    tool: postgres
    auth: "{{ workload.pg_auth }}"
    command: |
      CREATE TABLE IF NOT EXISTS public.iterator_save_test (
        id TEXT PRIMARY KEY,
        execution_id TEXT,
        item_name TEXT,
        item_value INTEGER,
        created_at TIMESTAMPTZ DEFAULT now()
      );
    next:
      - step: process_items

  - step: process_items
    desc: Process items with save (NEW loop format)
    tool: python
    loop:
      collection: "{{ workload.items }}"
      element: item
      mode: sequential
    code: |
      def main(context):
          item = context.get('item', {})
          return {
              'item_name': item.get('name', 'unknown'),
              'item_value': item.get('value', 0)
          }
    sink:
      tool: postgres
      auth: "{{ workload.pg_auth }}"
      table: public.iterator_save_test
      mode: upsert
      key: id
      args:
        id: "{{ execution_id }}:{{ result.data.item_name }}"
        execution_id: "{{ execution_id }}"
        item_name: "{{ result.data.item_name }}"
        item_value: "{{ result.data.item_value }}"
    next:
      - step: end
    
  - step: end
    desc: End test

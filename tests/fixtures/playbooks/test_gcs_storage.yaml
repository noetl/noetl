apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: test_gcs_storage
  path: tests/gcs_storage_test
  description: 'Test GCS storage tier for large results.

    Explicitly configures storage to use GCS.

    '
workload:
  item_count: 2000
  item_size: 1000
workflow:
- step: start
  tool:
  - name: generate_data
    kind: python
    args:
      count: '{{ item_count }}'
      size: '{{ item_size }}'
    code: "items = [{\"id\": i, \"data\": \"G\" * size, \"type\": \"gcs_test\"} for\
      \ i in range(count)]\nresult = {\n    \"status\": \"ok\",\n    \"tier\": \"\
      gcs\",\n    \"count\": len(items),\n    \"total_bytes\": count * size,\n   \
      \ \"items\": items\n}\n"
  result:
    store:
      kind: gcs
    output_select:
    - status
    - tier
    - count
    - total_bytes
  next:
    spec:
      mode: exclusive
    arcs:
    - step: verify_gcs_storage
- step: verify_gcs_storage
  tool:
  - name: verify
    kind: python
    args:
      has_ref: '{{ start._ref is defined }}'
      store_type: '{{ start._store | default(''none'') }}'
      status: '{{ start.status }}'
      count: '{{ start.count }}'
      total_bytes: '{{ start.total_bytes }}'
    code: "is_gcs = store_type == \"gcs\"\nresult = {\n    \"test_result\": \"PASSED\"\
      \ if is_gcs else \"FAILED\",\n    \"externalized\": has_ref,\n    \"storage_tier\"\
      : store_type,\n    \"expected_tier\": \"gcs\",\n    \"correct_tier\": is_gcs,\n\
      \    \"status\": status,\n    \"count\": count,\n    \"total_bytes\": total_bytes,\n\
      \    \"message\": f\"GCS storage {'verified' if is_gcs else 'NOT used - got\
      \ ' + store_type}\"\n}\n"
  next:
    spec:
      mode: exclusive
    arcs:
    - step: load_from_gcs
- step: load_from_gcs
  tool:
  - name: load_artifact
    kind: artifact
    action: get
    args:
      result_ref: '{{ start._ref }}'
  next:
    spec:
      mode: exclusive
    arcs:
    - step: final_summary
- step: final_summary
  tool:
  - name: summarize
    kind: python
    args:
      tier_correct: '{{ verify_gcs_storage.correct_tier }}'
      loaded_count: '{{ load_from_gcs.count | default(0) }}'
      expected_count: '{{ item_count }}'
    code: "data_loaded = loaded_count == expected_count\nresult = {\n    \"test_result\"\
      : \"PASSED\" if (tier_correct and data_loaded) else \"FAILED\",\n    \"gcs_tier_used\"\
      : tier_correct,\n    \"data_loaded_from_gcs\": data_loaded,\n    \"items_loaded\"\
      : loaded_count,\n    \"items_expected\": expected_count,\n    \"message\": \"\
      GCS storage and retrieval working correctly\" if (tier_correct and data_loaded)\
      \ else \"GCS test failed\"\n}\n"

apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: test_auth0_full_flow
  path: api_integration/auth0/test_auth0_full_flow
  description: |
    End-to-end test of Auth0 authentication flow.
    Gets token from Auth0, validates it, creates session.

    Input:
      - username: Auth0 user email (default: kadyapam@gmail.com)
      - password: Auth0 user password
      - auth0_credential: Credential name for Auth0 client secret

    Output:
      - session_token: NoETL session token
      - user_id: Internal user ID
      - auth0_user_id: Auth0 user identifier
  tags:
    - auth0
    - authentication
    - integration-test

workload:
  username: "{{ username | default('kadyapam@gmail.com') }}"
  password: "{{ password }}"
  auth0_domain: "mestumre-development.us.auth0.com"
  client_id: "Jqop7YoaiZalLHdBRo5ScNQ1RJhbhbDN"
  auth0_credential: "{{ auth0_credential | default('auth0_client') }}"
  db_credential: pg_k8s

workflow:
  - step: start
    desc: Begin full Auth0 flow test
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "starting", "test": "auth0_full_flow"}
    next:
      - step: get_auth0_token

  - step: get_auth0_token
    desc: Get Auth0 access token
    tool:
      kind: playbook
      path: api_integration/auth0/get_auth0_token
      args:
        username: "{{ workload.username }}"
        password: "{{ workload.password }}"
        auth0_domain: "{{ workload.auth0_domain }}"
        client_id: "{{ workload.client_id }}"
        auth0_credential: "{{ workload.auth0_credential }}"
    case:
      - when: "{{ event.name == 'call.done' and get_auth0_token.status == 'success' }}"
        then:
          - next:
              - step: login_with_token
      - when: "{{ event.name == 'call.done' and get_auth0_token.status == 'error' }}"
        then:
          - next:
              - step: auth_error

  - step: login_with_token
    desc: Create NoETL session with Auth0 token
    tool:
      kind: playbook
      path: api_integration/auth0/auth0_login
      args:
        auth0_token: "{{ get_auth0_token.access_token }}"
        client_ip: "127.0.0.1"
    case:
      - when: "{{ event.name == 'call.done' and login_with_token.status == 'authenticated' }}"
        then:
          - next:
              - step: test_success
      - when: "{{ event.name == 'call.done' and login_with_token.status != 'authenticated' }}"
        then:
          - next:
              - step: login_error

  - step: test_success
    desc: Return successful test result
    tool:
      kind: python
      auth: {}
      libs: {}
      args:
        session_token: "{{ login_with_token.session_token }}"
        user_id: "{{ login_with_token.user.user_id }}"
        email: "{{ login_with_token.user.email }}"
        expires_at: "{{ login_with_token.expires_at }}"
      code: |
        # Arguments injected: session_token, user_id, email, expires_at
        result = {
            "status": "success",
            "test": "auth0_full_flow",
            "session_token": session_token,
            "user": {
                "user_id": user_id,
                "email": email
            },
            "expires_at": expires_at
        }
    next:
      - step: end

  - step: auth_error
    desc: Auth0 token acquisition failed
    tool:
      kind: python
      auth: {}
      libs: {}
      args:
        error: "{{ get_auth0_token }}"
      code: |
        # Arguments injected: error
        result = {
            "status": "error",
            "stage": "auth0_token",
            "error": error
        }
    next:
      - step: end

  - step: login_error
    desc: NoETL login failed
    tool:
      kind: python
      auth: {}
      libs: {}
      args:
        error: "{{ login_with_token }}"
      code: |
        # Arguments injected: error
        result = {
            "status": "error",
            "stage": "noetl_login",
            "error": error
        }
    next:
      - step: end

  - step: end
    desc: Complete
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "complete"}

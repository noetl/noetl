apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: get_auth0_token
  path: api_integration/auth0/get_auth0_token
  description: |
    Get Auth0 access token using Resource Owner Password Grant.
    Retrieves Auth0 client secret from NoETL credential table.

    Input:
      - username: Auth0 user email
      - password: Auth0 user password
      - auth0_domain: Auth0 tenant domain (default: mestumre-development.us.auth0.com)
      - client_id: Auth0 application client ID (default: Jqop7YoaiZalLHdBRo5ScNQ1RJhbhbDN)
      - auth0_credential: Credential key for Auth0 client secret (default: auth0_client)

    Output:
      - access_token: Auth0 access token
      - token_type: Token type (Bearer)
      - expires_in: Token expiration in seconds
  tags:
    - auth0
    - authentication
    - token

workload:
  username: "{{ username }}"
  password: "{{ password }}"
  auth0_domain: "{{ auth0_domain | default('mestumre-development.us.auth0.com') }}"
  client_id: "{{ client_id | default('Jqop7YoaiZalLHdBRo5ScNQ1RJhbhbDN') }}"
  auth0_credential: "{{ auth0_credential | default('auth0_client') }}"
  audience: "{{ audience | default('https://' + auth0_domain | default('mestumre-development.us.auth0.com') + '/me/') }}"

keychain:
  - name: auth0_credentials
    kind: credential
    scope: global
    credential: "{{ auth0_credential }}"

workflow:
  - step: start
    desc: Begin token acquisition
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "initialized"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: get_token

  - step: get_token
    desc: Get access token from Auth0
    tool:
      kind: http
      method: POST
      endpoint: "https://{{ auth0_domain }}/oauth/token"
      headers:
        Content-Type: "application/json"
      payload:
        grant_type: "password"
        username: "{{ username }}"
        password: "{{ password }}"
        audience: "{{ audience }}"
        client_id: "{{ client_id }}"
        client_secret: "{{ keychain.auth0_credentials.client_secret }}"
        scope: "openid profile email"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: success
          when: "{{ response.status_code == 200 }}"
        - step: error
          when: "{{ response.status_code != 200 }}"

  - step: success
    desc: Return token
    tool:
      kind: python
      args:
        access_token: "{{ get_token.data.access_token }}"
        token_type: "{{ get_token.data.token_type }}"
        expires_in: "{{ get_token.data.expires_in }}"
      code: |
        # Arguments injected: access_token, token_type, expires_in
        result = {
            "status": "success",
            "access_token": access_token,
            "token_type": token_type,
            "expires_in": expires_in
        }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: error
    desc: Token acquisition failed
    tool:
      kind: python
      args:
        status: "{{ get_token.status_code }}"
        error: "{{ get_token.data }}"
      code: |
        # Arguments injected: status, error
        result = {
            "status": "error",
            "http_status": status,
            "error": error
        }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: Complete
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "complete"}

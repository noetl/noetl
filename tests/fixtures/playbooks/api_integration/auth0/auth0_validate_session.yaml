apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: auth0_validate_session
  path: api_integration/auth0/auth0_validate_session
  description: |
    Validate NoETL session token.

    Input:
      - session_token: NoETL session token

    Output:
      - valid: Boolean
      - user: User details
  tags:
    - auth0
    - validation

workload:
  session_token: "{{ session_token }}"
  db_credential: pg_k8s
  callback_subject: ""  # Set by gateway for async response
  request_id: ""

workflow:
  - step: start
    desc: Begin validation
    tool:
      kind: python
      code: |
        result = {"status": "initialized"}
    case:
      - when: "{{ event.name == 'call.done' }}"
        then:
          - next:
              next:
                - step: lookup_session

  - step: lookup_session
    desc: Lookup and validate session
    tool:
      kind: postgres
      auth: "{{ workload.db_credential }}"
      command: |
        SELECT
          s.session_id,
          s.user_id,
          s.expires_at,
          s.is_active,
          u.email,
          u.display_name,
          u.is_active as user_is_active,
          CASE
            WHEN s.expires_at < NOW() THEN false
            WHEN NOT s.is_active THEN false
            WHEN NOT u.is_active THEN false
            ELSE true
          END as session_valid
        FROM auth.sessions s
        JOIN auth.users u ON s.user_id = u.user_id
        WHERE s.session_token = '{{ workload.session_token }}';
    next:
      - step: check_and_route

  - step: check_and_route
    desc: Check session validity and route
    tool:
      kind: python
      libs:
        json: json
      args:
        rows_json: "{{ lookup_session.command_0.rows | tojson }}"
      code: |
        rows = json.loads(rows_json) if isinstance(rows_json, str) else rows_json
        if rows and len(rows) > 0 and rows[0].get('session_valid'):
            result = {"valid": True, "session": rows[0], "route": "update_activity"}
        else:
            result = {"valid": False, "route": "validation_failed"}
    case:
      - when: "{{ event.name == 'call.done' and result.route == 'update_activity' }}"
        then:
          - next:
              next:
                - step: update_activity
      - when: "{{ event.name == 'call.done' }}"
        then:
          - next:
              next:
                - step: validation_failed

  - step: update_activity
    desc: Update last activity
    tool:
      kind: postgres
      auth: "{{ workload.db_credential }}"
      command: |
        UPDATE auth.sessions
        SET last_activity_at = NOW()
        WHERE session_id = {{ check_and_route.session.session_id }};
    next:
      - step: get_roles

  - step: get_roles
    desc: Get user roles
    tool:
      kind: postgres
      auth: "{{ workload.db_credential }}"
      command: |
        SELECT r.role_name
        FROM auth.user_roles ur
        JOIN auth.roles r ON ur.role_id = r.role_id
        WHERE ur.user_id = {{ check_and_route.session.user_id }}
          AND (ur.expires_at IS NULL OR ur.expires_at > NOW());
    next:
      - step: success

  - step: success
    desc: Return valid session
    tool:
      kind: python
      libs:
        json: json
      args:
        session_json: "{{ check_and_route.session | tojson }}"
        roles_json: "{{ get_roles.command_0.rows | tojson }}"
      code: |
        session = json.loads(session_json) if isinstance(session_json, str) else session_json
        roles = json.loads(roles_json) if isinstance(roles_json, str) else roles_json

        result = {
            "valid": True,
            "user": {
                "user_id": session.get("user_id") if session else None,
                "email": session.get("email") if session else None,
                "display_name": session.get("display_name") if session else None,
                "roles": [r["role_name"] for r in roles] if roles else []
            },
            "message": "Session is valid"
        }
    spec:
      case_mode: inclusive
    case:
      - when: "{{ event.name == 'call.done' and workload.callback_subject }}"
        then:
          - send_callback:
              tool:
                kind: gateway
                action: callback
                data:
                  valid: true
                  user: "{{ result.user }}"
                  message: "{{ result.message }}"
      - when: "{{ event.name == 'call.done' }}"
        then:
          - next:
              next:
                - step: end

  - step: validation_failed
    desc: Return invalid
    tool:
      kind: python
      code: |
        result = {
            "valid": False,
            "message": "Session not found or expired"
        }
    spec:
      case_mode: inclusive
    case:
      - when: "{{ event.name == 'call.done' and workload.callback_subject }}"
        then:
          - send_callback:
              tool:
                kind: gateway
                action: callback
                data:
                  valid: false
                  message: "{{ result.message }}"
      - when: "{{ event.name == 'call.done' }}"
        then:
          - next:
              next:
                - step: end

  - step: end
    desc: Complete
    tool:
      kind: python
      code: |
        result = {"status": "complete"}

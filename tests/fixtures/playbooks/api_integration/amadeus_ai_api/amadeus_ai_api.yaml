apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: amadeus_ai_api
  path: api_integration/amadeus_ai_api
  description: Complete Amadeus AI travel API integration with OpenAI translation
  version: "2.0"

workload:
  pg_auth: pg_k8s
  gcp_auth: google_oauth
  openai_secret_path: projects/1014428265962/secrets/openai-api-key/versions/1
  amadeus_key_path: projects/1014428265962/secrets/api-key-test-api-amadeus-com/versions/1
  amadeus_secret_path: projects/1014428265962/secrets/api-secret-test-api-amadeus-com/versions/1
  query: I want a one-way flight from SFO to JFK on March 15, 2026 for 1 adult
  # Async callback support (injected by gateway when client_id is provided)
  request_id: "{{ request_id | default('') }}"
  gateway_url: "{{ gateway_url | default('http://gateway.gateway.svc.cluster.local:8090') }}"

keychain:
  - name: openai_token
    kind: secret_manager
    provider: gcp
    scope: global
    auth: "{{ workload.gcp_auth }}"
    map:
      api_key: '{{ workload.openai_secret_path }}'

  - name: amadeus_credentials
    kind: secret_manager
    provider: gcp
    scope: global
    auth: "{{ workload.gcp_auth }}"
    map:
      client_id: '{{ workload.amadeus_key_path }}'
      client_secret: '{{ workload.amadeus_secret_path }}'

  - name: amadeus_token
    kind: oauth2
    scope: global
    auto_renew: true
    endpoint: https://test.api.amadeus.com/v1/security/oauth2/token
    method: POST
    headers:
      Content-Type: application/x-www-form-urlencoded
    data:
      grant_type: client_credentials
      client_id: '{{ keychain.amadeus_credentials.client_id }}'
      client_secret: '{{ keychain.amadeus_credentials.client_secret }}'

workflow:
- step: start
  desc: Initialize workflow and create database tables
  tool:
    kind: postgres
    auth: "{{ workload.pg_auth }}"
    command: |
      -- Create results table
      CREATE TABLE IF NOT EXISTS api_results (
        id SERIAL PRIMARY KEY,
        execution_id VARCHAR(64),
        source VARCHAR(32),
        result JSONB,
        created_at TIMESTAMP DEFAULT NOW()
      );
      
      -- Create events table
      CREATE TABLE IF NOT EXISTS amadeus_ai_events (
        id SERIAL PRIMARY KEY,
        execution_id VARCHAR(64),
        event_type VARCHAR(32),
        api_call_type VARCHAR(32),
        input_data JSONB,
        output_data JSONB,
        status_code INTEGER,
        event_time TIMESTAMP DEFAULT NOW(),
        duration_ms INTEGER,
        details JSONB
      );
  next:
  - step: translate_query_to_amadeus

- step: translate_query_to_amadeus
  desc: Convert natural language query to Amadeus API endpoint using OpenAI
  tool:
    kind: http
    method: POST
    endpoint: https://api.openai.com/v1/chat/completions
    headers:
      Authorization: "Bearer {{ keychain.openai_token.api_key }}"
    payload:
      model: gpt-4o-mini
      messages:
      - role: system
        content: |
          You are a translator that converts natural-language travel queries into Amadeus API endpoints and parameters.
          
          When given a request, follow these steps:
          1. Understand what the user wants: flight search, hotel offers, airport search, etc.
          2. Map the details (origin, destination, dates, passengers, etc.) to the correct REST API endpoint and parameters.
          3. Return ONLY a JSON object with two properties:
             - "endpoint": The Amadeus API endpoint (e.g., "/v2/shopping/flight-offers")
             - "params": An object containing all query parameters
          
          4. Use real values from user input, and apply correct formatting (e.g., ISO dates).
          5. If values are ambiguous or missing, make reasonable assumptions.
          6. If the user provides a travel date without a year, assume they mean 2025.
          7. Always limit the number of returned results to 3 where applicable.
          
          Example:
          User: "I want a one-way flight from SFO to JFK on September 15, 2025 for 1 adult."
          Response:
          {
            "endpoint": "/v2/shopping/flight-offers",
            "params": {
              "originLocationCode": "SFO",
              "destinationLocationCode": "JFK",
              "departureDate": "2025-09-15",
              "adults": 1,
              "max": 3
            }
          }
      - role: user
        content: '{{ workload.query }}'
      temperature: 0.1
  next:
  - step: store_openai_query_event

- step: store_openai_query_event
  desc: Store the OpenAI query translation event in database
  tool:
    kind: postgres
    auth: '{{ workload.pg_auth }}'
    command: |
      INSERT INTO amadeus_ai_events (execution_id, event_type, api_call_type, input_data, output_data, status_code, duration_ms, details)
      VALUES (
        '{{ job.uuid }}',
        'openai_query_translation',
        'openai',
        $json${{ {"user_query": workload.query, "model": "gpt-4o-mini", "system_prompt": "natural_language_to_amadeus_rest_api"} | tojson }}$json$::jsonb,
        {% if translate_query_to_amadeus.data is defined %}$json${{ translate_query_to_amadeus.data | tojson }}$json$::jsonb{% else %}NULL{% endif %},
        {{ translate_query_to_amadeus.status_code | default(0) }},
        {{ (translate_query_to_amadeus.elapsed * 1000) | round | int if translate_query_to_amadeus.elapsed else 0 }},
        $json${{ {"endpoint": "https://api.openai.com/v1/chat/completions", "method": "POST"} | tojson }}$json$::jsonb
      );
  next:
  - step: parse_openai_response

- step: parse_openai_response
  desc: Parse OpenAI response to extract Amadeus endpoint and parameters
  tool:
    kind: python
    auth: {}
    libs:
      json: json
      re: re
    args:
      openai_response: '{{ translate_query_to_amadeus.data }}'
    code: |
      try:
          if not openai_response or not openai_response.get('choices'):
              result = {
                  "status": "error",
                  "message": "No response from OpenAI"
              }
          else:
              content = openai_response['choices'][0]['message']['content'].strip()

              # Handle markdown code blocks if present
              if content.startswith('```json'):
                  lines = content.split('\n')
                  json_lines = []
                  in_json_block = False
                  for line in lines:
                      if line.strip() == '```json':
                          in_json_block = True
                      elif line.strip() == '```' and in_json_block:
                          break
                      elif in_json_block:
                          json_lines.append(line)
                  content = '\n'.join(json_lines)

              # Strip JavaScript-style comments (// ...) that GPT sometimes adds
              # This handles both inline and full-line comments
              content = re.sub(r'//[^\n]*', '', content)

              # Parse JSON
              parsed = json.loads(content)

              result = {
                  "status": "success",
                  "endpoint": parsed.get('endpoint'),
                  "params": parsed.get('params')
              }
      except Exception as e:
          result = {
              "status": "error",
              "message": f"Failed to parse OpenAI response: {str(e)}"
          }
  next:
  - step: execute_amadeus_query

- step: execute_amadeus_query
  desc: Execute Amadeus API query using REST API
  tool:
    kind: http
    method: GET
    endpoint: https://test.api.amadeus.com{{ parse_openai_response.endpoint }}
    params: '{{ parse_openai_response.params }}'
    headers:
      Authorization: "Bearer {{ keychain.amadeus_token.access_token }}"
  case:
    # Retry on 5xx server errors (call.error payload carries response.data.status_code)
    - when: "{{ event.name == 'call.error' and response is defined and response.data is defined and response.data.status_code in [500, 502, 503] }}"
      then:
        retry:
          max_attempts: 3
          backoff_multiplier: 2.0
          initial_delay: 0.5
  next:
  - step: store_amadeus_query_event

- step: store_amadeus_query_event
  desc: Store the Amadeus API query event in database
  tool:
    kind: postgres
    auth: '{{ workload.pg_auth }}'
    command: |
      INSERT INTO amadeus_ai_events (execution_id, event_type, api_call_type, input_data, output_data, status_code, duration_ms, details)
      VALUES (
        '{{ job.uuid }}',
        'amadeus_api_search',
        'amadeus',
        $json${{ {"endpoint": parse_openai_response.endpoint, "params": parse_openai_response.params, "access_token_used": true} | tojson }}$json$::jsonb,
        {% if execute_amadeus_query.data is defined %}$json${{ execute_amadeus_query.data | tojson }}$json$::jsonb{% else %}NULL{% endif %},
        {{ execute_amadeus_query.status_code | default(0) }},
        {{ (execute_amadeus_query.elapsed * 1000) | round | int if execute_amadeus_query.elapsed else 0 }},
        $json${{ {"full_endpoint": execute_amadeus_query.url, "method": "GET"} | tojson }}$json$::jsonb
      );
  next:
  - step: translate_amadeus_response

- step: translate_amadeus_response
  desc: Convert Amadeus API response to natural language using OpenAI
  tool:
    kind: http
    method: POST
    endpoint: https://api.openai.com/v1/chat/completions
    headers:
      Authorization: "Bearer {{ keychain.openai_token.api_key }}"
    payload:
      model: gpt-4o-mini
      messages:
      - role: system
        content: |
          You are a helpful assistant that reads raw JSON responses from the Amadeus API and summarizes them into clear, human-readable language.
          
          Your task is to:
          1. Read and understand the JSON response structure (e.g. flights, hotels, etc.).
          2. Identify key information relevant to the user (e.g. origin/destination, dates, price, airline, stops, hotel name, stars, location, price).
          3. Summarize the most important details in clean, natural English.
          4. Use lists, bullet points, and grouping if appropriate.
          5. Do not show any raw JSON keys or code â€” just understandable sentences.
          6. For IATA codes always write a transcription (i.e. SVO will be Sheremetyevo International Airport)
      - role: user
        content: '{{ execute_amadeus_query.data | tojson }}'
      temperature: 0.3
  next:
  - step: store_openai_response_event

- step: store_openai_response_event
  desc: Store the OpenAI response translation event in database
  tool:
    kind: postgres
    auth: '{{ workload.pg_auth }}'
    command: |
      INSERT INTO amadeus_ai_events (execution_id, event_type, api_call_type, input_data, output_data, status_code, duration_ms, details)
      VALUES (
        '{{ job.uuid }}',
        'openai_response_translation',
        'openai',
        $json${{ {"amadeus_response_base64": execute_amadeus_query.data | tojson | b64encode, "model": "gpt-4o-mini", "system_prompt": "amadeus_response_to_natural_language"} | tojson }}$json$::jsonb,
        {% if translate_amadeus_response.data is defined %}$json${{ {"response_base64": translate_amadeus_response.data | tojson | b64encode, "is_base64_encoded": true} | tojson }}$json$::jsonb{% else %}NULL{% endif %},
        {{ translate_amadeus_response.status_code | default(0) }},
        {{ (translate_amadeus_response.elapsed * 1000) | round | int if translate_amadeus_response.elapsed else 0 }},
        $json${{ {"endpoint": "https://api.openai.com/v1/chat/completions", "method": "POST"} | tojson }}$json$::jsonb
      );
  next:
  - step: insert_final_result

- step: insert_final_result
  desc: Insert final natural language result into PostgreSQL
  tool:
    kind: postgres
    auth: '{{ workload.pg_auth }}'
    command: |
      INSERT INTO api_results (execution_id, source, result)
      VALUES (
        '{{ job.uuid }}',
        'amadeus_api',
        $json${{ {"query": workload.query, "natural_language_result": (translate_amadeus_response.data.choices[0].message.content if translate_amadeus_response.data and translate_amadeus_response.data.choices else 'No response generated') | b64encode, "execution_id": job.uuid, "is_base64_encoded": true} | tojson }}$json$::jsonb
      );
  next:
  - step: prepare_result

- step: prepare_result
  desc: Prepare final result for callback
  tool:
    kind: python
    args:
      query: "{{ workload.query }}"
      nl_result: "{{ translate_amadeus_response.data.choices[0].message.content if translate_amadeus_response.data and translate_amadeus_response.data.choices else 'No response generated' }}"
      execution_id: "{{ job.uuid }}"
    code: |
      result = {
          "status": "COMPLETED",
          "textOutput": nl_result,
          "query": query,
          "executionId": execution_id
      }
  case:
    # If request_id is set, send callback to gateway
    - when: "{{ event.name == 'call.done' and workload.request_id }}"
      then:
        - next:
            - step: send_callback
    - when: "{{ event.name == 'call.done' }}"
      then:
        - next:
            - step: end

- step: send_callback
  desc: Send result to gateway via HTTP callback
  tool:
    kind: http
    method: POST
    endpoint: "{{ workload.gateway_url }}/api/internal/callback/async"
    headers:
      Content-Type: application/json
    payload:
      request_id: "{{ workload.request_id }}"
      execution_id: "{{ job.uuid }}"
      status: "{{ prepare_result.status }}"
      data:
        textOutput: "{{ prepare_result.textOutput }}"
        query: "{{ prepare_result.query }}"
        executionId: "{{ prepare_result.executionId }}"
  case:
    - when: "{{ event.name == 'call.done' or event.name == 'call.error' }}"
      then:
        - next:
            - step: end

- step: end
  desc: End of workflow
  tool:
    kind: python
    args:
      status: "{{ prepare_result.status | default('COMPLETED') }}"
      text_output: "{{ prepare_result.textOutput | default('Workflow completed') }}"
    code: |
      result = {"status": status, "textOutput": text_output}

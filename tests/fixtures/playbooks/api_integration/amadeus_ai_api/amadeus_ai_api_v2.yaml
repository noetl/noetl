apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: amadeus_ai_api_v2
  path: api_integration/amadeus_ai_api_v2
  version: "2.0"
workload:
  jobId: '{{ job.uuid }}'
  execution_id: '{{ job.uuid }}'
  pg_auth: pg_local
  oauth_cred: google_oauth
  openai_secret_path: projects/1014428265962/secrets/openai-api-key/versions/1
  amadeus_key_path: projects/1014428265962/secrets/api-key-test-api-amadeus-com/versions/1
  amadeus_secret_path: projects/1014428265962/secrets/api-secret-test-api-amadeus-com/versions/1
  query: I want a one-way flight from SFO to JFK on March 15, 2026 for 1 adult

workflow:
- step: start
  desc: Start Amadeus AI API Workflow
  tool:
    kind: postgres
    auth: "{{ workload.pg_auth }}"
    command: |
      CREATE TABLE IF NOT EXISTS api_results (
        id SERIAL PRIMARY KEY,
        execution_id VARCHAR(64),
        source VARCHAR(32),
        result JSONB,
        created_at TIMESTAMP DEFAULT NOW()
      );
  next: create_amadeus_ai_event_table

- step: create_amadeus_ai_event_table
  desc: Create Amadeus AI event table
  tool:
    kind: postgres
    auth: "{{ workload.pg_auth }}"
    command: |
      CREATE TABLE IF NOT EXISTS amadeus_ai_events (
        id SERIAL PRIMARY KEY,
        execution_id VARCHAR(64),
        event_type VARCHAR(32),
        api_call_type VARCHAR(32),
        input_data JSONB,
        output_data JSONB,
        status_code INTEGER,
        event_time TIMESTAMP DEFAULT NOW(),
        duration_ms INTEGER,
        details JSONB
      );
  next: get_amadeus_token

- step: get_amadeus_token
  desc: Get Amadeus API access token using OAuth client credentials
  tool:
    kind: http
    method: POST
    endpoint: https://test.api.amadeus.com/v1/security/oauth2/token
    headers:
      Content-Type: application/x-www-form-urlencoded
    auth: "{{ workload.amadeus_key_path }}"
    data:
      grant_type: client_credentials
      client_id: "{{ auth.amadeus.client_id }}"
      client_secret: "{{ auth.amadeus.client_secret }}"
  next: translate_query_to_amadeus

- step: translate_query_to_amadeus
  desc: Convert natural language query to Amadeus API endpoint using OpenAI
  tool:
    kind: http
    method: POST
    endpoint: https://api.openai.com/v1/chat/completions
    auth: "{{ workload.openai_secret_path }}"
    headers:
      Authorization: "Bearer {{ secret.openai }}"
    payload:
      model: gpt-4o-mini
      messages:
      - role: system
        content: |
          You are a translator that converts natural-language travel queries into Amadeus API endpoints and parameters.
          Return ONLY a JSON object with:
          - "endpoint": The Amadeus API endpoint (e.g., "/v2/shopping/flight-offers")
          - "params": An object containing all query parameters
          Always limit results to 3 where applicable.
      - role: user
        content: '{{ workload.query }}'
      temperature: 0.1
  next: parse_openai_response

- step: parse_openai_response
  desc: Parse OpenAI response to extract Amadeus endpoint and parameters
  tool:
    kind: python
    code: |
      def main(openai_response):
          import json
          
          try:
              if not openai_response or not openai_response.get('choices'):
                  return {"status": "error", "message": "No response from OpenAI"}
              
              content = openai_response['choices'][0]['message']['content'].strip()
              
              # Handle markdown code blocks
              if content.startswith('```json'):
                  lines = content.split('\n')
                  json_lines = []
                  in_json_block = False
                  for line in lines:
                      if line.strip() == '```json':
                          in_json_block = True
                      elif line.strip() == '```' and in_json_block:
                          break
                      elif in_json_block:
                          json_lines.append(line)
                  content = '\n'.join(json_lines)
              
              parsed = json.loads(content)
              
              return {
                  "status": "success",
                  "endpoint": parsed.get('endpoint'),
                  "params": parsed.get('params')
              }
              
          except Exception as e:
              return {"status": "error", "message": f"Failed to parse: {str(e)}"}
  args:
    openai_response: "{{ translate_query_to_amadeus.data }}"
  next: execute_amadeus_query

- step: execute_amadeus_query
  desc: Execute Amadeus API query using REST API
  tool:
    kind: http
    method: GET
    endpoint: "https://test.api.amadeus.com{{ parse_openai_response.endpoint }}"
    params: "{{ parse_openai_response.params }}"
    headers:
      Authorization: "Bearer {{ get_amadeus_token.data.access_token }}"
  case:
    # Retry on 5xx errors
    - when: "{{ event.name == 'call.done' and error is defined and error.status in [500, 502, 503] }}"
      then:
        retry:
          max_attempts: 3
          backoff_multiplier: 2.0
          initial_delay: 0.5
  next: translate_amadeus_response

- step: translate_amadeus_response
  desc: Convert Amadeus API response to natural language using OpenAI
  tool:
    kind: http
    method: POST
    endpoint: https://api.openai.com/v1/chat/completions
    auth: "{{ workload.openai_secret_path }}"
    headers:
      Authorization: "Bearer {{ secret.openai }}"
    payload:
      model: gpt-4o-mini
      messages:
      - role: system
        content: |
          You are a helpful assistant that reads raw JSON responses from the Amadeus API 
          and summarizes them into clear, human-readable language.
          Identify key information and summarize in natural English.
          For IATA codes always write a transcription.
      - role: user
        content: "{{ execute_amadeus_query.data | tojson }}"
      temperature: 0.3
  next: insert_final_result

- step: insert_final_result
  desc: Insert final natural language result into PostgreSQL
  tool:
    kind: postgres
    auth: "{{ workload.pg_auth }}"
    command: |
      INSERT INTO api_results (execution_id, source, result)
      VALUES (
        '{{ execution_id }}',
        'amadeus_api',
        $json${{ {
          "query": workload.query,
          "natural_language_result": translate_amadeus_response.data.choices[0].message.content,
          "execution_id": execution_id
        } | tojson }}$json$::jsonb
      );
  next: end

- step: end
  desc: End of workflow
  tool:
    kind: python
    code: |
      def main():
          return {"status": "workflow_completed"}

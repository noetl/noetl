apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: test_gke_autopilot_lifecycle
  path: tests/fixtures/playbooks/test_gke_lifecycle
  description: Integration test for GKE Autopilot provisioning lifecycle
  labels:
    iap.noetl.io/provider: gcp
    iap.noetl.io/category: test

workload:
  # Test configuration
  project_id: mestumre-dev
  region: us-central1
  cluster_name_prefix: iap-test

  # State management
  state_database: /tmp/noetl-iap-test-state.duckdb

  # Cleanup
  cleanup_on_success: true
  cleanup_on_failure: true

workflow:
  - step: start
    desc: Initialize lifecycle test
    tool:
      kind: shell
      cmds:
        - |
          echo "=========================================="
          echo " GKE Autopilot Lifecycle Test"
          echo "=========================================="
          echo ""
          echo "Project:  {{ project_id }}"
          echo "Region:   {{ region }}"
          echo "State DB: {{ state_database }}"
          echo ""
    set_ctx:
      test_cluster_name: "{{ cluster_name_prefix }}-$(date +%Y%m%d%H%M%S)"
      test_start_time: "$(date +%s)"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: init_state

  - step: init_state
    desc: Initialize test state database
    tool:
      kind: duckdb
      database: "{{ state_database }}"
      commands: |
        -- Create minimal schema for testing
        CREATE TABLE IF NOT EXISTS resources (
            resource_id VARCHAR PRIMARY KEY,
            type_id VARCHAR NOT NULL,
            name VARCHAR NOT NULL,
            project VARCHAR,
            region VARCHAR,
            desired_state JSON NOT NULL,
            current_state JSON,
            status VARCHAR DEFAULT 'pending',
            labels JSON DEFAULT '{}',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            last_synced_at TIMESTAMP
        );

        CREATE TABLE IF NOT EXISTS operations (
            operation_id VARCHAR PRIMARY KEY,
            resource_id VARCHAR NOT NULL,
            operation_type VARCHAR NOT NULL,
            status VARCHAR NOT NULL,
            started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            completed_at TIMESTAMP,
            error_message VARCHAR,
            playbook_name VARCHAR
        );

        SELECT 'Test state initialized' as message;
    next:
      spec:
        mode: exclusive
      arcs:
        - step: verify_auth

  - step: verify_auth
    desc: Verify GCP authentication
    tool:
      kind: http
      method: GET
      url: https://cloudresourcemanager.googleapis.com/v1/projects/{{ project_id }}
      auth:
        source: adc
    set_ctx:
      auth_success: "{{ result.status == 200 }}"
      project_name: "{{ result.body.name | default('unknown') }}"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: auth_success
          when: "{{ ctx.auth_success }}"
        - step: auth_failed
          when: "{{ not ctx.auth_success }}"

  - step: auth_failed
    desc: Authentication failed
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "ERROR: GCP authentication failed"
          echo "Please run: gcloud auth application-default login"
          echo ""
          exit 1
    next:
      spec:
        mode: exclusive
      arcs:
        - step: cleanup

  - step: auth_success
    desc: Authentication verified
    tool:
      kind: shell
      cmds:
        - |
          echo "Authentication verified"
          echo "Project: {{ ctx.project_name }}"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: test_create

  - step: test_create
    desc: Test cluster creation
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "TEST: Create GKE Autopilot cluster"
          echo "Cluster: {{ ctx.test_cluster_name }}"
          echo ""
          # Note: In real test, this would call the gke_autopilot.yaml playbook
          # For now, we simulate the API call
    next:
      spec:
        mode: exclusive
      arcs:
        - step: simulate_create

  - step: simulate_create
    desc: Simulate cluster creation (dry run)
    tool:
      kind: http
      method: GET
      url: https://container.googleapis.com/v1/projects/{{ project_id }}/locations/{{ region }}/clusters
      auth:
        source: adc
    set_ctx:
      list_status: "{{ result.status }}"
      existing_clusters: "{{ result.body.clusters | default([]) | length }}"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: record_create

  - step: record_create
    desc: Record simulated creation
    tool:
      kind: duckdb
      database: "{{ state_database }}"
      commands: |
        INSERT INTO resources (resource_id, type_id, name, project, region, desired_state, status)
        VALUES (
          '{{ project_id }}/{{ region }}/{{ ctx.test_cluster_name }}',
          'container.googleapis.com/Cluster',
          '{{ ctx.test_cluster_name }}',
          '{{ project_id }}',
          '{{ region }}',
          '{"autopilot": {"enabled": true}}',
          'simulated'
        );

        INSERT INTO operations (operation_id, resource_id, operation_type, status, playbook_name)
        VALUES (
          'test-create-' || strftime(CURRENT_TIMESTAMP, '%Y%m%d%H%M%S'),
          '{{ project_id }}/{{ region }}/{{ ctx.test_cluster_name }}',
          'create',
          'simulated',
          'test_gke_lifecycle'
        );

        SELECT 'Create operation recorded' as message;
    next:
      spec:
        mode: exclusive
      arcs:
        - step: test_read

  - step: test_read
    desc: Test state read
    tool:
      kind: duckdb
      database: "{{ state_database }}"
      commands: |
        SELECT
          resource_id,
          name,
          type_id,
          status,
          created_at
        FROM resources
        WHERE project = '{{ project_id }}';
    set_ctx:
      resource_count: "{{ result | length }}"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: verify_read

  - step: verify_read
    desc: Verify state read
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "TEST: Read state"
          echo "Resources found: {{ ctx.resource_count }}"

          if [ "{{ ctx.resource_count }}" -gt 0 ]; then
            echo "PASS: State read successful"
          else
            echo "FAIL: No resources found in state"
            exit 1
          fi
    next:
      spec:
        mode: exclusive
      arcs:
        - step: test_update

  - step: test_update
    desc: Test state update
    tool:
      kind: duckdb
      database: "{{ state_database }}"
      commands: |
        UPDATE resources
        SET
          status = 'updated',
          current_state = '{"status": "RUNNING"}',
          updated_at = CURRENT_TIMESTAMP,
          last_synced_at = CURRENT_TIMESTAMP
        WHERE resource_id = '{{ project_id }}/{{ region }}/{{ ctx.test_cluster_name }}';

        INSERT INTO operations (operation_id, resource_id, operation_type, status, playbook_name)
        VALUES (
          'test-update-' || strftime(CURRENT_TIMESTAMP, '%Y%m%d%H%M%S'),
          '{{ project_id }}/{{ region }}/{{ ctx.test_cluster_name }}',
          'update',
          'completed',
          'test_gke_lifecycle'
        );

        SELECT 'Update operation completed' as message;
    next:
      spec:
        mode: exclusive
      arcs:
        - step: verify_update

  - step: verify_update
    desc: Verify state update
    tool:
      kind: duckdb
      database: "{{ state_database }}"
      commands: |
        SELECT status, current_state, last_synced_at
        FROM resources
        WHERE resource_id = '{{ project_id }}/{{ region }}/{{ ctx.test_cluster_name }}';
    set_ctx:
      updated_status: "{{ result[0].status if result else 'not_found' }}"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: check_update

  - step: check_update
    desc: Check update result
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "TEST: Update state"
          echo "Status after update: {{ ctx.updated_status }}"

          if [ "{{ ctx.updated_status }}" = "updated" ]; then
            echo "PASS: State update successful"
          else
            echo "FAIL: State update failed"
            exit 1
          fi
    next:
      spec:
        mode: exclusive
      arcs:
        - step: test_delete

  - step: test_delete
    desc: Test state deletion
    tool:
      kind: duckdb
      database: "{{ state_database }}"
      commands: |
        INSERT INTO operations (operation_id, resource_id, operation_type, status, playbook_name)
        VALUES (
          'test-delete-' || strftime(CURRENT_TIMESTAMP, '%Y%m%d%H%M%S'),
          '{{ project_id }}/{{ region }}/{{ ctx.test_cluster_name }}',
          'delete',
          'completed',
          'test_gke_lifecycle'
        );

        DELETE FROM resources
        WHERE resource_id = '{{ project_id }}/{{ region }}/{{ ctx.test_cluster_name }}';

        SELECT 'Delete operation completed' as message;
    next:
      spec:
        mode: exclusive
      arcs:
        - step: verify_delete

  - step: verify_delete
    desc: Verify state deletion
    tool:
      kind: duckdb
      database: "{{ state_database }}"
      commands: |
        SELECT COUNT(*) as remaining
        FROM resources
        WHERE resource_id = '{{ project_id }}/{{ region }}/{{ ctx.test_cluster_name }}';
    set_ctx:
      remaining_count: "{{ result[0].remaining if result else -1 }}"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: check_delete

  - step: check_delete
    desc: Check delete result
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "TEST: Delete state"
          echo "Remaining resources: {{ ctx.remaining_count }}"

          if [ "{{ ctx.remaining_count }}" = "0" ]; then
            echo "PASS: State deletion successful"
          else
            echo "FAIL: State deletion failed"
            exit 1
          fi
    next:
      spec:
        mode: exclusive
      arcs:
        - step: print_summary

  - step: print_summary
    desc: Print test summary
    tool:
      kind: duckdb
      database: "{{ state_database }}"
      commands: |
        SELECT
          operation_type,
          status,
          COUNT(*) as count
        FROM operations
        WHERE playbook_name = 'test_gke_lifecycle'
        GROUP BY operation_type, status
        ORDER BY operation_type;
    next:
      spec:
        mode: exclusive
      arcs:
        - step: final_report

  - step: final_report
    desc: Final test report
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "=========================================="
          echo " Test Results"
          echo "=========================================="
          echo ""
          echo "All CRUD operations passed!"
          echo ""
          echo "Operations tested:"
          echo "  - CREATE: Simulated cluster creation"
          echo "  - READ:   State query"
          echo "  - UPDATE: State modification"
          echo "  - DELETE: State removal"
          echo ""
          echo "Test state database: {{ state_database }}"
          echo ""
    next:
      spec:
        mode: exclusive
      arcs:
        - step: cleanup

  - step: cleanup
    desc: Cleanup test resources
    tool:
      kind: shell
      cmds:
        - |
          echo "Cleaning up test state database..."

          if [ "{{ cleanup_on_success }}" = "true" ]; then
            rm -f "{{ state_database }}"
            echo "Test database removed"
          else
            echo "Test database preserved at: {{ state_database }}"
          fi
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: Test complete
    tool:
      kind: shell
      cmds:
        - |
          echo ""
          echo "=========================================="
          echo " GKE Autopilot Lifecycle Test Complete"
          echo "=========================================="

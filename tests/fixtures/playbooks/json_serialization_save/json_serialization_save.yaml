apiVersion: noetl.io/v2
kind: Playbook

metadata:
  name: json_serialization_save
  path: tests/fixtures/playbooks/json_serialization_save/json_serialization_save

workload:
  pg_auth: pg_local

workflow:
  - step: start
    desc: Start workflow
    tool:
      kind: python
      code: |
        result = {"status": "initialized"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: create_test_table

  - step: create_test_table
    desc: Create test table with JSONB column
    tool:
      kind: postgres
      auth: "{{ pg_auth }}"
      command: |
        DROP TABLE IF EXISTS public.json_bug_test;
        CREATE TABLE public.json_bug_test (
          id INTEGER PRIMARY KEY,
          payload JSONB
        );
    next:
      spec:
        mode: exclusive
      arcs:
        - step: save_dict_to_jsonb

  - step: save_dict_to_jsonb
    desc: Save a Python dict to JSONB column (triggers bug)
    tool:
      - name: generate_data
        kind: python
        args:
          input_data: {}
        code: |
          # Return a dict that will be saved to JSONB
          result = {
              "data": {
                  "string_field": "test_value",
                  "number_field": 42,
                  "nested_object": {
                      "key1": "value1",
                      "key2": "value2"
                  },
                  "array_field": [1, 2, 3, 4, 5]
              }
          }
        spec:
          policy:
            rules:
              - when: true
                then:
                  do: continue
                  set_ctx:
                    json_data: "{{ outcome.result.data }}"

      - name: save_json
        kind: postgres
        auth: "{{ pg_auth }}"
        command: |
          INSERT INTO public.json_bug_test (id, payload)
          VALUES (1, '{{ ctx.json_data | tojson | replace("'", "''") }}'::jsonb)
        spec:
          policy:
            rules:
              - when: "{{ outcome.status == 'error' }}"
                then:
                  do: fail
              - when: true
                then:
                  do: continue

    next:
      spec:
        mode: exclusive
      arcs:
        - step: verify_save

  - step: verify_save
    desc: Verify the saved data
    tool:
      kind: postgres
      auth: "{{ pg_auth }}"
      command: |
        SELECT id, payload FROM public.json_bug_test WHERE id = 1;
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: Finish workflow
    tool:
      kind: python
      code: |
        result = {"status": "complete"}

apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: test_vars_template_access
  description: Test {{ ctx.var_name }} template access in Jinja2
  path: vars_test/test_vars_template_access
  version: 1.0.0
  labels:
    test: true
    feature: transient
    phase: 2
workload:
  greeting: Hello
workflow:
- step: start
  desc: Start workflow
  tool:
  - name: start_task
    kind: python
    args: {}
    code: 'result = {"status": "initialized"}

      '
  next:
    spec:
      mode: exclusive
    arcs:
    - step: set_variables
- step: set_variables
  desc: Set multiple test variables via policy rules
  tool:
  - name: set_vars_task
    kind: python
    args: {}
    code: "# Return values that will be extracted via policy rules\nresult = {\n \
      \   \"counter\": 42,\n    \"message\": \"Template access works!\",\n    \"config\"\
      : {\n        \"timeout\": 30,\n        \"retries\": 3\n    }\n}\n"
    spec:
      policy:
        rules:
        - else:
            then:
              do: continue
              set_ctx:
                counter: '{{ outcome.result.counter }}'
                message: '{{ outcome.result.message }}'
                config: '{{ outcome.result.config }}'
  next:
    spec:
      mode: exclusive
    arcs:
    - step: use_vars_in_template
- step: use_vars_in_template
  desc: Use {{ ctx.var_name }} in step data
  tool:
  - name: use_vars_task
    kind: python
    args:
      counter: '{{ ctx.counter }}'
      message: '{{ ctx.message }}'
      timeout: '{{ ctx.config.timeout }}'
      full_greeting: '{{ greeting }}, {{ ctx.message }}'
    code: "# This step receives data using {{ ctx.* }} templates\nresult = {\n   \
      \ \"status\": \"success\",\n    \"received_counter\": counter,\n    \"received_message\"\
      : message,\n    \"received_timeout\": timeout,\n    \"full_greeting\": full_greeting\n\
      }\n"
  next:
    spec:
      mode: exclusive
    arcs:
    - step: verify_results
- step: verify_results
  desc: Verify template values were rendered correctly
  tool:
  - name: verify_task
    kind: python
    args: {}
    code: "# Get previous step result\nprev_result = context.get('use_vars_in_template',\
      \ {})\nif isinstance(prev_result, dict) and 'data' in prev_result:\n    prev_result\
      \ = prev_result['data']\n\n# Verify values\ncounter = prev_result.get(\"received_counter\"\
      )\nmessage = prev_result.get(\"received_message\")\ntimeout = prev_result.get(\"\
      received_timeout\")\ngreeting = prev_result.get(\"full_greeting\")\n\nsuccess\
      \ = (\n    counter == 42 and\n    message == \"Template access works!\" and\n\
      \    timeout == 30 and\n    greeting == \"Hello, Template access works!\"\n\
      )\n\nresult = {\n    \"status\": \"success\" if success else \"failed\",\n \
      \   \"verification\": {\n        \"counter_correct\": counter == 42,\n     \
      \   \"message_correct\": message == \"Template access works!\",\n        \"\
      timeout_correct\": timeout == 30,\n        \"greeting_correct\": greeting ==\
      \ \"Hello, Template access works!\"\n    },\n    \"values\": {\n        \"counter\"\
      : counter,\n        \"message\": message,\n        \"timeout\": timeout,\n \
      \       \"greeting\": greeting\n    }\n}\n"
  next:
    spec:
      mode: exclusive
    arcs:
    - step: end
- step: end
  desc: End workflow
  tool:
  - name: end_task
    kind: python
    args: {}
    code: 'result = {"status": "complete"}

      '

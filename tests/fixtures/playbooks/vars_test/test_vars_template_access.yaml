---
apiVersion: noetl.io/v10
kind: Playbook
metadata:
  name: test_vars_template_access
  description: Test {{ ctx.var_name }} template access in Jinja2
  path: vars_test/test_vars_template_access
  version: 1.0.0
  labels:
    test: true
    feature: transient
    phase: 2

workload:
  greeting: "Hello"

workflow:
  - step: start
    desc: Start workflow
    tool:
      - start_task:
          kind: python
          args: {}
          code: |
            result = {"status": "initialized"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: set_variables

  - step: set_variables
    desc: Set multiple test variables via policy rules
    tool:
      - set_vars_task:
          kind: python
          args: {}
          code: |
            # Return values that will be extracted via policy rules
            result = {
                "counter": 42,
                "message": "Template access works!",
                "config": {
                    "timeout": 30,
                    "retries": 3
                }
            }
          spec:
            policy:
              rules:
                - else:
                    then:
                      do: continue
                      set_ctx:
                        counter: "{{ outcome.result.counter }}"
                        message: "{{ outcome.result.message }}"
                        config: "{{ outcome.result.config }}"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: use_vars_in_template

  - step: use_vars_in_template
    desc: Use {{ ctx.var_name }} in step data
    tool:
      - use_vars_task:
          kind: python
          args:
            counter: "{{ ctx.counter }}"
            message: "{{ ctx.message }}"
            timeout: "{{ ctx.config.timeout }}"
            full_greeting: "{{ greeting }}, {{ ctx.message }}"
          code: |
            # This step receives data using {{ ctx.* }} templates
            result = {
                "status": "success",
                "received_counter": counter,
                "received_message": message,
                "received_timeout": timeout,
                "full_greeting": full_greeting
            }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: verify_results

  - step: verify_results
    desc: Verify template values were rendered correctly
    tool:
      - verify_task:
          kind: python
          args: {}
          code: |
            # Get previous step result
            prev_result = context.get('use_vars_in_template', {})
            if isinstance(prev_result, dict) and 'data' in prev_result:
                prev_result = prev_result['data']

            # Verify values
            counter = prev_result.get("received_counter")
            message = prev_result.get("received_message")
            timeout = prev_result.get("received_timeout")
            greeting = prev_result.get("full_greeting")

            success = (
                counter == 42 and
                message == "Template access works!" and
                timeout == 30 and
                greeting == "Hello, Template access works!"
            )

            result = {
                "status": "success" if success else "failed",
                "verification": {
                    "counter_correct": counter == 42,
                    "message_correct": message == "Template access works!",
                    "timeout_correct": timeout == 30,
                    "greeting_correct": greeting == "Hello, Template access works!"
                },
                "values": {
                    "counter": counter,
                    "message": message,
                    "timeout": timeout,
                    "greeting": greeting
                }
            }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: End workflow
    tool:
      - end_task:
          kind: python
          args: {}
          code: |
            result = {"status": "complete"}

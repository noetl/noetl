apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: test_vars_api
  path: /vars_test/api_test
  description: Test variable management API endpoints

workload:
  test_mode: api_validation
  initial_value: 100

workflow:
  - step: start
    desc: Start workflow
    tool:
      kind: python
      code: |
        def main():
            return {"status": "initialized"}
    
    case:
      - when: "{{ event.name == 'step.exit' }}"
        then:
          next:
            - step: create_initial_vars

  - step: create_initial_vars
    desc: Create some variables via vars block
    tool:
      kind: python
      code: |
        def main():
          return {
            "user_id": 999,
            "username": "api_tester",
            "score": 85,
            "metadata": {
              "created": "2025-12-01",
              "source": "test_playbook"
            }
          }
    vars:
      test_user_id: "{{ result.user_id }}"
      test_username: "{{ result.username }}"
      test_score: "{{ result.score }}"
      test_metadata: "{{ result.metadata }}"
    next:
      - step: wait_for_api_calls

  - step: wait_for_api_calls
    desc: Pause to allow API endpoint testing
    tool:
      kind: python
      code: |
        def main():
          import time
          # Keep execution alive for API testing
          # In real test, external scripts will call API endpoints
          time.sleep(5)
          return {"status": "ready_for_api_tests"}
    
    case:
      - when: "{{ event.name == 'call.done' and response is defined }}"
        then:
          next:
            - step: verify_vars_accessible

  - step: verify_vars_accessible
    desc: Verify variables are accessible after API operations
    tool:
      kind: python
      code: |
        def main(user_id, username, score):
          # Debug: Show what we received
          print(f"DEBUG: Received user_id={repr(user_id)}, username={repr(username)}, score={repr(score)}")
          
          # Convert to correct types, with validation
          if not user_id or user_id == '':
            raise ValueError(f"user_id is empty or None: {repr(user_id)}")
          if not username or username == '':
            raise ValueError(f"username is empty or None: {repr(username)}")
          if not score or score == '':
            raise ValueError(f"score is empty or None: {repr(score)}")
            
          user_id = int(user_id) if isinstance(user_id, str) else user_id
          score = int(score) if isinstance(score, str) else score
          
          # Verify extracted variables are accessible
          assert user_id == 999, f"Expected user_id=999, got {user_id}"
          assert username == "api_tester", f"Expected username=api_tester, got {username}"
          assert score == 85, f"Expected score=85, got {score}"
          
          return {
            "verification": "passed",
            "vars_loaded": True,
            "user_id": user_id,
            "username": username,
            "score": score
          }
      args:
        user_id: "{{ vars.test_user_id }}"
        username: "{{ vars.test_username }}"
        score: "{{ vars.test_score }}"
    
    case:
      - when: "{{ event.name == 'call.done' and response is defined }}"
        then:
          next:
            - step: end

  - step: end
    desc: End workflow
    tool:
      kind: python
      code: |
        def main():
            return {"status": "complete"}

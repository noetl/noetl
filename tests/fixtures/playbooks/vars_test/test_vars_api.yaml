apiVersion: noetl.io/v10
kind: Playbook
metadata:
  name: test_vars_api
  path: /vars_test/api_test
  description: Test variable management API endpoints

workload:
  test_mode: api_validation
  initial_value: 100

workflow:
  - step: start
    desc: Start workflow
    tool:
      - start_task:
          kind: python
          args: {}
          code: |
            result = {"status": "initialized"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: create_initial_vars

  - step: create_initial_vars
    desc: Create some variables via policy rules
    tool:
      - create_vars_task:
          kind: python
          args: {}
          code: |
            result = {
              "user_id": 999,
              "username": "api_tester",
              "score": 85,
              "metadata": {
                "created": "2025-12-01",
                "source": "test_playbook"
              }
            }
          spec:
            policy:
              rules:
                - else:
                    then:
                      do: continue
                      set_ctx:
                        test_user_id: "{{ outcome.result.user_id }}"
                        test_username: "{{ outcome.result.username }}"
                        test_score: "{{ outcome.result.score }}"
                        test_metadata: "{{ outcome.result.metadata }}"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: wait_for_api_calls

  - step: wait_for_api_calls
    desc: Pause to allow API endpoint testing
    tool:
      - wait_task:
          kind: python
          libs:
            time: time
          args: {}
          code: |
            # Keep execution alive for API testing
            # In real test, external scripts will call API endpoints
            time.sleep(5)
            result = {"status": "ready_for_api_tests"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: verify_vars_accessible

  - step: verify_vars_accessible
    desc: Verify variables are accessible after API operations
    tool:
      - verify_task:
          kind: python
          args:
            user_id: "{{ ctx.test_user_id }}"
            username: "{{ ctx.test_username }}"
            score: "{{ ctx.test_score }}"
          code: |
            # Debug: Show what we received
            print(f"DEBUG: Received user_id={repr(user_id)}, username={repr(username)}, score={repr(score)}")

            # Convert to correct types, with validation
            if not user_id or user_id == '':
              raise ValueError(f"user_id is empty or None: {repr(user_id)}")
            if not username or username == '':
              raise ValueError(f"username is empty or None: {repr(username)}")
            if not score or score == '':
              raise ValueError(f"score is empty or None: {repr(score)}")

            user_id = int(user_id) if isinstance(user_id, str) else user_id
            score = int(score) if isinstance(score, str) else score

            # Verify extracted variables are accessible
            assert user_id == 999, f"Expected user_id=999, got {user_id}"
            assert username == "api_tester", f"Expected username=api_tester, got {username}"
            assert score == 85, f"Expected score=85, got {score}"

            result = {
              "verification": "passed",
              "vars_loaded": True,
              "user_id": user_id,
              "username": username,
              "score": score
            }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: End workflow
    tool:
      - end_task:
          kind: python
          args: {}
          code: |
            result = {"status": "complete"}

apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: test_vars_api
  path: /vars_test/api_test
  description: Test variable management API endpoints
workload:
  test_mode: api_validation
  initial_value: 100
workflow:
- step: start
  desc: Start workflow
  tool:
  - name: start_task
    kind: python
    args: {}
    code: 'result = {"status": "initialized"}

      '
  next:
    spec:
      mode: exclusive
    arcs:
    - step: create_initial_vars
- step: create_initial_vars
  desc: Create some variables via policy rules
  tool:
  - name: create_vars_task
    kind: python
    args: {}
    code: "result = {\n  \"user_id\": 999,\n  \"username\": \"api_tester\",\n  \"\
      score\": 85,\n  \"metadata\": {\n    \"created\": \"2025-12-01\",\n    \"source\"\
      : \"test_playbook\"\n  }\n}\n"
    spec:
      policy:
        rules:
        - else:
            then:
              do: continue
              set_ctx:
                test_user_id: '{{ outcome.result.user_id }}'
                test_username: '{{ outcome.result.username }}'
                test_score: '{{ outcome.result.score }}'
                test_metadata: '{{ outcome.result.metadata }}'
  next:
    spec:
      mode: exclusive
    arcs:
    - step: wait_for_api_calls
- step: wait_for_api_calls
  desc: Pause to allow API endpoint testing
  tool:
  - name: wait_task
    kind: python
    libs:
      time: time
    args: {}
    code: '# Keep execution alive for API testing

      # In real test, external scripts will call API endpoints

      time.sleep(5)

      result = {"status": "ready_for_api_tests"}

      '
  next:
    spec:
      mode: exclusive
    arcs:
    - step: verify_vars_accessible
- step: verify_vars_accessible
  desc: Verify variables are accessible after API operations
  tool:
  - name: verify_task
    kind: python
    args:
      user_id: '{{ ctx.test_user_id }}'
      username: '{{ ctx.test_username }}'
      score: '{{ ctx.test_score }}'
    code: "# Debug: Show what we received\nprint(f\"DEBUG: Received user_id={repr(user_id)},\
      \ username={repr(username)}, score={repr(score)}\")\n\n# Convert to correct\
      \ types, with validation\nif not user_id or user_id == '':\n  raise ValueError(f\"\
      user_id is empty or None: {repr(user_id)}\")\nif not username or username ==\
      \ '':\n  raise ValueError(f\"username is empty or None: {repr(username)}\")\n\
      if not score or score == '':\n  raise ValueError(f\"score is empty or None:\
      \ {repr(score)}\")\n\nuser_id = int(user_id) if isinstance(user_id, str) else\
      \ user_id\nscore = int(score) if isinstance(score, str) else score\n\n# Verify\
      \ extracted variables are accessible\nassert user_id == 999, f\"Expected user_id=999,\
      \ got {user_id}\"\nassert username == \"api_tester\", f\"Expected username=api_tester,\
      \ got {username}\"\nassert score == 85, f\"Expected score=85, got {score}\"\n\
      \nresult = {\n  \"verification\": \"passed\",\n  \"vars_loaded\": True,\n  \"\
      user_id\": user_id,\n  \"username\": username,\n  \"score\": score\n}\n"
  next:
    spec:
      mode: exclusive
    arcs:
    - step: end
- step: end
  desc: End workflow
  tool:
  - name: end_task
    kind: python
    args: {}
    code: 'result = {"status": "complete"}

      '

apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: test_vars_simple
  path: test/vars_simple

workload:
  execution_id: '{{ job.uuid }}'

workflow:
- step: start
  desc: Simple transient test
  tool:
    kind: python
    code: |
      def main():
          return {"status": "initialized"}
  
  case:
  - when: "{{ event.name == 'step.exit' }}"
    then:
      next:
      - step: set_var

- step: set_var
  desc: Set a test variable
  tool:
    kind: python
    code: |
      async def main():
          from noetl.worker.transient import TransientVars
          
          execution_id = int(context.get('execution_id'))
          
          # Set variable
          await TransientVars.set_cached(
              var_name="test_counter",
              var_value=42,
              execution_id=execution_id,
              var_type="user_defined",
              source_step="set_var"
          )
          
          print(f"Set test_counter=42 for execution {execution_id}")
          return {"status": "success", "var_set": "test_counter"}
  
  case:
  - when: "{{ event.name == 'call.done' and response is defined }}"
    then:
      next:
      - step: get_var

- step: get_var
  desc: Get the variable back
  tool:
    kind: python
    kind: python
    code: |
      async def main():
          from noetl.worker.transient import TransientVars
          
          execution_id = int(context.get('execution_id'))
          
          # Get variable
          result = await TransientVars.get_cached(
              var_name="test_counter",
              execution_id=execution_id
          )
          
          if result:
              print(f"Retrieved test_counter: {result}")
              print(f"Value: {result['value']}")
              print(f"Access count: {result['access_count']}")
              print(f"Created: {result['created_at']}")
              print(f"Accessed: {result['accessed_at']}")
              return {"status": "success", "value": result["value"], "access_count": result["access_count"]}
          else:
              print("Variable not found!")
              return {"status": "error", "message": "variable not found"}
  
  case:
  - when: "{{ event.name == 'call.done' and response is defined }}"
    then:
      next:
      - step: end

- step: end
  desc: Test complete
  tool:
    kind: python
    code: |
      def main():
          return {"status": "complete"}

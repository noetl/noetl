apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: playbook_composition
  path: tests/fixtures/playbooks/playbook_composition/playbook_composition
workload:
  pg_auth: pg_local
  message: Playbook composition with iterator validation
  users:
  - name: Alice
    age: 28
    department: Engineering
    years_experience: 5
    performance_rating: 4.2
  - name: Bob
    age: 34
    department: Marketing
    years_experience: 8
    performance_rating: 3.8
  - name: Charlie
    age: 29
    department: Engineering
    years_experience: 3
    performance_rating: 4.5
  - name: Diana
    age: 42
    department: Management
    years_experience: 15
    performance_rating: 4.0
workflow:
- step: start
  desc: Initialize user profile processing
  tool:
    kind: python
    args: {}
    code: 'result = {"status": "initialized"}

      '
  next:
    spec:
      mode: exclusive
    arcs:
    - step: setup_storage
- step: setup_storage
  desc: Ensure results table exists
  tool:
    kind: postgres
    auth: '{{ pg_auth }}'
    command: "CREATE TABLE IF NOT EXISTS public.user_profile_results (\n  id TEXT\
      \ PRIMARY KEY,\n  execution_id TEXT,\n  user_name TEXT,\n  profile_score DOUBLE\
      \ PRECISION,\n  score_category TEXT,\n  processed_at TIMESTAMPTZ DEFAULT now()\n\
      );\n"
  next:
    spec:
      mode: exclusive
    arcs:
    - step: process_users
- step: process_users
  desc: Process each user through profile scoring sub-playbook
  loop:
    in: '{{ users }}'
    iterator: user
    spec:
      mode: sequential
  tool:
  - name: save_profile
    kind: playbook
    task: process_users
    path: tests/fixtures/playbooks/playbook_composition/user_profile_scorer
    return_step: finalize_result
    args:
      user_data: '{{ user }}'
      execution_context: '{{ execution_id }}'
  - name: store_result
    kind: postgres
    auth: '{{ pg_auth }}'
    command: "INSERT INTO public.user_profile_results (id, execution_id, user_name,\
      \ profile_score, score_category)\nVALUES (\n  '{{ execution_id }}:{{ user.name\
      \ }}',\n  '{{ execution_id }}',\n  '{{ user.name }}',\n  {{ save_profile.profile_score\
      \ | default(0.0) }},\n  '{{ save_profile.score_category | default(\"unknown\"\
      ) }}'\n)\nON CONFLICT (id) DO UPDATE SET\n  user_name = EXCLUDED.user_name,\n\
      \  profile_score = EXCLUDED.profile_score,\n  score_category = EXCLUDED.score_category,\n\
      \  processed_at = now();\n"
  next:
    spec:
      mode: exclusive
    arcs:
    - step: validate_results
- step: validate_results
  desc: Validate all profile scores are within expected range and categories are correct
  tool:
    kind: python
    args:
      user_results: '{{ process_users.data }}'
      expected_min_score: 0.0
      expected_max_score: 100.0
      valid_categories:
      - Junior
      - Mid-Level
      - Senior
      - Executive
    code: "# Be tolerant of early execution before loop aggregation completes.\n#\
      \ If we did not receive a list of final results yet, return a tracking status\n\
      # instead of raising an error to avoid polluting event logs.\nif not isinstance(user_results,\
      \ list):\n    size = 0\n    try:\n        size = len(user_results)  # may be\
      \ 0 for non-sized types\n    except Exception:\n        size = 0\n    result\
      \ = {\n        \"status\": \"tracking\",\n        \"all_valid\": None,\n   \
      \     \"total_users\": size,\n        \"valid_users\": 0,\n        \"validation_details\"\
      : [],\n        \"summary\": \"Awaiting loop aggregation of process_users results\"\
      \n    }\nelse:\n    validation_results = []\n    all_valid = True\n\n    for\
      \ i, res in enumerate(user_results):\n        if not isinstance(res, dict):\n\
      \            validation_results.append({\n                \"index\": i,\n  \
      \              \"valid\": False,\n                \"message\": f\"Result {i}\
      \ is not a dict: {type(res)}\"\n            })\n            all_valid = False\n\
      \            continue\n\n        # Check if result has required fields\n   \
      \     profile_score = res.get('profile_score')\n        score_category = res.get('score_category')\n\
      \        user_name = res.get('user_name', f'user_{i}')\n\n        validation\
      \ = {\n            \"index\": i,\n            \"user_name\": user_name,\n  \
      \          \"profile_score\": profile_score,\n            \"score_category\"\
      : score_category,\n            \"valid\": True,\n            \"issues\": []\n\
      \        }\n\n        # Validate profile score\n        if profile_score is\
      \ None:\n            validation[\"issues\"].append(\"Missing profile_score\"\
      )\n            validation[\"valid\"] = False\n        elif not isinstance(profile_score,\
      \ (int, float)):\n            validation[\"issues\"].append(f\"profile_score\
      \ must be numeric, got {type(profile_score)}\")\n            validation[\"valid\"\
      ] = False\n        elif not (expected_min_score <= profile_score <= expected_max_score):\n\
      \            validation[\"issues\"].append(f\"profile_score {profile_score}\
      \ not in range [{expected_min_score}, {expected_max_score}]\")\n           \
      \ validation[\"valid\"] = False\n\n        # Validate score category\n     \
      \   if score_category is None:\n            validation[\"issues\"].append(\"\
      Missing score_category\")\n            validation[\"valid\"] = False\n     \
      \   elif score_category not in valid_categories:\n            validation[\"\
      issues\"].append(f\"score_category '{score_category}' not in valid categories\
      \ {valid_categories}\")\n            validation[\"valid\"] = False\n\n     \
      \   if not validation[\"valid\"]:\n            all_valid = False\n\n       \
      \ validation_results.append(validation)\n\n    result = {\n        \"status\"\
      : \"success\" if all_valid else \"validation_failed\",\n        \"all_valid\"\
      : all_valid,\n        \"total_users\": len(user_results),\n        \"valid_users\"\
      : sum(1 for v in validation_results if v[\"valid\"]),\n        \"validation_details\"\
      : validation_results,\n        \"summary\": f\"Processed {len(user_results)}\
      \ users, {sum(1 for v in validation_results if v['valid'])} valid\"\n    }\n"
  next:
    spec:
      mode: exclusive
    arcs:
    - step: end
- step: end
  desc: Complete profile processing pipeline
  tool:
    kind: python
    args:
      validation_result: '{{ validate_results.data }}'
      user_count: '{{ users | length }}'
    code: "# Be robust to unexpected types (e.g., during early tracking states)\n\
      if not isinstance(validation_result, dict):\n    try:\n        summary = str(validation_result)\n\
      \    except Exception:\n        summary = 'N/A'\n    validation_result = {\n\
      \        'status': 'unknown',\n        'all_valid': False,\n        'summary':\
      \ summary\n    }\nprint(f\"Pipeline completed successfully!\")\nprint(f\"Users\
      \ processed: {user_count}\")\nprint(f\"Validation status: {validation_result.get('status',\
      \ 'unknown')}\")\nprint(f\"All valid: {validation_result.get('all_valid', False)}\"\
      )\nprint(f\"Summary: {validation_result.get('summary', 'No summary available')}\"\
      )\n\nresult = {\n    \"pipeline_status\": \"completed\",\n    \"users_processed\"\
      : user_count,\n    \"validation_passed\": validation_result.get('all_valid',\
      \ False),\n    \"message\": \"Playbook composition test completed successfully\"\
      \n}\n"

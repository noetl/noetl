apiVersion: noetl.io/v2
kind: Playbook

metadata:
  name: duckdb_gcs_workload_identity
  path: tests/fixtures/playbooks/duckdb_gcs_workload_identity/workload_identity

workload:
  pg_auth: pg_local
  gcs_bucket: noetl-demo-19700101
  upload_file: test_file_{{ execution_id }}.parquet
  download_file: test_file_downloaded_{{ execution_id }}.parquet

workflow:
  - step: start
    desc: Start workflow
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "initialized"}
    next:
      - step: test_data


  - step: test_data
    desc: Upload a parquet file to GCS via DuckDB
    tool:
      kind: duckdb
      auth:
        pg_db:
          source: credential
          tool: postgres
          key: "{{ workload.pg_auth }}"
        gcs_secret:
          source: credential
          tool: hmac
          key: gcs_hmac_local
          scope: gs://{{ workload.gcs_bucket }}
      commands: |
        INSTALL httpfs;
        LOAD httpfs;

        CREATE TABLE test_data AS
        SELECT 'test data' AS message, '{{ execution_id }}' AS id;

        COPY test_data TO 'gs://{{ workload.gcs_bucket }}/fixture/{{ workload.upload_file }}' (FORMAT PARQUET);
    next:
      - step: download_file

  - step: download_file
    desc: Read the file back and upload under a different name
    tool:
      kind: duckdb
      auth:
        pg_db:
          source: credential
          tool: postgres
          key: "{{ workload.pg_auth }}"
        gcs_secret:
          source: credential
          tool: hmac
          key: gcs_hmac_local
          scope: gs://{{ workload.gcs_bucket }}
      commands: |
        INSTALL httpfs;
        LOAD httpfs;

        CREATE TABLE downloaded_data AS
        SELECT * FROM 'gs://{{ workload.gcs_bucket }}/fixture/{{ workload.upload_file }}';

        COPY downloaded_data TO '{{ workload.download_file }}' (FORMAT PARQUET);
    next:
      - step: end

  - step: end
    desc: Done
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "completed"}

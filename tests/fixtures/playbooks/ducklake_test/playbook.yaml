apiVersion: noetl.io/v1
kind: Playbook
metadata:
  name: ducklake_test
  path: tests/fixtures/playbooks/ducklake_test
  description: |
    Test DuckLake distributed DuckDB with PostgreSQL metastore.
    Demonstrates concurrent access across multiple workers without file locking.

workload:
  catalog_auth: noetl_ducklake_catalog
  catalog_name: "test_catalog"
  data_path: "/opt/noetl/data/ducklake"
  
  # Test data
  user_ids: [1, 2, 3, 4, 5]

workflow:
  - step: start
    desc: "Initialize DuckLake test"
    next:
      - step: create_catalog_db

  # Setup: Create PostgreSQL catalog database
  - step: create_catalog_db
    desc: "Create ducklake_catalog database in Postgres"
    tool: postgres
    auth:
      type: postgres
      credential: noetl_connection
    command: |
      SELECT 1 FROM pg_database WHERE datname = 'ducklake_catalog';
    next:
      - when: "{{ result.data.command_0.rows | length == 0 }}"
        then:
          - step: create_db_sql
      - step: create_users_table

  - step: create_db_sql
    desc: "Actually create the database"
    tool: postgres
    auth:
      type: postgres
      credential: noetl_connection
    command: |
      CREATE DATABASE ducklake_catalog;
    next:
      - step: create_users_table

  # Test 1: Create table and insert data
  - step: create_users_table
    desc: "Create users table in DuckLake catalog"
    tool: ducklake
    catalog_connection: "{{ workload.catalog_connection }}"
    catalog_name: "{{ workload.catalog_name }}"
    data_path: "{{ workload.data_path }}"
    command: |
      CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY,
        name VARCHAR,
        email VARCHAR,
        created_at TIMESTAMP
      );
    next:
      - step: insert_initial_users

  - step: insert_initial_users
    desc: "Insert initial user data"
    tool: ducklake
    catalog_connection: "{{ workload.catalog_connection }}"
    catalog_name: "{{ workload.catalog_name }}"
    data_path: "{{ workload.data_path }}"
    command: |
      INSERT INTO users VALUES 
        (1, 'Alice', 'alice@example.com', NOW()),
        (2, 'Bob', 'bob@example.com', NOW());
    next:
      - step: query_users

  # Test 2: Query data
  - step: query_users
    desc: "Query users table"
    tool: ducklake
    catalog_connection: "{{ workload.catalog_connection }}"
    catalog_name: "{{ workload.catalog_name }}"
    data_path: "{{ workload.data_path }}"
    command: |
      SELECT * FROM users ORDER BY id;
    vars:
      user_count: "{{ result.data.command_0.row_count }}"
    next:
      - step: loop_insert_events

  # Test 3: Distributed loop (async mode - multiple workers)
  - step: loop_insert_events
    desc: "Insert events for users in parallel"
    loop:
      collection: "{{ workload.user_ids }}"
      element: user_id
      mode: async
    tool: ducklake
    catalog_connection: "{{ workload.catalog_connection }}"
    catalog_name: "{{ workload.catalog_name }}"
    data_path: "{{ workload.data_path }}"
    command: |
      CREATE TABLE IF NOT EXISTS user_events (
        user_id INTEGER,
        event_type VARCHAR,
        event_time TIMESTAMP
      );
      INSERT INTO user_events (user_id, event_type, event_time)
      VALUES ({{ loop.element }}, 'test_event', NOW());
    next:
      - when: "{{ event.name == 'loop.done' }}"
        then:
          - step: count_events

  # Test 4: Verify distributed inserts
  - step: count_events
    desc: "Count events inserted by distributed workers"
    tool: ducklake
    catalog_connection: "{{ workload.catalog_connection }}"
    catalog_name: "{{ workload.catalog_name }}"
    data_path: "{{ workload.data_path }}"
    command: |
      SELECT COUNT(*) as event_count FROM user_events;
    vars:
      event_count: "{{ result.data.command_0.rows[0].event_count }}"
    next:
      - step: get_catalog_info

  # Test 5: Get catalog metadata
  - step: get_catalog_info
    desc: "Get DuckLake catalog snapshots and table info"
    tool: ducklake
    catalog_connection: "{{ workload.catalog_connection }}"
    catalog_name: "{{ workload.catalog_name }}"
    data_path: "{{ workload.data_path }}"
    commands:
      - "SELECT * FROM ducklake_snapshots('{{ workload.catalog_name }}') ORDER BY snapshot_id DESC LIMIT 5;"
      - "SELECT * FROM ducklake_table_info('{{ workload.catalog_name }}');"
    vars:
      snapshot_count: "{{ result.data.command_0.row_count }}"
      table_count: "{{ result.data.command_1.row_count }}"
    next:
      - step: end

  - step: end
    desc: |
      DuckLake test completed successfully.
      - Users created: {{ vars.user_count }}
      - Events inserted: {{ vars.event_count }}
      - Snapshots: {{ vars.snapshot_count }}
      - Tables: {{ vars.table_count }}

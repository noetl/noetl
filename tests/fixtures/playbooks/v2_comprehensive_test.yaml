apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: v2_comprehensive_test
  path: test/v2/comprehensive
  description: Comprehensive V2 test with multiple steps, conditionals, and data flow

workload:
  initial_message: "Starting V2 comprehensive test"
  threshold: 10

workflow:
  - step: start
    desc: Initialize workflow with data preparation
    tool:
      kind: python
      args:
        initial_message: "{{ workload.initial_message }}"
      code: |
        import random
        value = random.randint(1, 20)
        print(f"[START] {initial_message}")
        print(f"[START] Generated random value: {value}")
        result = {
            "status": "initialized",
            "random_value": value,
            "message": initial_message
        }
    next:
      - step: process_high
        when: "{{ start.random_value > workload.threshold }}"
      - step: process_low
        when: "{{ start.random_value <= workload.threshold }}"

  - step: process_high
    desc: Process high values
    tool:
      kind: python
      args:
        value: "{{ start.random_value }}"
      code: |
        value = int(value)
        print(f"[PROCESS_HIGH] Handling high value: {value}")
        processed = value * 2
        print(f"[PROCESS_HIGH] Doubled result: {processed}")
        result = {
            "status": "high_processed",
            "original": value,
            "processed": processed,
            "category": "high"
        }
    next:
      - step: summarize

  - step: process_low
    desc: Process low values
    tool:
      kind: python
      args:
        value: "{{ start.random_value }}"
      code: |
        value = int(value)
        print(f"[PROCESS_LOW] Handling low value: {value}")
        processed = value + 100
        print(f"[PROCESS_LOW] Added 100, result: {processed}")
        result = {
            "status": "low_processed",
            "original": value,
            "processed": processed,
            "category": "low"
        }
    next:
      - step: summarize

  - step: summarize
    desc: Generate final summary
    tool:
      kind: python
      args:
        start_value: "{{ start.random_value }}"
        category: "{{ process_high.category if process_high else process_low.category }}"
        final_value: "{{ process_high.processed if process_high else process_low.processed }}"
      code: |
        import json
        print(f"[SUMMARIZE] Generating final summary")

        summary = {
            "workflow": "v2_comprehensive_test",
            "original_value": start_value,
            "processing_path": category,
            "final_result": final_value,
            "completed": True
        }

        print(f"[SUMMARIZE] Final summary: {json.dumps(summary, indent=2)}")
        result = summary
    next:
      - step: end

  - step: end
    desc: Workflow complete
    tool:
      kind: python
      args: {}
      code: |
        print("[END] Workflow execution completed successfully!")
        result = {"status": "completed"}

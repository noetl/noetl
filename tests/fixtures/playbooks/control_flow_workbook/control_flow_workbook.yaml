apiVersion: noetl.io/v10
kind: Playbook

metadata:
  name: control_flow_workbook
  path: tests/fixtures/playbooks/control_flow_workbook # catalog path; do not change in tests

workload:
  temperature_c: 30 # tune to test hot/cold routing

# A tiny workbook with a python action that evaluates a flag.
workbook:
  - name: compute_flag
    tool:
      kind: python
      args:
        temperature_c: null
      code: |
        is_hot = float(temperature_c) >= 25.0
        msg = "hot" if is_hot else "cold"
        result = {"is_hot": is_hot, "message": msg}
    assert:
      expects:
        - temperature_c
      returns:
        - is_hot
        - message

workflow:
  - step: start
    desc: "Begin"
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "initialized"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: eval_flag

  - step: eval_flag
    desc: "Call workbook action to compute is_hot"
    tool:
      kind: workbook
      name: compute_flag
      args:
        temperature_c: "{{ temperature_c }}"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: hot_path
          when: "{{ eval_flag.is_hot == true }}"
        - step: cold_path
          when: "{{ eval_flag.is_hot == false }}"

  - step: hot_path
    desc: "Hot branch; fan out to two steps in PARALLEL"
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "routing_to_parallel"}
    next:
      spec:
        mode: inclusive
      arcs:
        - step: hot_task_a
        - step: hot_task_b

  - step: hot_task_a
    tool:
      kind: python
      args: {}
      code: |
        result = {"who": "A"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: hot_task_b
    tool:
      kind: python
      args: {}
      code: |
        result = {"who": "B"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: cold_path
    desc: "Cold branch single continuation"
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "routing_to_cold"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: cold_task

  - step: cold_task
    tool:
      kind: python
      args: {}
      code: |
        result = {"who": "C"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: "Finish"
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "complete"}

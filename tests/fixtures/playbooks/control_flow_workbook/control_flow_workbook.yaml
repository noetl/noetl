apiVersion: noetl.io/v2
kind: Playbook

metadata:
  name: control_flow_workbook
  path: tests/fixtures/playbooks/control_flow_workbook # catalog path; do not change in tests

workload:
  temperature_c: 30 # tune to test hot/cold routing

# A tiny workbook with a python action that evaluates a flag.
workbook:
  - name: compute_flag
    tool:
      kind: python
      code: |
        def main(temperature_c):
            is_hot = float(temperature_c) >= 25.0
            msg = "hot" if is_hot else "cold"
            return {"is_hot": is_hot, "message": msg}
      args:
        temperature_c: null
    assert:
      expects:
        - temperature_c
      returns:
        - is_hot
        - message

workflow:
  - step: start
    desc: "Begin"
    tool:
      kind: python
      code: |
        def main():
            return {"status": "initialized"}
    
    case:
      - when: "{{ event.name == 'step.exit' }}"
        then:
          next:
            - step: eval_flag

  - step: eval_flag
    desc: "Call workbook action to compute is_hot"
    tool:
      kind: workbook
      name: compute_flag
      args:
        temperature_c: "{{ workload.temperature_c }}"
    
    case:
      - when: "{{ event.name == 'step.exit' and response is defined and response.is_hot == true }}"
        then:
          next:
            - step: hot_path
      
      - when: "{{ event.name == 'step.exit' and response is defined and response.is_hot == false }}"
        then:
          next:
            - step: cold_path

  - step: hot_path
    desc: "Hot branch; fan out to two steps in PARALLEL"
    tool:
      kind: python
      code: |
        def main():
            return {"status": "routing_to_parallel"}
    
    case:
      - when: "{{ event.name == 'step.exit' }}"
        then:
          next:
            - step: hot_task_a
            - step: hot_task_b

  - step: hot_task_a
    tool:
      kind: python
      code: |
        def main():
            return {"who": "A"}
    
    case:
      - when: "{{ event.name == 'step.exit' and response is defined }}"
        then:
          next:
            - step: end

  - step: hot_task_b
    tool:
      kind: python
      code: |
        def main():
            return {"who": "B"}
    
    case:
      - when: "{{ event.name == 'step.exit' and response is defined }}"
        then:
          next:
            - step: end

  - step: cold_path
    desc: "Cold branch single continuation"
    tool:
      kind: python
      code: |
        def main():
            return {"status": "routing_to_cold"}
    
    case:
      - when: "{{ event.name == 'step.exit' }}"
        then:
          next:
            - step: cold_task

  - step: cold_task
    tool:
      kind: python
      code: |
        def main():
            return {"who": "C"}
    
    case:
      - when: "{{ event.name == 'step.exit' and response is defined }}"
        then:
          next:
            - step: end

  - step: end
    desc: "Finish"
    tool:
      kind: python
      code: |
        def main():
            return {"status": "complete"}

apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: multi_playbook_batch
  path: batch_execution/multi_playbook_batch

workload:
  jobId: '{{ job.uuid }}'
  secret_name: test-secret
  environment: dev
  GOOGLE_CLOUD_PROJECT: noetl-demo-19700101
  cities:
    - name: London
      lat: 51.51
      lon: -0.13
  base_url: https://api.open-meteo.com/v1
  temperature_threshold: 26
  baseFilePath: /opt/noetl/data/test
  bucket: test-bucket
  pg_auth: pg_k8s

workflow:
  - step: start
    desc: Start Multiple Playbook Batch Workflow
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "initialized", "message": "Starting batch workflow"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: run_http_test

  - step: run_http_test
    desc: Run HTTP test playbook
    tool:
      kind: playbook
      path: tests/fixtures/playbooks/data_transfer/http_to_postgres_simple
      payload:
        url: https://httpbin.org/get
        method: GET
    next:
      spec:
        mode: exclusive
      arcs:
        - step: run_weather_processing
          args:
            http_result: '{{ run_http_test }}'

  - step: run_weather_processing
    desc: Run weather processing playbook
    tool:
      kind: playbook
      path: tests/fixtures/playbooks/control_flow_workbook
      payload:
        cities: '{{ cities }}'
        base_url: '{{ base_url }}'
        temperature_threshold: '{{ temperature_threshold }}'
    next:
      spec:
        mode: exclusive
      arcs:
        - step: run_data_transformation
          args:
            weather_result: '{{ run_weather_processing }}'

  - step: run_data_transformation
    desc: Run data transformation playbook
    tool:
      kind: playbook
      path: tests/fixtures/playbooks/duckdb_gcs_workload_identity/workload_identity
      payload:
        baseFilePath: '{{ baseFilePath }}'
        bucket: '{{ bucket }}'
        pg_auth: '{{ pg_auth }}'
    next:
      spec:
        mode: exclusive
      arcs:
        - step: store_results

  - step: store_results
    desc: Store the results from all playbooks
    tool:
      kind: duckdb
      auth:
        pg_db:
          source: credential
          tool: postgres
          key: "{{ pg_auth }}"
      commands: |
        ATTACH '' AS pg_db (TYPE POSTGRES, SECRET pg_db);

        CREATE TABLE IF NOT EXISTS pg_db.playbook_batch_results (
            id BIGINT PRIMARY KEY,
            execution_id TEXT,
            http_result TEXT,
            weather_result TEXT,
            data_result TEXT
        );

        INSERT INTO pg_db.playbook_batch_results (
            id, execution_id, http_result, weather_result, data_result
        ) VALUES (
            {{ execution_id }},
            '{{ execution_id }}',
            '{{ run_http_test | tojson | replace("'", "''") }}',
            '{{ run_weather_processing | tojson | replace("'", "''") }}',
            '{{ run_data_transformation | tojson | replace("'", "''") }}'
        );

        SELECT COUNT(*) AS total_records
        FROM pg_db.playbook_batch_results
        WHERE execution_id = '{{ execution_id }}';
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: End of batch workflow
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "completed"}

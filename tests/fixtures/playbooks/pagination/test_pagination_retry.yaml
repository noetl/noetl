apiVersion: noetl.io/v1
kind: Playbook
metadata:
  name: test_pagination_retry
  path: tests/pagination/retry
  description: Pagination with retry for failed requests

workload:
  api_url: http://paginated-api.test-server.svc.cluster.local:5555

workflow:
  - step: start
    desc: Fetch data with retry on failures
    next:
      - step: fetch_with_retry

  - step: fetch_with_retry
    desc: Pagination with automatic retry on page 2
    tool: http
    url: "{{ workload.api_url }}/api/v1/flaky"
    method: GET
    params:
      page: 1
      fail_on: "2"  # Fail on page 2 first attempt
    loop:
      pagination:
        type: response_based
        continue_while: "{{ response.data.paging.hasMore == true }}"
        next_page:
          params:
            page: "{{ (response.data.paging.page | int) + 1 }}"
        merge_strategy: append
        merge_path: data.data
        max_iterations: 10
        retry:
          max_attempts: 3
          backoff: exponential
          initial_delay: 0.5
          max_delay: 5
    next:
      - step: validate_results

  - step: validate_results
    desc: Validate retry succeeded
    tool: python
    args:
      input_data:
        fetch_with_retry: "{{ fetch_with_retry }}"
    code: |
      def main(input_data):
          # Check we got all items despite failures - handle server wrapping
          raw_data = input_data.get('fetch_with_retry', [])
          
          # Unwrap if server wrapped in {'value': ...}
          if isinstance(raw_data, dict) and 'value' in raw_data:
              data = raw_data['value']
          elif isinstance(raw_data, dict) and 'data' in raw_data:
              data = raw_data['data']
          elif isinstance(raw_data, list):
              data = raw_data
          else:
              data = []
          
          print(f"Total items fetched (with retry): {len(data)}")
          
          # Note: This will fail on page 2 unless retry is working
          # With retry, should get all 35 items
          assert len(data) >= 10, f"Expected at least 10 items, got {len(data)}"
          
          return {
              'status': 'success',
              'total_items': len(data),
              'retry_worked': len(data) == 35
          }
    next:
      - step: end

  - step: end
    desc: Workflow complete

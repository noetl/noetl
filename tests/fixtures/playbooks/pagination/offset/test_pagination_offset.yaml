apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: test_pagination_offset
  path: tests/pagination/offset/offset
  description: Offset-based pagination test using canonical format

workload:
  api_url: "http://paginated-api.test-server.svc.cluster.local:5555"

vars:
  offset: 0
  limit: 10
  collected_users: []
  has_more: true

workflow:
  - step: start
    desc: Initialize offset pagination
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "initialized"}
    next:
      - step: fetch_page

  - step: fetch_page
    desc: Fetch a single page of users with offset
    tool:
      kind: http
      url: "{{ workload.api_url }}/api/v1/users"
      method: GET
      params:
        offset: "{{ vars.offset }}"
        limit: "{{ vars.limit }}"
      eval:
        - expr: "{{ outcome.status == 'error' and outcome.error.retryable }}"
          do: retry
          attempts: 5
          backoff: exponential
          delay: 1.0
        - expr: "{{ outcome.status == 'error' }}"
          do: fail
        - else:
            do: continue
    next:
      - step: check_pagination

  - step: check_pagination
    desc: Check if more pages exist and collect results
    tool:
      kind: python
      args:
        response: "{{ fetch_page }}"
        collected: "{{ vars.collected_users }}"
        current_offset: "{{ vars.offset }}"
        limit: "{{ vars.limit }}"
      code: |
        data = response.get('data', {})
        users = data.get('users', [])
        has_more = data.get('has_more', False)

        # Append new users to collected
        all_users = collected + users if isinstance(collected, list) else users

        next_offset = current_offset + limit

        result = {
            'collected_users': all_users,
            'has_more': has_more,
            'next_offset': next_offset,
            'total_collected': len(all_users)
        }
    vars:
      collected_users: "{{ check_pagination.collected_users }}"
      offset: "{{ check_pagination.next_offset }}"
      has_more: "{{ check_pagination.has_more }}"
    next:
      - step: fetch_page
        when: "{{ vars.has_more == true }}"
      - step: validate_results
        when: "{{ vars.has_more != true }}"

  - step: validate_results
    desc: Validate merged results
    tool:
      kind: python
      args:
        users: "{{ vars.collected_users }}"
      code: |
        data = users if isinstance(users, list) else []

        print(f"Total users fetched: {len(data)}")
        print(f"First user: {data[0] if data else None}")
        print(f"Last user: {data[-1] if data else None}")

        # Validate
        expected_count = 35
        success = len(data) == expected_count

        if data:
            first_id = data[0].get('id', 0)
            last_id = data[-1].get('id', 0)
        else:
            first_id = 0
            last_id = 0

        result = {
            'status': 'success' if success else 'failed',
            'total_users': len(data),
            'first_id': first_id,
            'last_id': last_id
        }
    next:
      - step: end

  - step: end
    desc: Workflow complete
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "complete"}

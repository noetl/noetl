apiVersion: noetl.io/v10
kind: Playbook
metadata:
  name: test_pagination_cursor
  path: tests/pagination/cursor/cursor
  description: Cursor-based pagination test using canonical format

workload:
  api_url: "http://paginated-api.test-server.svc.cluster.local:5555"
  cursor: ""
  limit: 10
  collected_events: []
  has_more: true

workflow:
  - step: start
    desc: Initialize cursor pagination
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "initialized"}
    set_ctx:
      cursor: "{{ workload.cursor }}"
      limit: "{{ workload.limit }}"
      collected_events: "{{ workload.collected_events }}"
      has_more: "{{ workload.has_more }}"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: fetch_page

  - step: fetch_page
    desc: Fetch a single page of events with cursor
    tool:
      kind: http
      url: "{{ api_url }}/api/v1/events"
      method: GET
      params:
        cursor: "{{ ctx.cursor }}"
        limit: "{{ ctx.limit }}"
      spec:
        policy:
          rules:
            - when: "{{ outcome.status == 'error' and outcome.error.retryable }}"
              then:
                do: retry
                attempts: 5
                backoff: exponential
                delay: 1.0
            - when: "{{ outcome.status == 'error' }}"
              then:
                do: fail
            - else:
                then:
                  do: continue
    next:
      spec:
        mode: exclusive
      arcs:
        - step: check_pagination

  - step: check_pagination
    desc: Check if more pages exist and collect results
    tool:
      kind: python
      args:
        response: "{{ fetch_page }}"
        collected: "{{ ctx.collected_events }}"
      code: |
        data = response.get('data', {})
        events = data.get('events', [])
        next_cursor = data.get('next_cursor', '')

        # Append new events to collected
        all_events = collected + events if isinstance(collected, list) else events

        has_more = next_cursor is not None and next_cursor != ''

        result = {
            'collected_events': all_events,
            'has_more': has_more,
            'next_cursor': next_cursor if has_more else '',
            'total_collected': len(all_events)
        }
    set_ctx:
      collected_events: "{{ check_pagination.collected_events }}"
      cursor: "{{ check_pagination.next_cursor }}"
      has_more: "{{ check_pagination.has_more }}"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: fetch_page
          when: "{{ ctx.has_more == true }}"
        - step: validate_results
          when: "{{ ctx.has_more != true }}"

  - step: validate_results
    desc: Validate merged results
    tool:
      kind: python
      args:
        events: "{{ ctx.collected_events }}"
      code: |
        data = events if isinstance(events, list) else []

        print(f"Total events fetched: {len(data)}")
        print(f"First event: {data[0] if data else None}")
        print(f"Last event: {data[-1] if data else None}")

        # Validate
        expected_count = 35
        success = len(data) == expected_count

        if data:
            first_id = data[0].get('id', 0)
            last_id = data[-1].get('id', 0)
        else:
            first_id = 0
            last_id = 0

        result = {
            'status': 'success' if success else 'failed',
            'total_events': len(data),
            'first_id': first_id,
            'last_id': last_id
        }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: Workflow complete
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "complete"}

apiVersion: noetl.io/v10
kind: Playbook
metadata:
  name: test_pagination_basic
  path: tests/pagination/basic/basic
  description: Basic page-number pagination test using canonical format

workload:
  api_url: "http://paginated-api.test-server.svc.cluster.local:5555"

ctx:
  current_page: 1
  page_size: 10
  collected_items: []
  has_more: true

workflow:
  - step: start
    desc: Initialize pagination
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "initialized"}
    next:
      spec:
        mode: exclusive
      arcs:
        - step: fetch_page

  - step: fetch_page
    desc: Fetch a single page of assessments
    tool:
      kind: http
      url: "{{ api_url }}/api/v1/assessments"
      method: GET
      params:
        page: "{{ ctx.current_page }}"
        pageSize: "{{ ctx.page_size }}"
      spec:
        policy:
          rules:
            - when: "{{ outcome.status == 'error' and outcome.error.retryable }}"
              then:
                do: retry
                attempts: 5
                backoff: exponential
                delay: 1.0
            - when: "{{ outcome.status == 'error' }}"
              then:
                do: fail
            - else:
                then:
                  do: continue
    next:
      spec:
        mode: exclusive
      arcs:
        - step: check_pagination

  - step: check_pagination
    desc: Check if more pages exist and collect results
    tool:
      kind: python
      args:
        response: "{{ fetch_page }}"
        collected: "{{ ctx.collected_items }}"
        current_page: "{{ ctx.current_page }}"
      code: |
        data = response.get('data', {})
        items = data.get('data', [])
        paging = data.get('paging', {})

        # Append new items to collected
        all_items = collected + items if isinstance(collected, list) else items

        has_more = paging.get('hasMore', False)
        next_page = current_page + 1

        result = {
            'collected_items': all_items,
            'has_more': has_more,
            'next_page': next_page,
            'total_collected': len(all_items)
        }
    set_ctx:
      collected_items: "{{ check_pagination.collected_items }}"
      current_page: "{{ check_pagination.next_page }}"
      has_more: "{{ check_pagination.has_more }}"
    next:
      spec:
        mode: exclusive
      arcs:
        - step: fetch_page
          when: "{{ ctx.has_more == true }}"
        - step: validate_results
          when: "{{ ctx.has_more != true }}"

  - step: validate_results
    desc: Validate merged results
    tool:
      kind: python
      args:
        items: "{{ ctx.collected_items }}"
      code: |
        data = items if isinstance(items, list) else []

        print(f"Total items fetched: {len(data)}")
        print(f"First item: {data[0] if data else None}")
        print(f"Last item: {data[-1] if data else None}")

        # Validate
        expected_count = 35
        success = len(data) == expected_count

        if data:
            first_id = data[0].get('id', 0)
            last_id = data[-1].get('id', 0)
        else:
            first_id = 0
            last_id = 0

        result = {
            'status': 'success' if success else 'failed',
            'total_items': len(data),
            'first_id': first_id,
            'last_id': last_id,
            'expected': expected_count
        }
    next:
      spec:
        mode: exclusive
      arcs:
        - step: end

  - step: end
    desc: Workflow complete
    tool:
      kind: python
      args: {}
      code: |
        result = {"status": "complete"}

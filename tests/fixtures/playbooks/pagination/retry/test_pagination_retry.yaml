apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: test_pagination_retry
  path: tests/pagination/retry/retry
  description: Pagination with retry for failed requests

workload:
  api_url: "http://paginated-api.test-server.svc.cluster.local:5555"

workflow:
  - step: start
    desc: Fetch data with retry on failures
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "initialized"}

    case:
      - when: "{{ event.name == 'step.exit' }}"
        then:
          next:
            - step: fetch_with_retry

  - step: fetch_with_retry
    desc: Pagination with automatic retry on page 2
    tool:
      kind: http
      url: "{{ workload.api_url }}/api/v1/flaky"
      method: GET
      params:
        page: 1
        fail_on: "2" # Fail on page 2 first attempt

    case:
      - when: "{{ event.name == 'call.error' and error.status in [500, 502, 503] }}"
        then:
          retry:
            max_attempts: 3
            backoff_multiplier: 2.0
            initial_delay: 0.5

      - when: "{{ event.name == 'call.done' and response is defined and response.paging.hasMore == true }}"
        then:
          collect:
            strategy: append
            path: data
            into: pages
          retry:
            max_attempts: 10
            params:
              page: "{{ (response.paging.page | int) + 1 }}"

      - when: "{{ event.name == 'call.done' and response is defined and response.paging.hasMore != true }}"
        then:
          collect:
            strategy: append
            path: data
            into: pages
          next:
            - step: validate_results

  - step: validate_results
    desc: Validate retry succeeded
    tool:
      kind: python
      auth: {}
      libs: {}
      args:
        input_data: "{{ fetch_with_retry }}"
      code: |
        # Check we got all items despite failures - handle server wrapping
        raw_data = input_data

        # Unwrap if server wrapped in {'value': ...}
        if isinstance(raw_data, dict) and 'value' in raw_data:
            data = raw_data['value']
        elif isinstance(raw_data, dict) and 'data' in raw_data:
            data = raw_data['data']
        elif isinstance(raw_data, list):
            data = raw_data
        else:
            data = []

        print(f"Total items fetched (with retry): {len(data)}")

        # Note: This will fail on page 2 unless retry is working
        # With retry, should get all 35 items
        assert len(data) >= 10, f"Expected at least 10 items, got {len(data)}"

        result = {
            'status': 'success',
            'total_items': len(data),
            'retry_worked': len(data) == 35
        }

    case:
      - when: "{{ event.name == 'step.exit' and response is defined }}"
        then:
          next:
            - step: end

  - step: end
    desc: Workflow complete
    tool:
      kind: python
      auth: {}
      libs: {}
      args: {}
      code: |
        result = {"status": "complete"}

apiVersion: noetl.io/v2
kind: Playbook
metadata:
  name: v2_actions_test
  path: test/v2/actions

workload:
  test_message: "Testing V2 actions: call, retry, sink"
  max_retries: 2
  numbers: [10, 20, 30]

workflow:
  # Start: Process data and store in variable
  - step: start
    desc: Initialize data processing
    tool:
      - init:
          kind: python
          code: |
            print(f"[START] Processing initial data")
            data = {"count": 0, "sum": 0, "items": []}
            return data
    next:
      - step: process_loop

  # Loop through numbers and collect results
  - step: process_loop
    desc: Loop through numbers and double them
    loop:
      spec:
        mode: sequential
      in: "{{ workload.numbers }}"
      iterator: num
    tool:
      - double_number:
          kind: python
          args:
            num: "{{ iter.num }}"
          code: |
            num = input_data.get('num')
            print(f"[LOOP] Processing {num}")
            result = num * 2
            return {"original": num, "doubled": result}
          eval:
            - else:
                do: continue
                set_iter:
                  loop_result: "{{ outcome.result }}"
    next:
      - step: aggregate

  # Aggregate loop results
  - step: aggregate
    desc: Sum all doubled values
    tool:
      - aggregate_results:
          kind: python
          args:
            loop_results: "{{ vars.loop_results | default([]) }}"
          code: |
            results = input_data.get('loop_results', [])
            print(f"[AGGREGATE] Processing {len(results)} results")

            total = sum(item['doubled'] for item in results)
            original_sum = sum(item['original'] for item in results)

            return {
                "count": len(results),
                "original_sum": original_sum,
                "doubled_sum": total
            }
    next:
      - step: helper
        when: "{{ aggregate.count > 0 }}"
        args:
          message: "Aggregate completed with {{ aggregate.count }} items"
          data: "{{ aggregate }}"
      - step: test_secrets

  # Helper step (called by aggregate)
  - step: helper
    desc: Helper step to demonstrate call action
    tool:
      - helper_action:
          kind: python
          args:
            message: "{{ args.message | default('No message') }}"
            data: "{{ args.data | default({}) }}"
          code: |
            message = input_data.get('message', 'No message')
            data = input_data.get('data', {})
            print(f"[HELPER] {message}")
            print(f"[HELPER] Data: {data}")
            return {"helper_called": True, "message": message}
    next:
      - step: verify

  # Test secrets tool
  - step: test_secrets
    desc: Fetch secret from environment
    tool:
      - fetch_secret:
          kind: secrets
          provider: "env"
          name: "TEST_SECRET"
    next:
      - step: verify

  # Verify results
  - step: verify
    desc: Verify all actions completed
    tool:
      - verify_actions:
          kind: python
          args:
            aggregate: "{{ aggregate | default({}) }}"
            helper: "{{ helper | default({}) }}"
          code: |
            print("[VERIFY] All actions completed successfully")

            # Check if we have the expected data
            aggregate_result = input_data.get('aggregate', {})
            helper_result = input_data.get('helper', {})

            success = (
                aggregate_result.get('count', 0) == 3 and
                aggregate_result.get('doubled_sum', 0) == 120 and
                helper_result.get('helper_called', False)
            )

            return {
                "success": success,
                "aggregate": aggregate_result,
                "helper": helper_result,
                "message": "All tests passed!" if success else "Some tests failed"
            }
    next:
      - step: end

  # End step
  - step: end
    desc: Workflow complete
    tool:
      - complete:
          kind: python
          args:
            verify: "{{ verify }}"
          code: |
            verify_result = input_data.get('verify', {})
            print(f"[END] {verify_result.get('message', 'Complete')}")
            return {"status": "completed", "success": verify_result.get('success', False)}

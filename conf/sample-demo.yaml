workflow:
  version: "1"
  id: "sample-demo" 
  description: "Retrieves BTC/USD exchange rate from 3 different exchanges, calculates an average and puts the latter into db."
  context:
    aws:
      access-key: "sdFASDFA"
      secret-key: "ASDASDFASDF"
  tasks: 
    retrive-btc-usd:
      description: "Retrieves BTC/USD exchange rate from 3 different exchanges"
      steps: 
        - s3:
            action: "directory"
            path: "s3a://datalake/{{ loop.value | strip(\"https://\") | \"/\" }}"
            validate: "empty"
          context: "aws"
        - s3:
            action: "directory"
            path: "s3a://datalake/{{ loop.value | strip(\"https://\") | \"/\" }}"
            validate: "empty"
          context: "aws"
        - rest:
            action: "download" 
            url: "{{ .value }}"
            path: "s3a://datalake/{{ loop.value | strip(\"https://\") | \"/\" }}"
          context: "aws"
    loop: 
      - "https://cex.io/api/last_price/BTC/USD"
      - "https://api.bitfinex.com/v1/pubticker/btcusd"
      - "https://api.hitbtc.com/api/2/public/ticker/BTCUSD"

    aggragate-btc-usd:
      description: "Calculate BTC/USD average and display result"
      steps: 
        - aggregate:
            action: "average"
            sources: 
              - "s3a://datalake/cex.io/api/last_price/BTC/USD/"
              - "s3a://datalake/api.bitfinex.com/v1/pubticker/btcusd/"
              - "s3a://datalake/api.hitbtc.com/api/2/public/ticker/BTCUSD/"
          context: "aws"
      require: 
        - "retrive-btc-usd"

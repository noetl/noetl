{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://noetl.io/schemas/playbook_v2_authoring.json",
  "title": "NoETL Playbook v2 (Authoring)",
  "type": "object",
  "required": ["apiVersion", "kind", "metadata", "workload", "workbook", "workflow"],
  "additionalProperties": false,
  "properties": {
    "apiVersion": { "type": "string", "pattern": "^noetl\\.io\\/v\\d+$" },
    "kind": { "const": "Playbook" },

    "protocol": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "version"],
      "properties": {
        "kind": { "type": "string", "enum": ["mcp"] },
        "version": { "type": "string" },
        "requires": {
          "type": "object",
          "additionalProperties": { "type": ["boolean", "string", "number"] }
        }
      },
      "description": "Single protocol declaration. Example: {kind:'mcp', version:'2025-06-18'}"
    },

    "metadata": {
      "type": "object",
      "required": ["name", "path"],
      "additionalProperties": true,
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "path": { "type": "string", "minLength": 1 },
        "labels": { "type": "object", "additionalProperties": { "type": "string" } }
      }
    },

    "workload": { "type": "object", "additionalProperties": true },

    "workbook": {
      "type": "array",
      "minItems": 0,
      "items": { "$ref": "#/$defs/workbook_item" }
    },

    "workflow": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/workflow_step" }
    }
  },

  "$defs": {
    "action_type": {
      "type": "string",
      "enum": ["http", "python", "postgres", "duckdb", "iterator", "router", "playbook", "end"]
    },

    "json_schema": { "type": "object", "additionalProperties": true },

    "workbook_item": {
      "type": "object",
      "required": ["name", "type"],
      "additionalProperties": true,
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "type": { "$ref": "#/$defs/action_type" },
        "desc": { "type": "string" },

        "inputSchema": { "$ref": "#/$defs/json_schema" },
        "auth": { "type": "object", "additionalProperties": true },

        "endpoint": { "type": "string" },
        "method": { "type": "string" },
        "params": { "type": "object", "additionalProperties": true },
        "headers": { "type": "object", "additionalProperties": true },

        "code": { "type": "string" },

        "sql": { "type": "string" },
        "command": { "type": "string" },

        "iterator": { "type": "object", "additionalProperties": true },

        "save": { "type": "object", "additionalProperties": true }
      },
      "allOf": [
        {
          "if": { "properties": { "type": { "const": "http" } }, "required": ["type"] },
          "then": { "required": ["endpoint"] }
        },
        {
          "if": { "properties": { "type": { "const": "python" } }, "required": ["type"] },
          "then": { "required": ["code"] }
        },
        {
          "if": { "properties": { "type": { "enum": ["postgres", "duckdb"] } }, "required": ["type"] },
          "then": {
            "oneOf": [
              { "required": ["sql"] },
              { "required": ["command"] }
            ]
          }
        },
        {
          "if": { "properties": { "type": { "const": "iterator" } }, "required": ["type"] },
          "then": { }
        },
        {
          "if": { "properties": { "type": { "enum": ["router", "end", "playbook"] } }, "required": ["type"] },
          "then": { }
        }
      ]
    },

    "task_call": {
      "type": "object",
      "required": ["task", "args"],
      "additionalProperties": false,
      "properties": {
        "task": {
          "type": "string",
          "minLength": 1,
          "description": "Workbook task name OR built-in action type (http/python/...)."
        },
        "args": { "type": "object", "additionalProperties": true }
      },
      "description": "Referential form."
    },

    "next_edge": {
      "type": "object",
      "required": ["step"],
      "additionalProperties": false,
      "properties": {
        "step": { "type": "string", "minLength": 1 },
        "input": {
          "type": "object",
          "additionalProperties": true,
          "description": "Edge-scoped payload merged into target step args at enqueue. Edge wins."
        }
      }
    },

    "workflow_step": {
      "type": "object",
      "required": ["step"],
      "additionalProperties": false,
      "properties": {
        "step": { "type": "string", "minLength": 1 },
        "desc": { "type": "string" },
        "when": { "type": "string" },

        "call": { "$ref": "#/$defs/task_call" },

        "type": {
          "$ref": "#/$defs/action_type",
          "description": "Inline form (built-in action type)."
        },
        "args": {
          "type": "object",
          "additionalProperties": true,
          "description": "Inline form arguments."
        },

        "next": {
          "type": "array",
          "items": { "$ref": "#/$defs/next_edge" }
        },

        "save": { "type": "object", "additionalProperties": true }
      },
      "allOf": [
        {
          "oneOf": [
            { "required": ["call"] },
            { "required": ["type", "args"] },
            { "properties": { "type": { "const": "router" } } },
            { "properties": { "type": { "const": "end" } } }
          ]
        }
      ],
      "description": "Step may be authored as referential (call.task+args) or inline (type+args)."
    }
  }
}
